var Prototype={Version:"1.7.1",Browser:(function(){var ua=navigator.userAgent;var isOpera=Object.prototype.toString.call(window.opera)=="[object Opera]";return{IE:!!window.attachEvent&&!isOpera,Opera:isOpera,WebKit:ua.indexOf("AppleWebKit/")>-1,Gecko:ua.indexOf("Gecko")>-1&&ua.indexOf("KHTML")===-1,MobileSafari:/Apple.*Mobile/.test(ua)}})(),BrowserFeatures:{XPath:!!document.evaluate,SelectorsAPI:!!document.querySelector,ElementExtensions:(function(){var constructor=window.Element||window.HTMLElement;return !!(constructor&&constructor.prototype)})(),SpecificElementExtensions:(function(){if(typeof window.HTMLDivElement!=="undefined"){return true}var div=document.createElement("div"),form=document.createElement("form"),isSupported=false;if(div.__proto__&&(div.__proto__!==form.__proto__)){isSupported=true}div=form=null;return isSupported})()},ScriptFragment:"<script[^>]*>([\\S\\s]*?)<\/script\\s*>",JSONFilter:/^\/\*-secure-([\s\S]*)\*\/\s*$/,emptyFunction:function(){},K:function(x){return x}};if(Prototype.Browser.MobileSafari){Prototype.BrowserFeatures.SpecificElementExtensions=false}var Class=(function(){var IS_DONTENUM_BUGGY=(function(){for(var p in {toString:1}){if(p==="toString"){return false}}return true})();function subclass(){}function create(){var parent=null,properties=$A(arguments);if(Object.isFunction(properties[0])){parent=properties.shift()}function klass(){this.initialize.apply(this,arguments)}Object.extend(klass,Class.Methods);klass.superclass=parent;klass.subclasses=[];if(parent){subclass.prototype=parent.prototype;klass.prototype=new subclass;parent.subclasses.push(klass)}for(var i=0,length=properties.length;i<length;i++){klass.addMethods(properties[i])}if(!klass.prototype.initialize){klass.prototype.initialize=Prototype.emptyFunction}klass.prototype.constructor=klass;return klass}function addMethods(source){var ancestor=this.superclass&&this.superclass.prototype,properties=Object.keys(source);if(IS_DONTENUM_BUGGY){if(source.toString!=Object.prototype.toString){properties.push("toString")}if(source.valueOf!=Object.prototype.valueOf){properties.push("valueOf")}}for(var i=0,length=properties.length;i<length;i++){var property=properties[i],value=source[property];if(ancestor&&Object.isFunction(value)&&value.argumentNames()[0]=="$super"){var method=value;value=(function(m){return function(){return ancestor[m].apply(this,arguments)}})(property).wrap(method);value.valueOf=(function(method){return function(){return method.valueOf.call(method)}})(method);value.toString=(function(method){return function(){return method.toString.call(method)}})(method)}this.prototype[property]=value}return this}return{create:create,Methods:{addMethods:addMethods}}})();(function(){var _toString=Object.prototype.toString,_hasOwnProperty=Object.prototype.hasOwnProperty,NULL_TYPE="Null",UNDEFINED_TYPE="Undefined",BOOLEAN_TYPE="Boolean",NUMBER_TYPE="Number",STRING_TYPE="String",OBJECT_TYPE="Object",FUNCTION_CLASS="[object Function]",BOOLEAN_CLASS="[object Boolean]",NUMBER_CLASS="[object Number]",STRING_CLASS="[object String]",ARRAY_CLASS="[object Array]",DATE_CLASS="[object Date]",NATIVE_JSON_STRINGIFY_SUPPORT=window.JSON&&typeof JSON.stringify==="function"&&JSON.stringify(0)==="0"&&typeof JSON.stringify(Prototype.K)==="undefined";var DONT_ENUMS=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"];var IS_DONTENUM_BUGGY=(function(){for(var p in {toString:1}){if(p==="toString"){return false}}return true})();function Type(o){switch(o){case null:return NULL_TYPE;case (void 0):return UNDEFINED_TYPE}var type=typeof o;switch(type){case"boolean":return BOOLEAN_TYPE;case"number":return NUMBER_TYPE;case"string":return STRING_TYPE}return OBJECT_TYPE}function extend(destination,source){for(var property in source){destination[property]=source[property]}return destination}function inspect(object){try{if(isUndefined(object)){return"undefined"}if(object===null){return"null"}return object.inspect?object.inspect():String(object)}catch(e){if(e instanceof RangeError){return"..."}throw e}}function toJSON(value){return Str("",{"":value},[])}function Str(key,holder,stack){var value=holder[key];if(Type(value)===OBJECT_TYPE&&typeof value.toJSON==="function"){value=value.toJSON(key)}var _class=_toString.call(value);switch(_class){case NUMBER_CLASS:case BOOLEAN_CLASS:case STRING_CLASS:value=value.valueOf()}switch(value){case null:return"null";case true:return"true";case false:return"false"}var type=typeof value;switch(type){case"string":return value.inspect(true);case"number":return isFinite(value)?String(value):"null";case"object":for(var i=0,length=stack.length;i<length;i++){if(stack[i]===value){throw new TypeError("Cyclic reference to '"+value+"' in object")}}stack.push(value);var partial=[];if(_class===ARRAY_CLASS){for(var i=0,length=value.length;i<length;i++){var str=Str(i,value,stack);partial.push(typeof str==="undefined"?"null":str)}partial="["+partial.join(",")+"]"}else{var keys=Object.keys(value);for(var i=0,length=keys.length;i<length;i++){var key=keys[i],str=Str(key,value,stack);if(typeof str!=="undefined"){partial.push(key.inspect(true)+":"+str)}}partial="{"+partial.join(",")+"}"}stack.pop();return partial}}function stringify(object){return JSON.stringify(object)}function toQueryString(object){return $H(object).toQueryString()}function toHTML(object){return object&&object.toHTML?object.toHTML():String.interpret(object)}function keys(object){if(Type(object)!==OBJECT_TYPE){throw new TypeError()}var results=[];for(var property in object){if(_hasOwnProperty.call(object,property)){results.push(property)}}if(IS_DONTENUM_BUGGY){for(var i=0;property=DONT_ENUMS[i];i++){if(_hasOwnProperty.call(object,property)){results.push(property)}}}return results}function values(object){var results=[];for(var property in object){results.push(object[property])}return results}function clone(object){return extend({},object)}function isElement(object){return !!(object&&object.nodeType==1)}function isArray(object){return _toString.call(object)===ARRAY_CLASS}var hasNativeIsArray=(typeof Array.isArray=="function")&&Array.isArray([])&&!Array.isArray({});if(hasNativeIsArray){isArray=Array.isArray}function isHash(object){return object instanceof Hash}function isFunction(object){return _toString.call(object)===FUNCTION_CLASS}function isString(object){return _toString.call(object)===STRING_CLASS}function isNumber(object){return _toString.call(object)===NUMBER_CLASS}function isDate(object){return _toString.call(object)===DATE_CLASS}function isUndefined(object){return typeof object==="undefined"}extend(Object,{extend:extend,inspect:inspect,toJSON:NATIVE_JSON_STRINGIFY_SUPPORT?stringify:toJSON,toQueryString:toQueryString,toHTML:toHTML,keys:Object.keys||keys,values:values,clone:clone,isElement:isElement,isArray:isArray,isHash:isHash,isFunction:isFunction,isString:isString,isNumber:isNumber,isDate:isDate,isUndefined:isUndefined})})();Object.extend(Function.prototype,(function(){var slice=Array.prototype.slice;function update(array,args){var arrayLength=array.length,length=args.length;while(length--){array[arrayLength+length]=args[length]}return array}function merge(array,args){array=slice.call(array,0);return update(array,args)}function argumentNames(){var names=this.toString().match(/^[\s\(]*function[^(]*\(([^)]*)\)/)[1].replace(/\/\/.*?[\r\n]|\/\*(?:.|[\r\n])*?\*\//g,"").replace(/\s+/g,"").split(",");return names.length==1&&!names[0]?[]:names}function bind(context){if(arguments.length<2&&Object.isUndefined(arguments[0])){return this}if(!Object.isFunction(this)){throw new TypeError("The object is not callable.")}var nop=function(){};var __method=this,args=slice.call(arguments,1);var bound=function(){var a=merge(args,arguments);var c=this instanceof bound?this:context;return __method.apply(c,a)};nop.prototype=this.prototype;bound.prototype=new nop();return bound}function bindAsEventListener(context){var __method=this,args=slice.call(arguments,1);return function(event){var a=update([event||window.event],args);return __method.apply(context,a)}}function curry(){if(!arguments.length){return this}var __method=this,args=slice.call(arguments,0);return function(){var a=merge(args,arguments);return __method.apply(this,a)}}function delay(timeout){var __method=this,args=slice.call(arguments,1);timeout=timeout*1000;return window.setTimeout(function(){return __method.apply(__method,args)},timeout)}function defer(){var args=update([0.01],arguments);return this.delay.apply(this,args)}function wrap(wrapper){var __method=this;return function(){var a=update([__method.bind(this)],arguments);return wrapper.apply(this,a)}}function methodize(){if(this._methodized){return this._methodized}var __method=this;return this._methodized=function(){var a=update([this],arguments);return __method.apply(null,a)}}var extensions={argumentNames:argumentNames,bindAsEventListener:bindAsEventListener,curry:curry,delay:delay,defer:defer,wrap:wrap,methodize:methodize};if(!Function.prototype.bind){extensions.bind=bind}return extensions})());(function(proto){function toISOString(){return this.getUTCFullYear()+"-"+(this.getUTCMonth()+1).toPaddedString(2)+"-"+this.getUTCDate().toPaddedString(2)+"T"+this.getUTCHours().toPaddedString(2)+":"+this.getUTCMinutes().toPaddedString(2)+":"+this.getUTCSeconds().toPaddedString(2)+"Z"}function toJSON(){return this.toISOString()}if(!proto.toISOString){proto.toISOString=toISOString}if(!proto.toJSON){proto.toJSON=toJSON}})(Date.prototype);RegExp.prototype.match=RegExp.prototype.test;RegExp.escape=function(str){return String(str).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")};var PeriodicalExecuter=Class.create({initialize:function(callback,frequency){this.callback=callback;this.frequency=frequency;this.currentlyExecuting=false;this.registerCallback()},registerCallback:function(){this.timer=setInterval(this.onTimerEvent.bind(this),this.frequency*1000)},execute:function(){this.callback(this)},stop:function(){if(!this.timer){return}clearInterval(this.timer);this.timer=null},onTimerEvent:function(){if(!this.currentlyExecuting){try{this.currentlyExecuting=true;this.execute();this.currentlyExecuting=false}catch(e){this.currentlyExecuting=false;throw e}}}});Object.extend(String,{interpret:function(value){return value==null?"":String(value)},specialChar:{"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","\\":"\\\\"}});Object.extend(String.prototype,(function(){var NATIVE_JSON_PARSE_SUPPORT=window.JSON&&typeof JSON.parse==="function"&&JSON.parse('{"test": true}').test;function prepareReplacement(replacement){if(Object.isFunction(replacement)){return replacement}var template=new Template(replacement);return function(match){return template.evaluate(match)}}function gsub(pattern,replacement){var result="",source=this,match;replacement=prepareReplacement(replacement);if(Object.isString(pattern)){pattern=RegExp.escape(pattern)}if(!(pattern.length||pattern.source)){replacement=replacement("");return replacement+source.split("").join(replacement)+replacement}while(source.length>0){match=source.match(pattern);if(match&&match[0].length>0){result+=source.slice(0,match.index);result+=String.interpret(replacement(match));source=source.slice(match.index+match[0].length)}else{result+=source,source=""}}return result}function sub(pattern,replacement,count){replacement=prepareReplacement(replacement);count=Object.isUndefined(count)?1:count;return this.gsub(pattern,function(match){if(--count<0){return match[0]}return replacement(match)})}function scan(pattern,iterator){this.gsub(pattern,iterator);return String(this)}function truncate(length,truncation){length=length||30;truncation=Object.isUndefined(truncation)?"...":truncation;return this.length>length?this.slice(0,length-truncation.length)+truncation:String(this)}function strip(){return this.replace(/^\s+/,"").replace(/\s+$/,"")}function stripTags(){return this.replace(/<\w+(\s+("[^"]*"|'[^']*'|[^>])+)?>|<\/\w+>/gi,"")}function stripScripts(){return this.replace(new RegExp(Prototype.ScriptFragment,"img"),"")}function extractScripts(){var matchAll=new RegExp(Prototype.ScriptFragment,"img"),matchOne=new RegExp(Prototype.ScriptFragment,"im");return(this.match(matchAll)||[]).map(function(scriptTag){return(scriptTag.match(matchOne)||["",""])[1]})}function evalScripts(){return this.extractScripts().map(function(script){return eval(script)})}function escapeHTML(){return this.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function unescapeHTML(){return this.stripTags().replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")}function toQueryParams(separator){var match=this.strip().match(/([^?#]*)(#.*)?$/);if(!match){return{}}return match[1].split(separator||"&").inject({},function(hash,pair){if((pair=pair.split("="))[0]){var key=decodeURIComponent(pair.shift()),value=pair.length>1?pair.join("="):pair[0];if(value!=undefined){value=value.gsub("+"," ");value=decodeURIComponent(value)}if(key in hash){if(!Object.isArray(hash[key])){hash[key]=[hash[key]]}hash[key].push(value)}else{hash[key]=value}}return hash})}function toArray(){return this.split("")}function succ(){return this.slice(0,this.length-1)+String.fromCharCode(this.charCodeAt(this.length-1)+1)}function times(count){return count<1?"":new Array(count+1).join(this)}function camelize(){return this.replace(/-+(.)?/g,function(match,chr){return chr?chr.toUpperCase():""})}function capitalize(){return this.charAt(0).toUpperCase()+this.substring(1).toLowerCase()}function underscore(){return this.replace(/::/g,"/").replace(/([A-Z]+)([A-Z][a-z])/g,"$1_$2").replace(/([a-z\d])([A-Z])/g,"$1_$2").replace(/-/g,"_").toLowerCase()}function dasherize(){return this.replace(/_/g,"-")}function inspect(useDoubleQuotes){var escapedString=this.replace(/[\x00-\x1f\\]/g,function(character){if(character in String.specialChar){return String.specialChar[character]}return"\\u00"+character.charCodeAt().toPaddedString(2,16)});if(useDoubleQuotes){return'"'+escapedString.replace(/"/g,'\\"')+'"'}return"'"+escapedString.replace(/'/g,"\\'")+"'"}function unfilterJSON(filter){return this.replace(filter||Prototype.JSONFilter,"$1")}function isJSON(){var str=this;if(str.blank()){return false}str=str.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@");str=str.replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]");str=str.replace(/(?:^|:|,)(?:\s*\[)+/g,"");return(/^[\],:{}\s]*$/).test(str)}function evalJSON(sanitize){var json=this.unfilterJSON(),cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;if(cx.test(json)){json=json.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}try{if(!sanitize||json.isJSON()){return eval("("+json+")")}}catch(e){}throw new SyntaxError("Badly formed JSON string: "+this.inspect())}function parseJSON(){var json=this.unfilterJSON();return JSON.parse(json)}function include(pattern){return this.indexOf(pattern)>-1}function startsWith(pattern,position){position=Object.isNumber(position)?position:0;return this.lastIndexOf(pattern,position)===position}function endsWith(pattern,position){pattern=String(pattern);position=Object.isNumber(position)?position:this.length;if(position<0){position=0}if(position>this.length){position=this.length}var d=position-pattern.length;return d>=0&&this.indexOf(pattern,d)===d}function empty(){return this==""}function blank(){return/^\s*$/.test(this)}function interpolate(object,pattern){return new Template(this,pattern).evaluate(object)}return{gsub:gsub,sub:sub,scan:scan,truncate:truncate,strip:String.prototype.trim||strip,stripTags:stripTags,stripScripts:stripScripts,extractScripts:extractScripts,evalScripts:evalScripts,escapeHTML:escapeHTML,unescapeHTML:unescapeHTML,toQueryParams:toQueryParams,parseQuery:toQueryParams,toArray:toArray,succ:succ,times:times,camelize:camelize,capitalize:capitalize,underscore:underscore,dasherize:dasherize,inspect:inspect,unfilterJSON:unfilterJSON,isJSON:isJSON,evalJSON:NATIVE_JSON_PARSE_SUPPORT?parseJSON:evalJSON,include:include,startsWith:String.prototype.startsWith||startsWith,endsWith:String.prototype.endsWith||endsWith,empty:empty,blank:blank,interpolate:interpolate}})());var Template=Class.create({initialize:function(template,pattern){this.template=template.toString();this.pattern=pattern||Template.Pattern},evaluate:function(object){if(object&&Object.isFunction(object.toTemplateReplacements)){object=object.toTemplateReplacements()}return this.template.gsub(this.pattern,function(match){if(object==null){return(match[1]+"")}var before=match[1]||"";if(before=="\\"){return match[2]}var ctx=object,expr=match[3],pattern=/^([^.[]+|\[((?:.*?[^\\])?)\])(\.|\[|$)/;match=pattern.exec(expr);if(match==null){return before}while(match!=null){var comp=match[1].startsWith("[")?match[2].replace(/\\\\]/g,"]"):match[1];ctx=ctx[comp];if(null==ctx||""==match[3]){break}expr=expr.substring("["==match[3]?match[1].length:match[0].length);match=pattern.exec(expr)}return before+String.interpret(ctx)})}});Template.Pattern=/(^|.|\r|\n)(#\{(.*?)\})/;var $break={};var Enumerable=(function(){function each(iterator,context){try{this._each(iterator,context)}catch(e){if(e!=$break){throw e}}return this}function eachSlice(number,iterator,context){var index=-number,slices=[],array=this.toArray();if(number<1){return array}while((index+=number)<array.length){slices.push(array.slice(index,index+number))}return slices.collect(iterator,context)}function all(iterator,context){iterator=iterator||Prototype.K;var result=true;this.each(function(value,index){result=result&&!!iterator.call(context,value,index,this);if(!result){throw $break}},this);return result}function any(iterator,context){iterator=iterator||Prototype.K;var result=false;this.each(function(value,index){if(result=!!iterator.call(context,value,index,this)){throw $break}},this);return result}function collect(iterator,context){iterator=iterator||Prototype.K;var results=[];this.each(function(value,index){results.push(iterator.call(context,value,index,this))},this);return results}function detect(iterator,context){var result;this.each(function(value,index){if(iterator.call(context,value,index,this)){result=value;throw $break}},this);return result}function findAll(iterator,context){var results=[];this.each(function(value,index){if(iterator.call(context,value,index,this)){results.push(value)}},this);return results}function grep(filter,iterator,context){iterator=iterator||Prototype.K;var results=[];if(Object.isString(filter)){filter=new RegExp(RegExp.escape(filter))}this.each(function(value,index){if(filter.match(value)){results.push(iterator.call(context,value,index,this))}},this);return results}function include(object){if(Object.isFunction(this.indexOf)&&this.indexOf(object)!=-1){return true}var found=false;this.each(function(value){if(value==object){found=true;throw $break}});return found}function inGroupsOf(number,fillWith){fillWith=Object.isUndefined(fillWith)?null:fillWith;return this.eachSlice(number,function(slice){while(slice.length<number){slice.push(fillWith)}return slice})}function inject(memo,iterator,context){this.each(function(value,index){memo=iterator.call(context,memo,value,index,this)},this);return memo}function invoke(method){var args=$A(arguments).slice(1);return this.map(function(value){return value[method].apply(value,args)})}function max(iterator,context){iterator=iterator||Prototype.K;var result;this.each(function(value,index){value=iterator.call(context,value,index,this);if(result==null||value>=result){result=value}},this);return result}function min(iterator,context){iterator=iterator||Prototype.K;var result;this.each(function(value,index){value=iterator.call(context,value,index,this);if(result==null||value<result){result=value}},this);return result}function partition(iterator,context){iterator=iterator||Prototype.K;var trues=[],falses=[];this.each(function(value,index){(iterator.call(context,value,index,this)?trues:falses).push(value)},this);return[trues,falses]}function pluck(property){var results=[];this.each(function(value){results.push(value[property])});return results}function reject(iterator,context){var results=[];this.each(function(value,index){if(!iterator.call(context,value,index,this)){results.push(value)}},this);return results}function sortBy(iterator,context){return this.map(function(value,index){return{value:value,criteria:iterator.call(context,value,index,this)}},this).sort(function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}).pluck("value")}function toArray(){return this.map()}function zip(){var iterator=Prototype.K,args=$A(arguments);if(Object.isFunction(args.last())){iterator=args.pop()}var collections=[this].concat(args).map($A);return this.map(function(value,index){return iterator(collections.pluck(index))})}function size(){return this.toArray().length}function inspect(){return"#<Enumerable:"+this.toArray().inspect()+">"}return{each:each,eachSlice:eachSlice,all:all,every:all,any:any,some:any,collect:collect,map:collect,detect:detect,findAll:findAll,select:findAll,filter:findAll,grep:grep,include:include,member:include,inGroupsOf:inGroupsOf,inject:inject,invoke:invoke,max:max,min:min,partition:partition,pluck:pluck,reject:reject,sortBy:sortBy,toArray:toArray,entries:toArray,zip:zip,size:size,inspect:inspect,find:detect}})();function $A(iterable){if(!iterable){return[]}if("toArray" in Object(iterable)){return iterable.toArray()}var length=iterable.length||0,results=new Array(length);while(length--){results[length]=iterable[length]}return results}function $w(string){if(!Object.isString(string)){return[]}string=string.strip();return string?string.split(/\s+/):[]}Array.from=$A;(function(){var arrayProto=Array.prototype,slice=arrayProto.slice,_each=arrayProto.forEach;function each(iterator,context){for(var i=0,length=this.length>>>0;i<length;i++){if(i in this){iterator.call(context,this[i],i,this)}}}if(!_each){_each=each}function clear(){this.length=0;return this}function first(){return this[0]}function last(){return this[this.length-1]}function compact(){return this.select(function(value){return value!=null})}function flatten(){return this.inject([],function(array,value){if(Object.isArray(value)){return array.concat(value.flatten())}array.push(value);return array})}function without(){var values=slice.call(arguments,0);return this.select(function(value){return !values.include(value)})}function reverse(inline){return(inline===false?this.toArray():this)._reverse()}function uniq(sorted){return this.inject([],function(array,value,index){if(0==index||(sorted?array.last()!=value:!array.include(value))){array.push(value)}return array})}function intersect(array){return this.uniq().findAll(function(item){return array.indexOf(item)!==-1})}function clone(){return slice.call(this,0)}function size(){return this.length}function inspect(){return"["+this.map(Object.inspect).join(", ")+"]"}function indexOf(item,i){if(this==null){throw new TypeError()}var array=Object(this),length=array.length>>>0;if(length===0){return -1}i=Number(i);if(isNaN(i)){i=0}else{if(i!==0&&isFinite(i)){i=(i>0?1:-1)*Math.floor(Math.abs(i))}}if(i>length){return -1}var k=i>=0?i:Math.max(length-Math.abs(i),0);for(;k<length;k++){if(k in array&&array[k]===item){return k}}return -1}function lastIndexOf(item,i){if(this==null){throw new TypeError()}var array=Object(this),length=array.length>>>0;if(length===0){return -1}if(!Object.isUndefined(i)){i=Number(i);if(isNaN(i)){i=0}else{if(i!==0&&isFinite(i)){i=(i>0?1:-1)*Math.floor(Math.abs(i))}}}else{i=length}var k=i>=0?Math.min(i,length-1):length-Math.abs(i);for(;k>=0;k--){if(k in array&&array[k]===item){return k}}return -1}function concat(_){var array=[],items=slice.call(arguments,0),item,n=0;items.unshift(this);for(var i=0,length=items.length;i<length;i++){item=items[i];if(Object.isArray(item)&&!("callee" in item)){for(var j=0,arrayLength=item.length;j<arrayLength;j++){if(j in item){array[n]=item[j]}n++}}else{array[n++]=item}}array.length=n;return array}function wrapNative(method){return function(){if(arguments.length===0){return method.call(this,Prototype.K)}else{if(arguments[0]===undefined){var args=slice.call(arguments,1);args.unshift(Prototype.K);return method.apply(this,args)}else{return method.apply(this,arguments)}}}}function map(iterator){if(this==null){throw new TypeError()}iterator=iterator||Prototype.K;var object=Object(this);var results=[],context=arguments[1],n=0;for(var i=0,length=object.length>>>0;i<length;i++){if(i in object){results[n]=iterator.call(context,object[i],i,object)}n++}results.length=n;return results}if(arrayProto.map){map=wrapNative(Array.prototype.map)}function filter(iterator){if(this==null||!Object.isFunction(iterator)){throw new TypeError()}var object=Object(this);var results=[],context=arguments[1],value;for(var i=0,length=object.length>>>0;i<length;i++){if(i in object){value=object[i];if(iterator.call(context,value,i,object)){results.push(value)}}}return results}if(arrayProto.filter){filter=Array.prototype.filter}function some(iterator){if(this==null){throw new TypeError()}iterator=iterator||Prototype.K;var context=arguments[1];var object=Object(this);for(var i=0,length=object.length>>>0;i<length;i++){if(i in object&&iterator.call(context,object[i],i,object)){return true}}return false}if(arrayProto.some){var some=wrapNative(Array.prototype.some)}function every(iterator){if(this==null){throw new TypeError()}iterator=iterator||Prototype.K;var context=arguments[1];var object=Object(this);for(var i=0,length=object.length>>>0;i<length;i++){if(i in object&&!iterator.call(context,object[i],i,object)){return false}}return true}if(arrayProto.every){var every=wrapNative(Array.prototype.every)}var _reduce=arrayProto.reduce;function inject(memo,iterator){iterator=iterator||Prototype.K;var context=arguments[2];return _reduce.call(this,iterator.bind(context),memo)}if(!arrayProto.reduce){var inject=Enumerable.inject}Object.extend(arrayProto,Enumerable);if(!arrayProto._reverse){arrayProto._reverse=arrayProto.reverse}Object.extend(arrayProto,{_each:_each,map:map,collect:map,select:filter,filter:filter,findAll:filter,some:some,any:some,every:every,all:every,inject:inject,clear:clear,first:first,last:last,compact:compact,flatten:flatten,without:without,reverse:reverse,uniq:uniq,intersect:intersect,clone:clone,toArray:clone,size:size,inspect:inspect});var CONCAT_ARGUMENTS_BUGGY=(function(){return[].concat(arguments)[0][0]!==1})(1,2);if(CONCAT_ARGUMENTS_BUGGY){arrayProto.concat=concat}if(!arrayProto.indexOf){arrayProto.indexOf=indexOf}if(!arrayProto.lastIndexOf){arrayProto.lastIndexOf=lastIndexOf}})();function $H(object){return new Hash(object)}var Hash=Class.create(Enumerable,(function(){function initialize(object){this._object=Object.isHash(object)?object.toObject():Object.clone(object)}function _each(iterator,context){var i=0;for(var key in this._object){var value=this._object[key],pair=[key,value];pair.key=key;pair.value=value;iterator.call(context,pair,i);i++}}function set(key,value){return this._object[key]=value}function get(key){if(this._object[key]!==Object.prototype[key]){return this._object[key]}}function unset(key){var value=this._object[key];delete this._object[key];return value}function toObject(){return Object.clone(this._object)}function keys(){return this.pluck("key")}function values(){return this.pluck("value")}function index(value){var match=this.detect(function(pair){return pair.value===value});return match&&match.key}function merge(object){return this.clone().update(object)}function update(object){return new Hash(object).inject(this,function(result,pair){result.set(pair.key,pair.value);return result})}function toQueryPair(key,value){if(Object.isUndefined(value)){return key}value=String.interpret(value);value=value.gsub(/(\r)?\n/,"\r\n");value=encodeURIComponent(value);value=value.gsub(/%20/,"+");return key+"="+value}function toQueryString(){return this.inject([],function(results,pair){var key=encodeURIComponent(pair.key),values=pair.value;if(values&&typeof values=="object"){if(Object.isArray(values)){var queryValues=[];for(var i=0,len=values.length,value;i<len;i++){value=values[i];queryValues.push(toQueryPair(key,value))}return results.concat(queryValues)}}else{results.push(toQueryPair(key,values))}return results}).join("&")}function inspect(){return"#<Hash:{"+this.map(function(pair){return pair.map(Object.inspect).join(": ")}).join(", ")+"}>"}function clone(){return new Hash(this)}return{initialize:initialize,_each:_each,set:set,get:get,unset:unset,toObject:toObject,toTemplateReplacements:toObject,keys:keys,values:values,index:index,merge:merge,update:update,toQueryString:toQueryString,inspect:inspect,toJSON:toObject,clone:clone}})());Hash.from=$H;Object.extend(Number.prototype,(function(){function toColorPart(){return this.toPaddedString(2,16)}function succ(){return this+1}function times(iterator,context){$R(0,this,true).each(iterator,context);return this}function toPaddedString(length,radix){var string=this.toString(radix||10);return"0".times(length-string.length)+string}function abs(){return Math.abs(this)}function round(){return Math.round(this)}function ceil(){return Math.ceil(this)}function floor(){return Math.floor(this)}return{toColorPart:toColorPart,succ:succ,times:times,toPaddedString:toPaddedString,abs:abs,round:round,ceil:ceil,floor:floor}})());function $R(start,end,exclusive){return new ObjectRange(start,end,exclusive)}var ObjectRange=Class.create(Enumerable,(function(){function initialize(start,end,exclusive){this.start=start;this.end=end;this.exclusive=exclusive}function _each(iterator,context){var value=this.start,i;for(i=0;this.include(value);i++){iterator.call(context,value,i);value=value.succ()}}function include(value){if(value<this.start){return false}if(this.exclusive){return value<this.end}return value<=this.end}return{initialize:initialize,_each:_each,include:include}})());var Abstract={};var Try={these:function(){var returnValue;for(var i=0,length=arguments.length;i<length;i++){var lambda=arguments[i];try{returnValue=lambda();break}catch(e){}}return returnValue}};var Ajax={getTransport:function(){return Try.these(function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")})||false},activeRequestCount:0};Ajax.Responders={responders:[],_each:function(iterator,context){this.responders._each(iterator,context)},register:function(responder){if(!this.include(responder)){this.responders.push(responder)}},unregister:function(responder){this.responders=this.responders.without(responder)},dispatch:function(callback,request,transport,json){this.each(function(responder){if(Object.isFunction(responder[callback])){try{responder[callback].apply(responder,[request,transport,json])}catch(e){}}})}};Object.extend(Ajax.Responders,Enumerable);Ajax.Responders.register({onCreate:function(){Ajax.activeRequestCount++},onComplete:function(){Ajax.activeRequestCount--}});Ajax.Base=Class.create({initialize:function(options){this.options={method:"post",asynchronous:true,contentType:"application/x-www-form-urlencoded",encoding:"UTF-8",parameters:"",evalJSON:true,evalJS:true};Object.extend(this.options,options||{});this.options.method=this.options.method.toLowerCase();if(Object.isHash(this.options.parameters)){this.options.parameters=this.options.parameters.toObject()}}});Ajax.Request=Class.create(Ajax.Base,{_complete:false,initialize:function($super,url,options){$super(options);this.transport=Ajax.getTransport();this.request(url)},request:function(url){this.url=url;this.method=this.options.method;var params=Object.isString(this.options.parameters)?this.options.parameters:Object.toQueryString(this.options.parameters);if(!["get","post"].include(this.method)){params+=(params?"&":"")+"_method="+this.method;this.method="post"}if(params&&this.method==="get"){this.url+=(this.url.include("?")?"&":"?")+params}this.parameters=params.toQueryParams();try{var response=new Ajax.Response(this);if(this.options.onCreate){this.options.onCreate(response)}Ajax.Responders.dispatch("onCreate",this,response);this.transport.open(this.method.toUpperCase(),this.url,this.options.asynchronous);if(this.options.asynchronous){this.respondToReadyState.bind(this).defer(1)}this.transport.onreadystatechange=this.onStateChange.bind(this);this.setRequestHeaders();this.body=this.method=="post"?(this.options.postBody||params):null;this.transport.send(this.body);if(!this.options.asynchronous&&this.transport.overrideMimeType){this.onStateChange()}}catch(e){this.dispatchException(e)}},onStateChange:function(){var readyState=this.transport.readyState;if(readyState>1&&!((readyState==4)&&this._complete)){this.respondToReadyState(this.transport.readyState)}},setRequestHeaders:function(){var headers={"X-Requested-With":"XMLHttpRequest","X-Prototype-Version":Prototype.Version,Accept:"text/javascript, text/html, application/xml, text/xml, */*"};if(this.method=="post"){headers["Content-type"]=this.options.contentType+(this.options.encoding?"; charset="+this.options.encoding:"");if(this.transport.overrideMimeType&&(navigator.userAgent.match(/Gecko\/(\d{4})/)||[0,2005])[1]<2005){headers.Connection="close"}}if(typeof this.options.requestHeaders=="object"){var extras=this.options.requestHeaders;if(Object.isFunction(extras.push)){for(var i=0,length=extras.length;i<length;i+=2){headers[extras[i]]=extras[i+1]}}else{$H(extras).each(function(pair){headers[pair.key]=pair.value})}}for(var name in headers){if(headers[name]!=null){this.transport.setRequestHeader(name,headers[name])}}},success:function(){var status=this.getStatus();return !status||(status>=200&&status<300)||status==304},getStatus:function(){try{if(this.transport.status===1223){return 204}return this.transport.status||0}catch(e){return 0}},respondToReadyState:function(readyState){var state=Ajax.Request.Events[readyState],response=new Ajax.Response(this);if(state=="Complete"){try{this._complete=true;(this.options["on"+response.status]||this.options["on"+(this.success()?"Success":"Failure")]||Prototype.emptyFunction)(response,response.headerJSON)}catch(e){this.dispatchException(e)}var contentType=response.getHeader("Content-type");if(this.options.evalJS=="force"||(this.options.evalJS&&this.isSameOrigin()&&contentType&&contentType.match(/^\s*(text|application)\/(x-)?(java|ecma)script(;.*)?\s*$/i))){this.evalResponse()}}try{(this.options["on"+state]||Prototype.emptyFunction)(response,response.headerJSON);Ajax.Responders.dispatch("on"+state,this,response,response.headerJSON)}catch(e){this.dispatchException(e)}if(state=="Complete"){this.transport.onreadystatechange=Prototype.emptyFunction}},isSameOrigin:function(){var m=this.url.match(/^\s*https?:\/\/[^\/]*/);return !m||(m[0]=="#{protocol}//#{domain}#{port}".interpolate({protocol:location.protocol,domain:document.domain,port:location.port?":"+location.port:""}))},getHeader:function(name){try{return this.transport.getResponseHeader(name)||null}catch(e){return null}},evalResponse:function(){try{return eval((this.transport.responseText||"").unfilterJSON())}catch(e){this.dispatchException(e)}},dispatchException:function(exception){(this.options.onException||Prototype.emptyFunction)(this,exception);Ajax.Responders.dispatch("onException",this,exception)}});Ajax.Request.Events=["Uninitialized","Loading","Loaded","Interactive","Complete"];Ajax.Response=Class.create({initialize:function(request){this.request=request;var transport=this.transport=request.transport,readyState=this.readyState=transport.readyState;if((readyState>2&&!Prototype.Browser.IE)||readyState==4){this.status=this.getStatus();this.statusText=this.getStatusText();this.responseText=String.interpret(transport.responseText);this.headerJSON=this._getHeaderJSON()}if(readyState==4){var xml=transport.responseXML;this.responseXML=Object.isUndefined(xml)?null:xml;this.responseJSON=this._getResponseJSON()}},status:0,statusText:"",getStatus:Ajax.Request.prototype.getStatus,getStatusText:function(){try{return this.transport.statusText||""}catch(e){return""}},getHeader:Ajax.Request.prototype.getHeader,getAllHeaders:function(){try{return this.getAllResponseHeaders()}catch(e){return null}},getResponseHeader:function(name){return this.transport.getResponseHeader(name)},getAllResponseHeaders:function(){return this.transport.getAllResponseHeaders()},_getHeaderJSON:function(){var json=this.getHeader("X-JSON");if(!json){return null}try{json=decodeURIComponent(escape(json))}catch(e){}try{return json.evalJSON(this.request.options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}},_getResponseJSON:function(){var options=this.request.options;if(!options.evalJSON||(options.evalJSON!="force"&&!(this.getHeader("Content-type")||"").include("application/json"))||this.responseText.blank()){return null}try{return this.responseText.evalJSON(options.sanitizeJSON||!this.request.isSameOrigin())}catch(e){this.request.dispatchException(e)}}});Ajax.Updater=Class.create(Ajax.Request,{initialize:function($super,container,url,options){this.container={success:(container.success||container),failure:(container.failure||(container.success?null:container))};options=Object.clone(options);var onComplete=options.onComplete;options.onComplete=(function(response,json){this.updateContent(response.responseText);if(Object.isFunction(onComplete)){onComplete(response,json)}}).bind(this);$super(url,options)},updateContent:function(responseText){var receiver=this.container[this.success()?"success":"failure"],options=this.options;if(!options.evalScripts){responseText=responseText.stripScripts()}if(receiver=$(receiver)){if(options.insertion){if(Object.isString(options.insertion)){var insertion={};insertion[options.insertion]=responseText;receiver.insert(insertion)}else{options.insertion(receiver,responseText)}}else{receiver.update(responseText)}}}});Ajax.PeriodicalUpdater=Class.create(Ajax.Base,{initialize:function($super,container,url,options){$super(options);this.onComplete=this.options.onComplete;this.frequency=(this.options.frequency||2);this.decay=(this.options.decay||1);this.updater={};this.container=container;this.url=url;this.start()},start:function(){this.options.onComplete=this.updateComplete.bind(this);this.onTimerEvent()},stop:function(){this.updater.options.onComplete=undefined;clearTimeout(this.timer);(this.onComplete||Prototype.emptyFunction).apply(this,arguments)},updateComplete:function(response){if(this.options.decay){this.decay=(response.responseText==this.lastText?this.decay*this.options.decay:1);this.lastText=response.responseText}this.timer=this.onTimerEvent.bind(this).delay(this.decay*this.frequency)},onTimerEvent:function(){this.updater=new Ajax.Updater(this.container,this.url,this.options)}});(function(GLOBAL){var UNDEFINED;var SLICE=Array.prototype.slice;var DIV=document.createElement("div");function $(element){if(arguments.length>1){for(var i=0,elements=[],length=arguments.length;i<length;i++){elements.push($(arguments[i]))}return elements}if(Object.isString(element)){element=document.getElementById(element)}return Element.extend(element)}GLOBAL.$=$;if(!GLOBAL.Node){GLOBAL.Node={}}if(!GLOBAL.Node.ELEMENT_NODE){Object.extend(GLOBAL.Node,{ELEMENT_NODE:1,ATTRIBUTE_NODE:2,TEXT_NODE:3,CDATA_SECTION_NODE:4,ENTITY_REFERENCE_NODE:5,ENTITY_NODE:6,PROCESSING_INSTRUCTION_NODE:7,COMMENT_NODE:8,DOCUMENT_NODE:9,DOCUMENT_TYPE_NODE:10,DOCUMENT_FRAGMENT_NODE:11,NOTATION_NODE:12})}var ELEMENT_CACHE={};function shouldUseCreationCache(tagName,attributes){if(tagName==="select"){return false}if("type" in attributes){return false}return true}var HAS_EXTENDED_CREATE_ELEMENT_SYNTAX=(function(){try{var el=document.createElement('<input name="x">');return el.tagName.toLowerCase()==="input"&&el.name==="x"}catch(err){return false}})();var oldElement=GLOBAL.Element;function Element(tagName,attributes){attributes=attributes||{};tagName=tagName.toLowerCase();if(HAS_EXTENDED_CREATE_ELEMENT_SYNTAX&&attributes.name){tagName="<"+tagName+' name="'+attributes.name+'">';delete attributes.name;return Element.writeAttribute(document.createElement(tagName),attributes)}if(!ELEMENT_CACHE[tagName]){ELEMENT_CACHE[tagName]=Element.extend(document.createElement(tagName))}var node=shouldUseCreationCache(tagName,attributes)?ELEMENT_CACHE[tagName].cloneNode(false):document.createElement(tagName);return Element.writeAttribute(node,attributes)}GLOBAL.Element=Element;Object.extend(GLOBAL.Element,oldElement||{});if(oldElement){GLOBAL.Element.prototype=oldElement.prototype}Element.Methods={ByTag:{},Simulated:{}};var methods={};var INSPECT_ATTRIBUTES={id:"id",className:"class"};function inspect(element){element=$(element);var result="<"+element.tagName.toLowerCase();var attribute,value;for(var property in INSPECT_ATTRIBUTES){attribute=INSPECT_ATTRIBUTES[property];value=(element[property]||"").toString();if(value){result+=" "+attribute+"="+value.inspect(true)}}return result+">"}methods.inspect=inspect;function visible(element){return $(element).style.display!=="none"}function toggle(element,bool){element=$(element);if(Object.isUndefined(bool)){bool=!Element.visible(element)}Element[bool?"show":"hide"](element);return element}function hide(element){element=$(element);element.style.display="none";return element}function show(element){element=$(element);element.style.display="";return element}Object.extend(methods,{visible:visible,toggle:toggle,hide:hide,show:show});function remove(element){element=$(element);element.parentNode.removeChild(element);return element}var SELECT_ELEMENT_INNERHTML_BUGGY=(function(){var el=document.createElement("select"),isBuggy=true;el.innerHTML='<option value="test">test</option>';if(el.options&&el.options[0]){isBuggy=el.options[0].nodeName.toUpperCase()!=="OPTION"}el=null;return isBuggy})();var TABLE_ELEMENT_INNERHTML_BUGGY=(function(){try{var el=document.createElement("table");if(el&&el.tBodies){el.innerHTML="<tbody><tr><td>test</td></tr></tbody>";var isBuggy=typeof el.tBodies[0]=="undefined";el=null;return isBuggy}}catch(e){return true}})();var LINK_ELEMENT_INNERHTML_BUGGY=(function(){try{var el=document.createElement("div");el.innerHTML="<link />";var isBuggy=(el.childNodes.length===0);el=null;return isBuggy}catch(e){return true}})();var ANY_INNERHTML_BUGGY=SELECT_ELEMENT_INNERHTML_BUGGY||TABLE_ELEMENT_INNERHTML_BUGGY||LINK_ELEMENT_INNERHTML_BUGGY;var SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING=(function(){var s=document.createElement("script"),isBuggy=false;try{s.appendChild(document.createTextNode(""));isBuggy=!s.firstChild||s.firstChild&&s.firstChild.nodeType!==3}catch(e){isBuggy=true}s=null;return isBuggy})();function update(element,content){element=$(element);var descendants=element.getElementsByTagName("*"),i=descendants.length;while(i--){purgeElement(descendants[i])}if(content&&content.toElement){content=content.toElement()}if(Object.isElement(content)){return element.update().insert(content)}content=Object.toHTML(content);var tagName=element.tagName.toUpperCase();if(tagName==="SCRIPT"&&SCRIPT_ELEMENT_REJECTS_TEXTNODE_APPENDING){element.text=content;return element}if(ANY_INNERHTML_BUGGY){if(tagName in INSERTION_TRANSLATIONS.tags){while(element.firstChild){element.removeChild(element.firstChild)}var nodes=getContentFromAnonymousElement(tagName,content.stripScripts());for(var i=0,node;node=nodes[i];i++){element.appendChild(node)}}else{if(LINK_ELEMENT_INNERHTML_BUGGY&&Object.isString(content)&&content.indexOf("<link")>-1){while(element.firstChild){element.removeChild(element.firstChild)}var nodes=getContentFromAnonymousElement(tagName,content.stripScripts(),true);for(var i=0,node;node=nodes[i];i++){element.appendChild(node)}}else{element.innerHTML=content.stripScripts()}}}else{element.innerHTML=content.stripScripts()}content.evalScripts.bind(content).defer();return element}function replace(element,content){element=$(element);if(content&&content.toElement){content=content.toElement()}else{if(!Object.isElement(content)){content=Object.toHTML(content);var range=element.ownerDocument.createRange();range.selectNode(element);content.evalScripts.bind(content).defer();content=range.createContextualFragment(content.stripScripts())}}element.parentNode.replaceChild(content,element);return element}var INSERTION_TRANSLATIONS={before:function(element,node){element.parentNode.insertBefore(node,element)},top:function(element,node){element.insertBefore(node,element.firstChild)},bottom:function(element,node){element.appendChild(node)},after:function(element,node){element.parentNode.insertBefore(node,element.nextSibling)},tags:{TABLE:["<table>","</table>",1],TBODY:["<table><tbody>","</tbody></table>",2],TR:["<table><tbody><tr>","</tr></tbody></table>",3],TD:["<table><tbody><tr><td>","</td></tr></tbody></table>",4],SELECT:["<select>","</select>",1]}};var tags=INSERTION_TRANSLATIONS.tags;Object.extend(tags,{THEAD:tags.TBODY,TFOOT:tags.TBODY,TH:tags.TD});function replace_IE(element,content){element=$(element);if(content&&content.toElement){content=content.toElement()}if(Object.isElement(content)){element.parentNode.replaceChild(content,element);return element}content=Object.toHTML(content);var parent=element.parentNode,tagName=parent.tagName.toUpperCase();if(tagName in INSERTION_TRANSLATIONS.tags){var nextSibling=Element.next(element);var fragments=getContentFromAnonymousElement(tagName,content.stripScripts());parent.removeChild(element);var iterator;if(nextSibling){iterator=function(node){parent.insertBefore(node,nextSibling)}}else{iterator=function(node){parent.appendChild(node)}}fragments.each(iterator)}else{element.outerHTML=content.stripScripts()}content.evalScripts.bind(content).defer();return element}if("outerHTML" in document.documentElement){replace=replace_IE}function isContent(content){if(Object.isUndefined(content)||content===null){return false}if(Object.isString(content)||Object.isNumber(content)){return true}if(Object.isElement(content)){return true}if(content.toElement||content.toHTML){return true}return false}function insertContentAt(element,content,position){position=position.toLowerCase();var method=INSERTION_TRANSLATIONS[position];if(content&&content.toElement){content=content.toElement()}if(Object.isElement(content)){method(element,content);return element}content=Object.toHTML(content);var tagName=((position==="before"||position==="after")?element.parentNode:element).tagName.toUpperCase();var childNodes=getContentFromAnonymousElement(tagName,content.stripScripts());if(position==="top"||position==="after"){childNodes.reverse()}for(var i=0,node;node=childNodes[i];i++){method(element,node)}content.evalScripts.bind(content).defer()}function insert(element,insertions){element=$(element);if(isContent(insertions)){insertions={bottom:insertions}}for(var position in insertions){insertContentAt(element,insertions[position],position)}return element}function wrap(element,wrapper,attributes){element=$(element);if(Object.isElement(wrapper)){$(wrapper).writeAttribute(attributes||{})}else{if(Object.isString(wrapper)){wrapper=new Element(wrapper,attributes)}else{wrapper=new Element("div",wrapper)}}if(element.parentNode){element.parentNode.replaceChild(wrapper,element)}wrapper.appendChild(element);return wrapper}function cleanWhitespace(element){element=$(element);var node=element.firstChild;while(node){var nextNode=node.nextSibling;if(node.nodeType===Node.TEXT_NODE&&!/\S/.test(node.nodeValue)){element.removeChild(node)}node=nextNode}return element}function empty(element){return $(element).innerHTML.blank()}function getContentFromAnonymousElement(tagName,html,force){var t=INSERTION_TRANSLATIONS.tags[tagName],div=DIV;var workaround=!!t;if(!workaround&&force){workaround=true;t=["","",0]}if(workaround){div.innerHTML="&#160;"+t[0]+html+t[1];div.removeChild(div.firstChild);for(var i=t[2];i--;){div=div.firstChild}}else{div.innerHTML=html}return $A(div.childNodes)}function clone(element,deep){if(!(element=$(element))){return}var clone=element.cloneNode(deep);if(!HAS_UNIQUE_ID_PROPERTY){clone._prototypeUID=UNDEFINED;if(deep){var descendants=Element.select(clone,"*"),i=descendants.length;while(i--){descendants[i]._prototypeUID=UNDEFINED}}}return Element.extend(clone)}function purgeElement(element){var uid=getUniqueElementID(element);if(uid){Element.stopObserving(element);if(!HAS_UNIQUE_ID_PROPERTY){element._prototypeUID=UNDEFINED}delete Element.Storage[uid]}}function purgeCollection(elements){var i=elements.length;while(i--){purgeElement(elements[i])}}function purgeCollection_IE(elements){var i=elements.length,element,uid;while(i--){element=elements[i];uid=getUniqueElementID(element);delete Element.Storage[uid];delete Event.cache[uid]}}if(HAS_UNIQUE_ID_PROPERTY){purgeCollection=purgeCollection_IE}function purge(element){if(!(element=$(element))){return}purgeElement(element);var descendants=element.getElementsByTagName("*"),i=descendants.length;while(i--){purgeElement(descendants[i])}return null}Object.extend(methods,{remove:remove,update:update,replace:replace,insert:insert,wrap:wrap,cleanWhitespace:cleanWhitespace,empty:empty,clone:clone,purge:purge});function recursivelyCollect(element,property,maximumLength){element=$(element);maximumLength=maximumLength||-1;var elements=[];while(element=element[property]){if(element.nodeType===Node.ELEMENT_NODE){elements.push(Element.extend(element))}if(elements.length===maximumLength){break}}return elements}function ancestors(element){return recursivelyCollect(element,"parentNode")}function descendants(element){return Element.select(element,"*")}function firstDescendant(element){element=$(element).firstChild;while(element&&element.nodeType!==Node.ELEMENT_NODE){element=element.nextSibling}return $(element)}function immediateDescendants(element){var results=[],child=$(element).firstChild;while(child){if(child.nodeType===Node.ELEMENT_NODE){results.push(Element.extend(child))}child=child.nextSibling}return results}function previousSiblings(element){return recursivelyCollect(element,"previousSibling")}function nextSiblings(element){return recursivelyCollect(element,"nextSibling")}function siblings(element){element=$(element);var previous=previousSiblings(element),next=nextSiblings(element);return previous.reverse().concat(next)}function match(element,selector){element=$(element);if(Object.isString(selector)){return Prototype.Selector.match(element,selector)}return selector.match(element)}function _recursivelyFind(element,property,expression,index){element=$(element),expression=expression||0,index=index||0;if(Object.isNumber(expression)){index=expression,expression=null}while(element=element[property]){if(element.nodeType!==1){continue}if(expression&&!Prototype.Selector.match(element,expression)){continue}if(--index>=0){continue}return Element.extend(element)}}function up(element,expression,index){element=$(element);if(arguments.length===1){return $(element.parentNode)}return _recursivelyFind(element,"parentNode",expression,index)}function down(element,expression,index){if(arguments.length===1){return firstDescendant(element)}element=$(element),expression=expression||0,index=index||0;if(Object.isNumber(expression)){index=expression,expression="*"}var node=Prototype.Selector.select(expression,element)[index];return Element.extend(node)}function previous(element,expression,index){return _recursivelyFind(element,"previousSibling",expression,index)}function next(element,expression,index){return _recursivelyFind(element,"nextSibling",expression,index)}function select(element){element=$(element);var expressions=SLICE.call(arguments,1).join(", ");return Prototype.Selector.select(expressions,element)}function adjacent(element){element=$(element);var expressions=SLICE.call(arguments,1).join(", ");var siblings=Element.siblings(element),results=[];for(var i=0,sibling;sibling=siblings[i];i++){if(Prototype.Selector.match(sibling,expressions)){results.push(sibling)}}return results}function descendantOf_DOM(element,ancestor){element=$(element),ancestor=$(ancestor);while(element=element.parentNode){if(element===ancestor){return true}}return false}function descendantOf_contains(element,ancestor){element=$(element),ancestor=$(ancestor);if(!ancestor.contains){return descendantOf_DOM(element,ancestor)}return ancestor.contains(element)&&ancestor!==element}function descendantOf_compareDocumentPosition(element,ancestor){element=$(element),ancestor=$(ancestor);return(element.compareDocumentPosition(ancestor)&8)===8}var descendantOf;if(DIV.compareDocumentPosition){descendantOf=descendantOf_compareDocumentPosition}else{if(DIV.contains){descendantOf=descendantOf_contains}else{descendantOf=descendantOf_DOM}}Object.extend(methods,{recursivelyCollect:recursivelyCollect,ancestors:ancestors,descendants:descendants,firstDescendant:firstDescendant,immediateDescendants:immediateDescendants,previousSiblings:previousSiblings,nextSiblings:nextSiblings,siblings:siblings,match:match,up:up,down:down,previous:previous,next:next,select:select,adjacent:adjacent,descendantOf:descendantOf,getElementsBySelector:select,childElements:immediateDescendants});var idCounter=1;function identify(element){element=$(element);var id=Element.readAttribute(element,"id");if(id){return id}do{id="anonymous_element_"+idCounter++}while($(id));Element.writeAttribute(element,"id",id);return id}function readAttribute(element,name){return $(element).getAttribute(name)}function readAttribute_IE(element,name){element=$(element);var table=ATTRIBUTE_TRANSLATIONS.read;if(table.values[name]){return table.values[name](element,name)}if(table.names[name]){name=table.names[name]}if(name.include(":")){if(!element.attributes||!element.attributes[name]){return null}return element.attributes[name].value}return element.getAttribute(name)}function readAttribute_Opera(element,name){if(name==="title"){return element.title}return element.getAttribute(name)}var PROBLEMATIC_ATTRIBUTE_READING=(function(){DIV.setAttribute("onclick",[]);var value=DIV.getAttribute("onclick");var isFunction=Object.isArray(value);DIV.removeAttribute("onclick");return isFunction})();if(PROBLEMATIC_ATTRIBUTE_READING){readAttribute=readAttribute_IE}else{if(Prototype.Browser.Opera){readAttribute=readAttribute_Opera}}function writeAttribute(element,name,value){element=$(element);var attributes={},table=ATTRIBUTE_TRANSLATIONS.write;if(typeof name==="object"){attributes=name}else{attributes[name]=Object.isUndefined(value)?true:value}for(var attr in attributes){name=table.names[attr]||attr;value=attributes[attr];if(table.values[attr]){name=table.values[attr](element,value)||name}if(value===false||value===null){element.removeAttribute(name)}else{if(value===true){element.setAttribute(name,name)}else{element.setAttribute(name,value)}}}return element}function hasAttribute(element,attribute){attribute=ATTRIBUTE_TRANSLATIONS.has[attribute]||attribute;var node=$(element).getAttributeNode(attribute);return !!(node&&node.specified)}GLOBAL.Element.Methods.Simulated.hasAttribute=hasAttribute;function classNames(element){return new Element.ClassNames(element)}var regExpCache={};function getRegExpForClassName(className){if(regExpCache[className]){return regExpCache[className]}var re=new RegExp("(^|\\s+)"+className+"(\\s+|$)");regExpCache[className]=re;return re}function hasClassName(element,className){if(!(element=$(element))){return}var elementClassName=element.className;if(elementClassName.length===0){return false}if(elementClassName===className){return true}return getRegExpForClassName(className).test(elementClassName)}function addClassName(element,className){if(!(element=$(element))){return}if(!hasClassName(element,className)){element.className+=(element.className?" ":"")+className}return element}function removeClassName(element,className){if(!(element=$(element))){return}element.className=element.className.replace(getRegExpForClassName(className)," ").strip();return element}function toggleClassName(element,className,bool){if(!(element=$(element))){return}if(Object.isUndefined(bool)){bool=!hasClassName(element,className)}var method=Element[bool?"addClassName":"removeClassName"];return method(element,className)}var ATTRIBUTE_TRANSLATIONS={};var classProp="className",forProp="for";DIV.setAttribute(classProp,"x");if(DIV.className!=="x"){DIV.setAttribute("class","x");if(DIV.className==="x"){classProp="class"}}var LABEL=document.createElement("label");LABEL.setAttribute(forProp,"x");if(LABEL.htmlFor!=="x"){LABEL.setAttribute("htmlFor","x");if(LABEL.htmlFor==="x"){forProp="htmlFor"}}LABEL=null;function _getAttr(element,attribute){return element.getAttribute(attribute)}function _getAttr2(element,attribute){return element.getAttribute(attribute,2)}function _getAttrNode(element,attribute){var node=element.getAttributeNode(attribute);return node?node.value:""}function _getFlag(element,attribute){return $(element).hasAttribute(attribute)?attribute:null}DIV.onclick=Prototype.emptyFunction;var onclickValue=DIV.getAttribute("onclick");var _getEv;if(String(onclickValue).indexOf("{")>-1){_getEv=function(element,attribute){var value=element.getAttribute(attribute);if(!value){return null}value=value.toString();value=value.split("{")[1];value=value.split("}")[0];return value.strip()}}else{if(onclickValue===""){_getEv=function(element,attribute){var value=element.getAttribute(attribute);if(!value){return null}return value.strip()}}}ATTRIBUTE_TRANSLATIONS.read={names:{"class":classProp,className:classProp,"for":forProp,htmlFor:forProp},values:{style:function(element){return element.style.cssText.toLowerCase()},title:function(element){return element.title}}};ATTRIBUTE_TRANSLATIONS.write={names:{className:"class",htmlFor:"for",cellpadding:"cellPadding",cellspacing:"cellSpacing"},values:{checked:function(element,value){element.checked=!!value},style:function(element,value){element.style.cssText=value?value:""}}};ATTRIBUTE_TRANSLATIONS.has={names:{}};Object.extend(ATTRIBUTE_TRANSLATIONS.write.names,ATTRIBUTE_TRANSLATIONS.read.names);var CAMEL_CASED_ATTRIBUTE_NAMES=$w("colSpan rowSpan vAlign dateTime accessKey tabIndex encType maxLength readOnly longDesc frameBorder");for(var i=0,attr;attr=CAMEL_CASED_ATTRIBUTE_NAMES[i];i++){ATTRIBUTE_TRANSLATIONS.write.names[attr.toLowerCase()]=attr;ATTRIBUTE_TRANSLATIONS.has.names[attr.toLowerCase()]=attr}Object.extend(ATTRIBUTE_TRANSLATIONS.read.values,{href:_getAttr2,src:_getAttr2,type:_getAttr,action:_getAttrNode,disabled:_getFlag,checked:_getFlag,readonly:_getFlag,multiple:_getFlag,onload:_getEv,onunload:_getEv,onclick:_getEv,ondblclick:_getEv,onmousedown:_getEv,onmouseup:_getEv,onmouseover:_getEv,onmousemove:_getEv,onmouseout:_getEv,onfocus:_getEv,onblur:_getEv,onkeypress:_getEv,onkeydown:_getEv,onkeyup:_getEv,onsubmit:_getEv,onreset:_getEv,onselect:_getEv,onchange:_getEv});Object.extend(methods,{identify:identify,readAttribute:readAttribute,writeAttribute:writeAttribute,classNames:classNames,hasClassName:hasClassName,addClassName:addClassName,removeClassName:removeClassName,toggleClassName:toggleClassName});function normalizeStyleName(style){if(style==="float"||style==="styleFloat"){return"cssFloat"}return style.camelize()}function normalizeStyleName_IE(style){if(style==="float"||style==="cssFloat"){return"styleFloat"}return style.camelize()}function setStyle(element,styles){element=$(element);var elementStyle=element.style,match;if(Object.isString(styles)){elementStyle.cssText+=";"+styles;if(styles.include("opacity")){var opacity=styles.match(/opacity:\s*(\d?\.?\d*)/)[1];Element.setOpacity(element,opacity)}return element}for(var property in styles){if(property==="opacity"){Element.setOpacity(element,styles[property])}else{var value=styles[property];if(property==="float"||property==="cssFloat"){property=Object.isUndefined(elementStyle.styleFloat)?"cssFloat":"styleFloat"}elementStyle[property]=value}}return element}function getStyle(element,style){element=$(element);style=normalizeStyleName(style);var value=element.style[style];if(!value||value==="auto"){var css=document.defaultView.getComputedStyle(element,null);value=css?css[style]:null}if(style==="opacity"){return value?parseFloat(value):1}return value==="auto"?null:value}function getStyle_Opera(element,style){switch(style){case"height":case"width":if(!Element.visible(element)){return null}var dim=parseInt(getStyle(element,style),10);if(dim!==element["offset"+style.capitalize()]){return dim+"px"}return Element.measure(element,style);default:return getStyle(element,style)}}function getStyle_IE(element,style){element=$(element);style=normalizeStyleName_IE(style);var value=element.style[style];if(!value&&element.currentStyle){value=element.currentStyle[style]}if(style==="opacity"&&!STANDARD_CSS_OPACITY_SUPPORTED){return getOpacity_IE(element)}if(value==="auto"){if((style==="width"||style==="height")&&Element.visible(element)){return Element.measure(element,style)+"px"}return null}return value}function stripAlphaFromFilter_IE(filter){return(filter||"").replace(/alpha\([^\)]*\)/gi,"")}function hasLayout_IE(element){if(!element.currentStyle||!element.currentStyle.hasLayout){element.style.zoom=1}return element}var STANDARD_CSS_OPACITY_SUPPORTED=(function(){DIV.style.cssText="opacity:.55";return/^0.55/.test(DIV.style.opacity)})();function setOpacity(element,value){element=$(element);if(value==1||value===""){value=""}else{if(value<0.00001){value=0}}element.style.opacity=value;return element}function setOpacity_IE(element,value){if(STANDARD_CSS_OPACITY_SUPPORTED){return setOpacity(element,value)}element=hasLayout_IE($(element));var filter=Element.getStyle(element,"filter"),style=element.style;if(value==1||value===""){filter=stripAlphaFromFilter_IE(filter);if(filter){style.filter=filter}else{style.removeAttribute("filter")}return element}if(value<0.00001){value=0}style.filter=stripAlphaFromFilter_IE(filter)+"alpha(opacity="+(value*100)+")";return element}function getOpacity(element){return Element.getStyle(element,"opacity")}function getOpacity_IE(element){if(STANDARD_CSS_OPACITY_SUPPORTED){return getOpacity(element)}var filter=Element.getStyle(element,"filter");if(filter.length===0){return 1}var match=(filter||"").match(/alpha\(opacity=(.*)\)/);if(match&&match[1]){return parseFloat(match[1])/100}return 1}Object.extend(methods,{setStyle:setStyle,getStyle:getStyle,setOpacity:setOpacity,getOpacity:getOpacity});if("styleFloat" in DIV.style){methods.getStyle=getStyle_IE;methods.setOpacity=setOpacity_IE;methods.getOpacity=getOpacity_IE}var UID=0;GLOBAL.Element.Storage={UID:1};function getUniqueElementID(element){if(element===window){return 0}if(typeof element._prototypeUID==="undefined"){element._prototypeUID=Element.Storage.UID++}return element._prototypeUID}function getUniqueElementID_IE(element){if(element===window){return 0}if(element==document){return 1}return element.uniqueID}var HAS_UNIQUE_ID_PROPERTY=("uniqueID" in DIV);if(HAS_UNIQUE_ID_PROPERTY){getUniqueElementID=getUniqueElementID_IE}function getStorage(element){if(!(element=$(element))){return}var uid=getUniqueElementID(element);if(!Element.Storage[uid]){Element.Storage[uid]=$H()}return Element.Storage[uid]}function store(element,key,value){if(!(element=$(element))){return}var storage=getStorage(element);if(arguments.length===2){storage.update(key)}else{storage.set(key,value)}return element}function retrieve(element,key,defaultValue){if(!(element=$(element))){return}var storage=getStorage(element),value=storage.get(key);if(Object.isUndefined(value)){storage.set(key,defaultValue);value=defaultValue}return value}Object.extend(methods,{getStorage:getStorage,store:store,retrieve:retrieve});var Methods={},ByTag=Element.Methods.ByTag,F=Prototype.BrowserFeatures;if(!F.ElementExtensions&&("__proto__" in DIV)){GLOBAL.HTMLElement={};GLOBAL.HTMLElement.prototype=DIV.__proto__;F.ElementExtensions=true}function checkElementPrototypeDeficiency(tagName){if(typeof window.Element==="undefined"){return false}var proto=window.Element.prototype;if(proto){var id="_"+(Math.random()+"").slice(2),el=document.createElement(tagName);proto[id]="x";var isBuggy=(el[id]!=="x");delete proto[id];el=null;return isBuggy}return false}var HTMLOBJECTELEMENT_PROTOTYPE_BUGGY=checkElementPrototypeDeficiency("object");function extendElementWith(element,methods){for(var property in methods){var value=methods[property];if(Object.isFunction(value)&&!(property in element)){element[property]=value.methodize()}}}var EXTENDED={};function elementIsExtended(element){var uid=getUniqueElementID(element);return(uid in EXTENDED)}function extend(element){if(!element||elementIsExtended(element)){return element}if(element.nodeType!==Node.ELEMENT_NODE||element==window){return element}var methods=Object.clone(Methods),tagName=element.tagName.toUpperCase();if(ByTag[tagName]){Object.extend(methods,ByTag[tagName])}extendElementWith(element,methods);EXTENDED[getUniqueElementID(element)]=true;return element}function extend_IE8(element){if(!element||elementIsExtended(element)){return element}var t=element.tagName;if(t&&(/^(?:object|applet|embed)$/i.test(t))){extendElementWith(element,Element.Methods);extendElementWith(element,Element.Methods.Simulated);extendElementWith(element,Element.Methods.ByTag[t.toUpperCase()])}return element}if(F.SpecificElementExtensions){extend=HTMLOBJECTELEMENT_PROTOTYPE_BUGGY?extend_IE8:Prototype.K}function addMethodsToTagName(tagName,methods){tagName=tagName.toUpperCase();if(!ByTag[tagName]){ByTag[tagName]={}}Object.extend(ByTag[tagName],methods)}function mergeMethods(destination,methods,onlyIfAbsent){if(Object.isUndefined(onlyIfAbsent)){onlyIfAbsent=false}for(var property in methods){var value=methods[property];if(!Object.isFunction(value)){continue}if(!onlyIfAbsent||!(property in destination)){destination[property]=value.methodize()}}}function findDOMClass(tagName){var klass;var trans={OPTGROUP:"OptGroup",TEXTAREA:"TextArea",P:"Paragraph",FIELDSET:"FieldSet",UL:"UList",OL:"OList",DL:"DList",DIR:"Directory",H1:"Heading",H2:"Heading",H3:"Heading",H4:"Heading",H5:"Heading",H6:"Heading",Q:"Quote",INS:"Mod",DEL:"Mod",A:"Anchor",IMG:"Image",CAPTION:"TableCaption",COL:"TableCol",COLGROUP:"TableCol",THEAD:"TableSection",TFOOT:"TableSection",TBODY:"TableSection",TR:"TableRow",TH:"TableCell",TD:"TableCell",FRAMESET:"FrameSet",IFRAME:"IFrame"};if(trans[tagName]){klass="HTML"+trans[tagName]+"Element"}if(window[klass]){return window[klass]}klass="HTML"+tagName+"Element";if(window[klass]){return window[klass]}klass="HTML"+tagName.capitalize()+"Element";if(window[klass]){return window[klass]}var element=document.createElement(tagName),proto=element.__proto__||element.constructor.prototype;element=null;return proto}function addMethods(methods){if(arguments.length===0){addFormMethods()}if(arguments.length===2){var tagName=methods;methods=arguments[1]}if(!tagName){Object.extend(Element.Methods,methods||{})}else{if(Object.isArray(tagName)){for(var i=0,tag;tag=tagName[i];i++){addMethodsToTagName(tag,methods)}}else{addMethodsToTagName(tagName,methods)}}var ELEMENT_PROTOTYPE=window.HTMLElement?HTMLElement.prototype:Element.prototype;if(F.ElementExtensions){mergeMethods(ELEMENT_PROTOTYPE,Element.Methods);mergeMethods(ELEMENT_PROTOTYPE,Element.Methods.Simulated,true)}if(F.SpecificElementExtensions){for(var tag in Element.Methods.ByTag){var klass=findDOMClass(tag);if(Object.isUndefined(klass)){continue}mergeMethods(klass.prototype,ByTag[tag])}}Object.extend(Element,Element.Methods);Object.extend(Element,Element.Methods.Simulated);delete Element.ByTag;delete Element.Simulated;Element.extend.refresh();ELEMENT_CACHE={}}Object.extend(GLOBAL.Element,{extend:extend,addMethods:addMethods});if(extend===Prototype.K){GLOBAL.Element.extend.refresh=Prototype.emptyFunction}else{GLOBAL.Element.extend.refresh=function(){if(Prototype.BrowserFeatures.ElementExtensions){return}Object.extend(Methods,Element.Methods);Object.extend(Methods,Element.Methods.Simulated);EXTENDED={}}}function addFormMethods(){Object.extend(Form,Form.Methods);Object.extend(Form.Element,Form.Element.Methods);Object.extend(Element.Methods.ByTag,{FORM:Object.clone(Form.Methods),INPUT:Object.clone(Form.Element.Methods),SELECT:Object.clone(Form.Element.Methods),TEXTAREA:Object.clone(Form.Element.Methods),BUTTON:Object.clone(Form.Element.Methods)})}Element.addMethods(methods);function destroyCache_IE(){DIV=null;ELEMENT_CACHE=null}if(window.attachEvent){window.attachEvent("onunload",destroyCache_IE)}})(this);(function(){function toDecimal(pctString){var match=pctString.match(/^(\d+)%?$/i);if(!match){return null}return(Number(match[1])/100)}function getRawStyle(element,style){element=$(element);var value=element.style[style];if(!value||value==="auto"){var css=document.defaultView.getComputedStyle(element,null);value=css?css[style]:null}if(style==="opacity"){return value?parseFloat(value):1}return value==="auto"?null:value}function getRawStyle_IE(element,style){var value=element.style[style];if(!value&&element.currentStyle){value=element.currentStyle[style]}return value}function getContentWidth(element,context){var boxWidth=element.offsetWidth;var bl=getPixelValue(element,"borderLeftWidth",context)||0;var br=getPixelValue(element,"borderRightWidth",context)||0;var pl=getPixelValue(element,"paddingLeft",context)||0;var pr=getPixelValue(element,"paddingRight",context)||0;return boxWidth-bl-br-pl-pr}if("currentStyle" in document.documentElement){getRawStyle=getRawStyle_IE}function getPixelValue(value,property,context){var element=null;if(Object.isElement(value)){element=value;value=getRawStyle(element,property)}if(value===null||Object.isUndefined(value)){return null}if((/^(?:-)?\d+(\.\d+)?(px)?$/i).test(value)){return window.parseFloat(value)}var isPercentage=value.include("%"),isViewport=(context===document.viewport);if(/\d/.test(value)&&element&&element.runtimeStyle&&!(isPercentage&&isViewport)){var style=element.style.left,rStyle=element.runtimeStyle.left;element.runtimeStyle.left=element.currentStyle.left;element.style.left=value||0;value=element.style.pixelLeft;element.style.left=style;element.runtimeStyle.left=rStyle;return value}if(element&&isPercentage){context=context||element.parentNode;var decimal=toDecimal(value),whole=null;var isHorizontal=property.include("left")||property.include("right")||property.include("width");var isVertical=property.include("top")||property.include("bottom")||property.include("height");if(context===document.viewport){if(isHorizontal){whole=document.viewport.getWidth()}else{if(isVertical){whole=document.viewport.getHeight()}}}else{if(isHorizontal){whole=$(context).measure("width")}else{if(isVertical){whole=$(context).measure("height")}}}return(whole===null)?0:whole*decimal}return 0}function toCSSPixels(number){if(Object.isString(number)&&number.endsWith("px")){return number}return number+"px"}function isDisplayed(element){while(element&&element.parentNode){var display=element.getStyle("display");if(display==="none"){return false}element=$(element.parentNode)}return true}var hasLayout=Prototype.K;if("currentStyle" in document.documentElement){hasLayout=function(element){if(!element.currentStyle.hasLayout){element.style.zoom=1}return element}}function cssNameFor(key){if(key.include("border")){key=key+"-width"}return key.camelize()}Element.Layout=Class.create(Hash,{initialize:function($super,element,preCompute){$super();this.element=$(element);Element.Layout.PROPERTIES.each(function(property){this._set(property,null)},this);if(preCompute){this._preComputing=true;this._begin();Element.Layout.PROPERTIES.each(this._compute,this);this._end();this._preComputing=false}},_set:function(property,value){return Hash.prototype.set.call(this,property,value)},set:function(property,value){throw"Properties of Element.Layout are read-only."},get:function($super,property){var value=$super(property);return value===null?this._compute(property):value},_begin:function(){if(this._isPrepared()){return}var element=this.element;if(isDisplayed(element)){this._setPrepared(true);return}var originalStyles={position:element.style.position||"",width:element.style.width||"",visibility:element.style.visibility||"",display:element.style.display||""};element.store("prototype_original_styles",originalStyles);var position=getRawStyle(element,"position"),width=element.offsetWidth;if(width===0||width===null){element.style.display="block";width=element.offsetWidth}var context=(position==="fixed")?document.viewport:element.parentNode;var tempStyles={visibility:"hidden",display:"block"};if(position!=="fixed"){tempStyles.position="absolute"}element.setStyle(tempStyles);var positionedWidth=element.offsetWidth,newWidth;if(width&&(positionedWidth===width)){newWidth=getContentWidth(element,context)}else{if(position==="absolute"||position==="fixed"){newWidth=getContentWidth(element,context)}else{var parent=element.parentNode,pLayout=$(parent).getLayout();newWidth=pLayout.get("width")-this.get("margin-left")-this.get("border-left")-this.get("padding-left")-this.get("padding-right")-this.get("border-right")-this.get("margin-right")}}element.setStyle({width:newWidth+"px"});this._setPrepared(true)},_end:function(){var element=this.element;var originalStyles=element.retrieve("prototype_original_styles");element.store("prototype_original_styles",null);element.setStyle(originalStyles);this._setPrepared(false)},_compute:function(property){var COMPUTATIONS=Element.Layout.COMPUTATIONS;if(!(property in COMPUTATIONS)){throw"Property not found."}return this._set(property,COMPUTATIONS[property].call(this,this.element))},_isPrepared:function(){return this.element.retrieve("prototype_element_layout_prepared",false)},_setPrepared:function(bool){return this.element.store("prototype_element_layout_prepared",bool)},toObject:function(){var args=$A(arguments);var keys=(args.length===0)?Element.Layout.PROPERTIES:args.join(" ").split(" ");var obj={};keys.each(function(key){if(!Element.Layout.PROPERTIES.include(key)){return}var value=this.get(key);if(value!=null){obj[key]=value}},this);return obj},toHash:function(){var obj=this.toObject.apply(this,arguments);return new Hash(obj)},toCSS:function(){var args=$A(arguments);var keys=(args.length===0)?Element.Layout.PROPERTIES:args.join(" ").split(" ");var css={};keys.each(function(key){if(!Element.Layout.PROPERTIES.include(key)){return}if(Element.Layout.COMPOSITE_PROPERTIES.include(key)){return}var value=this.get(key);if(value!=null){css[cssNameFor(key)]=value+"px"}},this);return css},inspect:function(){return"#<Element.Layout>"}});Object.extend(Element.Layout,{PROPERTIES:$w("height width top left right bottom border-left border-right border-top border-bottom padding-left padding-right padding-top padding-bottom margin-top margin-bottom margin-left margin-right padding-box-width padding-box-height border-box-width border-box-height margin-box-width margin-box-height"),COMPOSITE_PROPERTIES:$w("padding-box-width padding-box-height margin-box-width margin-box-height border-box-width border-box-height"),COMPUTATIONS:{height:function(element){if(!this._preComputing){this._begin()}var bHeight=this.get("border-box-height");if(bHeight<=0){if(!this._preComputing){this._end()}return 0}var bTop=this.get("border-top"),bBottom=this.get("border-bottom");var pTop=this.get("padding-top"),pBottom=this.get("padding-bottom");if(!this._preComputing){this._end()}return bHeight-bTop-bBottom-pTop-pBottom},width:function(element){if(!this._preComputing){this._begin()}var bWidth=this.get("border-box-width");if(bWidth<=0){if(!this._preComputing){this._end()}return 0}var bLeft=this.get("border-left"),bRight=this.get("border-right");var pLeft=this.get("padding-left"),pRight=this.get("padding-right");if(!this._preComputing){this._end()}return bWidth-bLeft-bRight-pLeft-pRight},"padding-box-height":function(element){var height=this.get("height"),pTop=this.get("padding-top"),pBottom=this.get("padding-bottom");return height+pTop+pBottom},"padding-box-width":function(element){var width=this.get("width"),pLeft=this.get("padding-left"),pRight=this.get("padding-right");return width+pLeft+pRight},"border-box-height":function(element){if(!this._preComputing){this._begin()}var height=element.offsetHeight;if(!this._preComputing){this._end()}return height},"border-box-width":function(element){if(!this._preComputing){this._begin()}var width=element.offsetWidth;if(!this._preComputing){this._end()}return width},"margin-box-height":function(element){var bHeight=this.get("border-box-height"),mTop=this.get("margin-top"),mBottom=this.get("margin-bottom");if(bHeight<=0){return 0}return bHeight+mTop+mBottom},"margin-box-width":function(element){var bWidth=this.get("border-box-width"),mLeft=this.get("margin-left"),mRight=this.get("margin-right");if(bWidth<=0){return 0}return bWidth+mLeft+mRight},top:function(element){var offset=element.positionedOffset();return offset.top},bottom:function(element){var offset=element.positionedOffset(),parent=element.getOffsetParent(),pHeight=parent.measure("height");var mHeight=this.get("border-box-height");return pHeight-mHeight-offset.top},left:function(element){var offset=element.positionedOffset();return offset.left},right:function(element){var offset=element.positionedOffset(),parent=element.getOffsetParent(),pWidth=parent.measure("width");var mWidth=this.get("border-box-width");return pWidth-mWidth-offset.left},"padding-top":function(element){return getPixelValue(element,"paddingTop")},"padding-bottom":function(element){return getPixelValue(element,"paddingBottom")},"padding-left":function(element){return getPixelValue(element,"paddingLeft")},"padding-right":function(element){return getPixelValue(element,"paddingRight")},"border-top":function(element){return getPixelValue(element,"borderTopWidth")},"border-bottom":function(element){return getPixelValue(element,"borderBottomWidth")},"border-left":function(element){return getPixelValue(element,"borderLeftWidth")},"border-right":function(element){return getPixelValue(element,"borderRightWidth")},"margin-top":function(element){return getPixelValue(element,"marginTop")},"margin-bottom":function(element){return getPixelValue(element,"marginBottom")},"margin-left":function(element){return getPixelValue(element,"marginLeft")},"margin-right":function(element){return getPixelValue(element,"marginRight")}}});if("getBoundingClientRect" in document.documentElement){Object.extend(Element.Layout.COMPUTATIONS,{right:function(element){var parent=hasLayout(element.getOffsetParent());var rect=element.getBoundingClientRect(),pRect=parent.getBoundingClientRect();return(pRect.right-rect.right).round()},bottom:function(element){var parent=hasLayout(element.getOffsetParent());var rect=element.getBoundingClientRect(),pRect=parent.getBoundingClientRect();return(pRect.bottom-rect.bottom).round()}})}Element.Offset=Class.create({initialize:function(left,top){this.left=left.round();this.top=top.round();this[0]=this.left;this[1]=this.top},relativeTo:function(offset){return new Element.Offset(this.left-offset.left,this.top-offset.top)},inspect:function(){return"#<Element.Offset left: #{left} top: #{top}>".interpolate(this)},toString:function(){return"[#{left}, #{top}]".interpolate(this)},toArray:function(){return[this.left,this.top]}});function getLayout(element,preCompute){return new Element.Layout(element,preCompute)}function measure(element,property){return $(element).getLayout().get(property)}function getHeight(element){return Element.getDimensions(element).height}function getWidth(element){return Element.getDimensions(element).width}function getDimensions(element){element=$(element);var display=Element.getStyle(element,"display");if(display&&display!=="none"){return{width:element.offsetWidth,height:element.offsetHeight}}var style=element.style;var originalStyles={visibility:style.visibility,position:style.position,display:style.display};var newStyles={visibility:"hidden",display:"block"};if(originalStyles.position!=="fixed"){newStyles.position="absolute"}Element.setStyle(element,newStyles);var dimensions={width:element.offsetWidth,height:element.offsetHeight};Element.setStyle(element,originalStyles);return dimensions}function getOffsetParent(element){element=$(element);if(isDocument(element)||isDetached(element)||isBody(element)||isHtml(element)){return $(document.body)}var isInline=(Element.getStyle(element,"display")==="inline");if(!isInline&&element.offsetParent){return $(element.offsetParent)}while((element=element.parentNode)&&element!==document.body){if(Element.getStyle(element,"position")!=="static"){return isHtml(element)?$(document.body):$(element)}}return $(document.body)}function cumulativeOffset(element){element=$(element);var valueT=0,valueL=0;if(element.parentNode){do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;element=element.offsetParent}while(element)}return new Element.Offset(valueL,valueT)}function positionedOffset(element){element=$(element);var layout=element.getLayout();var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;element=element.offsetParent;if(element){if(isBody(element)){break}var p=Element.getStyle(element,"position");if(p!=="static"){break}}}while(element);valueL-=layout.get("margin-top");valueT-=layout.get("margin-left");return new Element.Offset(valueL,valueT)}function cumulativeScrollOffset(element){var valueT=0,valueL=0;do{if(element===document.body){var bodyScrollNode=document.documentElement||document.body.parentNode||document.body;valueT+=!Object.isUndefined(window.pageYOffset)?window.pageYOffset:bodyScrollNode.scrollTop||0;valueL+=!Object.isUndefined(window.pageXOffset)?window.pageXOffset:bodyScrollNode.scrollLeft||0;break}else{valueT+=element.scrollTop||0;valueL+=element.scrollLeft||0;element=element.parentNode}}while(element);return new Element.Offset(valueL,valueT)}function viewportOffset(forElement){var valueT=0,valueL=0,docBody=document.body;forElement=$(forElement);var element=forElement;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;if(element.offsetParent==docBody&&Element.getStyle(element,"position")=="absolute"){break}}while(element=element.offsetParent);element=forElement;do{if(element!=docBody){valueT-=element.scrollTop||0;valueL-=element.scrollLeft||0}}while(element=element.parentNode);return new Element.Offset(valueL,valueT)}function absolutize(element){element=$(element);if(Element.getStyle(element,"position")==="absolute"){return element}var offsetParent=getOffsetParent(element);var eOffset=element.viewportOffset(),pOffset=offsetParent.viewportOffset();var offset=eOffset.relativeTo(pOffset);var layout=element.getLayout();element.store("prototype_absolutize_original_styles",{position:element.getStyle("position"),left:element.getStyle("left"),top:element.getStyle("top"),width:element.getStyle("width"),height:element.getStyle("height")});element.setStyle({position:"absolute",top:offset.top+"px",left:offset.left+"px",width:layout.get("width")+"px",height:layout.get("height")+"px"});return element}function relativize(element){element=$(element);if(Element.getStyle(element,"position")==="relative"){return element}var originalStyles=element.retrieve("prototype_absolutize_original_styles");if(originalStyles){element.setStyle(originalStyles)}return element}function scrollTo(element){element=$(element);var pos=Element.cumulativeOffset(element);window.scrollTo(pos.left,pos.top);return element}function makePositioned(element){element=$(element);var position=Element.getStyle(element,"position"),styles={};if(position==="static"||!position){styles.position="relative";if(Prototype.Browser.Opera){styles.top=0;styles.left=0}Element.setStyle(element,styles);Element.store(element,"prototype_made_positioned",true)}return element}function undoPositioned(element){element=$(element);var storage=Element.getStorage(element),madePositioned=storage.get("prototype_made_positioned");if(madePositioned){storage.unset("prototype_made_positioned");Element.setStyle(element,{position:"",top:"",bottom:"",left:"",right:""})}return element}function makeClipping(element){element=$(element);var storage=Element.getStorage(element),madeClipping=storage.get("prototype_made_clipping");if(Object.isUndefined(madeClipping)){var overflow=Element.getStyle(element,"overflow");storage.set("prototype_made_clipping",overflow);if(overflow!=="hidden"){element.style.overflow="hidden"}}return element}function undoClipping(element){element=$(element);var storage=Element.getStorage(element),overflow=storage.get("prototype_made_clipping");if(!Object.isUndefined(overflow)){storage.unset("prototype_made_clipping");element.style.overflow=overflow||""}return element}function clonePosition(element,source,options){options=Object.extend({setLeft:true,setTop:true,setWidth:true,setHeight:true,offsetTop:0,offsetLeft:0},options||{});source=$(source);element=$(element);var p,delta,layout,styles={};if(options.setLeft||options.setTop){p=Element.viewportOffset(source);delta=[0,0];if(Element.getStyle(element,"position")==="absolute"){var parent=Element.getOffsetParent(element);if(parent!==document.body){delta=Element.viewportOffset(parent)}}}if(options.setWidth||options.setHeight){layout=Element.getLayout(source)}if(options.setLeft){styles.left=(p[0]-delta[0]+options.offsetLeft)+"px"}if(options.setTop){styles.top=(p[1]-delta[1]+options.offsetTop)+"px"}if(options.setWidth){styles.width=layout.get("border-box-width")+"px"}if(options.setHeight){styles.height=layout.get("border-box-height")+"px"}return Element.setStyle(element,styles)}if(Prototype.Browser.IE){getOffsetParent=getOffsetParent.wrap(function(proceed,element){element=$(element);if(isDocument(element)||isDetached(element)||isBody(element)||isHtml(element)){return $(document.body)}var position=element.getStyle("position");if(position!=="static"){return proceed(element)}element.setStyle({position:"relative"});var value=proceed(element);element.setStyle({position:position});return value});positionedOffset=positionedOffset.wrap(function(proceed,element){element=$(element);if(!element.parentNode){return new Element.Offset(0,0)}var position=element.getStyle("position");if(position!=="static"){return proceed(element)}var offsetParent=element.getOffsetParent();if(offsetParent&&offsetParent.getStyle("position")==="fixed"){hasLayout(offsetParent)}element.setStyle({position:"relative"});var value=proceed(element);element.setStyle({position:position});return value})}else{if(Prototype.Browser.Webkit){cumulativeOffset=function(element){element=$(element);var valueT=0,valueL=0;do{valueT+=element.offsetTop||0;valueL+=element.offsetLeft||0;if(element.offsetParent==document.body){if(Element.getStyle(element,"position")=="absolute"){break}}element=element.offsetParent}while(element);return new Element.Offset(valueL,valueT)}}}Element.addMethods({getLayout:getLayout,measure:measure,getWidth:getWidth,getHeight:getHeight,getDimensions:getDimensions,getOffsetParent:getOffsetParent,cumulativeOffset:cumulativeOffset,positionedOffset:positionedOffset,cumulativeScrollOffset:cumulativeScrollOffset,viewportOffset:viewportOffset,absolutize:absolutize,relativize:relativize,scrollTo:scrollTo,makePositioned:makePositioned,undoPositioned:undoPositioned,makeClipping:makeClipping,undoClipping:undoClipping,clonePosition:clonePosition});function isBody(element){return element.nodeName.toUpperCase()==="BODY"}function isHtml(element){return element.nodeName.toUpperCase()==="HTML"}function isDocument(element){return element.nodeType===Node.DOCUMENT_NODE}function isDetached(element){return element!==document.body&&!Element.descendantOf(element,document.body)}if("getBoundingClientRect" in document.documentElement){Element.addMethods({viewportOffset:function(element){element=$(element);if(isDetached(element)){return new Element.Offset(0,0)}var rect=element.getBoundingClientRect(),docEl=document.documentElement;return new Element.Offset(rect.left-docEl.clientLeft,rect.top-docEl.clientTop)}})}})();(function(){var IS_OLD_OPERA=Prototype.Browser.Opera&&(window.parseFloat(window.opera.version())<9.5);var ROOT=null;function getRootElement(){if(ROOT){return ROOT}ROOT=IS_OLD_OPERA?document.body:document.documentElement;return ROOT}function getDimensions(){return{width:this.getWidth(),height:this.getHeight()}}function getWidth(){return getRootElement().clientWidth}function getHeight(){return getRootElement().clientHeight}function getScrollOffsets(){var x=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft;var y=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop;return new Element.Offset(x,y)}document.viewport={getDimensions:getDimensions,getWidth:getWidth,getHeight:getHeight,getScrollOffsets:getScrollOffsets}})();window.$$=function(){var expression=$A(arguments).join(", ");return Prototype.Selector.select(expression,document)};Prototype.Selector=(function(){function select(){throw new Error('Method "Prototype.Selector.select" must be defined.')}function match(){throw new Error('Method "Prototype.Selector.match" must be defined.')}function find(elements,expression,index){index=index||0;var match=Prototype.Selector.match,length=elements.length,matchIndex=0,i;for(i=0;i<length;i++){if(match(elements[i],expression)&&index==matchIndex++){return Element.extend(elements[i])}}}function extendElements(elements){for(var i=0,length=elements.length;i<length;i++){Element.extend(elements[i])}return elements}var K=Prototype.K;return{select:select,match:match,find:find,extendElements:(Element.extend===K)?K:extendElements,extendElement:Element.extend}})();
/*!
 * Sizzle CSS Selector Engine
 *  Copyright 2011, The Dojo Foundation
 *  Released under the MIT, BSD, and GPL Licenses.
 *  More information: http://sizzlejs.com/
 */
(function(){var chunker=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,done=0,toString=Object.prototype.toString,hasDuplicate=false,baseHasDuplicate=true,rBackslash=/\\/g,rNonWord=/\W/;[0,0].sort(function(){baseHasDuplicate=false;return 0});var Sizzle=function(selector,context,results,seed){results=results||[];context=context||document;var origContext=context;if(context.nodeType!==1&&context.nodeType!==9){return[]}if(!selector||typeof selector!=="string"){return results}var m,set,checkSet,extra,ret,cur,pop,i,prune=true,contextXML=Sizzle.isXML(context),parts=[],soFar=selector;do{chunker.exec("");m=chunker.exec(soFar);if(m){soFar=m[3];parts.push(m[1]);if(m[2]){extra=m[3];break}}}while(m);if(parts.length>1&&origPOS.exec(selector)){if(parts.length===2&&Expr.relative[parts[0]]){set=posProcess(parts[0]+parts[1],context)}else{set=Expr.relative[parts[0]]?[context]:Sizzle(parts.shift(),context);while(parts.length){selector=parts.shift();if(Expr.relative[selector]){selector+=parts.shift()}set=posProcess(selector,set)}}}else{if(!seed&&parts.length>1&&context.nodeType===9&&!contextXML&&Expr.match.ID.test(parts[0])&&!Expr.match.ID.test(parts[parts.length-1])){ret=Sizzle.find(parts.shift(),context,contextXML);context=ret.expr?Sizzle.filter(ret.expr,ret.set)[0]:ret.set[0]}if(context){ret=seed?{expr:parts.pop(),set:makeArray(seed)}:Sizzle.find(parts.pop(),parts.length===1&&(parts[0]==="~"||parts[0]==="+")&&context.parentNode?context.parentNode:context,contextXML);set=ret.expr?Sizzle.filter(ret.expr,ret.set):ret.set;if(parts.length>0){checkSet=makeArray(set)}else{prune=false}while(parts.length){cur=parts.pop();pop=cur;if(!Expr.relative[cur]){cur=""}else{pop=parts.pop()}if(pop==null){pop=context}Expr.relative[cur](checkSet,pop,contextXML)}}else{checkSet=parts=[]}}if(!checkSet){checkSet=set}if(!checkSet){Sizzle.error(cur||selector)}if(toString.call(checkSet)==="[object Array]"){if(!prune){results.push.apply(results,checkSet)}else{if(context&&context.nodeType===1){for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&(checkSet[i]===true||checkSet[i].nodeType===1&&Sizzle.contains(context,checkSet[i]))){results.push(set[i])}}}else{for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&checkSet[i].nodeType===1){results.push(set[i])}}}}}else{makeArray(checkSet,results)}if(extra){Sizzle(extra,origContext,results,seed);Sizzle.uniqueSort(results)}return results};Sizzle.uniqueSort=function(results){if(sortOrder){hasDuplicate=baseHasDuplicate;results.sort(sortOrder);if(hasDuplicate){for(var i=1;i<results.length;i++){if(results[i]===results[i-1]){results.splice(i--,1)}}}}return results};Sizzle.matches=function(expr,set){return Sizzle(expr,null,null,set)};Sizzle.matchesSelector=function(node,expr){return Sizzle(expr,null,null,[node]).length>0};Sizzle.find=function(expr,context,isXML){var set;if(!expr){return[]}for(var i=0,l=Expr.order.length;i<l;i++){var match,type=Expr.order[i];if((match=Expr.leftMatch[type].exec(expr))){var left=match[1];match.splice(1,1);if(left.substr(left.length-1)!=="\\"){match[1]=(match[1]||"").replace(rBackslash,"");set=Expr.find[type](match,context,isXML);if(set!=null){expr=expr.replace(Expr.match[type],"");break}}}}if(!set){set=typeof context.getElementsByTagName!=="undefined"?context.getElementsByTagName("*"):[]}return{set:set,expr:expr}};Sizzle.filter=function(expr,set,inplace,not){var match,anyFound,old=expr,result=[],curLoop=set,isXMLFilter=set&&set[0]&&Sizzle.isXML(set[0]);while(expr&&set.length){for(var type in Expr.filter){if((match=Expr.leftMatch[type].exec(expr))!=null&&match[2]){var found,item,filter=Expr.filter[type],left=match[1];anyFound=false;match.splice(1,1);if(left.substr(left.length-1)==="\\"){continue}if(curLoop===result){result=[]}if(Expr.preFilter[type]){match=Expr.preFilter[type](match,curLoop,inplace,result,not,isXMLFilter);if(!match){anyFound=found=true}else{if(match===true){continue}}}if(match){for(var i=0;(item=curLoop[i])!=null;i++){if(item){found=filter(item,match,i,curLoop);var pass=not^!!found;if(inplace&&found!=null){if(pass){anyFound=true}else{curLoop[i]=false}}else{if(pass){result.push(item);anyFound=true}}}}}if(found!==undefined){if(!inplace){curLoop=result}expr=expr.replace(Expr.match[type],"");if(!anyFound){return[]}break}}}if(expr===old){if(anyFound==null){Sizzle.error(expr)}else{break}}old=expr}return curLoop};Sizzle.error=function(msg){throw"Syntax error, unrecognized expression: "+msg};var Expr=Sizzle.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(elem){return elem.getAttribute("href")},type:function(elem){return elem.getAttribute("type")}},relative:{"+":function(checkSet,part){var isPartStr=typeof part==="string",isTag=isPartStr&&!rNonWord.test(part),isPartStrNotTag=isPartStr&&!isTag;if(isTag){part=part.toLowerCase()}for(var i=0,l=checkSet.length,elem;i<l;i++){if((elem=checkSet[i])){while((elem=elem.previousSibling)&&elem.nodeType!==1){}checkSet[i]=isPartStrNotTag||elem&&elem.nodeName.toLowerCase()===part?elem||false:elem===part}}if(isPartStrNotTag){Sizzle.filter(part,checkSet,true)}},">":function(checkSet,part){var elem,isPartStr=typeof part==="string",i=0,l=checkSet.length;if(isPartStr&&!rNonWord.test(part)){part=part.toLowerCase();for(;i<l;i++){elem=checkSet[i];if(elem){var parent=elem.parentNode;checkSet[i]=parent.nodeName.toLowerCase()===part?parent:false}}}else{for(;i<l;i++){elem=checkSet[i];if(elem){checkSet[i]=isPartStr?elem.parentNode:elem.parentNode===part}}if(isPartStr){Sizzle.filter(part,checkSet,true)}}},"":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("parentNode",part,doneName,checkSet,nodeCheck,isXML)},"~":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("previousSibling",part,doneName,checkSet,nodeCheck,isXML)}},find:{ID:function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m&&m.parentNode?[m]:[]}},NAME:function(match,context){if(typeof context.getElementsByName!=="undefined"){var ret=[],results=context.getElementsByName(match[1]);for(var i=0,l=results.length;i<l;i++){if(results[i].getAttribute("name")===match[1]){ret.push(results[i])}}return ret.length===0?null:ret}},TAG:function(match,context){if(typeof context.getElementsByTagName!=="undefined"){return context.getElementsByTagName(match[1])}}},preFilter:{CLASS:function(match,curLoop,inplace,result,not,isXML){match=" "+match[1].replace(rBackslash,"")+" ";if(isXML){return match}for(var i=0,elem;(elem=curLoop[i])!=null;i++){if(elem){if(not^(elem.className&&(" "+elem.className+" ").replace(/[\t\n\r]/g," ").indexOf(match)>=0)){if(!inplace){result.push(elem)}}else{if(inplace){curLoop[i]=false}}}}return false},ID:function(match){return match[1].replace(rBackslash,"")},TAG:function(match,curLoop){return match[1].replace(rBackslash,"").toLowerCase()},CHILD:function(match){if(match[1]==="nth"){if(!match[2]){Sizzle.error(match[0])}match[2]=match[2].replace(/^\+|\s*/g,"");var test=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(match[2]==="even"&&"2n"||match[2]==="odd"&&"2n+1"||!/\D/.test(match[2])&&"0n+"+match[2]||match[2]);match[2]=(test[1]+(test[2]||1))-0;match[3]=test[3]-0}else{if(match[2]){Sizzle.error(match[0])}}match[0]=done++;return match},ATTR:function(match,curLoop,inplace,result,not,isXML){var name=match[1]=match[1].replace(rBackslash,"");if(!isXML&&Expr.attrMap[name]){match[1]=Expr.attrMap[name]}match[4]=(match[4]||match[5]||"").replace(rBackslash,"");if(match[2]==="~="){match[4]=" "+match[4]+" "}return match},PSEUDO:function(match,curLoop,inplace,result,not){if(match[1]==="not"){if((chunker.exec(match[3])||"").length>1||/^\w/.test(match[3])){match[3]=Sizzle(match[3],null,null,curLoop)}else{var ret=Sizzle.filter(match[3],curLoop,inplace,true^not);if(!inplace){result.push.apply(result,ret)}return false}}else{if(Expr.match.POS.test(match[0])||Expr.match.CHILD.test(match[0])){return true}}return match},POS:function(match){match.unshift(true);return match}},filters:{enabled:function(elem){return elem.disabled===false&&elem.type!=="hidden"},disabled:function(elem){return elem.disabled===true},checked:function(elem){return elem.checked===true},selected:function(elem){if(elem.parentNode){elem.parentNode.selectedIndex}return elem.selected===true},parent:function(elem){return !!elem.firstChild},empty:function(elem){return !elem.firstChild},has:function(elem,i,match){return !!Sizzle(match[3],elem).length},header:function(elem){return(/h\d/i).test(elem.nodeName)},text:function(elem){var attr=elem.getAttribute("type"),type=elem.type;return elem.nodeName.toLowerCase()==="input"&&"text"===type&&(attr===type||attr===null)},radio:function(elem){return elem.nodeName.toLowerCase()==="input"&&"radio"===elem.type},checkbox:function(elem){return elem.nodeName.toLowerCase()==="input"&&"checkbox"===elem.type},file:function(elem){return elem.nodeName.toLowerCase()==="input"&&"file"===elem.type},password:function(elem){return elem.nodeName.toLowerCase()==="input"&&"password"===elem.type},submit:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"submit"===elem.type},image:function(elem){return elem.nodeName.toLowerCase()==="input"&&"image"===elem.type},reset:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"reset"===elem.type},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&"button"===elem.type||name==="button"},input:function(elem){return(/input|select|textarea|button/i).test(elem.nodeName)},focus:function(elem){return elem===elem.ownerDocument.activeElement}},setFilters:{first:function(elem,i){return i===0},last:function(elem,i,match,array){return i===array.length-1},even:function(elem,i){return i%2===0},odd:function(elem,i){return i%2===1},lt:function(elem,i,match){return i<match[3]-0},gt:function(elem,i,match){return i>match[3]-0},nth:function(elem,i,match){return match[3]-0===i},eq:function(elem,i,match){return match[3]-0===i}},filter:{PSEUDO:function(elem,match,i,array){var name=match[1],filter=Expr.filters[name];if(filter){return filter(elem,i,match,array)}else{if(name==="contains"){return(elem.textContent||elem.innerText||Sizzle.getText([elem])||"").indexOf(match[3])>=0}else{if(name==="not"){var not=match[3];for(var j=0,l=not.length;j<l;j++){if(not[j]===elem){return false}}return true}else{Sizzle.error(name)}}}},CHILD:function(elem,match){var type=match[1],node=elem;switch(type){case"only":case"first":while((node=node.previousSibling)){if(node.nodeType===1){return false}}if(type==="first"){return true}node=elem;case"last":while((node=node.nextSibling)){if(node.nodeType===1){return false}}return true;case"nth":var first=match[2],last=match[3];if(first===1&&last===0){return true}var doneName=match[0],parent=elem.parentNode;if(parent&&(parent.sizcache!==doneName||!elem.nodeIndex)){var count=0;for(node=parent.firstChild;node;node=node.nextSibling){if(node.nodeType===1){node.nodeIndex=++count}}parent.sizcache=doneName}var diff=elem.nodeIndex-last;if(first===0){return diff===0}else{return(diff%first===0&&diff/first>=0)}}},ID:function(elem,match){return elem.nodeType===1&&elem.getAttribute("id")===match},TAG:function(elem,match){return(match==="*"&&elem.nodeType===1)||elem.nodeName.toLowerCase()===match},CLASS:function(elem,match){return(" "+(elem.className||elem.getAttribute("class"))+" ").indexOf(match)>-1},ATTR:function(elem,match){var name=match[1],result=Expr.attrHandle[name]?Expr.attrHandle[name](elem):elem[name]!=null?elem[name]:elem.getAttribute(name),value=result+"",type=match[2],check=match[4];return result==null?type==="!=":type==="="?value===check:type==="*="?value.indexOf(check)>=0:type==="~="?(" "+value+" ").indexOf(check)>=0:!check?value&&result!==false:type==="!="?value!==check:type==="^="?value.indexOf(check)===0:type==="$="?value.substr(value.length-check.length)===check:type==="|="?value===check||value.substr(0,check.length+1)===check+"-":false},POS:function(elem,match,i,array){var name=match[2],filter=Expr.setFilters[name];if(filter){return filter(elem,i,match,array)}}}};var origPOS=Expr.match.POS,fescape=function(all,num){return"\\"+(num-0+1)};for(var type in Expr.match){Expr.match[type]=new RegExp(Expr.match[type].source+(/(?![^\[]*\])(?![^\(]*\))/.source));Expr.leftMatch[type]=new RegExp(/(^(?:.|\r|\n)*?)/.source+Expr.match[type].source.replace(/\\(\d+)/g,fescape))}var makeArray=function(array,results){array=Array.prototype.slice.call(array,0);if(results){results.push.apply(results,array);return results}return array};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType}catch(e){makeArray=function(array,results){var i=0,ret=results||[];if(toString.call(array)==="[object Array]"){Array.prototype.push.apply(ret,array)}else{if(typeof array.length==="number"){for(var l=array.length;i<l;i++){ret.push(array[i])}}else{for(;array[i];i++){ret.push(array[i])}}}return ret}}var sortOrder,siblingCheck;if(document.documentElement.compareDocumentPosition){sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition){return a.compareDocumentPosition?-1:1}return a.compareDocumentPosition(b)&4?-1:1}}else{sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}else{if(a.sourceIndex&&b.sourceIndex){return a.sourceIndex-b.sourceIndex}}var al,bl,ap=[],bp=[],aup=a.parentNode,bup=b.parentNode,cur=aup;if(aup===bup){return siblingCheck(a,b)}else{if(!aup){return -1}else{if(!bup){return 1}}}while(cur){ap.unshift(cur);cur=cur.parentNode}cur=bup;while(cur){bp.unshift(cur);cur=cur.parentNode}al=ap.length;bl=bp.length;for(var i=0;i<al&&i<bl;i++){if(ap[i]!==bp[i]){return siblingCheck(ap[i],bp[i])}}return i===al?siblingCheck(a,bp[i],-1):siblingCheck(ap[i],b,1)};siblingCheck=function(a,b,ret){if(a===b){return ret}var cur=a.nextSibling;while(cur){if(cur===b){return -1}cur=cur.nextSibling}return 1}}Sizzle.getText=function(elems){var ret="",elem;for(var i=0;elems[i];i++){elem=elems[i];if(elem.nodeType===3||elem.nodeType===4){ret+=elem.nodeValue}else{if(elem.nodeType!==8){ret+=Sizzle.getText(elem.childNodes)}}}return ret};(function(){var form=document.createElement("div"),id="script"+(new Date()).getTime(),root=document.documentElement;form.innerHTML="<a name='"+id+"'/>";root.insertBefore(form,root.firstChild);if(document.getElementById(id)){Expr.find.ID=function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m?m.id===match[1]||typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id").nodeValue===match[1]?[m]:undefined:[]}};Expr.filter.ID=function(elem,match){var node=typeof elem.getAttributeNode!=="undefined"&&elem.getAttributeNode("id");return elem.nodeType===1&&node&&node.nodeValue===match}}root.removeChild(form);root=form=null})();(function(){var div=document.createElement("div");div.appendChild(document.createComment(""));if(div.getElementsByTagName("*").length>0){Expr.find.TAG=function(match,context){var results=context.getElementsByTagName(match[1]);if(match[1]==="*"){var tmp=[];for(var i=0;results[i];i++){if(results[i].nodeType===1){tmp.push(results[i])}}results=tmp}return results}}div.innerHTML="<a href='#'></a>";if(div.firstChild&&typeof div.firstChild.getAttribute!=="undefined"&&div.firstChild.getAttribute("href")!=="#"){Expr.attrHandle.href=function(elem){return elem.getAttribute("href",2)}}div=null})();if(document.querySelectorAll){(function(){var oldSizzle=Sizzle,div=document.createElement("div"),id="__sizzle__";div.innerHTML="<p class='TEST'></p>";if(div.querySelectorAll&&div.querySelectorAll(".TEST").length===0){return}Sizzle=function(query,context,extra,seed){context=context||document;if(!seed&&!Sizzle.isXML(context)){var match=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(query);if(match&&(context.nodeType===1||context.nodeType===9)){if(match[1]){return makeArray(context.getElementsByTagName(query),extra)}else{if(match[2]&&Expr.find.CLASS&&context.getElementsByClassName){return makeArray(context.getElementsByClassName(match[2]),extra)}}}if(context.nodeType===9){if(query==="body"&&context.body){return makeArray([context.body],extra)}else{if(match&&match[3]){var elem=context.getElementById(match[3]);if(elem&&elem.parentNode){if(elem.id===match[3]){return makeArray([elem],extra)}}else{return makeArray([],extra)}}}try{return makeArray(context.querySelectorAll(query),extra)}catch(qsaError){}}else{if(context.nodeType===1&&context.nodeName.toLowerCase()!=="object"){var oldContext=context,old=context.getAttribute("id"),nid=old||id,hasParent=context.parentNode,relativeHierarchySelector=/^\s*[+~]/.test(query);if(!old){context.setAttribute("id",nid)}else{nid=nid.replace(/'/g,"\\$&")}if(relativeHierarchySelector&&hasParent){context=context.parentNode}try{if(!relativeHierarchySelector||hasParent){return makeArray(context.querySelectorAll("[id='"+nid+"'] "+query),extra)}}catch(pseudoError){}finally{if(!old){oldContext.removeAttribute("id")}}}}}return oldSizzle(query,context,extra,seed)};for(var prop in oldSizzle){Sizzle[prop]=oldSizzle[prop]}div=null})()}(function(){var html=document.documentElement,matches=html.matchesSelector||html.mozMatchesSelector||html.webkitMatchesSelector||html.msMatchesSelector;if(matches){var disconnectedMatch=!matches.call(document.createElement("div"),"div"),pseudoWorks=false;try{matches.call(document.documentElement,"[test!='']:sizzle")}catch(pseudoError){pseudoWorks=true}Sizzle.matchesSelector=function(node,expr){expr=expr.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!Sizzle.isXML(node)){try{if(pseudoWorks||!Expr.match.PSEUDO.test(expr)&&!/!=/.test(expr)){var ret=matches.call(node,expr);if(ret||!disconnectedMatch||node.document&&node.document.nodeType!==11){return ret}}}catch(e){}}return Sizzle(expr,null,null,[node]).length>0}}})();(function(){var div=document.createElement("div");div.innerHTML="<div class='test e'></div><div class='test'></div>";if(!div.getElementsByClassName||div.getElementsByClassName("e").length===0){return}div.lastChild.className="e";if(div.getElementsByClassName("e").length===1){return}Expr.order.splice(1,0,"CLASS");Expr.find.CLASS=function(match,context,isXML){if(typeof context.getElementsByClassName!=="undefined"&&!isXML){return context.getElementsByClassName(match[1])}};div=null})();function dirNodeCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1&&!isXML){elem.sizcache=doneName;elem.sizset=i}if(elem.nodeName.toLowerCase()===cur){match=elem;break}elem=elem[dir]}checkSet[i]=match}}}function dirCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1){if(!isXML){elem.sizcache=doneName;elem.sizset=i}if(typeof cur!=="string"){if(elem===cur){match=true;break}}else{if(Sizzle.filter(cur,[elem]).length>0){match=elem;break}}}elem=elem[dir]}checkSet[i]=match}}}if(document.documentElement.contains){Sizzle.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true)}}else{if(document.documentElement.compareDocumentPosition){Sizzle.contains=function(a,b){return !!(a.compareDocumentPosition(b)&16)}}else{Sizzle.contains=function(){return false}}}Sizzle.isXML=function(elem){var documentElement=(elem?elem.ownerDocument||elem:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false};var posProcess=function(selector,context){var match,tmpSet=[],later="",root=context.nodeType?[context]:context;while((match=Expr.match.PSEUDO.exec(selector))){later+=match[0];selector=selector.replace(Expr.match.PSEUDO,"")}selector=Expr.relative[selector]?selector+"*":selector;for(var i=0,l=root.length;i<l;i++){Sizzle(selector,root[i],tmpSet)}return Sizzle.filter(later,tmpSet)};window.Sizzle=Sizzle})();Prototype._original_property=window.Sizzle;(function(engine){var extendElements=Prototype.Selector.extendElements;function select(selector,scope){return extendElements(engine(selector,scope||document))}function match(element,selector){return engine.matches(selector,[element]).length==1}Prototype.Selector.engine=engine;Prototype.Selector.select=select;Prototype.Selector.match=match})(Sizzle);window.Sizzle=Prototype._original_property;delete Prototype._original_property;var Form={reset:function(form){form=$(form);form.reset();return form},serializeElements:function(elements,options){if(typeof options!="object"){options={hash:!!options}}else{if(Object.isUndefined(options.hash)){options.hash=true}}var key,value,submitted=false,submit=options.submit,accumulator,initial;if(options.hash){initial={};accumulator=function(result,key,value){if(key in result){if(!Object.isArray(result[key])){result[key]=[result[key]]}result[key]=result[key].concat(value)}else{result[key]=value}return result}}else{initial="";accumulator=function(result,key,values){if(!Object.isArray(values)){values=[values]}if(!values.length){return result}var encodedKey=encodeURIComponent(key).gsub(/%20/,"+");return result+(result?"&":"")+values.map(function(value){value=value.gsub(/(\r)?\n/,"\r\n");value=encodeURIComponent(value);value=value.gsub(/%20/,"+");return encodedKey+"="+value}).join("&")}}return elements.inject(initial,function(result,element){if(!element.disabled&&element.name){key=element.name;value=$(element).getValue();if(value!=null&&element.type!="file"&&(element.type!="submit"||(!submitted&&submit!==false&&(!submit||key==submit)&&(submitted=true)))){result=accumulator(result,key,value)}}return result})}};Form.Methods={serialize:function(form,options){return Form.serializeElements(Form.getElements(form),options)},getElements:function(form){var elements=$(form).getElementsByTagName("*");var element,results=[],serializers=Form.Element.Serializers;for(var i=0;element=elements[i];i++){if(serializers[element.tagName.toLowerCase()]){results.push(Element.extend(element))}}return results},getInputs:function(form,typeName,name){form=$(form);var inputs=form.getElementsByTagName("input");if(!typeName&&!name){return $A(inputs).map(Element.extend)}for(var i=0,matchingInputs=[],length=inputs.length;i<length;i++){var input=inputs[i];if((typeName&&input.type!=typeName)||(name&&input.name!=name)){continue}matchingInputs.push(Element.extend(input))}return matchingInputs},disable:function(form){form=$(form);Form.getElements(form).invoke("disable");return form},enable:function(form){form=$(form);Form.getElements(form).invoke("enable");return form},findFirstElement:function(form){var elements=$(form).getElements().findAll(function(element){return"hidden"!=element.type&&!element.disabled});var firstByIndex=elements.findAll(function(element){return element.hasAttribute("tabIndex")&&element.tabIndex>=0}).sortBy(function(element){return element.tabIndex}).first();return firstByIndex?firstByIndex:elements.find(function(element){return/^(?:input|select|textarea)$/i.test(element.tagName)})},focusFirstElement:function(form){form=$(form);var element=form.findFirstElement();if(element){element.activate()}return form},request:function(form,options){form=$(form),options=Object.clone(options||{});var params=options.parameters,action=form.readAttribute("action")||"";if(action.blank()){action=window.location.href}options.parameters=form.serialize(true);if(params){if(Object.isString(params)){params=params.toQueryParams()}Object.extend(options.parameters,params)}if(form.hasAttribute("method")&&!options.method){options.method=form.method}return new Ajax.Request(action,options)}};Form.Element={focus:function(element){$(element).focus();return element},select:function(element){$(element).select();return element}};Form.Element.Methods={serialize:function(element){element=$(element);if(!element.disabled&&element.name){var value=element.getValue();if(value!=undefined){var pair={};pair[element.name]=value;return Object.toQueryString(pair)}}return""},getValue:function(element){element=$(element);var method=element.tagName.toLowerCase();return Form.Element.Serializers[method](element)},setValue:function(element,value){element=$(element);var method=element.tagName.toLowerCase();Form.Element.Serializers[method](element,value);return element},clear:function(element){$(element).value="";return element},present:function(element){return $(element).value!=""},activate:function(element){element=$(element);try{element.focus();if(element.select&&(element.tagName.toLowerCase()!="input"||!(/^(?:button|reset|submit)$/i.test(element.type)))){element.select()}}catch(e){}return element},disable:function(element){element=$(element);element.disabled=true;return element},enable:function(element){element=$(element);element.disabled=false;return element}};var Field=Form.Element;var $F=Form.Element.Methods.getValue;Form.Element.Serializers=(function(){function input(element,value){switch(element.type.toLowerCase()){case"checkbox":case"radio":return inputSelector(element,value);default:return valueSelector(element,value)}}function inputSelector(element,value){if(Object.isUndefined(value)){return element.checked?element.value:null}else{element.checked=!!value}}function valueSelector(element,value){if(Object.isUndefined(value)){return element.value}else{element.value=value}}function select(element,value){if(Object.isUndefined(value)){return(element.type==="select-one"?selectOne:selectMany)(element)}var opt,currentValue,single=!Object.isArray(value);for(var i=0,length=element.length;i<length;i++){opt=element.options[i];currentValue=this.optionValue(opt);if(single){if(currentValue==value){opt.selected=true;return}}else{opt.selected=value.include(currentValue)}}}function selectOne(element){var index=element.selectedIndex;return index>=0?optionValue(element.options[index]):null}function selectMany(element){var values,length=element.length;if(!length){return null}for(var i=0,values=[];i<length;i++){var opt=element.options[i];if(opt.selected){values.push(optionValue(opt))}}return values}function optionValue(opt){return Element.hasAttribute(opt,"value")?opt.value:opt.text}return{input:input,inputSelector:inputSelector,textarea:valueSelector,select:select,selectOne:selectOne,selectMany:selectMany,optionValue:optionValue,button:valueSelector}})();Abstract.TimedObserver=Class.create(PeriodicalExecuter,{initialize:function($super,element,frequency,callback){$super(callback,frequency);this.element=$(element);this.lastValue=this.getValue()},execute:function(){var value=this.getValue();if(Object.isString(this.lastValue)&&Object.isString(value)?this.lastValue!=value:String(this.lastValue)!=String(value)){this.callback(this.element,value);this.lastValue=value}}});Form.Element.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.Element.getValue(this.element)}});Form.Observer=Class.create(Abstract.TimedObserver,{getValue:function(){return Form.serialize(this.element)}});Abstract.EventObserver=Class.create({initialize:function(element,callback){this.element=$(element);this.callback=callback;this.lastValue=this.getValue();if(this.element.tagName.toLowerCase()=="form"){this.registerFormCallbacks()}else{this.registerCallback(this.element)}},onElementEvent:function(){var value=this.getValue();if(this.lastValue!=value){this.callback(this.element,value);this.lastValue=value}},registerFormCallbacks:function(){Form.getElements(this.element).each(this.registerCallback,this)},registerCallback:function(element){if(element.type){switch(element.type.toLowerCase()){case"checkbox":case"radio":Event.observe(element,"click",this.onElementEvent.bind(this));break;default:Event.observe(element,"change",this.onElementEvent.bind(this));break}}}});Form.Element.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.Element.getValue(this.element)}});Form.EventObserver=Class.create(Abstract.EventObserver,{getValue:function(){return Form.serialize(this.element)}});(function(GLOBAL){var DIV=document.createElement("div");var docEl=document.documentElement;var MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED="onmouseenter" in docEl&&"onmouseleave" in docEl;var Event={KEY_BACKSPACE:8,KEY_TAB:9,KEY_RETURN:13,KEY_ESC:27,KEY_LEFT:37,KEY_UP:38,KEY_RIGHT:39,KEY_DOWN:40,KEY_DELETE:46,KEY_HOME:36,KEY_END:35,KEY_PAGEUP:33,KEY_PAGEDOWN:34,KEY_INSERT:45};var isIELegacyEvent=function(event){return false};if(window.attachEvent){if(window.addEventListener){isIELegacyEvent=function(event){return !(event instanceof window.Event)}}else{isIELegacyEvent=function(event){return true}}}var _isButton;function _isButtonForDOMEvents(event,code){return event.which?(event.which===code+1):(event.button===code)}var legacyButtonMap={0:1,1:4,2:2};function _isButtonForLegacyEvents(event,code){return event.button===legacyButtonMap[code]}function _isButtonForWebKit(event,code){switch(code){case 0:return event.which==1&&!event.metaKey;case 1:return event.which==2||(event.which==1&&event.metaKey);case 2:return event.which==3;default:return false}}if(window.attachEvent){if(!window.addEventListener){_isButton=_isButtonForLegacyEvents}else{_isButton=function(event,code){return isIELegacyEvent(event)?_isButtonForLegacyEvents(event,code):_isButtonForDOMEvents(event,code)}}}else{if(Prototype.Browser.WebKit){_isButton=_isButtonForWebKit}else{_isButton=_isButtonForDOMEvents}}function isLeftClick(event){return _isButton(event,0)}function isMiddleClick(event){return _isButton(event,1)}function isRightClick(event){return _isButton(event,2)}function element(event){return Element.extend(_element(event))}function _element(event){event=Event.extend(event);var node=event.target,type=event.type,currentTarget=event.currentTarget;if(currentTarget&&currentTarget.tagName){if(type==="load"||type==="error"||(type==="click"&&currentTarget.tagName.toLowerCase()==="input"&&currentTarget.type==="radio")){node=currentTarget}}return node.nodeType==Node.TEXT_NODE?node.parentNode:node}function findElement(event,expression){var element=_element(event),selector=Prototype.Selector;if(!expression){return Element.extend(element)}while(element){if(Object.isElement(element)&&selector.match(element,expression)){return Element.extend(element)}element=element.parentNode}}function pointer(event){return{x:pointerX(event),y:pointerY(event)}}function pointerX(event){var docElement=document.documentElement,body=document.body||{scrollLeft:0};return event.pageX||(event.clientX+(docElement.scrollLeft||body.scrollLeft)-(docElement.clientLeft||0))}function pointerY(event){var docElement=document.documentElement,body=document.body||{scrollTop:0};return event.pageY||(event.clientY+(docElement.scrollTop||body.scrollTop)-(docElement.clientTop||0))}function stop(event){Event.extend(event);event.preventDefault();event.stopPropagation();event.stopped=true}Event.Methods={isLeftClick:isLeftClick,isMiddleClick:isMiddleClick,isRightClick:isRightClick,element:element,findElement:findElement,pointer:pointer,pointerX:pointerX,pointerY:pointerY,stop:stop};var methods=Object.keys(Event.Methods).inject({},function(m,name){m[name]=Event.Methods[name].methodize();return m});if(window.attachEvent){function _relatedTarget(event){var element;switch(event.type){case"mouseover":case"mouseenter":element=event.fromElement;break;case"mouseout":case"mouseleave":element=event.toElement;break;default:return null}return Element.extend(element)}var additionalMethods={stopPropagation:function(){this.cancelBubble=true},preventDefault:function(){this.returnValue=false},inspect:function(){return"[object Event]"}};Event.extend=function(event,element){if(!event){return false}if(!isIELegacyEvent(event)){return event}if(event._extendedByPrototype){return event}event._extendedByPrototype=Prototype.emptyFunction;var pointer=Event.pointer(event);Object.extend(event,{target:event.srcElement||element,relatedTarget:_relatedTarget(event),pageX:pointer.x,pageY:pointer.y});Object.extend(event,methods);Object.extend(event,additionalMethods);return event}}else{Event.extend=Prototype.K}if(window.addEventListener){Event.prototype=window.Event.prototype||document.createEvent("HTMLEvents").__proto__;Object.extend(Event.prototype,methods)}var EVENT_TRANSLATIONS={mouseenter:"mouseover",mouseleave:"mouseout"};function getDOMEventName(eventName){return EVENT_TRANSLATIONS[eventName]||eventName}if(MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED){getDOMEventName=Prototype.K}function getUniqueElementID(element){if(element===window){return 0}if(typeof element._prototypeUID==="undefined"){element._prototypeUID=Element.Storage.UID++}return element._prototypeUID}function getUniqueElementID_IE(element){if(element===window){return 0}if(element==document){return 1}return element.uniqueID}if("uniqueID" in DIV){getUniqueElementID=getUniqueElementID_IE}function isCustomEvent(eventName){return eventName.include(":")}Event._isCustomEvent=isCustomEvent;function getRegistryForElement(element,uid){var CACHE=GLOBAL.Event.cache;if(Object.isUndefined(uid)){uid=getUniqueElementID(element)}if(!CACHE[uid]){CACHE[uid]={element:element}}return CACHE[uid]}function destroyRegistryForElement(element,uid){if(Object.isUndefined(uid)){uid=getUniqueElementID(element)}delete GLOBAL.Event.cache[uid]}function register(element,eventName,handler){var registry=getRegistryForElement(element);if(!registry[eventName]){registry[eventName]=[]}var entries=registry[eventName];var i=entries.length;while(i--){if(entries[i].handler===handler){return null}}var uid=getUniqueElementID(element);var responder=GLOBAL.Event._createResponder(uid,eventName,handler);var entry={responder:responder,handler:handler};entries.push(entry);return entry}function unregister(element,eventName,handler){var registry=getRegistryForElement(element);var entries=registry[eventName];if(!entries){return}var i=entries.length,entry;while(i--){if(entries[i].handler===handler){entry=entries[i];break}}if(!entry){return}var index=entries.indexOf(entry);entries.splice(index,1);return entry}function observe(element,eventName,handler){element=$(element);var entry=register(element,eventName,handler);if(entry===null){return element}var responder=entry.responder;if(isCustomEvent(eventName)){observeCustomEvent(element,eventName,responder)}else{observeStandardEvent(element,eventName,responder)}return element}function observeStandardEvent(element,eventName,responder){var actualEventName=getDOMEventName(eventName);if(element.addEventListener){element.addEventListener(actualEventName,responder,false)}else{element.attachEvent("on"+actualEventName,responder)}}function observeCustomEvent(element,eventName,responder){if(element.addEventListener){element.addEventListener("dataavailable",responder,false)}else{element.attachEvent("ondataavailable",responder);element.attachEvent("onlosecapture",responder)}}function stopObserving(element,eventName,handler){element=$(element);var handlerGiven=!Object.isUndefined(handler),eventNameGiven=!Object.isUndefined(eventName);if(!eventNameGiven&&!handlerGiven){stopObservingElement(element);return element}if(!handlerGiven){stopObservingEventName(element,eventName);return element}var entry=unregister(element,eventName,handler);if(!entry){return element}removeEvent(element,eventName,entry.responder);return element}function stopObservingStandardEvent(element,eventName,responder){var actualEventName=getDOMEventName(eventName);if(element.removeEventListener){element.removeEventListener(actualEventName,responder,false)}else{element.detachEvent("on"+actualEventName,responder)}}function stopObservingCustomEvent(element,eventName,responder){if(element.removeEventListener){element.removeEventListener("dataavailable",responder,false)}else{element.detachEvent("ondataavailable",responder);element.detachEvent("onlosecapture",responder)}}function stopObservingElement(element){var uid=getUniqueElementID(element),registry=GLOBAL.Event.cache[uid];if(!registry){return}destroyRegistryForElement(element,uid);var entries,i;for(var eventName in registry){if(eventName==="element"){continue}entries=registry[eventName];i=entries.length;while(i--){removeEvent(element,eventName,entries[i].responder)}}}function stopObservingEventName(element,eventName){var registry=getRegistryForElement(element);var entries=registry[eventName];if(!entries){return}delete registry[eventName];var i=entries.length;while(i--){removeEvent(element,eventName,entries[i].responder)}}function removeEvent(element,eventName,handler){if(isCustomEvent(eventName)){stopObservingCustomEvent(element,eventName,handler)}else{stopObservingStandardEvent(element,eventName,handler)}}function getFireTarget(element){if(element!==document){return element}if(document.createEvent&&!element.dispatchEvent){return document.documentElement}return element}function fire(element,eventName,memo,bubble){element=getFireTarget($(element));if(Object.isUndefined(bubble)){bubble=true}memo=memo||{};var event=fireEvent(element,eventName,memo,bubble);return Event.extend(event)}function fireEvent_DOM(element,eventName,memo,bubble){var event=document.createEvent("HTMLEvents");event.initEvent("dataavailable",bubble,true);event.eventName=eventName;event.memo=memo;element.dispatchEvent(event);return event}function fireEvent_IE(element,eventName,memo,bubble){var event=document.createEventObject();event.eventType=bubble?"ondataavailable":"onlosecapture";event.eventName=eventName;event.memo=memo;element.fireEvent(event.eventType,event);return event}var fireEvent=document.createEvent?fireEvent_DOM:fireEvent_IE;Event.Handler=Class.create({initialize:function(element,eventName,selector,callback){this.element=$(element);this.eventName=eventName;this.selector=selector;this.callback=callback;this.handler=this.handleEvent.bind(this)},start:function(){Event.observe(this.element,this.eventName,this.handler);return this},stop:function(){Event.stopObserving(this.element,this.eventName,this.handler);return this},handleEvent:function(event){var element=Event.findElement(event,this.selector);if(element){this.callback.call(this.element,event,element)}}});function on(element,eventName,selector,callback){element=$(element);if(Object.isFunction(selector)&&Object.isUndefined(callback)){callback=selector,selector=null}return new Event.Handler(element,eventName,selector,callback).start()}Object.extend(Event,Event.Methods);Object.extend(Event,{fire:fire,observe:observe,stopObserving:stopObserving,on:on});Element.addMethods({fire:fire,observe:observe,stopObserving:stopObserving,on:on});Object.extend(document,{fire:fire.methodize(),observe:observe.methodize(),stopObserving:stopObserving.methodize(),on:on.methodize(),loaded:false});if(GLOBAL.Event){Object.extend(window.Event,Event)}else{GLOBAL.Event=Event}GLOBAL.Event.cache={};function destroyCache_IE(){GLOBAL.Event.cache=null}if(window.attachEvent){window.attachEvent("onunload",destroyCache_IE)}DIV=null;docEl=null})(this);(function(GLOBAL){var docEl=document.documentElement;var MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED="onmouseenter" in docEl&&"onmouseleave" in docEl;function isSimulatedMouseEnterLeaveEvent(eventName){return !MOUSEENTER_MOUSELEAVE_EVENTS_SUPPORTED&&(eventName==="mouseenter"||eventName==="mouseleave")}function createResponder(uid,eventName,handler){if(Event._isCustomEvent(eventName)){return createResponderForCustomEvent(uid,eventName,handler)}if(isSimulatedMouseEnterLeaveEvent(eventName)){return createMouseEnterLeaveResponder(uid,eventName,handler)}return function(event){if(!Event.cache){return}var element=Event.cache[uid].element;Event.extend(event,element);handler.call(element,event)}}function createResponderForCustomEvent(uid,eventName,handler){return function(event){var element=Event.cache[uid].element;if(Object.isUndefined(event.eventName)){return false}if(event.eventName!==eventName){return false}Event.extend(event,element);handler.call(element,event)}}function createMouseEnterLeaveResponder(uid,eventName,handler){return function(event){var element=Event.cache[uid].element;Event.extend(event,element);var parent=event.relatedTarget;while(parent&&parent!==element){try{parent=parent.parentNode}catch(e){parent=element}}if(parent===element){return}handler.call(element,event)}}GLOBAL.Event._createResponder=createResponder;docEl=null})(this);(function(GLOBAL){var TIMER;function fireContentLoadedEvent(){if(document.loaded){return}if(TIMER){window.clearTimeout(TIMER)}document.loaded=true;document.fire("dom:loaded")}function checkReadyState(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",checkReadyState);fireContentLoadedEvent()}}function pollDoScroll(){try{document.documentElement.doScroll("left")}catch(e){TIMER=pollDoScroll.defer();return}fireContentLoadedEvent()}if(document.readyState==="complete"){fireContentLoadedEvent();return}if(document.addEventListener){document.addEventListener("DOMContentLoaded",fireContentLoadedEvent,false)}else{document.attachEvent("onreadystatechange",checkReadyState);if(window==top){TIMER=pollDoScroll.defer()}}Event.observe(window,"load",fireContentLoadedEvent)})(this);Element.addMethods();Hash.toQueryString=Object.toQueryString;var Toggle={display:Element.toggle};Element.Methods.childOf=Element.Methods.descendantOf;var Insertion={Before:function(element,content){return Element.insert(element,{before:content})},Top:function(element,content){return Element.insert(element,{top:content})},Bottom:function(element,content){return Element.insert(element,{bottom:content})},After:function(element,content){return Element.insert(element,{after:content})}};var $continue=new Error('"throw $continue" is deprecated, use "return" instead');var Position={includeScrollOffsets:false,prepare:function(){this.deltaX=window.pageXOffset||document.documentElement.scrollLeft||document.body.scrollLeft||0;this.deltaY=window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0},within:function(element,x,y){if(this.includeScrollOffsets){return this.withinIncludingScrolloffsets(element,x,y)}this.xcomp=x;this.ycomp=y;this.offset=Element.cumulativeOffset(element);return(y>=this.offset[1]&&y<this.offset[1]+element.offsetHeight&&x>=this.offset[0]&&x<this.offset[0]+element.offsetWidth)},withinIncludingScrolloffsets:function(element,x,y){var offsetcache=Element.cumulativeScrollOffset(element);this.xcomp=x+offsetcache[0]-this.deltaX;this.ycomp=y+offsetcache[1]-this.deltaY;this.offset=Element.cumulativeOffset(element);return(this.ycomp>=this.offset[1]&&this.ycomp<this.offset[1]+element.offsetHeight&&this.xcomp>=this.offset[0]&&this.xcomp<this.offset[0]+element.offsetWidth)},overlap:function(mode,element){if(!mode){return 0}if(mode=="vertical"){return((this.offset[1]+element.offsetHeight)-this.ycomp)/element.offsetHeight}if(mode=="horizontal"){return((this.offset[0]+element.offsetWidth)-this.xcomp)/element.offsetWidth}},cumulativeOffset:Element.Methods.cumulativeOffset,positionedOffset:Element.Methods.positionedOffset,absolutize:function(element){Position.prepare();return Element.absolutize(element)},relativize:function(element){Position.prepare();return Element.relativize(element)},realOffset:Element.Methods.cumulativeScrollOffset,offsetParent:Element.Methods.getOffsetParent,page:Element.Methods.viewportOffset,clone:function(source,target,options){options=options||{};return Element.clonePosition(target,source,options)}};if(!document.getElementsByClassName){document.getElementsByClassName=function(instanceMethods){function iter(name){return name.blank()?null:"[contains(concat(' ', @class, ' '), ' "+name+" ')]"}instanceMethods.getElementsByClassName=Prototype.BrowserFeatures.XPath?function(element,className){className=className.toString().strip();var cond=/\s/.test(className)?$w(className).map(iter).join(""):iter(className);return cond?document._getElementsByXPath(".//*"+cond,element):[]}:function(element,className){className=className.toString().strip();var elements=[],classNames=(/\s/.test(className)?$w(className):null);if(!classNames&&!className){return elements}var nodes=$(element).getElementsByTagName("*");className=" "+className+" ";for(var i=0,child,cn;child=nodes[i];i++){if(child.className&&(cn=" "+child.className+" ")&&(cn.include(className)||(classNames&&classNames.all(function(name){return !name.toString().blank()&&cn.include(" "+name+" ")})))){elements.push(Element.extend(child))}}return elements};return function(className,parentElement){return $(parentElement||document.body).getElementsByClassName(className)}}(Element.Methods)}Element.ClassNames=Class.create();Element.ClassNames.prototype={initialize:function(element){this.element=$(element)},_each:function(iterator,context){this.element.className.split(/\s+/).select(function(name){return name.length>0})._each(iterator,context)},set:function(className){this.element.className=className},add:function(classNameToAdd){if(this.include(classNameToAdd)){return}this.set($A(this).concat(classNameToAdd).join(" "))},remove:function(classNameToRemove){if(!this.include(classNameToRemove)){return}this.set($A(this).without(classNameToRemove).join(" "))},toString:function(){return $A(this).join(" ")}};Object.extend(Element.ClassNames.prototype,Enumerable);(function(){window.Selector=Class.create({initialize:function(expression){this.expression=expression.strip()},findElements:function(rootElement){return Prototype.Selector.select(this.expression,rootElement)},match:function(element){return Prototype.Selector.match(element,this.expression)},toString:function(){return this.expression},inspect:function(){return"#<Selector: "+this.expression+">"}});Object.extend(Selector,{matchElements:function(elements,expression){var match=Prototype.Selector.match,results=[];for(var i=0,length=elements.length;i<length;i++){var element=elements[i];if(match(element,expression)){results.push(Element.extend(element))}}return results},findElement:function(elements,expression,index){index=index||0;var matchIndex=0,element;for(var i=0,length=elements.length;i<length;i++){element=elements[i];if(Prototype.Selector.match(element,expression)&&index===matchIndex++){return Element.extend(element)}}},findChildElements:function(element,expressions){var selector=expressions.toArray().join(", ");return Prototype.Selector.select(selector,element||document)}})})();String.prototype.parseColor=function(){var color="#";if(this.slice(0,4)=="rgb("){var cols=this.slice(4,this.length-1).split(",");var i=0;do{color+=parseInt(cols[i]).toColorPart()}while(++i<3)}else{if(this.slice(0,1)=="#"){if(this.length==4){for(var i=1;i<4;i++){color+=(this.charAt(i)+this.charAt(i)).toLowerCase()}}if(this.length==7){color=this.toLowerCase()}}}return(color.length==7?color:(arguments[0]||this))};Element.collectTextNodes=function(element){return $A($(element).childNodes).collect(function(node){return(node.nodeType==3?node.nodeValue:(node.hasChildNodes()?Element.collectTextNodes(node):""))}).flatten().join("")};Element.collectTextNodesIgnoreClass=function(element,className){return $A($(element).childNodes).collect(function(node){return(node.nodeType==3?node.nodeValue:((node.hasChildNodes()&&!Element.hasClassName(node,className))?Element.collectTextNodesIgnoreClass(node,className):""))}).flatten().join("")};Element.setContentZoom=function(element,percent){element=$(element);element.setStyle({fontSize:(percent/100)+"em"});if(Prototype.Browser.WebKit){window.scrollBy(0,0)}return element};Element.getInlineOpacity=function(element){return $(element).style.opacity||""};Element.forceRerendering=function(element){try{element=$(element);var n=document.createTextNode(" ");element.appendChild(n);element.removeChild(n)}catch(e){}};var Effect={_elementDoesNotExistError:{name:"ElementDoesNotExistError",message:"The specified DOM element does not exist, but is required for this effect to operate"},Transitions:{linear:Prototype.K,sinoidal:function(pos){return(-Math.cos(pos*Math.PI)/2)+0.5},reverse:function(pos){return 1-pos},flicker:function(pos){var pos=((-Math.cos(pos*Math.PI)/4)+0.75)+Math.random()/4;return pos>1?1:pos},wobble:function(pos){return(-Math.cos(pos*Math.PI*(9*pos))/2)+0.5},pulse:function(pos,pulses){return(-Math.cos((pos*((pulses||5)-0.5)*2)*Math.PI)/2)+0.5},spring:function(pos){return 1-(Math.cos(pos*4.5*Math.PI)*Math.exp(-pos*6))},none:function(pos){return 0},full:function(pos){return 1}},DefaultOptions:{duration:1,fps:100,sync:false,from:0,to:1,delay:0,queue:"parallel"},tagifyText:function(element){var tagifyStyle="position:relative";if(Prototype.Browser.IE){tagifyStyle+=";zoom:1"}element=$(element);$A(element.childNodes).each(function(child){if(child.nodeType==3){child.nodeValue.toArray().each(function(character){element.insertBefore(new Element("span",{style:tagifyStyle}).update(character==" "?String.fromCharCode(160):character),child)});Element.remove(child)}})},multiple:function(element,effect){var elements;if(((typeof element=="object")||Object.isFunction(element))&&(element.length)){elements=element}else{elements=$(element).childNodes}var options=Object.extend({speed:0.1,delay:0},arguments[2]||{});var masterDelay=options.delay;$A(elements).each(function(element,index){new effect(element,Object.extend(options,{delay:index*options.speed+masterDelay}))})},PAIRS:{slide:["SlideDown","SlideUp"],blind:["BlindDown","BlindUp"],appear:["Appear","Fade"]},toggle:function(element,effect,options){element=$(element);effect=(effect||"appear").toLowerCase();return Effect[Effect.PAIRS[effect][element.visible()?1:0]](element,Object.extend({queue:{position:"end",scope:(element.id||"global"),limit:1}},options||{}))}};Effect.DefaultOptions.transition=Effect.Transitions.sinoidal;Effect.ScopedQueue=Class.create(Enumerable,{initialize:function(){this.effects=[];this.interval=null},_each:function(iterator){this.effects._each(iterator)},add:function(effect){var timestamp=new Date().getTime();var position=Object.isString(effect.options.queue)?effect.options.queue:effect.options.queue.position;switch(position){case"front":this.effects.findAll(function(e){return e.state=="idle"}).each(function(e){e.startOn+=effect.finishOn;e.finishOn+=effect.finishOn});break;case"with-last":timestamp=this.effects.pluck("startOn").max()||timestamp;break;case"end":timestamp=this.effects.pluck("finishOn").max()||timestamp;break}effect.startOn+=timestamp;effect.finishOn+=timestamp;if(!effect.options.queue.limit||(this.effects.length<effect.options.queue.limit)){this.effects.push(effect)}if(!this.interval){this.interval=setInterval(this.loop.bind(this),15)}},remove:function(effect){this.effects=this.effects.reject(function(e){return e==effect});if(this.effects.length==0){clearInterval(this.interval);this.interval=null}},loop:function(){var timePos=new Date().getTime();for(var i=0,len=this.effects.length;i<len;i++){this.effects[i]&&this.effects[i].loop(timePos)}}});Effect.Queues={instances:$H(),get:function(queueName){if(!Object.isString(queueName)){return queueName}return this.instances.get(queueName)||this.instances.set(queueName,new Effect.ScopedQueue())}};Effect.Queue=Effect.Queues.get("global");Effect.Base=Class.create({position:null,start:function(options){if(options&&options.transition===false){options.transition=Effect.Transitions.linear}this.options=Object.extend(Object.extend({},Effect.DefaultOptions),options||{});this.currentFrame=0;this.state="idle";this.startOn=this.options.delay*1000;this.finishOn=this.startOn+(this.options.duration*1000);this.fromToDelta=this.options.to-this.options.from;this.totalTime=this.finishOn-this.startOn;this.totalFrames=this.options.fps*this.options.duration;this.render=(function(){function dispatch(effect,eventName){if(effect.options[eventName+"Internal"]){effect.options[eventName+"Internal"](effect)}if(effect.options[eventName]){effect.options[eventName](effect)}}return function(pos){if(this.state==="idle"){this.state="running";dispatch(this,"beforeSetup");if(this.setup){this.setup()}dispatch(this,"afterSetup")}if(this.state==="running"){pos=(this.options.transition(pos)*this.fromToDelta)+this.options.from;this.position=pos;dispatch(this,"beforeUpdate");if(this.update){this.update(pos)}dispatch(this,"afterUpdate")}}})();this.event("beforeStart");if(!this.options.sync){Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).add(this)}},loop:function(timePos){if(timePos>=this.startOn){if(timePos>=this.finishOn){this.render(1);this.cancel();this.event("beforeFinish");if(this.finish){this.finish()}this.event("afterFinish");return}var pos=(timePos-this.startOn)/this.totalTime,frame=(pos*this.totalFrames).round();if(frame>this.currentFrame){this.render(pos);this.currentFrame=frame}}},cancel:function(){if(!this.options.sync){Effect.Queues.get(Object.isString(this.options.queue)?"global":this.options.queue.scope).remove(this)}this.state="finished"},event:function(eventName){if(this.options[eventName+"Internal"]){this.options[eventName+"Internal"](this)}if(this.options[eventName]){this.options[eventName](this)}},inspect:function(){var data=$H();for(property in this){if(!Object.isFunction(this[property])){data.set(property,this[property])}}return"#<Effect:"+data.inspect()+",options:"+$H(this.options).inspect()+">"}});Effect.Parallel=Class.create(Effect.Base,{initialize:function(effects){this.effects=effects||[];this.start(arguments[1])},update:function(position){this.effects.invoke("render",position)},finish:function(position){this.effects.each(function(effect){effect.render(1);effect.cancel();effect.event("beforeFinish");if(effect.finish){effect.finish(position)}effect.event("afterFinish")})}});Effect.Tween=Class.create(Effect.Base,{initialize:function(object,from,to){object=Object.isString(object)?$(object):object;var args=$A(arguments),method=args.last(),options=args.length==5?args[3]:null;this.method=Object.isFunction(method)?method.bind(object):Object.isFunction(object[method])?object[method].bind(object):function(value){object[method]=value};this.start(Object.extend({from:from,to:to},options||{}))},update:function(position){this.method(position)}});Effect.Event=Class.create(Effect.Base,{initialize:function(){this.start(Object.extend({duration:0},arguments[0]||{}))},update:Prototype.emptyFunction});Effect.Opacity=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element){throw (Effect._elementDoesNotExistError)}if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout)){this.element.setStyle({zoom:1})}var options=Object.extend({from:this.element.getOpacity()||0,to:1},arguments[1]||{});this.start(options)},update:function(position){this.element.setOpacity(position)}});Effect.Move=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element){throw (Effect._elementDoesNotExistError)}var options=Object.extend({x:0,y:0,mode:"relative"},arguments[1]||{});this.start(options)},setup:function(){this.element.makePositioned();this.originalLeft=parseFloat(this.element.getStyle("left")||"0");this.originalTop=parseFloat(this.element.getStyle("top")||"0");if(this.options.mode=="absolute"){this.options.x=this.options.x-this.originalLeft;this.options.y=this.options.y-this.originalTop}},update:function(position){this.element.setStyle({left:(this.options.x*position+this.originalLeft).round()+"px",top:(this.options.y*position+this.originalTop).round()+"px"})}});Effect.MoveBy=function(element,toTop,toLeft){return new Effect.Move(element,Object.extend({x:toLeft,y:toTop},arguments[3]||{}))};Effect.Scale=Class.create(Effect.Base,{initialize:function(element,percent){this.element=$(element);if(!this.element){throw (Effect._elementDoesNotExistError)}var options=Object.extend({scaleX:true,scaleY:true,scaleContent:true,scaleFromCenter:false,scaleMode:"box",scaleFrom:100,scaleTo:percent},arguments[2]||{});this.start(options)},setup:function(){this.restoreAfterFinish=this.options.restoreAfterFinish||false;this.elementPositioning=this.element.getStyle("position");this.originalStyle={};["top","left","width","height","fontSize"].each(function(k){this.originalStyle[k]=this.element.style[k]}.bind(this));this.originalTop=this.element.offsetTop;this.originalLeft=this.element.offsetLeft;var fontSize=this.element.getStyle("font-size")||"100%";["em","px","%","pt"].each(function(fontSizeType){if(fontSize.indexOf(fontSizeType)>0){this.fontSize=parseFloat(fontSize);this.fontSizeType=fontSizeType}}.bind(this));this.factor=(this.options.scaleTo-this.options.scaleFrom)/100;this.dims=null;if(this.options.scaleMode=="box"){this.dims=[this.element.offsetHeight,this.element.offsetWidth]}if(/^content/.test(this.options.scaleMode)){this.dims=[this.element.scrollHeight,this.element.scrollWidth]}if(!this.dims){this.dims=[this.options.scaleMode.originalHeight,this.options.scaleMode.originalWidth]}},update:function(position){var currentScale=(this.options.scaleFrom/100)+(this.factor*position);if(this.options.scaleContent&&this.fontSize){this.element.setStyle({fontSize:this.fontSize*currentScale+this.fontSizeType})}this.setDimensions(this.dims[0]*currentScale,this.dims[1]*currentScale)},finish:function(position){if(this.restoreAfterFinish){this.element.setStyle(this.originalStyle)}},setDimensions:function(height,width){var d={};if(this.options.scaleX){d.width=width.round()+"px"}if(this.options.scaleY){d.height=height.round()+"px"}if(this.options.scaleFromCenter){var topd=(height-this.dims[0])/2;var leftd=(width-this.dims[1])/2;if(this.elementPositioning=="absolute"){if(this.options.scaleY){d.top=this.originalTop-topd+"px"}if(this.options.scaleX){d.left=this.originalLeft-leftd+"px"}}else{if(this.options.scaleY){d.top=-topd+"px"}if(this.options.scaleX){d.left=-leftd+"px"}}}this.element.setStyle(d)}});Effect.Highlight=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element){throw (Effect._elementDoesNotExistError)}var options=Object.extend({startcolor:"#ffff99"},arguments[1]||{});this.start(options)},setup:function(){if(this.element.getStyle("display")=="none"){this.cancel();return}this.oldStyle={};if(!this.options.keepBackgroundImage){this.oldStyle.backgroundImage=this.element.getStyle("background-image");this.element.setStyle({backgroundImage:"none"})}if(!this.options.endcolor){this.options.endcolor=this.element.getStyle("background-color").parseColor("#ffffff")}if(!this.options.restorecolor){this.options.restorecolor=this.element.getStyle("background-color")}this._base=$R(0,2).map(function(i){return parseInt(this.options.startcolor.slice(i*2+1,i*2+3),16)}.bind(this));this._delta=$R(0,2).map(function(i){return parseInt(this.options.endcolor.slice(i*2+1,i*2+3),16)-this._base[i]}.bind(this))},update:function(position){this.element.setStyle({backgroundColor:$R(0,2).inject("#",function(m,v,i){return m+((this._base[i]+(this._delta[i]*position)).round().toColorPart())}.bind(this))})},finish:function(){this.element.setStyle(Object.extend(this.oldStyle,{backgroundColor:this.options.restorecolor}))}});Effect.ScrollTo=function(element){var options=arguments[1]||{},scrollOffsets=document.viewport.getScrollOffsets(),elementOffsets=$(element).cumulativeOffset();if(options.offset){elementOffsets[1]+=options.offset}return new Effect.Tween(null,scrollOffsets.top,elementOffsets[1],options,function(p){scrollTo(scrollOffsets.left,p.round())})};Effect.Fade=function(element){element=$(element);var oldOpacity=element.getInlineOpacity();var options=Object.extend({from:element.getOpacity()||1,to:0,afterFinishInternal:function(effect){if(effect.options.to!=0){return}effect.element.hide().setStyle({opacity:oldOpacity})}},arguments[1]||{});return new Effect.Opacity(element,options)};Effect.Appear=function(element){element=$(element);var options=Object.extend({from:(element.getStyle("display")=="none"?0:element.getOpacity()||0),to:1,afterFinishInternal:function(effect){effect.element.forceRerendering()},beforeSetup:function(effect){effect.element.setOpacity(effect.options.from).show()}},arguments[1]||{});return new Effect.Opacity(element,options)};Effect.Puff=function(element){element=$(element);var oldStyle={opacity:element.getInlineOpacity(),position:element.getStyle("position"),top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};return new Effect.Parallel([new Effect.Scale(element,200,{sync:true,scaleFromCenter:true,scaleContent:true,restoreAfterFinish:true}),new Effect.Opacity(element,{sync:true,to:0})],Object.extend({duration:1,beforeSetupInternal:function(effect){Position.absolutize(effect.effects[0].element)},afterFinishInternal:function(effect){effect.effects[0].element.hide().setStyle(oldStyle)}},arguments[1]||{}))};Effect.BlindUp=function(element){element=$(element);element.makeClipping();return new Effect.Scale(element,0,Object.extend({scaleContent:false,scaleX:false,restoreAfterFinish:true,afterFinishInternal:function(effect){effect.element.hide().undoClipping()}},arguments[1]||{}))};Effect.BlindDown=function(element){element=$(element);var elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:0,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makeClipping().setStyle({height:"0px"}).show()},afterFinishInternal:function(effect){effect.element.undoClipping()}},arguments[1]||{}))};Effect.SwitchOff=function(element){element=$(element);var oldOpacity=element.getInlineOpacity();return new Effect.Appear(element,Object.extend({duration:0.4,from:0,transition:Effect.Transitions.flicker,afterFinishInternal:function(effect){new Effect.Scale(effect.element,1,{duration:0.3,scaleFromCenter:true,scaleX:false,scaleContent:false,restoreAfterFinish:true,beforeSetup:function(effect){effect.element.makePositioned().makeClipping()},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned().setStyle({opacity:oldOpacity})}})}},arguments[1]||{}))};Effect.DropOut=function(element){element=$(element);var oldStyle={top:element.getStyle("top"),left:element.getStyle("left"),opacity:element.getInlineOpacity()};return new Effect.Parallel([new Effect.Move(element,{x:0,y:100,sync:true}),new Effect.Opacity(element,{sync:true,to:0})],Object.extend({duration:0.5,beforeSetup:function(effect){effect.effects[0].element.makePositioned()},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoPositioned().setStyle(oldStyle)}},arguments[1]||{}))};Effect.Shake=function(element){element=$(element);var options=Object.extend({distance:20,duration:0.5},arguments[1]||{});var distance=parseFloat(options.distance);var split=parseFloat(options.duration)/10;var oldStyle={top:element.getStyle("top"),left:element.getStyle("left")};return new Effect.Move(element,{x:distance,y:0,duration:split,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:distance*2,y:0,duration:split*2,afterFinishInternal:function(effect){new Effect.Move(effect.element,{x:-distance,y:0,duration:split,afterFinishInternal:function(effect){effect.element.undoPositioned().setStyle(oldStyle)}})}})}})}})}})}})};Effect.SlideDown=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle("bottom");var elementDimensions=element.getDimensions();return new Effect.Scale(element,100,Object.extend({scaleContent:false,scaleX:false,scaleFrom:window.opera?0:1,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makePositioned();effect.element.down().makePositioned();if(window.opera){effect.element.setStyle({top:""})}effect.element.makeClipping().setStyle({height:"0px"}).show()},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:(effect.dims[0]-effect.element.clientHeight)+"px"})},afterFinishInternal:function(effect){effect.element.undoClipping().undoPositioned();effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom})}},arguments[1]||{}))};Effect.SlideUp=function(element){element=$(element).cleanWhitespace();var oldInnerBottom=element.down().getStyle("bottom");var elementDimensions=element.getDimensions();return new Effect.Scale(element,window.opera?0:1,Object.extend({scaleContent:false,scaleX:false,scaleMode:"box",scaleFrom:100,scaleMode:{originalHeight:elementDimensions.height,originalWidth:elementDimensions.width},restoreAfterFinish:true,afterSetup:function(effect){effect.element.makePositioned();effect.element.down().makePositioned();if(window.opera){effect.element.setStyle({top:""})}effect.element.makeClipping().show()},afterUpdateInternal:function(effect){effect.element.down().setStyle({bottom:(effect.dims[0]-effect.element.clientHeight)+"px"})},afterFinishInternal:function(effect){effect.element.hide().undoClipping().undoPositioned();effect.element.down().undoPositioned().setStyle({bottom:oldInnerBottom})}},arguments[1]||{}))};Effect.Squish=function(element){return new Effect.Scale(element,window.opera?1:0,{restoreAfterFinish:true,beforeSetup:function(effect){effect.element.makeClipping()},afterFinishInternal:function(effect){effect.element.hide().undoClipping()}})};Effect.Grow=function(element){element=$(element);var options=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.full},arguments[1]||{});var oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()};var dims=element.getDimensions();var initialMoveX,initialMoveY;var moveX,moveY;switch(options.direction){case"top-left":initialMoveX=initialMoveY=moveX=moveY=0;break;case"top-right":initialMoveX=dims.width;initialMoveY=moveY=0;moveX=-dims.width;break;case"bottom-left":initialMoveX=moveX=0;initialMoveY=dims.height;moveY=-dims.height;break;case"bottom-right":initialMoveX=dims.width;initialMoveY=dims.height;moveX=-dims.width;moveY=-dims.height;break;case"center":initialMoveX=dims.width/2;initialMoveY=dims.height/2;moveX=-dims.width/2;moveY=-dims.height/2;break}return new Effect.Move(element,{x:initialMoveX,y:initialMoveY,duration:0.01,beforeSetup:function(effect){effect.element.hide().makeClipping().makePositioned()},afterFinishInternal:function(effect){new Effect.Parallel([new Effect.Opacity(effect.element,{sync:true,to:1,from:0,transition:options.opacityTransition}),new Effect.Move(effect.element,{x:moveX,y:moveY,sync:true,transition:options.moveTransition}),new Effect.Scale(effect.element,100,{scaleMode:{originalHeight:dims.height,originalWidth:dims.width},sync:true,scaleFrom:window.opera?1:0,transition:options.scaleTransition,restoreAfterFinish:true})],Object.extend({beforeSetup:function(effect){effect.effects[0].element.setStyle({height:"0px"}).show()},afterFinishInternal:function(effect){effect.effects[0].element.undoClipping().undoPositioned().setStyle(oldStyle)}},options))}})};Effect.Shrink=function(element){element=$(element);var options=Object.extend({direction:"center",moveTransition:Effect.Transitions.sinoidal,scaleTransition:Effect.Transitions.sinoidal,opacityTransition:Effect.Transitions.none},arguments[1]||{});var oldStyle={top:element.style.top,left:element.style.left,height:element.style.height,width:element.style.width,opacity:element.getInlineOpacity()};var dims=element.getDimensions();var moveX,moveY;switch(options.direction){case"top-left":moveX=moveY=0;break;case"top-right":moveX=dims.width;moveY=0;break;case"bottom-left":moveX=0;moveY=dims.height;break;case"bottom-right":moveX=dims.width;moveY=dims.height;break;case"center":moveX=dims.width/2;moveY=dims.height/2;break}return new Effect.Parallel([new Effect.Opacity(element,{sync:true,to:0,from:1,transition:options.opacityTransition}),new Effect.Scale(element,window.opera?1:0,{sync:true,transition:options.scaleTransition,restoreAfterFinish:true}),new Effect.Move(element,{x:moveX,y:moveY,sync:true,transition:options.moveTransition})],Object.extend({beforeStartInternal:function(effect){effect.effects[0].element.makePositioned().makeClipping()},afterFinishInternal:function(effect){effect.effects[0].element.hide().undoClipping().undoPositioned().setStyle(oldStyle)}},options))};Effect.Pulsate=function(element){element=$(element);var options=arguments[1]||{},oldOpacity=element.getInlineOpacity(),transition=options.transition||Effect.Transitions.linear,reverser=function(pos){return 1-transition((-Math.cos((pos*(options.pulses||5)*2)*Math.PI)/2)+0.5)};return new Effect.Opacity(element,Object.extend(Object.extend({duration:2,from:0,afterFinishInternal:function(effect){effect.element.setStyle({opacity:oldOpacity})}},options),{transition:reverser}))};Effect.Fold=function(element){element=$(element);var oldStyle={top:element.style.top,left:element.style.left,width:element.style.width,height:element.style.height};element.makeClipping();return new Effect.Scale(element,5,Object.extend({scaleContent:false,scaleX:false,afterFinishInternal:function(effect){new Effect.Scale(element,1,{scaleContent:false,scaleY:false,afterFinishInternal:function(effect){effect.element.hide().undoClipping().setStyle(oldStyle)}})}},arguments[1]||{}))};Effect.Morph=Class.create(Effect.Base,{initialize:function(element){this.element=$(element);if(!this.element){throw (Effect._elementDoesNotExistError)}var options=Object.extend({style:{}},arguments[1]||{});if(!Object.isString(options.style)){this.style=$H(options.style)}else{if(options.style.include(":")){this.style=options.style.parseStyle()}else{this.element.addClassName(options.style);this.style=$H(this.element.getStyles());this.element.removeClassName(options.style);var css=this.element.getStyles();this.style=this.style.reject(function(style){return style.value==css[style.key]});options.afterFinishInternal=function(effect){effect.element.addClassName(effect.options.style);effect.transforms.each(function(transform){effect.element.style[transform.style]=""})}}}this.start(options)},setup:function(){function parseColor(color){if(!color||["rgba(0, 0, 0, 0)","transparent"].include(color)){color="#ffffff"}color=color.parseColor();return $R(0,2).map(function(i){return parseInt(color.slice(i*2+1,i*2+3),16)})}this.transforms=this.style.map(function(pair){var property=pair[0],value=pair[1],unit=null;if(value.parseColor("#zzzzzz")!="#zzzzzz"){value=value.parseColor();unit="color"}else{if(property=="opacity"){value=parseFloat(value);if(Prototype.Browser.IE&&(!this.element.currentStyle.hasLayout)){this.element.setStyle({zoom:1})}}else{if(Element.CSS_LENGTH.test(value)){var components=value.match(/^([\+\-]?[0-9\.]+)(.*)$/);value=parseFloat(components[1]);unit=(components.length==3)?components[2]:null}}}var originalValue=this.element.getStyle(property);return{style:property.camelize(),originalValue:unit=="color"?parseColor(originalValue):parseFloat(originalValue||0),targetValue:unit=="color"?parseColor(value):value,unit:unit}}.bind(this)).reject(function(transform){return((transform.originalValue==transform.targetValue)||(transform.unit!="color"&&(isNaN(transform.originalValue)||isNaN(transform.targetValue))))})},update:function(position){var style={},transform,i=this.transforms.length;while(i--){style[(transform=this.transforms[i]).style]=transform.unit=="color"?"#"+(Math.round(transform.originalValue[0]+(transform.targetValue[0]-transform.originalValue[0])*position)).toColorPart()+(Math.round(transform.originalValue[1]+(transform.targetValue[1]-transform.originalValue[1])*position)).toColorPart()+(Math.round(transform.originalValue[2]+(transform.targetValue[2]-transform.originalValue[2])*position)).toColorPart():(transform.originalValue+(transform.targetValue-transform.originalValue)*position).toFixed(3)+(transform.unit===null?"":transform.unit)}this.element.setStyle(style,true)}});Effect.Transform=Class.create({initialize:function(tracks){this.tracks=[];this.options=arguments[1]||{};this.addTracks(tracks)},addTracks:function(tracks){tracks.each(function(track){track=$H(track);var data=track.values().first();this.tracks.push($H({ids:track.keys().first(),effect:Effect.Morph,options:{style:data}}))}.bind(this));return this},play:function(){return new Effect.Parallel(this.tracks.map(function(track){var ids=track.get("ids"),effect=track.get("effect"),options=track.get("options");var elements=[$(ids)||$$(ids)].flatten();return elements.map(function(e){return new effect(e,Object.extend({sync:true},options))})}).flatten(),this.options)}});Element.CSS_PROPERTIES=$w("backgroundColor backgroundPosition borderBottomColor borderBottomStyle borderBottomWidth borderLeftColor borderLeftStyle borderLeftWidth borderRightColor borderRightStyle borderRightWidth borderSpacing borderTopColor borderTopStyle borderTopWidth bottom clip color fontSize fontWeight height left letterSpacing lineHeight marginBottom marginLeft marginRight marginTop markerOffset maxHeight maxWidth minHeight minWidth opacity outlineColor outlineOffset outlineWidth paddingBottom paddingLeft paddingRight paddingTop right textIndent top width wordSpacing zIndex");Element.CSS_LENGTH=/^(([\+\-]?[0-9\.]+)(em|ex|px|in|cm|mm|pt|pc|\%))|0$/;String.__parseStyleElement=document.createElement("div");String.prototype.parseStyle=function(){var style,styleRules=$H();if(Prototype.Browser.WebKit){style=new Element("div",{style:this}).style}else{String.__parseStyleElement.innerHTML='<div style="'+this+'"></div>';style=String.__parseStyleElement.childNodes[0].style}Element.CSS_PROPERTIES.each(function(property){if(style[property]){styleRules.set(property,style[property])}});if(Prototype.Browser.IE&&this.include("opacity")){styleRules.set("opacity",this.match(/opacity:\s*((?:0|1)?(?:\.\d*)?)/)[1])}return styleRules};if(document.defaultView&&document.defaultView.getComputedStyle){Element.getStyles=function(element){var css=document.defaultView.getComputedStyle($(element),null);return Element.CSS_PROPERTIES.inject({},function(styles,property){styles[property]=css[property];return styles})}}else{Element.getStyles=function(element){element=$(element);var css=element.currentStyle,styles;styles=Element.CSS_PROPERTIES.inject({},function(results,property){results[property]=css[property];return results});if(!styles.opacity){styles.opacity=element.getOpacity()}return styles}}Effect.Methods={morph:function(element,style){element=$(element);new Effect.Morph(element,Object.extend({style:style},arguments[2]||{}));return element},visualEffect:function(element,effect,options){element=$(element);var s=effect.dasherize().camelize(),klass=s.charAt(0).toUpperCase()+s.substring(1);new Effect[klass](element,options);return element},highlight:function(element,options){element=$(element);new Effect.Highlight(element,options);return element}};$w("fade appear grow shrink fold blindUp blindDown slideUp slideDown pulsate shake puff squish switchOff dropOut").each(function(effect){Effect.Methods[effect]=function(element,options){element=$(element);Effect[effect.charAt(0).toUpperCase()+effect.substring(1)](element,options);return element}});$w("getInlineOpacity forceRerendering setContentZoom collectTextNodes collectTextNodesIgnoreClass getStyles").each(function(f){Effect.Methods[f]=Element[f]});Element.addMethods(Effect.Methods);if(Object.isUndefined(Effect)){throw ("dragdrop.js requires including script.aculo.us' effects.js library")}var Droppables={drops:[],remove:function(element){this.drops=this.drops.reject(function(d){return d.element==$(element)})},add:function(element){element=$(element);var options=Object.extend({greedy:true,hoverclass:null,tree:false},arguments[1]||{});if(options.containment){options._containers=[];var containment=options.containment;if(Object.isArray(containment)){containment.each(function(c){options._containers.push($(c))})}else{options._containers.push($(containment))}}if(options.accept){options.accept=[options.accept].flatten()}Element.makePositioned(element);options.element=element;this.drops.push(options)},findDeepestChild:function(drops){deepest=drops[0];for(i=1;i<drops.length;++i){if(Element.isParent(drops[i].element,deepest.element)){deepest=drops[i]}}return deepest},isContained:function(element,drop){var containmentNode;if(drop.tree){containmentNode=element.treeNode}else{containmentNode=element.parentNode}return drop._containers.detect(function(c){return containmentNode==c})},isAffected:function(point,element,drop){return((drop.element!=element)&&((!drop._containers)||this.isContained(element,drop))&&((!drop.accept)||(Element.classNames(element).detect(function(v){return drop.accept.include(v)})))&&Position.within(drop.element,point[0],point[1]))},deactivate:function(drop){if(drop.hoverclass){Element.removeClassName(drop.element,drop.hoverclass)}this.last_active=null},activate:function(drop){if(drop.hoverclass){Element.addClassName(drop.element,drop.hoverclass)}this.last_active=drop},show:function(point,element){if(!this.drops.length){return}var drop,affected=[];this.drops.each(function(drop){if(Droppables.isAffected(point,element,drop)){affected.push(drop)}});if(affected.length>0){drop=Droppables.findDeepestChild(affected)}if(this.last_active&&this.last_active!=drop){this.deactivate(this.last_active)}if(drop){Position.within(drop.element,point[0],point[1]);if(drop.onHover){drop.onHover(element,drop.element,Position.overlap(drop.overlap,drop.element))}if(drop!=this.last_active){Droppables.activate(drop)}}},fire:function(event,element){if(!this.last_active){return}Position.prepare();if(this.isAffected([Event.pointerX(event),Event.pointerY(event)],element,this.last_active)){if(this.last_active.onDrop){this.last_active.onDrop(element,this.last_active.element,event);return true}}},reset:function(){if(this.last_active){this.deactivate(this.last_active)}}};var Draggables={drags:[],observers:[],register:function(draggable){if(this.drags.length==0){this.eventMouseUp=this.endDrag.bindAsEventListener(this);this.eventMouseMove=this.updateDrag.bindAsEventListener(this);this.eventKeypress=this.keyPress.bindAsEventListener(this);Event.observe(document,"mouseup",this.eventMouseUp);Event.observe(document,"mousemove",this.eventMouseMove);Event.observe(document,"keypress",this.eventKeypress)}this.drags.push(draggable)},unregister:function(draggable){this.drags=this.drags.reject(function(d){return d==draggable});if(this.drags.length==0){Event.stopObserving(document,"mouseup",this.eventMouseUp);Event.stopObserving(document,"mousemove",this.eventMouseMove);Event.stopObserving(document,"keypress",this.eventKeypress)}},activate:function(draggable){if(draggable.options.delay){this._timeout=setTimeout(function(){Draggables._timeout=null;window.focus();Draggables.activeDraggable=draggable}.bind(this),draggable.options.delay)}else{window.focus();this.activeDraggable=draggable}},deactivate:function(){this.activeDraggable=null},updateDrag:function(event){if(!this.activeDraggable){return}var pointer=[Event.pointerX(event),Event.pointerY(event)];if(this._lastPointer&&(this._lastPointer.inspect()==pointer.inspect())){return}this._lastPointer=pointer;this.activeDraggable.updateDrag(event,pointer)},endDrag:function(event){if(this._timeout){clearTimeout(this._timeout);this._timeout=null}if(!this.activeDraggable){return}this._lastPointer=null;this.activeDraggable.endDrag(event);this.activeDraggable=null},keyPress:function(event){if(this.activeDraggable){this.activeDraggable.keyPress(event)}},addObserver:function(observer){this.observers.push(observer);this._cacheObserverCallbacks()},removeObserver:function(element){this.observers=this.observers.reject(function(o){return o.element==element});this._cacheObserverCallbacks()},notify:function(eventName,draggable,event){if(this[eventName+"Count"]>0){this.observers.each(function(o){if(o[eventName]){o[eventName](eventName,draggable,event)}})}if(draggable.options[eventName]){draggable.options[eventName](draggable,event)}},_cacheObserverCallbacks:function(){["onStart","onEnd","onDrag"].each(function(eventName){Draggables[eventName+"Count"]=Draggables.observers.select(function(o){return o[eventName]}).length})}};var Draggable=Class.create({initialize:function(element){var defaults={handle:false,reverteffect:function(element,top_offset,left_offset){var dur=Math.sqrt(Math.abs(top_offset^2)+Math.abs(left_offset^2))*0.02;new Effect.Move(element,{x:-left_offset,y:-top_offset,duration:dur,queue:{scope:"_draggable",position:"end"}})},endeffect:function(element){var toOpacity=Object.isNumber(element._opacity)?element._opacity:1;new Effect.Opacity(element,{duration:0.2,from:0.7,to:toOpacity,queue:{scope:"_draggable",position:"end"},afterFinish:function(){Draggable._dragging[element]=false}})},zindex:1000,revert:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,snap:false,delay:0};if(!arguments[1]||Object.isUndefined(arguments[1].endeffect)){Object.extend(defaults,{starteffect:function(element){element._opacity=Element.getOpacity(element);Draggable._dragging[element]=true;new Effect.Opacity(element,{duration:0.2,from:element._opacity,to:0.7})}})}var options=Object.extend(defaults,arguments[1]||{});this.element=$(element);if(options.handle&&Object.isString(options.handle)){this.handle=this.element.down("."+options.handle,0)}if(!this.handle){this.handle=$(options.handle)}if(!this.handle){this.handle=this.element}if(options.scroll&&!options.scroll.scrollTo&&!options.scroll.outerHTML){options.scroll=$(options.scroll);this._isScrollChild=Element.childOf(this.element,options.scroll)}Element.makePositioned(this.element);this.options=options;this.dragging=false;this.eventMouseDown=this.initDrag.bindAsEventListener(this);Event.observe(this.handle,"mousedown",this.eventMouseDown);Draggables.register(this)},destroy:function(){Event.stopObserving(this.handle,"mousedown",this.eventMouseDown);Draggables.unregister(this)},currentDelta:function(){return([parseInt(Element.getStyle(this.element,"left")||"0"),parseInt(Element.getStyle(this.element,"top")||"0")])},initDrag:function(event){if(!Object.isUndefined(Draggable._dragging[this.element])&&Draggable._dragging[this.element]){return}if(Event.isLeftClick(event)){var src=Event.element(event);if((tag_name=src.tagName.toUpperCase())&&(tag_name=="INPUT"||tag_name=="SELECT"||tag_name=="OPTION"||tag_name=="BUTTON"||tag_name=="TEXTAREA")){return}var pointer=[Event.pointerX(event),Event.pointerY(event)];var pos=this.element.cumulativeOffset();this.offset=[0,1].map(function(i){return(pointer[i]-pos[i])});Draggables.activate(this);Event.stop(event)}},startDrag:function(event){this.dragging=true;if(!this.delta){this.delta=this.currentDelta()}if(this.options.zindex){this.originalZ=parseInt(Element.getStyle(this.element,"z-index")||0);this.element.style.zIndex=this.options.zindex}if(this.options.ghosting){this._clone=this.element.cloneNode(true);this._originallyAbsolute=(this.element.getStyle("position")=="absolute");if(!this._originallyAbsolute){Position.absolutize(this.element)}this.element.parentNode.insertBefore(this._clone,this.element)}if(this.options.scroll){if(this.options.scroll==window){var where=this._getWindowScroll(this.options.scroll);this.originalScrollLeft=where.left;this.originalScrollTop=where.top}else{this.originalScrollLeft=this.options.scroll.scrollLeft;this.originalScrollTop=this.options.scroll.scrollTop}}Draggables.notify("onStart",this,event);if(this.options.starteffect){this.options.starteffect(this.element)}},updateDrag:function(event,pointer){if(!this.dragging){this.startDrag(event)}if(!this.options.quiet){Position.prepare();Droppables.show(pointer,this.element)}Draggables.notify("onDrag",this,event);this.draw(pointer);if(this.options.change){this.options.change(this)}if(this.options.scroll){this.stopScrolling();var p;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){p=[left,top,left+width,top+height]}}else{p=Position.page(this.options.scroll).toArray();p[0]+=this.options.scroll.scrollLeft+Position.deltaX;p[1]+=this.options.scroll.scrollTop+Position.deltaY;p.push(p[0]+this.options.scroll.offsetWidth);p.push(p[1]+this.options.scroll.offsetHeight)}var speed=[0,0];if(pointer[0]<(p[0]+this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[0]+this.options.scrollSensitivity)}if(pointer[1]<(p[1]+this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[1]+this.options.scrollSensitivity)}if(pointer[0]>(p[2]-this.options.scrollSensitivity)){speed[0]=pointer[0]-(p[2]-this.options.scrollSensitivity)}if(pointer[1]>(p[3]-this.options.scrollSensitivity)){speed[1]=pointer[1]-(p[3]-this.options.scrollSensitivity)}this.startScrolling(speed)}if(Prototype.Browser.WebKit){window.scrollBy(0,0)}Event.stop(event)},finishDrag:function(event,success){this.dragging=false;if(this.options.quiet){Position.prepare();var pointer=[Event.pointerX(event),Event.pointerY(event)];Droppables.show(pointer,this.element)}if(this.options.ghosting){if(!this._originallyAbsolute){Position.relativize(this.element)}delete this._originallyAbsolute;Element.remove(this._clone);this._clone=null}var dropped=false;if(success){dropped=Droppables.fire(event,this.element);if(!dropped){dropped=false}}if(dropped&&this.options.onDropped){this.options.onDropped(this.element)}Draggables.notify("onEnd",this,event);var revert=this.options.revert;if(revert&&Object.isFunction(revert)){revert=revert(this.element)}var d=this.currentDelta();if(revert&&this.options.reverteffect){if(dropped==0||revert!="failure"){this.options.reverteffect(this.element,d[1]-this.delta[1],d[0]-this.delta[0])}}else{this.delta=d}if(this.options.zindex){this.element.style.zIndex=this.originalZ}if(this.options.endeffect){this.options.endeffect(this.element)}Draggables.deactivate(this);Droppables.reset()},keyPress:function(event){if(event.keyCode!=Event.KEY_ESC){return}this.finishDrag(event,false);Event.stop(event)},endDrag:function(event){if(!this.dragging){return}this.stopScrolling();this.finishDrag(event,true);Event.stop(event)},draw:function(point){var pos=this.element.cumulativeOffset();if(this.options.ghosting){var r=Position.realOffset(this.element);pos[0]+=r[0]-Position.deltaX;pos[1]+=r[1]-Position.deltaY}var d=this.currentDelta();pos[0]-=d[0];pos[1]-=d[1];if(this.options.scroll&&(this.options.scroll!=window&&this._isScrollChild)){pos[0]-=this.options.scroll.scrollLeft-this.originalScrollLeft;pos[1]-=this.options.scroll.scrollTop-this.originalScrollTop}var p=[0,1].map(function(i){return(point[i]-pos[i]-this.offset[i])}.bind(this));if(this.options.snap){if(Object.isFunction(this.options.snap)){p=this.options.snap(p[0],p[1],this)}else{if(Object.isArray(this.options.snap)){p=p.map(function(v,i){return(v/this.options.snap[i]).round()*this.options.snap[i]}.bind(this))}else{p=p.map(function(v){return(v/this.options.snap).round()*this.options.snap}.bind(this))}}}var style=this.element.style;if((!this.options.constraint)||(this.options.constraint=="horizontal")){style.left=p[0]+"px"}if((!this.options.constraint)||(this.options.constraint=="vertical")){style.top=p[1]+"px"}if(style.visibility=="hidden"){style.visibility=""}},stopScrolling:function(){if(this.scrollInterval){clearInterval(this.scrollInterval);this.scrollInterval=null;Draggables._lastScrollPointer=null}},startScrolling:function(speed){if(!(speed[0]||speed[1])){return}this.scrollSpeed=[speed[0]*this.options.scrollSpeed,speed[1]*this.options.scrollSpeed];this.lastScrolled=new Date();this.scrollInterval=setInterval(this.scroll.bind(this),10)},scroll:function(){var current=new Date();var delta=current-this.lastScrolled;this.lastScrolled=current;if(this.options.scroll==window){with(this._getWindowScroll(this.options.scroll)){if(this.scrollSpeed[0]||this.scrollSpeed[1]){var d=delta/1000;this.options.scroll.scrollTo(left+d*this.scrollSpeed[0],top+d*this.scrollSpeed[1])}}}else{this.options.scroll.scrollLeft+=this.scrollSpeed[0]*delta/1000;this.options.scroll.scrollTop+=this.scrollSpeed[1]*delta/1000}Position.prepare();Droppables.show(Draggables._lastPointer,this.element);Draggables.notify("onDrag",this);if(this._isScrollChild){Draggables._lastScrollPointer=Draggables._lastScrollPointer||$A(Draggables._lastPointer);Draggables._lastScrollPointer[0]+=this.scrollSpeed[0]*delta/1000;Draggables._lastScrollPointer[1]+=this.scrollSpeed[1]*delta/1000;if(Draggables._lastScrollPointer[0]<0){Draggables._lastScrollPointer[0]=0}if(Draggables._lastScrollPointer[1]<0){Draggables._lastScrollPointer[1]=0}this.draw(Draggables._lastScrollPointer)}if(this.options.change){this.options.change(this)}},_getWindowScroll:function(w){var T,L,W,H;with(w.document){if(w.document.documentElement&&documentElement.scrollTop){T=documentElement.scrollTop;L=documentElement.scrollLeft}else{if(w.document.body){T=body.scrollTop;L=body.scrollLeft}}if(w.innerWidth){W=w.innerWidth;H=w.innerHeight}else{if(w.document.documentElement&&documentElement.clientWidth){W=documentElement.clientWidth;H=documentElement.clientHeight}else{W=body.offsetWidth;H=body.offsetHeight}}}return{top:T,left:L,width:W,height:H}}});Draggable._dragging={};var SortableObserver=Class.create({initialize:function(element,observer){this.element=$(element);this.observer=observer;this.lastValue=Sortable.serialize(this.element)},onStart:function(){this.lastValue=Sortable.serialize(this.element)},onEnd:function(){Sortable.unmark();if(this.lastValue!=Sortable.serialize(this.element)){this.observer(this.element)}}});var Sortable={SERIALIZE_RULE:/^[^_\-](?:[A-Za-z0-9\-\_]*)[_](.*)$/,sortables:{},_findRootElement:function(element){while(element.tagName.toUpperCase()!="BODY"){if(element.id&&Sortable.sortables[element.id]){return element}element=element.parentNode}},options:function(element){element=Sortable._findRootElement($(element));if(!element){return}return Sortable.sortables[element.id]},destroy:function(element){element=$(element);var s=Sortable.sortables[element.id];if(s){Draggables.removeObserver(s.element);s.droppables.each(function(d){Droppables.remove(d)});s.draggables.invoke("destroy");delete Sortable.sortables[s.element.id]}},create:function(element){element=$(element);var options=Object.extend({element:element,tag:"li",dropOnEmpty:false,tree:false,treeTag:"ul",overlap:"vertical",constraint:"vertical",containment:element,handle:false,only:false,delay:0,hoverclass:null,ghosting:false,quiet:false,scroll:false,scrollSensitivity:20,scrollSpeed:15,format:this.SERIALIZE_RULE,elements:false,handles:false,onChange:Prototype.emptyFunction,onUpdate:Prototype.emptyFunction},arguments[1]||{});this.destroy(element);var options_for_draggable={revert:true,quiet:options.quiet,scroll:options.scroll,scrollSpeed:options.scrollSpeed,scrollSensitivity:options.scrollSensitivity,delay:options.delay,ghosting:options.ghosting,constraint:options.constraint,handle:options.handle};if(options.starteffect){options_for_draggable.starteffect=options.starteffect}if(options.reverteffect){options_for_draggable.reverteffect=options.reverteffect}else{if(options.ghosting){options_for_draggable.reverteffect=function(element){element.style.top=0;element.style.left=0}}}if(options.endeffect){options_for_draggable.endeffect=options.endeffect}if(options.zindex){options_for_draggable.zindex=options.zindex}var options_for_droppable={overlap:options.overlap,containment:options.containment,tree:options.tree,hoverclass:options.hoverclass,onHover:Sortable.onHover};var options_for_tree={onHover:Sortable.onEmptyHover,overlap:options.overlap,containment:options.containment,hoverclass:options.hoverclass};Element.cleanWhitespace(element);options.draggables=[];options.droppables=[];if(options.dropOnEmpty||options.tree){Droppables.add(element,options_for_tree);options.droppables.push(element)}(options.elements||this.findElements(element,options)||[]).each(function(e,i){var handle=options.handles?$(options.handles[i]):(options.handle?$(e).select("."+options.handle)[0]:e);options.draggables.push(new Draggable(e,Object.extend(options_for_draggable,{handle:handle})));Droppables.add(e,options_for_droppable);if(options.tree){e.treeNode=element}options.droppables.push(e)});if(options.tree){(Sortable.findTreeElements(element,options)||[]).each(function(e){Droppables.add(e,options_for_tree);e.treeNode=element;options.droppables.push(e)})}this.sortables[element.identify()]=options;Draggables.addObserver(new SortableObserver(element,options.onUpdate))},findElements:function(element,options){return Element.findChildren(element,options.only,options.tree?true:false,options.tag)},findTreeElements:function(element,options){return Element.findChildren(element,options.only,options.tree?true:false,options.treeTag)},onHover:function(element,dropon,overlap){if(Element.isParent(dropon,element)){return}if(overlap>0.33&&overlap<0.66&&Sortable.options(dropon).tree){return}else{if(overlap>0.5){Sortable.mark(dropon,"before");if(dropon.previousSibling!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden";dropon.parentNode.insertBefore(element,dropon);if(dropon.parentNode!=oldParentNode){Sortable.options(oldParentNode).onChange(element)}Sortable.options(dropon.parentNode).onChange(element)}}else{Sortable.mark(dropon,"after");var nextElement=dropon.nextSibling||null;if(nextElement!=element){var oldParentNode=element.parentNode;element.style.visibility="hidden";dropon.parentNode.insertBefore(element,nextElement);if(dropon.parentNode!=oldParentNode){Sortable.options(oldParentNode).onChange(element)}Sortable.options(dropon.parentNode).onChange(element)}}}},onEmptyHover:function(element,dropon,overlap){var oldParentNode=element.parentNode;var droponOptions=Sortable.options(dropon);if(!Element.isParent(dropon,element)){var index;var children=Sortable.findElements(dropon,{tag:droponOptions.tag,only:droponOptions.only});var child=null;if(children){var offset=Element.offsetSize(dropon,droponOptions.overlap)*(1-overlap);for(index=0;index<children.length;index+=1){if(offset-Element.offsetSize(children[index],droponOptions.overlap)>=0){offset-=Element.offsetSize(children[index],droponOptions.overlap)}else{if(offset-(Element.offsetSize(children[index],droponOptions.overlap)/2)>=0){child=index+1<children.length?children[index+1]:null;break}else{child=children[index];break}}}}dropon.insertBefore(element,child);Sortable.options(oldParentNode).onChange(element);droponOptions.onChange(element)}},unmark:function(){if(Sortable._marker){Sortable._marker.hide()}},mark:function(dropon,position){var sortable=Sortable.options(dropon.parentNode);if(sortable&&!sortable.ghosting){return}if(!Sortable._marker){Sortable._marker=($("dropmarker")||Element.extend(document.createElement("DIV"))).hide().addClassName("dropmarker").setStyle({position:"absolute"});document.getElementsByTagName("body").item(0).appendChild(Sortable._marker)}var offsets=dropon.cumulativeOffset();Sortable._marker.setStyle({left:offsets[0]+"px",top:offsets[1]+"px"});if(position=="after"){if(sortable.overlap=="horizontal"){Sortable._marker.setStyle({left:(offsets[0]+dropon.clientWidth)+"px"})}else{Sortable._marker.setStyle({top:(offsets[1]+dropon.clientHeight)+"px"})}}Sortable._marker.show()},_tree:function(element,options,parent){var children=Sortable.findElements(element,options)||[];for(var i=0;i<children.length;++i){var match=children[i].id.match(options.format);if(!match){continue}var child={id:encodeURIComponent(match?match[1]:null),element:element,parent:parent,children:[],position:parent.children.length,container:$(children[i]).down(options.treeTag)};if(child.container){this._tree(child.container,options,child)}parent.children.push(child)}return parent},tree:function(element){element=$(element);var sortableOptions=this.options(element);var options=Object.extend({tag:sortableOptions.tag,treeTag:sortableOptions.treeTag,only:sortableOptions.only,name:element.id,format:sortableOptions.format},arguments[1]||{});var root={id:null,parent:null,children:[],container:element,position:0};return Sortable._tree(element,options,root)},_constructIndex:function(node){var index="";do{if(node.id){index="["+node.position+"]"+index}}while((node=node.parent)!=null);return index},sequence:function(element){element=$(element);var options=Object.extend(this.options(element),arguments[1]||{});return $(this.findElements(element,options)||[]).map(function(item){return item.id.match(options.format)?item.id.match(options.format)[1]:""})},setSequence:function(element,new_sequence){element=$(element);var options=Object.extend(this.options(element),arguments[2]||{});var nodeMap={};this.findElements(element,options).each(function(n){if(n.id.match(options.format)){nodeMap[n.id.match(options.format)[1]]=[n,n.parentNode]}n.parentNode.removeChild(n)});new_sequence.each(function(ident){var n=nodeMap[ident];if(n){n[1].appendChild(n[0]);delete nodeMap[ident]}})},serialize:function(element){element=$(element);var options=Object.extend(Sortable.options(element),arguments[1]||{});var name=encodeURIComponent((arguments[1]&&arguments[1].name)?arguments[1].name:element.id);if(options.tree){return Sortable.tree(element,arguments[1]).children.map(function(item){return[name+Sortable._constructIndex(item)+"[id]="+encodeURIComponent(item.id)].concat(item.children.map(arguments.callee))}).flatten().join("&")}else{return Sortable.sequence(element,arguments[1]).map(function(item){return name+"[]="+encodeURIComponent(item)}).join("&")}}};Element.isParent=function(child,element){if(!child.parentNode||child==element){return false}if(child.parentNode==element){return true}return Element.isParent(child.parentNode,element)};Element.findChildren=function(element,only,recursive,tagName){if(!element.hasChildNodes()){return null}tagName=tagName.toUpperCase();if(only){only=[only].flatten()}var elements=[];$A(element.childNodes).each(function(e){if(e.tagName&&e.tagName.toUpperCase()==tagName&&(!only||(Element.classNames(e).detect(function(v){return only.include(v)})))){elements.push(e)}if(recursive){var grandchildren=Element.findChildren(e,only,recursive,tagName);if(grandchildren){elements.push(grandchildren)}}});return(elements.length>0?elements.flatten():[])};Element.offsetSize=function(element,type){return element["offset"+((type=="vertical"||type=="height")?"Height":"Width")]};document.observe("dom:loaded",function(){if(!$(document.body).hasClassName("identity_validation")){return}var valid={},username,password,confirmation,request;var form=$(document.body).down("form.identity_form");var originalUsername=$F("username");function get(id){if($(id)){return $F(id)}}function validateElement(element){element.up(".validated_field").removeClassName("invalid").addClassName("valid");valid[element.id]=true}function invalidateElement(element,message){var field=element.up(".validated_field");field.removeClassName("valid").addClassName("invalid");field.down("p.error").update(message);valid[element.id]=false}function resetElement(element){var field=element.up(".validated_field");field.removeClassName("valid").removeClassName("invalid");field.down("p.error").update("");valid[element.id]=false}function getErrorForFirstName(){if(!$("first_name").getValue().length){return form.readAttribute("data-first-name-required")}}function getErrorForUsername(){username=$("username").getValue().strip().gsub(/\s+/," ");if(username.length<3){return form.readAttribute("data-username-too-short")}}function checkUsernameAvailability(){var usernameAvailabilityUrl=form.readAttribute("data-username-availability-url");new Ajax.Request(usernameAvailabilityUrl,{parameters:{username:username,first_name:get("first_name"),last_name:get("last_name")},method:"get",evalJSON:true,onComplete:function(transport){var result=transport.responseJSON;if(originalUsername.length&&result.username==originalUsername){return}if(result&&result.username==username&&username&&!result.available){var message=form.readAttribute("data-username-unavailable");if($("username_suggestions")){message+=" "+form.readAttribute("data-try-another-username")}invalidateElement($("username"),message);suggestUsernames(result.suggestions)}}})}function suggestUsernames(suggestions){if(!$("username_suggestions")){return}if(suggestions&&suggestions.length){$("username_suggestions").show().down("ul").update(suggestions.map(function(suggestedUsername){var escapedUsername=suggestedUsername.escapeHTML();return"<li><a href=# data='"+escapedUsername+"'>"+escapedUsername+"</a></li>"}).join(""))}else{hideUsernameSuggestions()}}function hideUsernameSuggestions(){if(!$("username_suggestions")){return}$("username_suggestions").hide()}function getErrorForPassword(){password=$("password").getValue();if(password.length<6){return form.readAttribute("data-password-too-short")}else{if(password=="password"){return form.readAttribute("data-password-not-password")}else{if(username&&username.length&&password==username){return form.readAttribute("data-password-same-as-username")}}}}function getErrorForPasswordConfirmation(){confirmation=$("password_confirmation").getValue();if(confirmation.length&&confirmation!=password){return form.readAttribute("data-password-mismatch")}else{if(confirmation.length<6){return form.readAttribute("data-password-too-short")}}}function performInteractiveValidationFor(element,validator,existingValue){var value=element.getValue();if(element.getValue()==existingValue){return}if(!value.length||validator()){resetElement(element)}else{validateElement(element)}}function performValidationFor(element,validator,complainAboutBlankValues){var message=(validator||Prototype.K)(),value=element.getValue();if(!value.length){if(complainAboutBlankValues){invalidateElement(element,message)}else{resetElement(element)}return false}else{if(message){invalidateElement(element,message);return false}else{validateElement(element);return true}}}function dummifyElement(element){if(element.hasClassName("dummy")){element.setValue("                      ").writeAttribute("data-dummy","true")}}function undummifyElement(element){if(element.readAttribute("data-dummy")){element.setValue("").writeAttribute("data-dummy",null)}}function dummify(){if(!$F("password")&&!$F("password_confirmation")){dummifyElement($("password"));dummifyElement($("password_confirmation"))}}function undummify(){undummifyElement($("password"));undummifyElement($("password_confirmation"))}$("first_name").observe("keyup",function(event){resetElement(this)});$("first_name").observe("blur",function(event){performValidationFor(this,getErrorForFirstName)});$("username").observe("keyup",function(event){hideUsernameSuggestions();resetElement(this)});$("username").observe("blur",function(event){hideUsernameSuggestions();if(performValidationFor(this,getErrorForUsername)){checkUsernameAvailability()}});$("password").observe("focus",function(event){undummify()});$("password").observe("keyup",function(event){performInteractiveValidationFor(this,getErrorForPassword,password)});$("password").observe("blur",function(event){performValidationFor(this,getErrorForPassword);dummify()});$("password_confirmation").observe("focus",function(event){undummify()});$("password_confirmation").observe("keyup",function(event){if(event.keyCode!=Event.KEY_RETURN){performInteractiveValidationFor(this,getErrorForPasswordConfirmation)}});$("password_confirmation").observe("blur",function(event){performValidationFor(this,getErrorForPasswordConfirmation);dummify()});form.observe("click",function(event){var element=event.findElement(".username_suggestions a[data]");if(element){username=element.readAttribute("data");$("username").setValue(username);validateElement($("username"));hideUsernameSuggestions();checkUsernameAvailability();$("password").focus();event.stop()}});form.observe("submit",function(event){performValidationFor($("first_name"),getErrorForFirstName,true);performValidationFor($("username"),getErrorForUsername,true);if($("password").hasClassName("dummy")){undummify();valid.password=valid.password_confirmation=true}else{performValidationFor($("password"),getErrorForPassword,true);performValidationFor($("password_confirmation"),getErrorForPasswordConfirmation,true)}if(!valid.first_name||!valid.username||!valid.password||!valid.password_confirmation){event.stop()}});dummify();if($("username").hasClassName("autofocus")){(function(){$("username").focus()}).defer()}});Element.addMethods({trace:function(element,expression){element=$(element);if(element.match(expression)){return element}return element.up(expression)}});Element.addMethods({upwards:function(element,iterator){while(element=$(element)){if(element.URL!==undefined){return}if(iterator(element)){return element}element=element.parentNode}}});var HoverObserver=Class.create({initialize:function(element,options){this.element=$(element);this.options=Object.extend(Object.clone(HoverObserver.Options),options||{});this.start()},start:function(){if(!this.observers){var events=$w(this.options.clickToHover?"click":"mouseover mouseout");this.observers=events.map(function(name){var handler=this["on"+name.capitalize()].bind(this);this.element.observe(name,handler);return{name:name,handler:handler}}.bind(this))}},stop:function(){if(this.observers){this.observers.each(function(info){this.element.stopObserving(info.name,info.handler)}.bind(this));delete this.observers}},onClick:function(event){var element=this.activeHoverElement=event.findElement();var container=this.getContainerForElement(element);if(container){if(this.activeContainer&&container==this.activeContainer){return this.deactivateContainer()}this.activateContainer(container)}},onMouseover:function(event){var element=this.activeHoverElement=event.findElement();var container=this.getContainerForElement(element);if(container){if(this.activeContainer){this.activateContainer(container)}else{this.startDelayedActivation(container)}}else{this.startDelayedDeactivation()}},onMouseout:function(event){delete this.activeHoverElement;this.startDelayedDeactivation()},activateContainer:function(container){var memo={toElement:container};this.stopDelayedDeactivation();if(this.activeContainer){if(this.activeContainer==container){return}memo.fromElement=this.activeContainer;this.deactivateContainer(memo)}this.activeContainer=container;this.activeContainer.fire(this.options.activationEvent,memo);this.activeContainer.addClassName(this.options.activeClassName)},deactivateContainer:function(memo){if(this.activeContainer){try{this.activeContainer.removeClassName(this.options.activeClassName);this.activeContainer.fire(this.options.deactivationEvent,memo)}catch(e){}delete this.activeContainer}},startDelayedActivation:function(container){if(this.options.activationDelay){(function(){if(container==this.getContainerForElement(this.activeHoverElement)){this.activateContainer(container)}}).bind(this).delay(this.options.activationDelay)}else{this.activateContainer(container)}},startDelayedDeactivation:function(){if(this.options.deactivationDelay){this.deactivationTimeout=this.deactivationTimeout||function(){var container=this.getContainerForElement(this.activeHoverElement);if(!container||container!=this.activeContainer){this.deactivateContainer()}}.bind(this).delay(this.options.deactivationDelay)}else{this.deactivateContainer()}},stopDelayedDeactivation:function(){if(this.deactivationTimeout){window.clearTimeout(this.deactivationTimeout);delete this.deactivationTimeout}},getContainerForElement:function(element){if(!element){return}if(element.hasAttribute&&!element.hasAttribute(this.options.containerAttribute)){var target=this.getTargetForElement(element);var container=this.getContainerForTarget(target);this.cacheContainerFromElementToTarget(container,element,target)}return $(element.readAttribute(this.options.containerAttribute))},getTargetForElement:function(element){if(!element){return}return element.trace("."+this.options.targetClassName)},getContainerForTarget:function(element){if(!element){return}var containerClassName=this.options.containerClassName,containerAttribute=this.options.containerAttribute,expression="["+containerAttribute+"], ."+containerClassName;var container=(element.hasClassName(containerClassName))?element:element.trace(expression);if(container&&container.hasAttribute(containerAttribute)){return $(container.readAttribute(containerAttribute))}else{return container}},cacheContainerFromElementToTarget:function(container,element,target){if(container&&target){element.upwards(function(e){e.writeAttribute(this.options.containerAttribute,container.identify());if(e==target){return true}}.bind(this))}}});Object.extend(HoverObserver,{Options:{activationDelay:0,deactivationDelay:0.5,targetClassName:"hover_target",containerClassName:"hover_container",containerAttribute:"hover_container",activeClassName:"hover",activationEvent:"hover:activated",deactivationEvent:"hover:deactivated",clickToHover:false}});var Cookie={get:function(name){var cookie=document.cookie.match(new RegExp("(^|;)\\s*"+escape(name)+"=([^;\\s]*)"));return(cookie?unescape(cookie[2]):null)},set:function(name,value,daysToExpire){var attrs="; path=/";if(daysToExpire!=undefined){var d=new Date();d.setTime(d.getTime()+(86400000*parseFloat(daysToExpire)));attrs+="; expires="+d.toGMTString()}return(document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(value||"")+attrs)},remove:function(name){var cookie=Cookie.get(name)||true;Cookie.set(name,"",-1);return cookie}};var Launchbar={initialize:function(){$(document.body).addClassName("with_launchbar");new HoverObserver("launchbar",{activationDelay:0.5,regionClassName:"hover_container"})},selectCurrent:function(application,name){var app_id="launchbar_app_"+application;var link_id="launchbar_link_"+application+"_"+name;if($(app_id)){$(app_id).addClassName("on")}if($(link_id)){$(link_id).addClassName("current_account");if($(app_id)){$(app_id).innerHTML+=": "+$(link_id).innerHTML}$(link_id).innerHTML="&bull; "+$(link_id).innerHTML}},rememberLocation:function(){var daysToExpire=0.125;Cookie.set("return_to",window.location.href,daysToExpire)}};document.observe("dom:loaded",function(){if($("launchbar")){Launchbar.initialize();Launchbar.rememberLocation()}});(function(){var focusInHandler=function(e){e.findElement().fire("focus:in")};var focusOutHandler=function(e){e.findElement().fire("focus:out")};if(document.addEventListener&&!Prototype.Browser.IE){document.addEventListener("focus",focusInHandler,true);document.addEventListener("blur",focusOutHandler,true)}else{document.observe("focusin",focusInHandler);document.observe("focusout",focusOutHandler)}})();var Placeholder={supported:function(){var i=document.createElement("input");return"placeholder" in i},teardown:function(input){Placeholder.focus(input)},clear:function(input){input.value="";input.removeClassName("placeholder")},focus:function(input){if(input.hasClassName("placeholder")&&input.value==input.readAttribute("placeholder")){Placeholder.clear(input)}},blur:function(input){if(input.value.blank()){input.value=input.readAttribute("placeholder");input.addClassName("placeholder")}}};document.observe("dom:loaded",function(){if(!Placeholder.supported()){$$("input[placeholder]").each(Placeholder.blur);$(document.body).observe("focus:in",function(event){var input=event.findElement("input[placeholder]");if(input){Placeholder.focus(input)}});$(document.body).observe("focus:out",function(event){var input=event.findElement("input[placeholder]");if(input){Placeholder.blur(input)}});$(document.body).observe("submit",function(event){event.element().select("input[placeholder]").each(Placeholder.teardown)})}});Placeholder.Overlay={wrap:function(input){if(!input){return $$("input.overlayable").each(Placeholder.Overlay.wrap)}input=$(input);if(input.overlay){return}input.overlay=true;var wrapper=new Element("span",{"class":"overlay_wrapper"});input.parentNode.replaceChild(wrapper,input);wrapper.appendChild(input);input.label=new Element("label",{"for":input.id,"class":"overlabel"});input.label.update(input.title);input.insert({before:input.label});Placeholder.Overlay.reset(input)},reset:function(input){if(input.value.blank()){input.label.show()}else{input.label.hide()}},focus:function(input){if(input.label&&input.value.blank()){input.label.addClassName("focus")}},blur:function(input){if(input.label&&input.value.blank()){input.label.removeClassName("focus");input.label.show()}}};document.observe("dom:loaded",function(){document.observe("focus:in",function(event){var input=event.findElement(".overlayable");if(input){Placeholder.Overlay.focus(input)}});document.observe("focus:out",function(event){var input=event.findElement(".overlayable");if(input){Placeholder.Overlay.blur(input)}});document.observe("keypress",function(event){if(event.keyCode==Event.KEY_TAB){return}var input=event.findElement(".overlayable");if(input&&input.label){input.label.hide()}});document.observe("paste",function(event){var input=event.findElement(".overlayable");if(input&&input.label){input.label.hide()}});Placeholder.Overlay.wrap();$$("input.overlayable[autocomplete=on]").each(function(input){Placeholder.Overlay.reset(input);new Form.Element.Observer(input,0.2,function(){Placeholder.Overlay.reset(input)})})});var AvatarUploader=Class.create({initialize:function(input,options){this.input=input;this.beforeUpload=options.beforeUpload;this.observe()},observe:function(){var self=this;this.input.observe("change",function(){self.upload()})},reset:function(){var container=this.input.up();container.innerHTML=container.innerHTML;this.input=container.down("input[type=file]");this.observe()},upload:function(){if(this.beforeUpload){this.beforeUpload()}this.input.up("form").submit();this.reset()}});var AvatarPreviewer={initialize:function(element){this.element=element;new AvatarUploader(element.down("input[type=file]"),{beforeUpload:this.uploadStart.bind(this)});element.down("[data-behavior~=remove_avatar]").observe("click",this.removeAvatar.bind(this))},uploadStart:function(){this.element.className="busy"},uploadComplete:function(url,key){$("avatar_key").value=key;this.element.down("div.photo").insert(new Element("img",{src:url}));this.element.className="complete"},removeAvatar:function(event){event.stop();$("avatar_key").value="";this.element.down("div.photo").clear();this.element.className=""}};document.observe("dom:loaded",function(){var element=$$("[data-behavior~=avatar_previewer]")[0];if(element){AvatarPreviewer.initialize(element)}});document.observe("dom:loaded",function(){var zoneMap={"10":"Hawaii","9":"Alaska","8":"Pacific Time (US & Canada)","7":"Mountain Time (US & Canada)","6":"Central Time (US & Canada)","5":"Eastern Time (US & Canada)","4":"Atlantic Time (Canada)","3":"Greenland","2":"Mid-Atlantic","1":"Azores","0":"UTC","-1":"Amsterdam","-2":"Athens","-3":"Moscow","-4":"Muscat","-5":"Ekaterinburg","-6":"Almaty","-7":"Bangkok","-8":"Beijing","-9":"Tokyo","-10":"Brisbane","-11":"Magadan","-12":"Auckland","-13":"Nuku'alofa"};function getTimezone(){var today=new Date();var winter=new Date(today.getFullYear(),0,1);var summer=new Date(today.getFullYear(),6,1);var offset=Math.max(winter.getTimezoneOffset(),summer.getTimezoneOffset())/60;return zoneMap[offset]}if($(document.body).hasClassName("rsvp")){var element=$$("[data-behavior~=time_zone_detection]")[0];if(!element){return}var timezone=getTimezone();if(timezone){element.hide();element.select("option").each(function(option){option.selected=(option.readAttribute("value")==timezone)})}}});(function(){var eventMatchers={HTMLEvents:/^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,MouseEvents:/^(?:click|mouse(?:down|up|over|move|out))$/};var defaultOptions={pointerX:0,pointerY:0,button:0,ctrlKey:false,altKey:false,shiftKey:false,metaKey:false,bubbles:true,cancelable:true};Event.simulate=function(element,eventName){var options=Object.extend(Object.clone(defaultOptions),arguments[2]||{});var oEvent,eventType=null;element=$(element);for(var name in eventMatchers){if(eventMatchers[name].test(eventName)){eventType=name;break}}if(!eventType){throw new SyntaxError("Only HTMLEvents and MouseEvents interfaces are supported")}if(document.createEvent){oEvent=document.createEvent(eventType);if(eventType=="HTMLEvents"){oEvent.initEvent(eventName,options.bubbles,options.cancelable)}else{oEvent.initMouseEvent(eventName,options.bubbles,options.cancelable,document.defaultView,options.button,options.pointerX,options.pointerY,options.pointerX,options.pointerY,options.ctrlKey,options.altKey,options.shiftKey,options.metaKey,options.button,element)}element.dispatchEvent(oEvent)}else{options.clientX=options.pointerX;options.clientY=options.pointerY;oEvent=Object.extend(document.createEventObject(),options);element.fireEvent("on"+eventName,oEvent)}return element};Element.addMethods({simulate:Event.simulate})})();var MenuObserver=Class.create({initialize:function(region,options){this.region=$(region);this.options=options;this.registerObservers();this.start()},registerObservers:function(){var startEvent,endEvent;$(document.body).observe("mousedown",this.onDocumentMouseDown.bind(this));this.region.observe("mousedown",this.onRegionMouseDown.bind(this));this.region.observe("mouseup",this.onRegionMouseUp.bind(this));if(Prototype.BrowserFeatures.Multitouch){this.region.observe("touchstart",this.onRegionMouseDown.bind(this));this.region.observe("touchend",this.onRegionMouseUp.bind(this))}this.region.observe("click",this.onRegionClick.bind(this));this.region.observe("mouseover",this.onRegionMouseOver.bind(this));this.region.observe("mouseout",this.onRegionMouseOut.bind(this));this.region.observe("keydown",this.onRegionKeyDown.bind(this));this.region.observe("menu:deactivate",this.deactivate.bind(this))},start:function(){this.started=true},stop:function(){this.started=false},onDocumentMouseDown:function(event){if(!this.started||!this.activeContainer){return}var element=event.findElement();if(!this.elementBelongsToActiveContainer(element)){this.dismiss()}},onRegionMouseDown:function(event){if(!this.started){return}var element=event.findElement();if(!this.elementBelongsToActiveContainer(element)){if(!this.dismiss()){return}}var target=this.findTargetForElement(element);if(target){var container=this.findContainerForElement(target);if(container==this.activeContainer){this.dismiss()}else{this.activate(container)}event.stop()}},onRegionMouseUp:function(event){if(!this.started||!this.activeContainer||this.isIgnorable(event)){return}var element=event.findElement();if(this.elementBelongsToActiveContainer(element)){var action=this.findActionForElement(element);if(action){this.select(action);this.deactivate();event.stop()}}},onRegionClick:function(event){if(!this.started||this.isIgnorable(event)){return}var element=event.findElement();var provision=this.findProvisionForElement(element);if(provision&&provision.match("a[href='#']")){event.stop()}},onRegionMouseOver:function(event){var element=event.findElement("[data-menuaction]");if(element){element.addClassName("hover")}},onRegionMouseOut:function(event){var element=event.findElement("[data-menuaction]");if(element){element.removeClassName("hover")}},onRegionKeyDown:function(event){if(!this.started){return}if(event.keyCode==Event.KEY_ESC){this.dismiss();event.stop()}},activate:function(container){if(container){var event=container.fire("menu:prepared",{container:this.activeContainer});if(!event.stopped){this.finishDeactivation();this.activeContainer=container;this.activeContainer.addClassName("active_menu");this.activeContent=this.findContentForContainer(container);this.activeContent.show();this.activeContainer.fire("menu:activated")}}},deactivate:function(){if(this.activeContainer){var container=this.activeContainer;var content=this.activeContent;this.activeContainer=this.activeContent=false;this.deactivation={container:container,content:content};try{this.deactivation.effect=new Effect.Fade(content,{duration:0.2,afterFinish:this.finishDeactivation.bind(this)})}catch(x){this.finishDeactivation()}}},finishDeactivation:function(){if(this.deactivation){try{this.deactivation.container.removeClassName("active_menu");this.deactivation.container.fire("menu:deactivated");if(this.deactivation.effect){this.deactivation.effect.cancel()}this.deactivation.content.setStyle({opacity:""}).hide()}catch(x){}finally{this.deactivation=false}}},dismiss:function(){if(!this.activeContainerIsModal()){this.deactivate();return true}},select:function(action){if(this.activeContainer){var actionName=action.readAttribute("data-menuaction");var actionValue=action.readAttribute("data-menuvalue");action.fire("menu:selected",{container:this.activeContainer,action:actionName,value:actionValue})}},isIgnorable:function(event){return event.button>1||event.ctrlKey||event.metaKey},elementBelongsToActiveContainer:function(element){if(this.activeContainer){return this.findContainerForElement(element)==this.activeContainer}},elementsBelongToSameContainer:function(first,second){var firstContainer=this.findContainerForElement(first);var secondContainer=this.findContainerForElement(second);return firstContainer==secondContainer},findTargetForElement:function(element){var target=element.trace(".menu_target");if(this.elementsBelongToSameContainer(element,target)){return target}},findActionForElement:function(element){var action=element.trace("[data-menuaction]");if(this.elementsBelongToSameContainer(element,action)){return action}},findProvisionForElement:function(element){var provision=element.trace(".menu_target, .menu_content, [data-menuaction]");if(this.elementsBelongToSameContainer(element,provision)){return provision}},findContainerForElement:function(element){if(!element){return}var parent=element.trace(".menu_content, .menu_container");if(!parent){return}if(parent==this.activeContent){return this.activeContainer}else{if(parent.hasClassName("menu_content")){return parent.trace(".menu_container")}else{return parent}}},findContentForContainer:function(container){var id=container.readAttribute("data-menucontent");if(id){return $(id)}else{return container.down(".menu_content")}},activeContainerIsModal:function(){return this.activeContainer&&this.activeContainer.hasClassName("modal")}});document.observe("keypress",function(event){var textarea=event.findElement("textarea.submits_on_return");if(textarea&&event.keyCode==Event.KEY_RETURN&&!event.shiftKey){var form=textarea.up("form");form.onsubmit?form.onsubmit():form.submit();event.stop()}});var SelectAllCheckbox=Class.create({initialize:function(aggregator,container,options){options=options||{};this.aggregator=$(aggregator);this.container=container?$(container):this.aggregator.up("form");this.minimum=options.minimum||0;this.updateAggregator(true);this.container.observe("click",function(event){var element=event.findElement("input[type=checkbox]");if(element){this.onCheckboxClicked(event,element)}}.bind(this))},onCheckboxClicked:function(event,element){if(element==this.aggregator){this.setAllCheckboxes(element.checked)}else{this.updateAggregator()}},getCheckboxes:function(){return this.checkboxes=this.checkboxes||this.container.select("input[type=checkbox]").without(this.aggregator)},updateAggregator:function(initialUpdate){var length=this.getCheckboxes().length;if(length>=this.minimum){var value=this.getAggregateValue();if((initialUpdate)||(!value)){this.aggregator.checked=value}}},getAggregateValue:function(){return this.getCheckboxes().all(function(element){return element.checked})},setAllCheckboxes:function(value){this.getCheckboxes().each(function(element){element.checked=value})}});Element.addMethods({autofocus:function(element,options){var field;element=$(element);options=options||{};if(options.firstBlankElement){field=element.select(".autofocus").find(function(candidate){return candidate.getValue().blank()})}if(!field){field=element.down(".autofocus")}if(field){(function(){try{field.focus()}catch(e){}}).defer()}return element}});Element.addMethods({preservingScrollPosition:function(element,callback){element=$(element);var offset=element.cumulativeOffset().top-document.viewport.getScrollOffsets().top;callback();window.scrollTo(0,element.cumulativeOffset().top-offset);return element}});Element.addMethods({slideIntoView:function(element,options){element=$(element),options=options||{};var effect;var top=element.cumulativeOffset()[1],height=element.getHeight(),bottom=top+height;var viewTop=document.viewport.getScrollOffsets().top,viewHeight=document.viewport.getHeight(),viewBottom=viewTop+viewHeight;if(top<=viewTop){effect=new Effect.ScrollTo(element,Object.extend({duration:0.15},options))}else{if(bottom>viewBottom){effect=new Effect.ScrollTo(element,Object.extend({duration:0.15,offset:height-viewHeight},options))}}if(options.sync){return effect}return element}});Effect.Height=Class.create();Object.extend(Effect.Height.prototype,Effect.Base.prototype);Object.extend(Effect.Height.prototype,{initialize:function(element,options){this.element=$(element);options=Object.extend({from:this.element.getHeight(),to:0},options||{});this.start(options)},setup:function(){this.setHeight(this.options.from)},update:function(position){this.setHeight(position)},finish:function(){this.setHeight(this.options.to)},setHeight:function(height){this.element.style.height=parseInt(height)+"px"}});Effect.Blend=Class.create();Object.extend(Effect.Blend.prototype,Effect.Base.prototype);Object.extend(Effect.Blend.prototype,{initialize:function(element,options){this.element=$(element);options=Object.extend({invert:false,from:0,to:1},options||{});this.start(options)},setup:function(){this.setOpacityByPosition(this.options.from)},update:function(position){this.setOpacityByPosition(position)},finish:function(){this.setOpacityByPosition(this.options.to)},setOpacityByPosition:function(position){var opacity=this.options.invert?1-position:position;this.element.setOpacity(opacity)}});var Transitions={animationEnabled:true};Element.addMethods({transition:function(element,change,options){if(typeof change=="object"&&typeof options=="function"){change=[change,options],options=change.shift(),change=change.shift()}element=$(element);options=options||{};options.animate=options.animate!==false&&Transitions.animationEnabled;options.fade=options.fade!==false;function finish(){(options.after||Prototype.K)()}function highlightAndFinish(destinationElement){if(options.highlight){var highlightElement=options.highlight===true?destinationElement:($(options.highlight)||destinationElement);new Effect.Highlight(highlightElement,{duration:2,afterFinish:finish})}else{finish.defer()}}function cloneWithoutIDs(element){element=$(element);var clone=element.cloneNode(true);clone.id="";clone.getElementsBySelector("*[id]").each(function(e){e.id=""});return clone}if(options.animate){var transitionElement=new Element("div").setStyle({position:"relative",overflow:"hidden"});element.insert({before:transitionElement});var sourceElement=cloneWithoutIDs(element);var sourceElementWrapper=sourceElement.wrap("div");var destinationElementWrapper=element.wrap("div");transitionElement.appendChild(sourceElementWrapper);transitionElement.appendChild(destinationElementWrapper)}change(element);if(options.animate){var sourceHeight=sourceElementWrapper.getHeight(),destinationHeight=destinationElementWrapper.getHeight();var sourceWidth=sourceElementWrapper.getWidth(),destinationWidth=destinationElementWrapper.getWidth();var outerWrapper=new Element("div");transitionElement.insert({before:outerWrapper});outerWrapper.setStyle({overflow:"hidden",height:sourceHeight+"px"});outerWrapper.appendChild(transitionElement);var maxHeight=destinationHeight>sourceHeight?destinationHeight:sourceHeight;transitionElement.setStyle({height:maxHeight+"px"});sourceElementWrapper.setStyle({position:"absolute",height:maxHeight+"px",width:sourceWidth+"px",top:0,left:0});destinationElementWrapper.setStyle({position:"absolute",height:maxHeight+"px",width:sourceWidth+"px",top:0,left:0,opacity:0,zIndex:2000});var effects=[new Effect.Height(transitionElement,{sync:true,from:sourceHeight,to:destinationHeight}),new Effect.Blend(destinationElementWrapper,{sync:true})];if(options.fade){effects.push(new Effect.Blend(sourceElementWrapper,{invert:true,sync:true}));destinationElementWrapper.setStyle({zIndex:0});sourceElementWrapper.setStyle({zIndex:2000})}new Effect.Parallel(effects,{duration:options.duration||0.3,afterUpdate:function(){if(outerWrapper){outerWrapper.insert({before:transitionElement});outerWrapper.remove();outerWrapper=false}},afterFinish:function(){var destinationElement=destinationElementWrapper.down();if(destinationElement){transitionElement.insert({before:destinationElement})}transitionElement.remove();highlightAndFinish(destinationElement)}})}else{highlightAndFinish(element)}return{after:function(after){options.after=(options.after||Prototype.K).wrap(function(proceed){proceed();after()});return this}}}});(function(){var queue=$A([]);queue.flush=function(){while(queue.any()){queue.pop().fire("dom:modified")}};var notify;function deferFire(element){if(!queue.include(element)){queue.push(element)}if(notify){window.clearTimeout(notify)}notify=queue.flush.defer()}function isFormField(element){if(Object.isElement(element)){return element.tagName.toLowerCase() in {input:0,select:0,button:0,option:0,optgroup:0,textarea:0}}}function fireModifiedEvent(){var args=$A(arguments),proceed=args.shift(),parent=$(args.first()).up();var element=proceed.apply(this,args);if(!isFormField(element)){if(Object.isElement(element)&&element.up("html")){deferFire(element)}else{if(Object.isElement(parent)&&parent.up("html")){deferFire(parent)}}}return element}Element.addMethods({insert:Element.Methods.insert.wrap(fireModifiedEvent),replace:Element.Methods.replace.wrap(fireModifiedEvent),update:Element.Methods.update.wrap(fireModifiedEvent)});document.observe("dom:loaded",function(){Event.fire.defer(document.body,"dom:modified")})})();var BackgroundIteration=Class.create({initialize:function(iterator,produceNextValue){this.iterator=iterator;this.produceNextValue=produceNextValue;this.callbacks=[];this.results=[];this.next=this.next.bind(this);this.next.defer()},next:function(){var value={},hasValue=this.produceNextValue(value);this.running=true;if(hasValue){try{this.results.push(this.iterator(value.value));this.next.defer()}catch(exception){this.exception=exception;this.end()}}else{this.end()}},end:function(){if(this.running){this.running=false;this.callbacks.invoke("call",this)}},after:function(callback){this.callbacks.push(callback);return this}});Object.extend(Array.prototype,{backgroundEach:function(iterator){var index=0;return new BackgroundIteration(iterator,function(memo){if(index==this.length){return false}else{memo.value=this[index++];return true}}.bind(this))}});function SHA1(msg){function rotate_left(n,s){var t4=(n<<s)|(n>>>(32-s));return t4}function lsb_hex(val){var str="";var i;var vh;var vl;for(i=0;i<=6;i+=2){vh=(val>>>(i*4+4))&15;vl=(val>>>(i*4))&15;str+=vh.toString(16)+vl.toString(16)}return str}function cvt_hex(val){var str="";var i;var v;for(i=7;i>=0;i--){v=(val>>>(i*4))&15;str+=v.toString(16)}return str}function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c)}else{if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128)}else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128)}}}return utftext}var blockstart;var i,j;var W=new Array(80);var H0=1732584193;var H1=4023233417;var H2=2562383102;var H3=271733878;var H4=3285377520;var A,B,C,D,E;var temp;msg=Utf8Encode(msg);var msg_len=msg.length;var word_array=new Array();for(i=0;i<msg_len-3;i+=4){j=msg.charCodeAt(i)<<24|msg.charCodeAt(i+1)<<16|msg.charCodeAt(i+2)<<8|msg.charCodeAt(i+3);word_array.push(j)}switch(msg_len%4){case 0:i=2147483648;break;case 1:i=msg.charCodeAt(msg_len-1)<<24|8388608;break;case 2:i=msg.charCodeAt(msg_len-2)<<24|msg.charCodeAt(msg_len-1)<<16|32768;break;case 3:i=msg.charCodeAt(msg_len-3)<<24|msg.charCodeAt(msg_len-2)<<16|msg.charCodeAt(msg_len-1)<<8|128;break}word_array.push(i);while((word_array.length%16)!=14){word_array.push(0)}word_array.push(msg_len>>>29);word_array.push((msg_len<<3)&4294967295);for(blockstart=0;blockstart<word_array.length;blockstart+=16){for(i=0;i<16;i++){W[i]=word_array[blockstart+i]}for(i=16;i<=79;i++){W[i]=rotate_left(W[i-3]^W[i-8]^W[i-14]^W[i-16],1)}A=H0;B=H1;C=H2;D=H3;E=H4;for(i=0;i<=19;i++){temp=(rotate_left(A,5)+((B&C)|(~B&D))+E+W[i]+1518500249)&4294967295;E=D;D=C;C=rotate_left(B,30);B=A;A=temp}for(i=20;i<=39;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+1859775393)&4294967295;E=D;D=C;C=rotate_left(B,30);B=A;A=temp}for(i=40;i<=59;i++){temp=(rotate_left(A,5)+((B&C)|(B&D)|(C&D))+E+W[i]+2400959708)&4294967295;E=D;D=C;C=rotate_left(B,30);B=A;A=temp}for(i=60;i<=79;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+3395469782)&4294967295;E=D;D=C;C=rotate_left(B,30);B=A;A=temp}H0=(H0+A)&4294967295;H1=(H1+B)&4294967295;H2=(H2+C)&4294967295;H3=(H3+D)&4294967295;H4=(H4+E)&4294967295}var temp=cvt_hex(H0)+cvt_hex(H1)+cvt_hex(H2)+cvt_hex(H3)+cvt_hex(H4);return temp.toLowerCase()}if(Prototype.Browser.IE){window._prompt=window.prompt;window.prompt=function(text,value){var self=arguments.callee;if(self.useModalDialog){text=(text||"").toString(),value=(value||"").toString();return window.showModalDialog("/ie7_prompt_fix.html",{title:document.title,text:text.escapeHTML(),value:value.escapeHTML()},"dialogHeight:150px;dialogWidth:400px;scroll:no;status:no")}else{var time=new Date().getTime(),result=window._prompt(text,value);if(new Date().getTime()-time<10){self.useModalDialog=true;result=self(text,value)}return result}}}if(Prototype.Browser.WebKit){document.observe("dom:loaded",function(){document.documentElement.setStyle({backgroundColor:document.body.getStyle("backgroundColor")})})}var AnchorObserver={enabled:true,interval:0.1};document.observe("dom:loaded",function(){var lastAnchor="";function poll(){var anchor=(window.location.hash||"").slice(1);if(anchor!=lastAnchor){document.fire("anchor:changed",{to:anchor,from:lastAnchor});lastAnchor=anchor}}if(AnchorObserver.enabled){setInterval(poll,AnchorObserver.interval*1000)}});(function(){var emptyAnchorHandler;function getEmptyAnchorHandler(){return emptyAnchorHandler=emptyAnchorHandler||new Element("a").writeAttribute({name:"/"}).setStyle({position:"absolute",visibility:"hidden"})}document.observe("click",function(event){var element=event.findElement("a[href=#/]");if(element){var offsets=document.viewport.getScrollOffsets();$(document.body).insert(getEmptyAnchorHandler().setStyle({left:offsets.left+"px",top:offsets.top+"px"}))}})})();(function(){var dimensions;document.observe("dom:loaded",function(event){dimensions=document.viewport.getDimensions()});Event.observe(window,"resize",function(event){var newDimensions=document.viewport.getDimensions();if(!dimensions||dimensions.width!=newDimensions.width||dimensions.height!=newDimensions.height){document.fire("viewport:resized",{dimensions:newDimensions,previousDimensions:dimensions});dimensions=newDimensions}})})();var DimZum={Version:"0.1"};DimZum.Controller=Class.create({initialize:function(options){this.options=options=options||{};this.prefix=options.prefix||"z";this.active=false;document.observe("anchor:changed",this.onAnchorChanged.bind(this));document.observe("shade:clicked",this.onShadeClicked.bind(this));document.observe("viewport:resized",this.onViewportResized.bind(this));document.observe("keypress",this.onKeyPressed.bind(this))},getShade:function(){return this.shade=this.shade||new DimZum.Shade(this.options.shade)},getWindow:function(){return this.window=this.window||new DimZum.Window(this.options.window)},onAnchorChanged:function(event){if(this.isActableAnchor(event.memo.to)){var elements=this.getElementsFromAnchor(event.memo.to);this.showElement(elements.first())}else{this.hideActiveElement()}},onShadeClicked:function(event){if(this.options.closeOnShadeClick!==false){this.close()}},onViewportResized:function(event){if(this.active){this.getShade().resizeElement();this.getWindow().repositionWindow()}},onKeyPressed:function(event){if(this.active&&event.keyCode==Event.KEY_ESC){this.close();event.stop()}},isActableAnchor:function(anchor){if(anchor&&anchor.substring(0,this.prefix.length+1)==this.prefix+"/"){return this.getElementsFromAnchor(anchor).first()}},getElementsFromAnchor:function(anchor){return anchor.substring(this.prefix.length+1).split("/").map(function(id){return $(id)})},showElement:function(element){var resumeShowElement=(function(){if(!this.active){this.getShade().show()}this.getWindow().showWithContents(element);this.getWindow().element.fire("dimzum:activated",{controller:this});this.active=element}).bind(this);var event=element.fire("dimzum:prepare",{controller:this,resume:resumeShowElement});if(!event.stopped){resumeShowElement()}},hideActiveElement:function(){if(this.active){this.getWindow().hide();this.getWindow().element.fire("dimzum:deactivated",{controller:this});this.getShade().hide();this.active=false}},close:function(){window.location.hash="#/";this.hideActiveElement()},clearPurgatory:function(){this.getWindow().clearPurgatory()}});DimZum.Shade=Class.create({initialize:function(options){this.options=options||{};this.createElement();$(document.body).insert(this.element);this.element.observe("click",this.onClick.bind(this))},show:function(){this.resizeElement();this.element.show()},hide:function(){this.element.hide()},createElement:function(){this.element=new Element("div").hide();this.element.setStyle({position:"absolute",top:0,left:0,background:this.options.background||"#000",opacity:this.options.opacity||0.5,zIndex:this.options.zIndex||1000})},resizeElement:function(){var dimensions=$(document.body).getDimensions();this.element.setStyle({width:dimensions.width+"px",height:dimensions.height+"px"})},onClick:function(event){this.element.fire("shade:clicked",{shade:this})}});DimZum.Window=Class.create({initialize:function(options){this.options=options||{};this.createElements()},createElements:function(){if(this.options.element){this.element=this.options.element;this.viewport=this.element.down("div.viewport")}else{this.element=new Element("div").hide();this.viewport=new Element("div").addClassName("viewport");this.controls=this.options.controls||new Element("div").update('<a href="#/">Close</a>');this.element.insert(this.viewport);this.controls.show().addClassName("controls");this.element.insert(this.controls)}this.element.addClassName(this.options.className||"dim_zum_window");this.element.setStyle({position:"absolute",top:0,left:0,zIndex:this.options.zIndex||2000});this.purgatory=new Element("div").hide();$(document.body).insert(this.element);$(document.body).insert(this.purgatory)},showWithContents:function(contentElement){this.adoptContents(contentElement);this.repositionWindow();this.element.show()},adoptContents:function(contentElement){this.releaseContents();this.viewport.insert(contentElement);this.hasContents=true;contentElement.show()},getContents:function(){if(this.hasContents){return this.viewport.down()}},releaseContents:function(){var contents=this.getContents();if(contents){contents.hide();this.purgatory.insert(contents)}this.hasContents=false},repositionWindow:function(){var windowDimensions=this.element.getDimensions();var viewportDimensions=document.viewport.getDimensions();var viewportOffsets=document.viewport.getScrollOffsets();var xOffsetFactor=this.options.xOffset||0.5;var yOffsetFactor=this.options.yOffset||0.5;var left=viewportDimensions.width*xOffsetFactor-windowDimensions.width*xOffsetFactor;var top=viewportDimensions.height*yOffsetFactor-windowDimensions.height*yOffsetFactor;this.element.setStyle({left:viewportOffsets.left+left+"px",top:viewportOffsets.top+top+"px"})},hide:function(){this.releaseContents();this.element.hide()},clearPurgatory:function(){this.purgatory.update("")}});Element.addMethods({forceVisibility:function(element,callback){var hiddenParents=[];while(element=$(element)){if(element.visible&&!element.visible()){hiddenParents.push(element.show())}element=element.parentNode}try{callback()}catch(e){throw e}finally{hiddenParents.invoke("hide")}}});var FlashDetect=new function(){var self=this;self.installed=false;self.raw="";self.major=-1;self.minor=-1;self.revision=-1;self.revisionStr="";var activeXDetectRules=[{name:"ShockwaveFlash.ShockwaveFlash.7",version:function(obj){return getActiveXVersion(obj)}},{name:"ShockwaveFlash.ShockwaveFlash.6",version:function(obj){var version="6,0,21";try{obj.AllowScriptAccess="always";version=getActiveXVersion(obj)}catch(err){}return version}},{name:"ShockwaveFlash.ShockwaveFlash",version:function(obj){return getActiveXVersion(obj)}}];var getActiveXVersion=function(activeXObj){var version=-1;try{version=activeXObj.GetVariable("$version")}catch(err){}return version};var getActiveXObject=function(name){var obj=-1;try{obj=new ActiveXObject(name)}catch(err){obj={activeXError:true}}return obj};var parseActiveXVersion=function(str){var versionArray=str.split(",");return{raw:str,major:parseInt(versionArray[0].split(" ")[1],10),minor:parseInt(versionArray[1],10),revision:parseInt(versionArray[2],10),revisionStr:versionArray[2]}};var parseStandardVersion=function(str){var descParts=str.split(/ +/);var majorMinor=descParts[2].split(/\./);var revisionStr=descParts[3];return{raw:str,major:parseInt(majorMinor[0],10),minor:parseInt(majorMinor[1],10),revisionStr:revisionStr,revision:parseRevisionStrToInt(revisionStr)}};var parseRevisionStrToInt=function(str){return parseInt(str.replace(/[a-zA-Z]/g,""),10)||self.revision};self.majorAtLeast=function(version){return self.major>=version};self.minorAtLeast=function(version){return self.minor>=version};self.revisionAtLeast=function(version){return self.revision>=version};self.versionAtLeast=function(major){var properties=[self.major,self.minor,self.revision];var len=Math.min(properties.length,arguments.length);for(i=0;i<len;i++){if(properties[i]>=arguments[i]){if(i+1<len&&properties[i]==arguments[i]){continue}else{return true}}else{return false}}};self.FlashDetect=function(){try{if(navigator.plugins&&navigator.plugins.length>0){var type="application/x-shockwave-flash";var mimeTypes=navigator.mimeTypes;if(mimeTypes&&mimeTypes[type]&&mimeTypes[type].enabledPlugin&&mimeTypes[type].enabledPlugin.description){var version=mimeTypes[type].enabledPlugin.description;var versionObj=parseStandardVersion(version);self.raw=versionObj.raw;self.major=versionObj.major;self.minor=versionObj.minor;self.revisionStr=versionObj.revisionStr;self.revision=versionObj.revision;self.installed=true}}else{if(navigator.appVersion.indexOf("Mac")==-1&&window.execScript){var version=-1;for(var i=0;i<activeXDetectRules.length&&version==-1;i++){var obj=getActiveXObject(activeXDetectRules[i].name);if(!obj.activeXError){self.installed=true;version=activeXDetectRules[i].version(obj);if(version!=-1){var versionObj=parseActiveXVersion(version);self.raw=versionObj.raw;self.major=versionObj.major;self.minor=versionObj.minor;self.revision=versionObj.revision;self.revisionStr=versionObj.revisionStr}}}}}}catch(e){self.installed=false;self.raw="";self.major=0;self.minor=0;self.revisionStr="";self.revision=0}}()};FlashDetect.JS_RELEASE="1.0.4";(function(){function getElementInfo(element){element=$(element);if(!element.getValue){return{}}return{name:element.tagName,type:element.readAttribute("type"),value:element.getValue()}}function restoreElementInfo(oldElements,element){var elementInfo=getElementInfo(element);if(!elementInfo){return}for(var i=0;i<oldElements.length;i++){var oldElementInfo=oldElements[i];if(elementInfo.name==oldElementInfo.name&&elementInfo.type==oldElementInfo.type){$(element).setValue(oldElementInfo.value);oldElements[i]={};break}}}Element.addMethods("form",{preservingValues:function(element,callback){element=$(element);var oldElements=$A(element.elements).map(getElementInfo);callback();$A(element.elements).each(restoreElementInfo.curry(oldElements));return element}})})();var FileIcon={LIB:{AI:"AI",AIFF:"AIFF",ASP:"WEB",CFM:"WEB",CGI:"WEB",DMG:"DMG",DOC:"DOC",DOCX:"DOC",EPS:"EPS",FLA:"FLA",GIF:"GIF",GZ:"TGZ",HTML:"HTML",HTM:"HTM",INDD:"INDD",JPG:"JPG",JPEG:"JPEG",JSP:"WEB",KEY:"KEY",LINK:"WEB",M4A:"M4A",M4V:"M4V",MOV:"MOV",MP3:"MP3",MPEG:"MPEG",MPG:"MPG",NUMBERS:"NUMBERS",ODP:"ODP",ODS:"ODS",ODT:"ODT",PAGES:"PAGES",PDF:"PDF",PHP:"WEB",PL:"WEB",PNG:"PNG",POT:"POT",PPT:"PPT",PPTX:"PPT",PS:"EPS",PSD:"PSD",RM:"RM",SIT:"SIT",SWF:"SWF",TAR:"TAR",TGZ:"TGZ",TIF:"TIF",TIFF:"TIFF",TXT:"TXT",VSD:"VSD",WAV:"WAV",WEB:"WEB",WMA:"WMA",WMV:"WMV",XLS:"XLS",XLSX:"XLS",ZIP:"ZIP"},SIZES:{small:"16x16",big:"32x32",jumbo:"86x100"},path:function(extension,size){return"/images/icons/icon_"+(FileIcon.exists(extension)||"Generic")+"_"+(size||"small")+".png"},exists:function(extension){return FileIcon.LIB[(extension||"").toUpperCase()]}};var SWFUpload;if(SWFUpload==undefined){SWFUpload=function(settings){this.initSWFUpload(settings)}}SWFUpload.prototype.initSWFUpload=function(settings){try{this.customSettings={};this.settings=settings;this.eventQueue=[];this.movieName="SWFUpload_"+SWFUpload.movieCount++;this.movieElement=null;SWFUpload.instances[this.movieName]=this;this.initSettings();this.loadFlash();this.displayDebugInfo()}catch(ex){delete SWFUpload.instances[this.movieName];throw ex}};SWFUpload.instances={};SWFUpload.movieCount=0;SWFUpload.version="2.2.0 2009-03-25";SWFUpload.QUEUE_ERROR={QUEUE_LIMIT_EXCEEDED:-100,FILE_EXCEEDS_SIZE_LIMIT:-110,ZERO_BYTE_FILE:-120,INVALID_FILETYPE:-130};SWFUpload.UPLOAD_ERROR={HTTP_ERROR:-200,MISSING_UPLOAD_URL:-210,IO_ERROR:-220,SECURITY_ERROR:-230,UPLOAD_LIMIT_EXCEEDED:-240,UPLOAD_FAILED:-250,SPECIFIED_FILE_ID_NOT_FOUND:-260,FILE_VALIDATION_FAILED:-270,FILE_CANCELLED:-280,UPLOAD_STOPPED:-290};SWFUpload.FILE_STATUS={QUEUED:-1,IN_PROGRESS:-2,ERROR:-3,COMPLETE:-4,CANCELLED:-5};SWFUpload.BUTTON_ACTION={SELECT_FILE:-100,SELECT_FILES:-110,START_UPLOAD:-120};SWFUpload.CURSOR={ARROW:-1,HAND:-2};SWFUpload.WINDOW_MODE={WINDOW:"window",TRANSPARENT:"transparent",OPAQUE:"opaque"};SWFUpload.completeURL=function(url){if(typeof(url)!=="string"||url.match(/^https?:\/\//i)||url.match(/^\//)){return url}var currentURL=window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"");var indexSlash=window.location.pathname.lastIndexOf("/");if(indexSlash<=0){path="/"}else{path=window.location.pathname.substr(0,indexSlash)+"/"}return path+url};SWFUpload.prototype.initSettings=function(){this.ensureDefault=function(settingName,defaultValue){this.settings[settingName]=(this.settings[settingName]==undefined)?defaultValue:this.settings[settingName]};this.ensureDefault("upload_url","");this.ensureDefault("preserve_relative_urls",false);this.ensureDefault("file_post_name","Filedata");this.ensureDefault("post_params",{});this.ensureDefault("use_query_string",false);this.ensureDefault("requeue_on_error",false);this.ensureDefault("http_success",[]);this.ensureDefault("assume_success_timeout",0);this.ensureDefault("file_types","*.*");this.ensureDefault("file_types_description","All Files");this.ensureDefault("file_size_limit",0);this.ensureDefault("file_upload_limit",0);this.ensureDefault("file_queue_limit",0);this.ensureDefault("flash_url","swfupload.swf");this.ensureDefault("prevent_swf_caching",true);this.ensureDefault("button_image_url","");this.ensureDefault("button_width",1);this.ensureDefault("button_height",1);this.ensureDefault("button_text","");this.ensureDefault("button_text_style","color: #000000; font-size: 16pt;");this.ensureDefault("button_text_top_padding",0);this.ensureDefault("button_text_left_padding",0);this.ensureDefault("button_action",SWFUpload.BUTTON_ACTION.SELECT_FILES);this.ensureDefault("button_disabled",false);this.ensureDefault("button_placeholder_id","");this.ensureDefault("button_placeholder",null);this.ensureDefault("button_cursor",SWFUpload.CURSOR.ARROW);this.ensureDefault("button_window_mode",SWFUpload.WINDOW_MODE.WINDOW);this.ensureDefault("debug",false);this.settings.debug_enabled=this.settings.debug;this.settings.return_upload_start_handler=this.returnUploadStart;this.ensureDefault("swfupload_loaded_handler",null);this.ensureDefault("file_dialog_start_handler",null);this.ensureDefault("file_queued_handler",null);this.ensureDefault("file_queue_error_handler",null);this.ensureDefault("file_dialog_complete_handler",null);this.ensureDefault("upload_start_handler",null);this.ensureDefault("upload_progress_handler",null);this.ensureDefault("upload_error_handler",null);this.ensureDefault("upload_success_handler",null);this.ensureDefault("upload_complete_handler",null);this.ensureDefault("debug_handler",this.debugMessage);this.ensureDefault("custom_settings",{});this.customSettings=this.settings.custom_settings;if(!!this.settings.prevent_swf_caching){this.settings.flash_url=this.settings.flash_url+(this.settings.flash_url.indexOf("?")<0?"?":"&")+"preventswfcaching="+new Date().getTime()}if(!this.settings.preserve_relative_urls){this.settings.upload_url=SWFUpload.completeURL(this.settings.upload_url);this.settings.button_image_url=SWFUpload.completeURL(this.settings.button_image_url)}delete this.ensureDefault};SWFUpload.prototype.loadFlash=function(){var targetElement,tempParent;if(document.getElementById(this.movieName)!==null){throw"ID "+this.movieName+" is already in use. The Flash Object could not be added"}targetElement=document.getElementById(this.settings.button_placeholder_id)||this.settings.button_placeholder;if(targetElement==undefined){throw"Could not find the placeholder element: "+this.settings.button_placeholder_id}tempParent=document.createElement("div");tempParent.innerHTML=this.getFlashHTML();targetElement.parentNode.replaceChild(tempParent.firstChild,targetElement);if(window[this.movieName]==undefined){window[this.movieName]=this.getMovieElement()}};SWFUpload.prototype.getFlashHTML=function(){return['<object id="',this.movieName,'" type="application/x-shockwave-flash" data="',this.settings.flash_url,'" width="',this.settings.button_width,'" height="',this.settings.button_height,'" class="swfupload">','<param name="wmode" value="',this.settings.button_window_mode,'" />','<param name="movie" value="',this.settings.flash_url,'" />','<param name="quality" value="high" />','<param name="menu" value="false" />','<param name="allowScriptAccess" value="always" />','<param name="flashvars" value="'+this.getFlashVars()+'" />',"</object>"].join("")};SWFUpload.prototype.getFlashVars=function(){var paramString=this.buildParamString();var httpSuccessString=this.settings.http_success.join(",");return["movieName=",encodeURIComponent(this.movieName),"&amp;uploadURL=",encodeURIComponent(this.settings.upload_url),"&amp;useQueryString=",encodeURIComponent(this.settings.use_query_string),"&amp;requeueOnError=",encodeURIComponent(this.settings.requeue_on_error),"&amp;httpSuccess=",encodeURIComponent(httpSuccessString),"&amp;assumeSuccessTimeout=",encodeURIComponent(this.settings.assume_success_timeout),"&amp;params=",encodeURIComponent(paramString),"&amp;filePostName=",encodeURIComponent(this.settings.file_post_name),"&amp;fileTypes=",encodeURIComponent(this.settings.file_types),"&amp;fileTypesDescription=",encodeURIComponent(this.settings.file_types_description),"&amp;fileSizeLimit=",encodeURIComponent(this.settings.file_size_limit),"&amp;fileUploadLimit=",encodeURIComponent(this.settings.file_upload_limit),"&amp;fileQueueLimit=",encodeURIComponent(this.settings.file_queue_limit),"&amp;debugEnabled=",encodeURIComponent(this.settings.debug_enabled),"&amp;buttonImageURL=",encodeURIComponent(this.settings.button_image_url),"&amp;buttonWidth=",encodeURIComponent(this.settings.button_width),"&amp;buttonHeight=",encodeURIComponent(this.settings.button_height),"&amp;buttonText=",encodeURIComponent(this.settings.button_text),"&amp;buttonTextTopPadding=",encodeURIComponent(this.settings.button_text_top_padding),"&amp;buttonTextLeftPadding=",encodeURIComponent(this.settings.button_text_left_padding),"&amp;buttonTextStyle=",encodeURIComponent(this.settings.button_text_style),"&amp;buttonAction=",encodeURIComponent(this.settings.button_action),"&amp;buttonDisabled=",encodeURIComponent(this.settings.button_disabled),"&amp;buttonCursor=",encodeURIComponent(this.settings.button_cursor)].join("")};SWFUpload.prototype.getMovieElement=function(){if(this.movieElement==undefined){this.movieElement=document.getElementById(this.movieName)}if(this.movieElement===null){throw"Could not find Flash element"}return this.movieElement};SWFUpload.prototype.buildParamString=function(){var postParams=this.settings.post_params;var paramStringPairs=[];if(typeof(postParams)==="object"){for(var name in postParams){if(postParams.hasOwnProperty(name)){paramStringPairs.push(encodeURIComponent(name.toString())+"="+encodeURIComponent(postParams[name].toString()))}}}return paramStringPairs.join("&amp;")};SWFUpload.prototype.destroy=function(){try{this.cancelUpload(null,false);var movieElement=null;movieElement=this.getMovieElement();if(movieElement&&typeof(movieElement.CallFunction)==="unknown"){for(var i in movieElement){try{if(typeof(movieElement[i])==="function"){movieElement[i]=null}}catch(ex1){}}try{movieElement.parentNode.removeChild(movieElement)}catch(ex){}}window[this.movieName]=null;SWFUpload.instances[this.movieName]=null;delete SWFUpload.instances[this.movieName];this.movieElement=null;this.settings=null;this.customSettings=null;this.eventQueue=null;this.movieName=null;return true}catch(ex2){return false}};SWFUpload.prototype.displayDebugInfo=function(){this.debug(["---SWFUpload Instance Info---\n","Version: ",SWFUpload.version,"\n","Movie Name: ",this.movieName,"\n","Settings:\n","\t","upload_url:               ",this.settings.upload_url,"\n","\t","flash_url:                ",this.settings.flash_url,"\n","\t","use_query_string:         ",this.settings.use_query_string.toString(),"\n","\t","requeue_on_error:         ",this.settings.requeue_on_error.toString(),"\n","\t","http_success:             ",this.settings.http_success.join(", "),"\n","\t","assume_success_timeout:   ",this.settings.assume_success_timeout,"\n","\t","file_post_name:           ",this.settings.file_post_name,"\n","\t","post_params:              ",this.settings.post_params.toString(),"\n","\t","file_types:               ",this.settings.file_types,"\n","\t","file_types_description:   ",this.settings.file_types_description,"\n","\t","file_size_limit:          ",this.settings.file_size_limit,"\n","\t","file_upload_limit:        ",this.settings.file_upload_limit,"\n","\t","file_queue_limit:         ",this.settings.file_queue_limit,"\n","\t","debug:                    ",this.settings.debug.toString(),"\n","\t","prevent_swf_caching:      ",this.settings.prevent_swf_caching.toString(),"\n","\t","button_placeholder_id:    ",this.settings.button_placeholder_id.toString(),"\n","\t","button_placeholder:       ",(this.settings.button_placeholder?"Set":"Not Set"),"\n","\t","button_image_url:         ",this.settings.button_image_url.toString(),"\n","\t","button_width:             ",this.settings.button_width.toString(),"\n","\t","button_height:            ",this.settings.button_height.toString(),"\n","\t","button_text:              ",this.settings.button_text.toString(),"\n","\t","button_text_style:        ",this.settings.button_text_style.toString(),"\n","\t","button_text_top_padding:  ",this.settings.button_text_top_padding.toString(),"\n","\t","button_text_left_padding: ",this.settings.button_text_left_padding.toString(),"\n","\t","button_action:            ",this.settings.button_action.toString(),"\n","\t","button_disabled:          ",this.settings.button_disabled.toString(),"\n","\t","custom_settings:          ",this.settings.custom_settings.toString(),"\n","Event Handlers:\n","\t","swfupload_loaded_handler assigned:  ",(typeof this.settings.swfupload_loaded_handler==="function").toString(),"\n","\t","file_dialog_start_handler assigned: ",(typeof this.settings.file_dialog_start_handler==="function").toString(),"\n","\t","file_queued_handler assigned:       ",(typeof this.settings.file_queued_handler==="function").toString(),"\n","\t","file_queue_error_handler assigned:  ",(typeof this.settings.file_queue_error_handler==="function").toString(),"\n","\t","upload_start_handler assigned:      ",(typeof this.settings.upload_start_handler==="function").toString(),"\n","\t","upload_progress_handler assigned:   ",(typeof this.settings.upload_progress_handler==="function").toString(),"\n","\t","upload_error_handler assigned:      ",(typeof this.settings.upload_error_handler==="function").toString(),"\n","\t","upload_success_handler assigned:    ",(typeof this.settings.upload_success_handler==="function").toString(),"\n","\t","upload_complete_handler assigned:   ",(typeof this.settings.upload_complete_handler==="function").toString(),"\n","\t","debug_handler assigned:             ",(typeof this.settings.debug_handler==="function").toString(),"\n"].join(""))};SWFUpload.prototype.addSetting=function(name,value,default_value){if(value==undefined){return(this.settings[name]=default_value)}else{return(this.settings[name]=value)}};SWFUpload.prototype.getSetting=function(name){if(this.settings[name]!=undefined){return this.settings[name]}return""};SWFUpload.prototype.callFlash=function(functionName,argumentArray){argumentArray=argumentArray||[];var movieElement=this.getMovieElement();var returnValue,returnString;try{returnString=movieElement.CallFunction('<invoke name="'+functionName+'" returntype="javascript">'+__flash__argumentsToXML(argumentArray,0)+"</invoke>");returnValue=eval(returnString)}catch(ex){throw"Call to "+functionName+" failed"}if(returnValue!=undefined&&typeof returnValue.post==="object"){returnValue=this.unescapeFilePostParams(returnValue)}return returnValue};SWFUpload.prototype.selectFile=function(){this.callFlash("SelectFile")};SWFUpload.prototype.selectFiles=function(){this.callFlash("SelectFiles")};SWFUpload.prototype.startUpload=function(fileID){this.callFlash("StartUpload",[fileID])};SWFUpload.prototype.cancelUpload=function(fileID,triggerErrorEvent){if(triggerErrorEvent!==false){triggerErrorEvent=true}this.callFlash("CancelUpload",[fileID,triggerErrorEvent])};SWFUpload.prototype.stopUpload=function(){this.callFlash("StopUpload")};SWFUpload.prototype.getStats=function(){return this.callFlash("GetStats")};SWFUpload.prototype.setStats=function(statsObject){this.callFlash("SetStats",[statsObject])};SWFUpload.prototype.getFile=function(fileID){if(typeof(fileID)==="number"){return this.callFlash("GetFileByIndex",[fileID])}else{return this.callFlash("GetFile",[fileID])}};SWFUpload.prototype.addFileParam=function(fileID,name,value){return this.callFlash("AddFileParam",[fileID,name,value])};SWFUpload.prototype.removeFileParam=function(fileID,name){this.callFlash("RemoveFileParam",[fileID,name])};SWFUpload.prototype.setUploadURL=function(url){this.settings.upload_url=url.toString();this.callFlash("SetUploadURL",[url])};SWFUpload.prototype.setPostParams=function(paramsObject){this.settings.post_params=paramsObject;this.callFlash("SetPostParams",[paramsObject])};SWFUpload.prototype.addPostParam=function(name,value){this.settings.post_params[name]=value;this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.removePostParam=function(name){delete this.settings.post_params[name];this.callFlash("SetPostParams",[this.settings.post_params])};SWFUpload.prototype.setFileTypes=function(types,description){this.settings.file_types=types;this.settings.file_types_description=description;this.callFlash("SetFileTypes",[types,description])};SWFUpload.prototype.setFileSizeLimit=function(fileSizeLimit){this.settings.file_size_limit=fileSizeLimit;this.callFlash("SetFileSizeLimit",[fileSizeLimit])};SWFUpload.prototype.setFileUploadLimit=function(fileUploadLimit){this.settings.file_upload_limit=fileUploadLimit;this.callFlash("SetFileUploadLimit",[fileUploadLimit])};SWFUpload.prototype.setFileQueueLimit=function(fileQueueLimit){this.settings.file_queue_limit=fileQueueLimit;this.callFlash("SetFileQueueLimit",[fileQueueLimit])};SWFUpload.prototype.setFilePostName=function(filePostName){this.settings.file_post_name=filePostName;this.callFlash("SetFilePostName",[filePostName])};SWFUpload.prototype.setUseQueryString=function(useQueryString){this.settings.use_query_string=useQueryString;this.callFlash("SetUseQueryString",[useQueryString])};SWFUpload.prototype.setRequeueOnError=function(requeueOnError){this.settings.requeue_on_error=requeueOnError;this.callFlash("SetRequeueOnError",[requeueOnError])};SWFUpload.prototype.setHTTPSuccess=function(http_status_codes){if(typeof http_status_codes==="string"){http_status_codes=http_status_codes.replace(" ","").split(",")}this.settings.http_success=http_status_codes;this.callFlash("SetHTTPSuccess",[http_status_codes])};SWFUpload.prototype.setAssumeSuccessTimeout=function(timeout_seconds){this.settings.assume_success_timeout=timeout_seconds;this.callFlash("SetAssumeSuccessTimeout",[timeout_seconds])};SWFUpload.prototype.setDebugEnabled=function(debugEnabled){this.settings.debug_enabled=debugEnabled;this.callFlash("SetDebugEnabled",[debugEnabled])};SWFUpload.prototype.setButtonImageURL=function(buttonImageURL){if(buttonImageURL==undefined){buttonImageURL=""}this.settings.button_image_url=buttonImageURL;this.callFlash("SetButtonImageURL",[buttonImageURL])};SWFUpload.prototype.setButtonDimensions=function(width,height){this.settings.button_width=width;this.settings.button_height=height;var movie=this.getMovieElement();if(movie!=undefined){movie.style.width=width+"px";movie.style.height=height+"px"}this.callFlash("SetButtonDimensions",[width,height])};SWFUpload.prototype.setButtonText=function(html){this.settings.button_text=html;this.callFlash("SetButtonText",[html])};SWFUpload.prototype.setButtonTextPadding=function(left,top){this.settings.button_text_top_padding=top;this.settings.button_text_left_padding=left;this.callFlash("SetButtonTextPadding",[left,top])};SWFUpload.prototype.setButtonTextStyle=function(css){this.settings.button_text_style=css;this.callFlash("SetButtonTextStyle",[css])};SWFUpload.prototype.setButtonDisabled=function(isDisabled){this.settings.button_disabled=isDisabled;this.callFlash("SetButtonDisabled",[isDisabled])};SWFUpload.prototype.setButtonAction=function(buttonAction){this.settings.button_action=buttonAction;this.callFlash("SetButtonAction",[buttonAction])};SWFUpload.prototype.setButtonCursor=function(cursor){this.settings.button_cursor=cursor;this.callFlash("SetButtonCursor",[cursor])};SWFUpload.prototype.queueEvent=function(handlerName,argumentArray){if(argumentArray==undefined){argumentArray=[]}else{if(!(argumentArray instanceof Array)){argumentArray=[argumentArray]}}var self=this;if(typeof this.settings[handlerName]==="function"){this.eventQueue.push(function(){this.settings[handlerName].apply(this,argumentArray)});setTimeout(function(){self.executeNextEvent()},0)}else{if(this.settings[handlerName]!==null){throw"Event handler "+handlerName+" is unknown or is not a function"}}};SWFUpload.prototype.executeNextEvent=function(){var f=this.eventQueue?this.eventQueue.shift():null;if(typeof(f)==="function"){f.apply(this)}};SWFUpload.prototype.unescapeFilePostParams=function(file){var reg=/[$]([0-9a-f]{4})/i;var unescapedPost={};var uk;if(file!=undefined){for(var k in file.post){if(file.post.hasOwnProperty(k)){uk=k;var match;while((match=reg.exec(uk))!==null){uk=uk.replace(match[0],String.fromCharCode(parseInt("0x"+match[1],16)))}unescapedPost[uk]=file.post[k]}}file.post=unescapedPost}return file};SWFUpload.prototype.testExternalInterface=function(){try{return this.callFlash("TestExternalInterface")}catch(ex){return false}};SWFUpload.prototype.flashReady=function(){var movieElement=this.getMovieElement();if(!movieElement){this.debug("Flash called back ready but the flash movie can't be found.");return}this.cleanUp(movieElement);this.queueEvent("swfupload_loaded_handler")};SWFUpload.prototype.cleanUp=function(movieElement){try{if(this.movieElement&&typeof(movieElement.CallFunction)==="unknown"){this.debug("Removing Flash functions hooks (this should only run in IE and should prevent memory leaks)");for(var key in movieElement){try{if(typeof(movieElement[key])==="function"){movieElement[key]=null}}catch(ex){}}}}catch(ex1){}window.__flash__removeCallback=function(instance,name){try{if(instance){instance[name]=null}}catch(flashEx){}}};SWFUpload.prototype.fileDialogStart=function(){this.queueEvent("file_dialog_start_handler")};SWFUpload.prototype.fileQueued=function(file){file=this.unescapeFilePostParams(file);this.queueEvent("file_queued_handler",file)};SWFUpload.prototype.fileQueueError=function(file,errorCode,message){file=this.unescapeFilePostParams(file);this.queueEvent("file_queue_error_handler",[file,errorCode,message])};SWFUpload.prototype.fileDialogComplete=function(numFilesSelected,numFilesQueued,numFilesInQueue){this.queueEvent("file_dialog_complete_handler",[numFilesSelected,numFilesQueued,numFilesInQueue])};SWFUpload.prototype.uploadStart=function(file){file=this.unescapeFilePostParams(file);this.queueEvent("return_upload_start_handler",file)};SWFUpload.prototype.returnUploadStart=function(file){var returnValue;if(typeof this.settings.upload_start_handler==="function"){file=this.unescapeFilePostParams(file);returnValue=this.settings.upload_start_handler.call(this,file)}else{if(this.settings.upload_start_handler!=undefined){throw"upload_start_handler must be a function"}}if(returnValue===undefined){returnValue=true}returnValue=!!returnValue;this.callFlash("ReturnUploadStart",[returnValue])};SWFUpload.prototype.uploadProgress=function(file,bytesComplete,bytesTotal){file=this.unescapeFilePostParams(file);this.queueEvent("upload_progress_handler",[file,bytesComplete,bytesTotal])};SWFUpload.prototype.uploadError=function(file,errorCode,message){file=this.unescapeFilePostParams(file);this.queueEvent("upload_error_handler",[file,errorCode,message])};SWFUpload.prototype.uploadSuccess=function(file,serverData,responseReceived){file=this.unescapeFilePostParams(file);this.queueEvent("upload_success_handler",[file,serverData,responseReceived])};SWFUpload.prototype.uploadComplete=function(file){file=this.unescapeFilePostParams(file);this.queueEvent("upload_complete_handler",file)};SWFUpload.prototype.debug=function(message){this.queueEvent("debug_handler",message)};SWFUpload.prototype.debugMessage=function(message){if(this.settings.debug){var exceptionMessage,exceptionValues=[];if(typeof message==="object"&&typeof message.name==="string"&&typeof message.message==="string"){for(var key in message){if(message.hasOwnProperty(key)){exceptionValues.push(key+": "+message[key])}}exceptionMessage=exceptionValues.join("\n")||"";exceptionValues=exceptionMessage.split("\n");exceptionMessage="EXCEPTION: "+exceptionValues.join("\nEXCEPTION: ");SWFUpload.Console.writeLine(exceptionMessage)}else{SWFUpload.Console.writeLine(message)}}};SWFUpload.Console={};SWFUpload.Console.writeLine=function(message){var console,documentForm;try{console=document.getElementById("SWFUpload_Console");if(!console){documentForm=document.createElement("form");document.getElementsByTagName("body")[0].appendChild(documentForm);console=document.createElement("textarea");console.id="SWFUpload_Console";console.style.fontFamily="monospace";console.setAttribute("wrap","off");console.wrap="off";console.style.overflow="auto";console.style.width="700px";console.style.height="350px";console.style.margin="5px";documentForm.appendChild(console)}console.value+=message+"\n";console.scrollTop=console.scrollHeight-console.clientHeight}catch(ex){alert("Exception: "+ex.name+" Message: "+ex.message)}};var SWFUpload;if(typeof(SWFUpload)==="function"){SWFUpload.queue={};SWFUpload.prototype.initSettings=(function(oldInitSettings){return function(){if(typeof(oldInitSettings)==="function"){oldInitSettings.call(this)}this.queueSettings={};this.queueSettings.queue_cancelled_flag=false;this.queueSettings.queue_upload_count=0;this.queueSettings.user_upload_complete_handler=this.settings.upload_complete_handler;this.queueSettings.user_upload_start_handler=this.settings.upload_start_handler;this.settings.upload_complete_handler=SWFUpload.queue.uploadCompleteHandler;this.settings.upload_start_handler=SWFUpload.queue.uploadStartHandler;this.settings.queue_complete_handler=this.settings.queue_complete_handler||null}})(SWFUpload.prototype.initSettings);SWFUpload.prototype.startUpload=function(fileID){this.queueSettings.queue_cancelled_flag=false;this.callFlash("StartUpload",[fileID])};SWFUpload.prototype.cancelQueue=function(){this.queueSettings.queue_cancelled_flag=true;this.stopUpload();var stats=this.getStats();while(stats.files_queued>0){this.cancelUpload();stats=this.getStats()}};SWFUpload.queue.uploadStartHandler=function(file){var returnValue;if(typeof(this.queueSettings.user_upload_start_handler)==="function"){returnValue=this.queueSettings.user_upload_start_handler.call(this,file)}returnValue=(returnValue===false)?false:true;this.queueSettings.queue_cancelled_flag=!returnValue;return returnValue};SWFUpload.queue.uploadCompleteHandler=function(file){var user_upload_complete_handler=this.queueSettings.user_upload_complete_handler;var continueUpload;if(file.filestatus===SWFUpload.FILE_STATUS.COMPLETE){this.queueSettings.queue_upload_count++}if(typeof(user_upload_complete_handler)==="function"){continueUpload=(user_upload_complete_handler.call(this,file)===false)?false:true}else{if(file.filestatus===SWFUpload.FILE_STATUS.QUEUED){continueUpload=false}else{continueUpload=true}}if(continueUpload){var stats=this.getStats();if(stats.files_queued>0&&this.queueSettings.queue_cancelled_flag===false){this.startUpload()}else{if(this.queueSettings.queue_cancelled_flag===false){this.queueEvent("queue_complete_handler",[this.queueSettings.queue_upload_count]);this.queueSettings.queue_upload_count=0}else{this.queueSettings.queue_cancelled_flag=false;this.queueSettings.queue_upload_count=0}}}}}var SWFUpload;if(typeof(SWFUpload)==="function"){SWFUpload.speed={};SWFUpload.prototype.initSettings=(function(oldInitSettings){return function(){if(typeof(oldInitSettings)==="function"){oldInitSettings.call(this)}this.ensureDefault=function(settingName,defaultValue){this.settings[settingName]=(this.settings[settingName]==undefined)?defaultValue:this.settings[settingName]};this.fileSpeedStats={};this.speedSettings={};this.ensureDefault("moving_average_history_size","10");this.speedSettings.user_file_queued_handler=this.settings.file_queued_handler;this.speedSettings.user_file_queue_error_handler=this.settings.file_queue_error_handler;this.speedSettings.user_upload_start_handler=this.settings.upload_start_handler;this.speedSettings.user_upload_error_handler=this.settings.upload_error_handler;this.speedSettings.user_upload_progress_handler=this.settings.upload_progress_handler;this.speedSettings.user_upload_success_handler=this.settings.upload_success_handler;this.speedSettings.user_upload_complete_handler=this.settings.upload_complete_handler;this.settings.file_queued_handler=SWFUpload.speed.fileQueuedHandler;this.settings.file_queue_error_handler=SWFUpload.speed.fileQueueErrorHandler;this.settings.upload_start_handler=SWFUpload.speed.uploadStartHandler;this.settings.upload_error_handler=SWFUpload.speed.uploadErrorHandler;this.settings.upload_progress_handler=SWFUpload.speed.uploadProgressHandler;this.settings.upload_success_handler=SWFUpload.speed.uploadSuccessHandler;this.settings.upload_complete_handler=SWFUpload.speed.uploadCompleteHandler;delete this.ensureDefault}})(SWFUpload.prototype.initSettings);SWFUpload.speed.fileQueuedHandler=function(file){if(typeof this.speedSettings.user_file_queued_handler==="function"){file=SWFUpload.speed.extendFile(file);return this.speedSettings.user_file_queued_handler.call(this,file)}};SWFUpload.speed.fileQueueErrorHandler=function(file,errorCode,message){if(typeof this.speedSettings.user_file_queue_error_handler==="function"){file=SWFUpload.speed.extendFile(file);return this.speedSettings.user_file_queue_error_handler.call(this,file,errorCode,message)}};SWFUpload.speed.uploadStartHandler=function(file){if(typeof this.speedSettings.user_upload_start_handler==="function"){file=SWFUpload.speed.extendFile(file,this.fileSpeedStats);return this.speedSettings.user_upload_start_handler.call(this,file)}};SWFUpload.speed.uploadErrorHandler=function(file,errorCode,message){file=SWFUpload.speed.extendFile(file,this.fileSpeedStats);SWFUpload.speed.removeTracking(file,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_error_handler==="function"){return this.speedSettings.user_upload_error_handler.call(this,file,errorCode,message)}};SWFUpload.speed.uploadProgressHandler=function(file,bytesComplete,bytesTotal){this.updateTracking(file,bytesComplete);file=SWFUpload.speed.extendFile(file,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_progress_handler==="function"){return this.speedSettings.user_upload_progress_handler.call(this,file,bytesComplete,bytesTotal)}};SWFUpload.speed.uploadSuccessHandler=function(file,serverData){if(typeof this.speedSettings.user_upload_success_handler==="function"){file=SWFUpload.speed.extendFile(file,this.fileSpeedStats);return this.speedSettings.user_upload_success_handler.call(this,file,serverData)}};SWFUpload.speed.uploadCompleteHandler=function(file){file=SWFUpload.speed.extendFile(file,this.fileSpeedStats);SWFUpload.speed.removeTracking(file,this.fileSpeedStats);if(typeof this.speedSettings.user_upload_complete_handler==="function"){return this.speedSettings.user_upload_complete_handler.call(this,file)}};SWFUpload.speed.extendFile=function(file,trackingList){if(!file){return null}var tracking;if(trackingList){tracking=trackingList[file.id]}if(tracking){file.currentSpeed=tracking.currentSpeed;file.averageSpeed=tracking.averageSpeed;file.movingAverageSpeed=tracking.movingAverageSpeed;file.timeRemaining=tracking.timeRemaining;file.timeElapsed=tracking.timeElapsed;file.percentUploaded=tracking.percentUploaded;file.sizeUploaded=tracking.bytesUploaded}else{file.currentSpeed=0;file.averageSpeed=0;file.movingAverageSpeed=0;file.timeRemaining=0;file.timeElapsed=0;file.percentUploaded=0;file.sizeUploaded=0}return file};SWFUpload.prototype.updateTracking=function(file,bytesUploaded){var tracking=this.fileSpeedStats[file.id];if(!tracking){this.fileSpeedStats[file.id]=tracking={}}bytesUploaded=bytesUploaded||tracking.bytesUploaded||0;if(bytesUploaded<0){bytesUploaded=0}if(bytesUploaded>file.size){bytesUploaded=file.size}var tickTime=(new Date()).getTime();if(!tracking.startTime){tracking.startTime=(new Date()).getTime();tracking.lastTime=tracking.startTime;tracking.currentSpeed=0;tracking.averageSpeed=0;tracking.movingAverageSpeed=0;tracking.movingAverageHistory=[];tracking.timeRemaining=0;tracking.timeElapsed=0;tracking.percentUploaded=bytesUploaded/file.size;tracking.bytesUploaded=bytesUploaded}else{if(tracking.startTime>tickTime){this.debug("When backwards in time")}else{var now=(new Date()).getTime();var lastTime=tracking.lastTime;var deltaTime=now-lastTime;var deltaBytes=bytesUploaded-tracking.bytesUploaded;if(deltaBytes===0||deltaTime===0){return tracking}tracking.lastTime=now;tracking.bytesUploaded=bytesUploaded;tracking.currentSpeed=(deltaBytes*8)/(deltaTime/1000);tracking.averageSpeed=(tracking.bytesUploaded*8)/((now-tracking.startTime)/1000);tracking.movingAverageHistory.push(tracking.currentSpeed);if(tracking.movingAverageHistory.length>this.settings.moving_average_history_size){tracking.movingAverageHistory.shift()}tracking.movingAverageSpeed=SWFUpload.speed.calculateMovingAverage(tracking.movingAverageHistory);tracking.timeRemaining=(file.size-tracking.bytesUploaded)*8/tracking.movingAverageSpeed;tracking.timeElapsed=(now-tracking.startTime)/1000;tracking.percentUploaded=(tracking.bytesUploaded/file.size*100)}}return tracking};SWFUpload.speed.removeTracking=function(file,trackingList){try{trackingList[file.id]=null;delete trackingList[file.id]}catch(ex){}};SWFUpload.speed.formatUnits=function(baseNumber,unitDivisors,unitLabels,singleFractional){var i,unit,unitDivisor,unitLabel;if(baseNumber===0){return"0 "+unitLabels[unitLabels.length-1]}if(singleFractional){unit=baseNumber;unitLabel=unitLabels.length>=unitDivisors.length?unitLabels[unitDivisors.length-1]:"";for(i=0;i<unitDivisors.length;i++){if(baseNumber>=unitDivisors[i]){unit=(baseNumber/unitDivisors[i]).toFixed(2);unitLabel=unitLabels.length>=i?" "+unitLabels[i]:"";break}}return unit+unitLabel}else{var formattedStrings=[];var remainder=baseNumber;for(i=0;i<unitDivisors.length;i++){unitDivisor=unitDivisors[i];unitLabel=unitLabels.length>i?" "+unitLabels[i]:"";unit=remainder/unitDivisor;if(i<unitDivisors.length-1){unit=Math.floor(unit)}else{unit=unit.toFixed(2)}if(unit>0){remainder=remainder%unitDivisor;formattedStrings.push(unit+unitLabel)}}return formattedStrings.join(" ")}};SWFUpload.speed.formatBPS=function(baseNumber){var bpsUnits=[1073741824,1048576,1024,1],bpsUnitLabels=["Gbps","Mbps","Kbps","bps"];return SWFUpload.speed.formatUnits(baseNumber,bpsUnits,bpsUnitLabels,true)};SWFUpload.speed.formatTime=function(baseNumber){var timeUnits=[86400,3600,60,1],timeUnitLabels=["d","h","m","s"];return SWFUpload.speed.formatUnits(baseNumber,timeUnits,timeUnitLabels,false)};SWFUpload.speed.formatBytes=function(baseNumber){var sizeUnits=[1073741824,1048576,1024,1],sizeUnitLabels=["GB","MB","KB","bytes"];return SWFUpload.speed.formatUnits(baseNumber,sizeUnits,sizeUnitLabels,true)};SWFUpload.speed.formatPercent=function(baseNumber){return baseNumber.toFixed(2)+" %"};SWFUpload.speed.calculateMovingAverage=function(history){var vals=[],size,sum=0,mean=0,varianceTemp=0,variance=0,standardDev=0;var i;var mSum=0,mCount=0;size=history.length;if(size>=8){for(i=0;i<size;i++){vals[i]=history[i];sum+=vals[i]}mean=sum/size;for(i=0;i<size;i++){varianceTemp+=Math.pow((vals[i]-mean),2)}variance=varianceTemp/size;standardDev=Math.sqrt(variance);for(i=0;i<size;i++){vals[i]=(vals[i]-mean)/standardDev}var deviationRange=2;for(i=0;i<size;i++){if(vals[i]<=deviationRange&&vals[i]>=-deviationRange){mCount++;mSum+=history[i]}}}else{mCount=size;for(i=0;i<size;i++){mSum+=history[i]}}return mSum/mCount}}var UppityUpload={forms:[],hasFlashSupport:function(){return FlashDetect.versionAtLeast(9)&&location.hash!="#noflash"},install:function(formElement){if(!UppityUpload.find(formElement)){var form=new UppityUpload.Form(formElement);UppityUpload.forms.push(form);return form}},find:function(formElement){return this.forms.find(function(form){return form.element==formElement})},uninstall:function(formElement){var form=UppityUpload.find(formElement);if(form){UppityUpload.forms=UppityUpload.forms.without(form);form.revert()}}};UppityUpload.AttachmentManager=Class.create({initialize:function(options){this.options=options||{};this.selectorControl=this.options.selectorControl;this.connectToSelectorControl();this.attachments=[]},addAttachment:function(attributes){var id=this.attachments.length;this.attachments[id]=Object.extend(Object.clone(attributes),{id:id});this.options.onAttachmentAdded(id,this.attachments[id]);return id},getAttachment:function(id){return this.attachments[id]},getAttachments:function(){return this.attachments.compact()},removeAttachment:function(id){var attributes=this.attachments[id];this.attachments[id]=null;this.options.onAttachmentRemoved(id,attributes)},prepareAttachments:function(onAttachmentsPrepared){if(!this.onAttachmentsPrepared){this.onAttachmentsPrepared=onAttachmentsPrepared;this.startAttachmentPreparation()}},finishAttachmentPreparation:function(attachmentsPrepared){if(this.onAttachmentsPrepared){this.onAttachmentsPrepared(attachmentsPrepared);this.onAttachmentsPrepared=null}},getButtonControl:function(){return this.selectorControl.getButtonControl()}});UppityUpload.AttachmentManager.createAttachmentManager=function(options,attachmentManagerPreference){if(UppityUpload.hasFlashSupport()){if(attachmentManagerPreference&&attachmentManagerPreference!="flash"){return new UppityUpload.HtmlAttachmentManager(options)}else{return new UppityUpload.FlashAttachmentManager(options)}}else{return new UppityUpload.HtmlAttachmentManager(options)}};UppityUpload.FlashAttachmentManager=Class.create(UppityUpload.AttachmentManager,{initialize:function($super,options){$super(options);this.ids={};this.totalBytesQueued=0;this.totalAttachmentsQueued=0;this.retry=0},name:"flash",connectToSelectorControl:function(){this.getButtonControl().withPlaceholderForFlashMovie(this.createSWFUpload.bind(this))},createSWFUpload:function(placeholder,width,height){this.swfUpload=new SWFUpload(this.optionsForSWFUpload(placeholder,width,height))},startAttachmentPreparation:function(){if(this.totalBytesQueued>0){this.totalBytesUploaded=0;this.swfUpload.startUpload()}else{this.finishAttachmentPreparation(true)}},removeAttachment:function($super,id){for(var flashID in this.ids){if(this.ids[flashID]==id){this.totalBytesQueued-=this.getAttachment(id).size;this.totalAttachmentsQueued-=1;this.swfUpload.cancelUpload(flashID,false);delete this.ids[flashID];break}}return $super(id)},optionsForSWFUpload:function(placeholder,width,height){return{flash_url:this.absoluteURLFor("/movies/swfupload.swf"),button_image_url:this.absoluteURLFor("/images/blank.gif"),upload_url:this.absoluteURLFor(this.options.uploadURL),requeue_on_error:true,file_size_limit:this.options.fileSizeLimit,file_upload_limit:this.options.fileUploadLimit,file_dialog_start_handler:this.onChooseFileDialogOpened.bind(this),file_queued_handler:this.onAttachmentQueued.bind(this),file_queue_error_handler:this.onAttachmentQueueFailed.bind(this),file_dialog_complete_handler:this.onChooseFileDialogClosed.bind(this),upload_start_handler:this.onUploadStarted.bind(this),upload_progress_handler:this.onUploadProgressChanged.bind(this),upload_success_handler:this.onUploadSucceeded.bind(this),upload_error_handler:this.onUploadFailed.bind(this),upload_complete_handler:this.onUploadCompleted.bind(this),button_placeholder_id:placeholder.identify(),button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,button_cursor:SWFUpload.CURSOR.HAND,button_width:width,button_height:height}},absoluteURLFor:function(path){var url=document.location.protocol+"//"+document.location.host;if(document.location.port){url+=":"+document.location.port}return url+path},buildErrorMessageFor:function(files,selectedFileCount,reason){if(files.length==1&&selectedFileCount==1){return"The file you selected can't be attached because it is "+reason+"."}else{if(files.length==1){return'The file "'+files.first().name+"\" can't be attached because it is "+reason+"."}else{if(files.length==selectedFileCount){return"None of the files you selected can be attached because they are all "+reason+"."}else{return""+files.length+' of the files you selected ("'+files.pluck("name").join('", "')+"\") can't be attached because they are "+reason+"."}}}},showUploadProgress:function(fileName,completedBytes){var progress=(this.totalBytesUploaded+(completedBytes||0))/this.totalBytesQueued;this.options.onProgressChanged(UppityUpload.UPLOADING+" "+fileName.escapeHTML()+"â€¦",progress)},onChooseFileDialogOpened:function(){this.errors={}},onAttachmentQueued:function(attachmentInfo){this.ids[attachmentInfo.id]=this.addAttachment(attachmentInfo);this.totalBytesQueued+=attachmentInfo.size;this.totalAttachmentsQueued+=1;if(this.swfUpload.settings.file_upload_limit>0&&this.totalAttachmentsQueued>=this.swfUpload.settings.file_upload_limit){this.options.onAttachmentLimitReached(this.totalAttachmentsQueued)}},onAttachmentQueueFailed:function(attachmentInfo,errorCode,errorMessage){this.errors[errorCode]=this.errors[errorCode]||[];this.errors[errorCode].push(attachmentInfo)},onChooseFileDialogClosed:function(selectedFileCount,queuedFileCount){var files,messages=[];if(files=this.errors[SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT]){messages.push(this.buildErrorMessageFor(files,selectedFileCount,"larger than "+this.options.fileSizeLimit+" in size"))}if(files=this.errors[SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE]){messages.push(this.buildErrorMessageFor(files,selectedFileCount,"empty or inaccessible"))}if(files=this.errors[SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED]){messages.push("You selected too many files. You can only upload "+this.swfUpload.settings.file_upload_limit+" at one time.")}if(messages.length){alert(messages.join("\n\n"))}},onUploadStarted:function(attachmentInfo){this.showUploadProgress(attachmentInfo.name)},onUploadProgressChanged:function(attachmentInfo,completedBytes,totalBytes){this.showUploadProgress(attachmentInfo.name,completedBytes)},onUploadSucceeded:function(attachmentInfo,responseBody,serverDidRespond){var id=this.ids[attachmentInfo.id],filename=responseBody.match(/<id>(.*?)<\/id>/)[1];this.options.onAttachmentProcessed(id,this.createInputFieldsForAttachment(attachmentInfo,filename));this.retry=0},onUploadFailed:function(attachmentInfo,errorCode,message){this.totalBytesQueued+=attachmentInfo.size;this.retry++},onUploadCompleted:function(attachmentInfo){if(this.retry>=3){this.swfUpload.cancelUpload();this.uploaded=true;this.finishAttachmentPreparation(false)}else{this.totalBytesUploaded+=attachmentInfo.size;this.showUploadProgress(attachmentInfo.name);if(this.totalBytesUploaded==this.totalBytesQueued){this.uploaded=true;this.finishAttachmentPreparation(true)}}},createInputFieldsForAttachment:function(attachmentInfo,filename){return[new Element("input").writeAttribute({type:"hidden",name:"[file][original_filename]",value:attachmentInfo.name}),new Element("input").writeAttribute({type:"hidden",name:"[file][file]",value:filename})]}});UppityUpload.HtmlAttachmentManager=Class.create(UppityUpload.AttachmentManager,{initialize:function($super,options){$super(options);this.inputFields={}},name:"html",connectToSelectorControl:function(){this.getButtonControl().whenInputFieldIsPopulated(this.storeInputField.bind(this))},storeInputField:function(inputField){var name=inputField.getValue().replace(/c:\\fakepath\\/i,"");var id=this.addAttachment({name:name});inputField.writeAttribute({name:"[file]"});this.inputFields[id]=inputField},startAttachmentPreparation:function(){this.getAttachments().each(function(attachmentInfo){var id=attachmentInfo.id;this.options.onAttachmentProcessed(id,[this.inputFields[id]])}.bind(this));this.finishAttachmentPreparation(true)}});UppityUpload.Control=Class.create({initialize:function(form,options){this.form=form;this.options=options||{};if(this.options.element){this.element=$(this.options.element)}this.setup()},setup:Prototype.emptyFunction,remove:function(){this.element.remove()},toElement:function(){return this.element}});UppityUpload.AttachmentControl=Class.create(UppityUpload.Control,{setup:function(){this.selectorControl=this.options.selectorControl;this.iconElement=this.createIconElement();this.nameElement=this.createNameElement();this.removeLink=this.createRemoveLink();this.element=new Element("div").addClassName("attachment");this.innerElement=new Element("div").addClassName("inner");this.privateElement=new Element("div").addClassName("private");this.publicElement=new Element("div").addClassName("public");this.privateElement.insert(this.iconElement);this.privateElement.insert(this.nameElement);this.privateElement.insert(this.removeLink);this.innerElement.insert(this.privateElement);this.innerElement.insert(this.publicElement);this.element.insert(this.innerElement)},createIconElement:function(){return new Element("img").addClassName("icon").writeAttribute("src",this.getIconURL())},createNameElement:function(){return new Element("span").addClassName("filename").update(this.getFileName().escapeHTML().truncate(40,"..."))},createRemoveLink:function(){var element=new Element("a").addClassName("remove").writeAttribute("href","#");element.update("<span>"+UppityUpload.REMOVE+"</span>");element.observe("click",this.onRemoveLinkClicked.bind(this));return element},getAttachmentInfo:function(){return this.form.attachmentManager.getAttachment(this.options.id)},getFileName:function(){return this.getAttachmentInfo().name},getIconURL:function(){var extension=(this.getFileName().match(/\.([^.]+)$/)||[]).last();return FileIcon.path(extension,this.selectorControl.getIconSize())},formatParameterName:function(name){return this.selectorControl.formatParameterName(this.options.id,name)},onRemoveLinkClicked:function(event){this.form.attachmentManager.removeAttachment(this.options.id);event.stop()},insertInputField:function(inputField){var parameterName=inputField.readAttribute("name");inputField.hide().writeAttribute({name:this.formatParameterName(parameterName)});this.privateElement.insert(inputField)},update:function(){this.publicElement.update.apply(this.publicElement,arguments)}});UppityUpload.ButtonControl=Class.create(UppityUpload.Control,{setup:function(){this.createInputField()},withPlaceholderForFlashMovie:function(callback){var box,offset,placeholder;this.element.forceVisibility(function(){box={width:this.inputField.measure("border-box-width"),height:this.element.measure("height")};if(Prototype.Browser.IE){box.width=box.width+5}offset=this.inputField.positionedOffset();this.overlay=new Element("div").setStyle({position:"absolute",top:offset.top+"px",left:offset.left+"px",width:box.width+"px",height:box.height+"px"})}.bind(this));placeholder=new Element("div");this.overlay.insert(placeholder);this.element.insert(this.overlay);callback(placeholder,box.width,box.height)},whenInputFieldIsPopulated:function(callback){this.onInputFieldPopulated=callback},createInputField:function(){this.inputField=new Element("input").writeAttribute({type:"file"});this.inputField.observe("change",this.onChange.bind(this));this.element.insert(this.inputField)},replaceInputField:function(){var oldInputField=this.inputField.remove();this.createInputField();return oldInputField},onChange:function(event){this.onInputFieldPopulated(this.replaceInputField());event.stop()},disable:function(){this.inputField.disable();this.setOverlayVisibilityTo("hidden")},enable:function(){this.inputField.enable();this.setOverlayVisibilityTo("visible")},hide:function(){this.element.addClassName("hidden")},show:function(){this.element.removeClassName("hidden")},setOverlayVisibilityTo:function(visibility){if(this.overlay){this.overlay.setStyle({visibility:visibility})}},slideIntoView:function(){this.element.slideIntoView()}});UppityUpload.FileSelectorControl=Class.create(UppityUpload.Control,{setup:function(){this.buttonControl=this.createButtonControl();this.prefix=this.element.readAttribute("prefix")||"attachments"},createButtonControl:function(){var element=this.element.down("div.attachment_button");return new UppityUpload.ButtonControl(this.form,{element:element})},getButtonControl:function(){return this.buttonControl},hideButton:function(){this.getButtonControl().disable();this.element.down("div.attachment_button_label").hide()},showButton:function(){this.getButtonControl().enable();this.element.down("div.attachment_button_label").show()},getAttachmentContainer:function(){return this.attachmentContainer=this.attachmentContainer||this.element.down("div.attachment_container")},getIconSize:function(){return this.iconSize=this.iconSize||(this.getAttachmentContainer().hasClassName("big_icons")?"big":"small")},createAttachmentControl:function(id){return new UppityUpload.AttachmentControl(this.form,{id:id,selectorControl:this})},enable:function(){this.getAttachmentContainer().removeClassName("disabled");this.getButtonControl().enable()},disable:function(){this.getButtonControl().disable();this.getAttachmentContainer().addClassName("disabled")}});UppityUpload.FileSelectorControl.createFileSelectorControl=function(form){var element=form.element.down("div.single_file_selector, div.multiple_file_selector");if(!element){return false}if(element.hasClassName("single_file_selector")){return new UppityUpload.SingleFileSelectorControl(form,{element:element})}else{return new UppityUpload.MultipleFileSelectorControl(form,{element:element})}};UppityUpload.MultipleFileSelectorControl=Class.create(UppityUpload.FileSelectorControl,{setup:function($super){$super();this.attachmentControls={}},addAttachment:function(id){this.attachmentControls[id]=this.createAttachmentControl(id);this.getAttachmentContainer().insert(this.attachmentControls[id])},removeAttachment:function(id){this.attachmentControls[id].remove();this.attachmentControls[id]=null},getAttachmentControl:function(id){return this.attachmentControls[id]},formatParameterName:function(id,name){return this.prefix+"["+id+"]"+name}});UppityUpload.SingleFileSelectorControl=Class.create(UppityUpload.FileSelectorControl,{setup:function($super){$super();this.changeLink=this.createChangeLink();this.changeLink.hide();this.element.insert(this.changeLink)},createChangeLink:function(){var element=new Element("a").addClassName("change").writeAttribute("href","#");element.update("<span>"+UppityUpload.CHOOSE_A_DIFFERENT_FILE+"</span>");element.observe("click",this.onChangeLinkClicked.bind(this));return element},addAttachment:function(id){this.clearExistingAttachment();this.attachmentControl=this.createAttachmentControl(id);this.getAttachmentContainer().insert(this.attachmentControl);this.buttonControl.hide();this.changeLink.show()},removeAttachment:function(){if(this.attachmentControl){this.attachmentControl.remove();this.attachmentControl=null}this.buttonControl.show();this.changeLink.hide()},clearExistingAttachment:function(){if(this.attachmentControl){var oldAttachmentId=this.attachmentControl.getAttachmentInfo().id;this.form.attachmentManager.removeAttachment(oldAttachmentId)}},onChangeLinkClicked:function(event){this.clearExistingAttachment();event.stop()},getAttachmentControl:function(){return this.attachmentControl},formatParameterName:function(id,name){return this.prefix+name}});UppityUpload.ProgressBarControl=Class.create(UppityUpload.Control,{setup:function(){this.element=new Element("div").addClassName("progress_bar");this.progressElement=new Element("div").addClassName("progress");this.element.insert(this.progressElement);this.setValue(0)},setValue:function(value,animate){var outerWidth=this.element.getDimensions().width;var innerWidth=parseInt(outerWidth*value);animate=innerWidth>0&&animate!==false;if(animate){this.animateToWidth(innerWidth)}else{this.progressElement.setStyle({width:innerWidth+"px"})}},animateToWidth:function(width){if(this.effect){this.effect.cancel()}this.effect=new Effect.Morph(this.progressElement,{duration:0.25,transition:Effect.Transitions.easeInSine,style:"width: "+width+"px",afterFinish:function(){delete this.effect}.bind(this)})}});UppityUpload.SubmitBarControl=Class.create(UppityUpload.Control,{setup:function(){this.submitContainer=$(this.options.submitContainer);this.progressContainer=new Element("div").addClassName("progress_container");this.statusMessageElement=new Element("div").addClassName("status_message");this.progressBarControl=new UppityUpload.ProgressBarControl(this.form);this.progressContainer.insert(this.statusMessageElement);this.progressContainer.insert(this.progressBarControl);this.element=this.submitContainer.wrap("div").addClassName("uppity_upload_submit_bar");this.element.insert(this.progressContainer);this.element.observe("click",this.onClick.bind(this));this.hideProgress()},showProgress:function(statusMessage,value,animate){if(!this.submitting){this.progressContainer.show();this.submitContainer.hide();this.submitting=true}this.statusMessageElement.update((statusMessage||"")+"&nbsp;");this.progressBarControl.setValue(value||0,animate);return this},hideProgress:function(){this.progressContainer.hide();this.submitContainer.show();this.submitting=false;return this},onClick:function(event){var element=event.findElement("input[type=submit]");if(element){if(element.form&&element.form!=this.form.element){return}this.form.submit();event.stop()}},slideIntoView:function(){this.element.slideIntoView();return this},revert:function(){this.element.insert({after:this.submitContainer});this.element.remove()}});UppityUpload.Form=Class.create({initialize:function(element){this.element=$(element);this.innerHTML=this.element.innerHTML;if(this.selectorControl=this.createSelectorControl()){this.attachmentManager=this.createAttachmentManager();this.element.writeAttribute("current_attachment_manager",this.attachmentManager.name)}this.submitBarControl=this.createSubmitBarControl();this.element.observe("submit",this.submit.bind(this))},createSelectorControl:function(){return UppityUpload.FileSelectorControl.createFileSelectorControl(this)},createSubmitBarControl:function(){var submitContainer=this.getOption("submit_container");return new UppityUpload.SubmitBarControl(this,{submitContainer:submitContainer})},createAttachmentManager:function(){return UppityUpload.AttachmentManager.createAttachmentManager({selectorControl:this.selectorControl,uploadURL:this.getOption("upload_url"),fileSizeLimit:this.getOption("file_size_limit")||0,fileUploadLimit:this.getOption("file_upload_limit")||0,onAttachmentAdded:this.onAttachmentAdded.bind(this),onAttachmentProcessed:this.onAttachmentProcessed.bind(this),onAttachmentRemoved:this.onAttachmentRemoved.bind(this),onProgressChanged:this.onProgressChanged.bind(this),onAttachmentLimitReached:this.onAttachmentLimitReached.bind(this)},this.getOption("preferred_attachment_manager"))},submit:function(event){if(event){event.stop()}if(!this.validateForm()){return false}if(!this.prepareAttachments()){return false}this.showProgress(this.getOption("finish_text")||"Finishingâ€¦",1);this.enable();if(!this.element.fire("form:submit",{form:this}).stopped){this.element.submit()}this.disable()},validateForm:function(){return !this.element.fire("form:beforesubmit",{form:this}).stopped},prepareAttachments:function(){if(!this.attachmentManager||this.attachmentsPrepared){return true}else{this.disable();this.attachmentManager.prepareAttachments(function(attachmentsPrepared){this.attachmentsPrepared=attachmentsPrepared;this.onAttachmentsPrepared(attachmentsPrepared)}.bind(this))}},enable:function(){if(this.selectorControl){this.selectorControl.enable()}this.element.getInputs().each(function(input){if(input.type=="button"||input.type=="submit"){input.enable()}});this.element.disabled=false},disable:function(){this.element.disabled=true;this.element.getInputs().each(function(input){if(input.type=="button"||input.type=="submit"){input.disable()}});if(this.selectorControl){this.selectorControl.disable()}},reset:function(){if(this.attachmentManager){this.attachmentManager.getAttachments().each(function(attachmentInfo){this.attachmentManager.removeAttachment(attachmentInfo.id)}.bind(this))}this.element.reset()},showProgress:function(message,progress){if(!this.hasShownProgress){this.hasShownProgress=true;this.submitBarControl.showProgress(message,progress,false);this.submitBarControl.slideIntoView()}else{this.submitBarControl.showProgress(message,progress)}},onAttachmentAdded:function(id,attributes){this.selectorControl.addAttachment(id);this.element.fire("attachment:added",{form:this,id:id})},onAttachmentProcessed:function(id,inputFields){var attachmentControl=this.getAttachmentControl(id);inputFields.each(function(inputFields){attachmentControl.insertInputField(inputFields)})},onAttachmentRemoved:function(id,attributes){this.selectorControl.removeAttachment(id);this.selectorControl.showButton();this.element.fire("attachment:removed",{form:this,id:id})},onAttachmentLimitReached:function(count){this.selectorControl.hideButton()},onProgressChanged:function(message,progress){this.showProgress(message,progress)},onAttachmentsPrepared:function(attachmentsPrepared){this.submit.bind(this).defer()},getAttachments:function(){return this.attachmentManager.getAttachments()},hasAttachments:function(){return this.attachmentManager.getAttachments().length},getAttachmentControl:function(id){return this.selectorControl.getAttachmentControl(id)},getButtonControl:function(){return this.selectorControl.getButtonControl()},getOption:function(name){var value=this.element.readAttribute(name);if(name.match(/_(container|element)$/)){return $(value)}return value},revert:function(){this.element.preservingValues(function(){this.submitBarControl.revert();this.element.update(this.innerHTML)}.bind(this));this.element.stopObserving("submit")}});UppityUpload.CHOOSE_A_DIFFERENT_FILE="Choose a different file";UppityUpload.REMOVE="Remove";UppityUpload.UPLOADING="Uploading";document.observe("dom:modified",function(){$(document.body).select("form.uppity_upload").each(UppityUpload.install)});var WysiHat={};WysiHat.Editor={attach:function(textarea){var editArea;textarea=$(textarea);var id=textarea.id+"_editor";if(editArea=$(id)){return editArea}editArea=new Element("div",{id:id,"class":"editor",contentEditable:"true"});editArea.update(WysiHat.Formatting.getBrowserMarkupFrom(textarea.value));Object.extend(editArea,WysiHat.Commands);textarea.insert({before:editArea});textarea.hide();return editArea}};WysiHat.BrowserFeatures=(function(){function createTmpIframe(callback){var frame,frameDocument;frame=new Element("iframe");frame.setStyle({position:"absolute",left:"-1000px"});frame.onFrameLoaded(function(){if(typeof frame.contentDocument!=="undefined"){frameDocument=frame.contentDocument}else{if(typeof frame.contentWindow!=="undefined"&&typeof frame.contentWindow.document!=="undefined"){frameDocument=frame.contentWindow.document}}frameDocument.designMode="on";callback(frameDocument);frame.remove()});$(document.body).insert(frame)}var features={};function detectParagraphType(document){document.body.innerHTML="";document.execCommand("insertparagraph",false,null);var tagName;element=document.body.childNodes[0];if(element&&element.tagName){tagName=element.tagName.toLowerCase()}if(tagName=="div"){features.paragraphType="div"}else{if(document.body.innerHTML=="<p><br></p>"){features.paragraphType="br"}else{features.paragraphType="p"}}}function detectIndentType(document){document.body.innerHTML="tab";document.execCommand("indent",false,null);var tagName;element=document.body.childNodes[0];if(element&&element.tagName){tagName=element.tagName.toLowerCase()}features.indentInsertsBlockquote=(tagName=="blockquote")}features.run=function run(){if(features.finished){return}createTmpIframe(function(document){detectParagraphType(document);detectIndentType(document);features.finished=true})};return features})();if(!window.getSelection){var DOMUtils={isDataNode:function(node){try{return node&&node.nodeValue!==null&&node.data!==null}catch(e){return false}},isAncestorOf:function(parent,node){if(!parent){return false}return !DOMUtils.isDataNode(parent)&&(parent.contains(DOMUtils.isDataNode(node)?node.parentNode:node)||node.parentNode==parent)},isAncestorOrSelf:function(root,node){return DOMUtils.isAncestorOf(root,node)||root==node},findClosestAncestor:function(root,node){if(DOMUtils.isAncestorOf(root,node)){while(node&&node.parentNode!=root){node=node.parentNode}}return node},getNodeLength:function(node){return DOMUtils.isDataNode(node)?node.length:node.childNodes.length},splitDataNode:function(node,offset){if(!DOMUtils.isDataNode(node)){return false}var newNode=node.cloneNode(false);node.deleteData(offset,node.length);newNode.deleteData(0,offset);node.parentNode.insertBefore(newNode,node.nextSibling)}};window.Range=(function(){function Range(document){this._document=document;this.startContainer=this.endContainer=document.body;this.endOffset=DOMUtils.getNodeLength(document.body)}Range.START_TO_START=0;Range.START_TO_END=1;Range.END_TO_END=2;Range.END_TO_START=3;function findChildPosition(node){for(var i=0;node=node.previousSibling;i++){continue}return i}Range.prototype={startContainer:null,startOffset:0,endContainer:null,endOffset:0,commonAncestorContainer:null,collapsed:false,_document:null,_toTextRange:function(){function adoptEndPoint(textRange,domRange,bStart){var container=domRange[bStart?"startContainer":"endContainer"];var offset=domRange[bStart?"startOffset":"endOffset"],textOffset=0;var anchorNode=DOMUtils.isDataNode(container)?container:container.childNodes[offset];var anchorParent=DOMUtils.isDataNode(container)?container.parentNode:container;if(container.nodeType==3||container.nodeType==4){textOffset=offset}var cursorNode=domRange._document.createElement("a");if(anchorNode){anchorParent.insertBefore(cursorNode,anchorNode)}else{anchorParent.appendChild(cursorNode)}var cursor=domRange._document.body.createTextRange();cursor.moveToElementText(cursorNode);cursorNode.parentNode.removeChild(cursorNode);textRange.setEndPoint(bStart?"StartToStart":"EndToStart",cursor);textRange[bStart?"moveStart":"moveEnd"]("character",textOffset)}var textRange=this._document.body.createTextRange();adoptEndPoint(textRange,this,true);adoptEndPoint(textRange,this,false);return textRange},_refreshProperties:function(){this.collapsed=(this.startContainer==this.endContainer&&this.startOffset==this.endOffset);var node=this.startContainer;while(node&&node!=this.endContainer&&!DOMUtils.isAncestorOf(node,this.endContainer)){node=node.parentNode}this.commonAncestorContainer=node},setStart:function(container,offset){this.startContainer=container;this.startOffset=offset;this._refreshProperties()},setEnd:function(container,offset){this.endContainer=container;this.endOffset=offset;this._refreshProperties()},setStartBefore:function(refNode){this.setStart(refNode.parentNode,findChildPosition(refNode))},setStartAfter:function(refNode){this.setStart(refNode.parentNode,findChildPosition(refNode)+1)},setEndBefore:function(refNode){this.setEnd(refNode.parentNode,findChildPosition(refNode))},setEndAfter:function(refNode){this.setEnd(refNode.parentNode,findChildPosition(refNode)+1)},selectNode:function(refNode){this.setStartBefore(refNode);this.setEndAfter(refNode)},selectNodeContents:function(refNode){this.setStart(refNode,0);this.setEnd(refNode,DOMUtils.getNodeLength(refNode))},collapse:function(toStart){if(toStart){this.setEnd(this.startContainer,this.startOffset)}else{this.setStart(this.endContainer,this.endOffset)}},cloneContents:function(){return(function cloneSubtree(iterator){for(var node,frag=document.createDocumentFragment();node=iterator.next();){node=node.cloneNode(!iterator.hasPartialSubtree());if(iterator.hasPartialSubtree()){node.appendChild(cloneSubtree(iterator.getSubtreeIterator()))}frag.appendChild(node)}return frag})(new RangeIterator(this))},extractContents:function(){var range=this.cloneRange();if(this.startContainer!=this.commonAncestorContainer){this.setStartAfter(DOMUtils.findClosestAncestor(this.commonAncestorContainer,this.startContainer))}this.collapse(true);return(function extractSubtree(iterator){for(var node,frag=document.createDocumentFragment();node=iterator.next();){iterator.hasPartialSubtree()?node=node.cloneNode(false):iterator.remove();if(iterator.hasPartialSubtree()){node.appendChild(extractSubtree(iterator.getSubtreeIterator()))}frag.appendChild(node)}return frag})(new RangeIterator(range))},deleteContents:function(){var range=this.cloneRange();if(this.startContainer!=this.commonAncestorContainer){this.setStartAfter(DOMUtils.findClosestAncestor(this.commonAncestorContainer,this.startContainer))}this.collapse(true);(function deleteSubtree(iterator){while(iterator.next()){iterator.hasPartialSubtree()?deleteSubtree(iterator.getSubtreeIterator()):iterator.remove()}})(new RangeIterator(range))},insertNode:function(newNode){if(DOMUtils.isDataNode(this.startContainer)){DOMUtils.splitDataNode(this.startContainer,this.startOffset);this.startContainer.parentNode.insertBefore(newNode,this.startContainer.nextSibling)}else{var offsetNode=this.startContainer.childNodes[this.startOffset];if(offsetNode){this.startContainer.insertBefore(newNode,offsetNode)}else{this.startContainer.appendChild(newNode)}}this.setStart(this.startContainer,this.startOffset)},surroundContents:function(newNode){var content=this.extractContents();this.insertNode(newNode);newNode.appendChild(content);this.selectNode(newNode)},compareBoundaryPoints:function(how,sourceRange){var containerA,offsetA,containerB,offsetB;switch(how){case Range.START_TO_START:case Range.START_TO_END:containerA=this.startContainer;offsetA=this.startOffset;break;case Range.END_TO_END:case Range.END_TO_START:containerA=this.endContainer;offsetA=this.endOffset;break}switch(how){case Range.START_TO_START:case Range.END_TO_START:containerB=sourceRange.startContainer;offsetB=sourceRange.startOffset;break;case Range.START_TO_END:case Range.END_TO_END:containerB=sourceRange.endContainer;offsetB=sourceRange.endOffset;break}return containerA.sourceIndex<containerB.sourceIndex?-1:containerA.sourceIndex==containerB.sourceIndex?offsetA<offsetB?-1:offsetA==offsetB?0:1:1},cloneRange:function(){var range=new Range(this._document);range.setStart(this.startContainer,this.startOffset);range.setEnd(this.endContainer,this.endOffset);return range},detach:function(){},toString:function(){return this._toTextRange().text},createContextualFragment:function(tagString){var content=(DOMUtils.isDataNode(this.startContainer)?this.startContainer.parentNode:this.startContainer).cloneNode(false);content.innerHTML=tagString;for(var fragment=this._document.createDocumentFragment();content.firstChild;){fragment.appendChild(content.firstChild)}return fragment}};function RangeIterator(range){this.range=range;if(range.collapsed){return}var root=range.commonAncestorContainer;this._next=range.startContainer==root&&!DOMUtils.isDataNode(range.startContainer)?range.startContainer.childNodes[range.startOffset]:DOMUtils.findClosestAncestor(root,range.startContainer);this._end=range.endContainer==root&&!DOMUtils.isDataNode(range.endContainer)?range.endContainer.childNodes[range.endOffset]:DOMUtils.findClosestAncestor(root,range.endContainer).nextSibling}RangeIterator.prototype={range:null,_current:null,_next:null,_end:null,hasNext:function(){return !!this._next},next:function(){var current=this._current=this._next;this._next=this._current&&this._current.nextSibling!=this._end?this._current.nextSibling:null;if(DOMUtils.isDataNode(this._current)){if(this.range.endContainer==this._current){(current=current.cloneNode(true)).deleteData(this.range.endOffset,current.length-this.range.endOffset)}if(this.range.startContainer==this._current){(current=current.cloneNode(true)).deleteData(0,this.range.startOffset)}}return current},remove:function(){if(DOMUtils.isDataNode(this._current)&&(this.range.startContainer==this._current||this.range.endContainer==this._current)){var start=this.range.startContainer==this._current?this.range.startOffset:0;var end=this.range.endContainer==this._current?this.range.endOffset:this._current.length;this._current.deleteData(start,end-start)}else{this._current.parentNode.removeChild(this._current)}},hasPartialSubtree:function(){return !DOMUtils.isDataNode(this._current)&&(DOMUtils.isAncestorOrSelf(this._current,this.range.startContainer)||DOMUtils.isAncestorOrSelf(this._current,this.range.endContainer))},getSubtreeIterator:function(){var subRange=new Range(this.range._document);subRange.selectNodeContents(this._current);if(DOMUtils.isAncestorOrSelf(this._current,this.range.startContainer)){subRange.setStart(this.range.startContainer,this.range.startOffset)}if(DOMUtils.isAncestorOrSelf(this._current,this.range.endContainer)){subRange.setEnd(this.range.endContainer,this.range.endOffset)}return new RangeIterator(subRange)}};return Range})();window.Range._fromTextRange=function(textRange,document){function adoptBoundary(domRange,textRange,bStart){var cursorNode=document.createElement("a"),cursor=textRange.duplicate();cursor.collapse(bStart);var parent=cursor.parentElement();do{parent.insertBefore(cursorNode,cursorNode.previousSibling);cursor.moveToElementText(cursorNode)}while(cursor.compareEndPoints(bStart?"StartToStart":"StartToEnd",textRange)>0&&cursorNode.previousSibling);if(cursor.compareEndPoints(bStart?"StartToStart":"StartToEnd",textRange)==-1&&cursorNode.nextSibling){cursor.setEndPoint(bStart?"EndToStart":"EndToEnd",textRange);domRange[bStart?"setStart":"setEnd"](cursorNode.nextSibling,cursor.text.length)}else{domRange[bStart?"setStartBefore":"setEndBefore"](cursorNode)}cursorNode.parentNode.removeChild(cursorNode)}var domRange=new Range(document);adoptBoundary(domRange,textRange,true);adoptBoundary(domRange,textRange,false);return domRange};document.createRange=function(){return new Range(document)};window.Selection=(function(){function Selection(document){this._document=document;var selection=this;document.attachEvent("onselectionchange",function(){selection._selectionChangeHandler()})}Selection.prototype={rangeCount:0,_document:null,_selectionChangeHandler:function(){this.rangeCount=this._selectionExists(this._document.selection.createRange())?1:0},_selectionExists:function(textRange){return textRange.compareEndPoints("StartToEnd",textRange)!=0||textRange.parentElement().isContentEditable},addRange:function(range){var selection=this._document.selection.createRange(),textRange=range._toTextRange();if(!this._selectionExists(selection)){textRange.select()}else{if(textRange.compareEndPoints("StartToStart",selection)==-1){if(textRange.compareEndPoints("StartToEnd",selection)>-1&&textRange.compareEndPoints("EndToEnd",selection)==-1){selection.setEndPoint("StartToStart",textRange)}else{if(textRange.compareEndPoints("EndToStart",selection)<1&&textRange.compareEndPoints("EndToEnd",selection)>-1){selection.setEndPoint("EndToEnd",textRange)}}}selection.select()}},removeAllRanges:function(){this._document.selection.empty()},getRangeAt:function(index){var textRange=this._document.selection.createRange();if(this._selectionExists(textRange)){return Range._fromTextRange(textRange,this._document)}return null},toString:function(){return this._document.selection.createRange().text}};return Selection})();window.getSelection=(function(){var selection=new Selection(document);return function(){return selection}})();window.getSelection.custom=true}Object.extend(Range.prototype,(function(){function beforeRange(range){if(!range||!range.compareBoundaryPoints){return false}return(this.compareBoundaryPoints(this.START_TO_START,range)==-1&&this.compareBoundaryPoints(this.START_TO_END,range)==-1&&this.compareBoundaryPoints(this.END_TO_END,range)==-1&&this.compareBoundaryPoints(this.END_TO_START,range)==-1)}function afterRange(range){if(!range||!range.compareBoundaryPoints){return false}return(this.compareBoundaryPoints(this.START_TO_START,range)==1&&this.compareBoundaryPoints(this.START_TO_END,range)==1&&this.compareBoundaryPoints(this.END_TO_END,range)==1&&this.compareBoundaryPoints(this.END_TO_START,range)==1)}function betweenRange(range){if(!range||!range.compareBoundaryPoints){return false}return !(this.beforeRange(range)||this.afterRange(range))}function equalRange(range){if(!range||!range.compareBoundaryPoints){return false}return(this.compareBoundaryPoints(this.START_TO_START,range)==0&&this.compareBoundaryPoints(this.START_TO_END,range)==1&&this.compareBoundaryPoints(this.END_TO_END,range)==0&&this.compareBoundaryPoints(this.END_TO_START,range)==-1)}function getNode(){var parent=this.commonAncestorContainer;while(parent.nodeType==Node.TEXT_NODE){parent=parent.parentNode}var child=parent.childElements().detect(function(child){var range=document.createRange();range.selectNodeContents(child);return this.betweenRange(range)}.bind(this));return $(child||parent)}return{beforeRange:beforeRange,afterRange:afterRange,betweenRange:betweenRange,equalRange:equalRange,getNode:getNode}})());if(window.getSelection.custom){Object.extend(Selection.prototype,(function(){function getNode(){var range=this._document.selection.createRange();return $(range.parentElement())}function selectNode(element){var range=this._document.body.createTextRange();range.moveToElementText(element);range.select()}return{getNode:getNode,selectNode:selectNode}})())}else{if(typeof Selection=="undefined"){var Selection={};Selection.prototype=window.getSelection().__proto__}Object.extend(Selection.prototype,(function(){function getNode(){if(this.rangeCount>0){return this.getRangeAt(0).getNode()}else{return null}}function selectNode(element){var range=document.createRange();range.selectNode(element);this.removeAllRanges();this.addRange(range)}return{getNode:getNode,selectNode:selectNode}})())}document.on("dom:loaded",function(){function fieldChangeHandler(event,element){var value;if(element.contentEditable=="true"){value=element.innerHTML}else{if(element.getValue){value=element.getValue()}}if(value&&element.previousValue!=value){element.fire("field:change");element.previousValue=value}}$(document.body).on("keyup",'input,textarea,*[contenteditable=""],*[contenteditable=true]',fieldChangeHandler)});WysiHat.Commands=(function(window){function boldSelection(){this.execCommand("bold",false,null)}function boldSelected(){return this.queryCommandState("bold")}function underlineSelection(){this.execCommand("underline",false,null)}function underlineSelected(){return this.queryCommandState("underline")}function italicSelection(){this.execCommand("italic",false,null)}function italicSelected(){return this.queryCommandState("italic")}function strikethroughSelection(){this.execCommand("strikethrough",false,null)}function indentSelection(){if(Prototype.Browser.Gecko){var selection,range,node,blockquote;selection=window.getSelection();range=selection.getRangeAt(0);node=selection.getNode();if(range.collapsed){range=document.createRange();range.selectNodeContents(node);selection.removeAllRanges();selection.addRange(range)}blockquote=new Element("blockquote");range=selection.getRangeAt(0);range.surroundContents(blockquote)}else{this.execCommand("indent",false,null)}}function outdentSelection(){this.execCommand("outdent",false,null)}function toggleIndentation(){if(this.indentSelected()){this.outdentSelection()}else{this.indentSelection()}}function indentSelected(){var node=window.getSelection().getNode();return node.match("blockquote, blockquote *")}function fontSelection(font){this.execCommand("fontname",false,font)}function fontSizeSelection(fontSize){this.execCommand("fontsize",false,fontSize)}function colorSelection(color){this.execCommand("forecolor",false,color)}function backgroundColorSelection(color){if(Prototype.Browser.Gecko){this.execCommand("hilitecolor",false,color)}else{this.execCommand("backcolor",false,color)}}function alignSelection(alignment){this.execCommand("justify"+alignment)}function alignSelected(){var node=window.getSelection().getNode();return Element.getStyle(node,"textAlign")}function linkSelection(url){this.execCommand("createLink",false,url)}function unlinkSelection(){var node=window.getSelection().getNode();if(this.linkSelected()){window.getSelection().selectNode(node)}this.execCommand("unlink",false,null)}function linkSelected(){var node=window.getSelection().getNode();return node?node.tagName.toUpperCase()=="A":false}function formatblockSelection(element){this.execCommand("formatblock",false,element)}function toggleOrderedList(){var selection,node;selection=window.getSelection();node=selection.getNode();if(this.orderedListSelected()&&!node.match("ol li:last-child, ol li:last-child *")){selection.selectNode(node.up("ol"))}else{if(this.unorderedListSelected()){selection.selectNode(node.up("ul"))}}this.execCommand("insertorderedlist",false,null)}function insertOrderedList(){this.toggleOrderedList()}function orderedListSelected(){var element=window.getSelection().getNode();if(element){return element.match('*[contenteditable=""] ol, *[contenteditable=true] ol, *[contenteditable=""] ol *, *[contenteditable=true] ol *')}return false}function toggleUnorderedList(){var selection,node;selection=window.getSelection();node=selection.getNode();if(this.unorderedListSelected()&&!node.match("ul li:last-child, ul li:last-child *")){selection.selectNode(node.up("ul"))}else{if(this.orderedListSelected()){selection.selectNode(node.up("ol"))}}this.execCommand("insertunorderedlist",false,null)}function insertUnorderedList(){this.toggleUnorderedList()}function unorderedListSelected(){var element=window.getSelection().getNode();if(element){return element.match('*[contenteditable=""] ul, *[contenteditable=true] ul, *[contenteditable=""] ul *, *[contenteditable=true] ul *')}return false}function insertImage(url){this.execCommand("insertImage",false,url)}function insertHTML(html){if(Prototype.Browser.IE){var range=window.document.selection.createRange();range.pasteHTML(html);range.collapse(false);range.select()}else{this.execCommand("insertHTML",false,html)}}function execCommand(command,ui,value){var handler=this.commands.get(command);if(handler){handler.bind(this)(value)}else{try{window.document.execCommand(command,ui,value)}catch(e){return null}}document.activeElement.fire("field:change")}function queryCommandState(state){var handler=this.queryCommands.get(state);if(handler){return handler.bind(this)()}else{try{return window.document.queryCommandState(state)}catch(e){return null}}}function getSelectedStyles(){var styles=$H({});var editor=this;editor.styleSelectors.each(function(style){var node=editor.selection.getNode();styles.set(style.first(),Element.getStyle(node,style.last()))});return styles}return{boldSelection:boldSelection,boldSelected:boldSelected,underlineSelection:underlineSelection,underlineSelected:underlineSelected,italicSelection:italicSelection,italicSelected:italicSelected,strikethroughSelection:strikethroughSelection,indentSelection:indentSelection,outdentSelection:outdentSelection,toggleIndentation:toggleIndentation,indentSelected:indentSelected,fontSelection:fontSelection,fontSizeSelection:fontSizeSelection,colorSelection:colorSelection,backgroundColorSelection:backgroundColorSelection,alignSelection:alignSelection,alignSelected:alignSelected,linkSelection:linkSelection,unlinkSelection:unlinkSelection,linkSelected:linkSelected,formatblockSelection:formatblockSelection,toggleOrderedList:toggleOrderedList,insertOrderedList:insertOrderedList,orderedListSelected:orderedListSelected,toggleUnorderedList:toggleUnorderedList,insertUnorderedList:insertUnorderedList,unorderedListSelected:unorderedListSelected,insertImage:insertImage,insertHTML:insertHTML,execCommand:execCommand,queryCommandState:queryCommandState,getSelectedStyles:getSelectedStyles,commands:$H({}),queryCommands:$H({link:linkSelected,orderedlist:orderedListSelected,unorderedlist:unorderedListSelected}),styleSelectors:$H({fontname:"fontFamily",fontsize:"fontSize",forecolor:"color",hilitecolor:"backgroundColor",backcolor:"backgroundColor"})}})(window);if(Prototype.Browser.IE){Object.extend(Selection.prototype,(function(){function setBookmark(){var bookmark=$("bookmark");if(bookmark){bookmark.remove()}bookmark=new Element("span",{id:"bookmark"}).update("&nbsp;");var parent=new Element("div");parent.appendChild(bookmark);var range=this._document.selection.createRange();range.collapse();range.pasteHTML(parent.innerHTML)}function moveToBookmark(){var bookmark=$("bookmark");if(!bookmark){return}var range=this._document.selection.createRange();range.moveToElementText(bookmark);range.collapse();range.select();bookmark.remove()}return{setBookmark:setBookmark,moveToBookmark:moveToBookmark}})())}else{Object.extend(Selection.prototype,(function(){function setBookmark(){var bookmark=$("bookmark");if(bookmark){bookmark.remove()}bookmark=new Element("span",{id:"bookmark"}).update("&nbsp;");this.getRangeAt(0).insertNode(bookmark)}function moveToBookmark(){var bookmark=$("bookmark");if(!bookmark){return}var range=document.createRange();range.setStartBefore(bookmark);this.removeAllRanges();this.addRange(range);bookmark.remove()}return{setBookmark:setBookmark,moveToBookmark:moveToBookmark}})())}(function(){function cloneWithAllowedAttributes(element,allowedAttributes){var result=new Element(element.tagName),length=allowedAttributes.length,i;element=$(element);for(i=0;i<allowedAttributes.length;i++){attribute=allowedAttributes[i];if(element.hasAttribute(attribute)){result.writeAttribute(attribute,element.readAttribute(attribute))}}return result}function withEachChildNodeOf(element,callback){var nodes=$A(element.childNodes),length=nodes.length,i;for(i=0;i<length;i++){callback(nodes[i])}}function sanitizeNode(node,tagsToRemove,tagsToAllow,tagsToSkip){var parentNode=node.parentNode;switch(node.nodeType){case Node.ELEMENT_NODE:var tagName=node.tagName.toLowerCase();if(tagsToSkip){var newNode=node.cloneNode(false);withEachChildNodeOf(node,function(childNode){newNode.appendChild(childNode);sanitizeNode(childNode,tagsToRemove,tagsToAllow,tagsToSkip)});parentNode.insertBefore(newNode,node)}else{if(tagName in tagsToAllow){var newNode=cloneWithAllowedAttributes(node,tagsToAllow[tagName]);withEachChildNodeOf(node,function(childNode){newNode.appendChild(childNode);sanitizeNode(childNode,tagsToRemove,tagsToAllow,tagsToSkip)});parentNode.insertBefore(newNode,node)}else{if(!(tagName in tagsToRemove)){withEachChildNodeOf(node,function(childNode){parentNode.insertBefore(childNode,node);sanitizeNode(childNode,tagsToRemove,tagsToAllow,tagsToSkip)})}}}case Node.COMMENT_NODE:parentNode.removeChild(node)}}Element.addMethods({sanitizeContents:function(element,options){element=$(element);var tagsToRemove={};(options.remove||"").split(",").each(function(tagName){tagsToRemove[tagName.strip()]=true});var tagsToAllow={};(options.allow||"").split(",").each(function(selector){var parts=selector.strip().split(/[\[\]]/);var tagName=parts[0],allowedAttributes=parts.slice(1).grep(/./);tagsToAllow[tagName]=allowedAttributes});var tagsToSkip=options.skip;withEachChildNodeOf(element,function(childNode){sanitizeNode(childNode,tagsToRemove,tagsToAllow,tagsToSkip)});return element}})})();(function(){function onReadyStateComplete(document,callback){var handler;function checkReadyState(){if(document.readyState==="complete"){if(handler){handler.stop()}callback();return true}else{return false}}handler=Element.on(document,"readystatechange",checkReadyState);checkReadyState()}function observeFrameContentLoaded(element){element=$(element);var loaded,contentLoadedHandler;loaded=false;function fireFrameLoaded(){if(loaded){return}loaded=true;if(contentLoadedHandler){contentLoadedHandler.stop()}element.fire("frame:loaded")}if(window.addEventListener){contentLoadedHandler=document.on("DOMFrameContentLoaded",function(event){if(element==event.element()){fireFrameLoaded()}})}element.on("load",function(){var frameDocument;if(typeof element.contentDocument!=="undefined"){frameDocument=element.contentDocument}else{if(typeof element.contentWindow!=="undefined"&&typeof element.contentWindow.document!=="undefined"){frameDocument=element.contentWindow.document}}onReadyStateComplete(frameDocument,fireFrameLoaded)});return element}function onFrameLoaded(element,callback){element.on("frame:loaded",callback);element.observeFrameContentLoaded()}Element.addMethods({observeFrameContentLoaded:observeFrameContentLoaded,onFrameLoaded:onFrameLoaded})})();document.on("dom:loaded",function(){if("selection" in document&&"onselectionchange" in document){var selectionChangeHandler=function(){var range=document.selection.createRange();var element=range.parentElement();$(element).fire("selection:change")};document.on("selectionchange",selectionChangeHandler)}else{var previousRange;var selectionChangeHandler=function(){var element=document.activeElement;var elementTagName=element.tagName.toLowerCase();if(elementTagName=="textarea"||elementTagName=="input"){previousRange=null;$(element).fire("selection:change")}else{var selection=window.getSelection();if(selection.rangeCount<1){return}var range=selection.getRangeAt(0);if(range&&range.equalRange(previousRange)){return}previousRange=range;element=range.commonAncestorContainer;while(element.nodeType==Node.TEXT_NODE){element=element.parentNode}$(element).fire("selection:change")}};document.on("mouseup",selectionChangeHandler);document.on("keyup",selectionChangeHandler)}});WysiHat.Formatting=(function(){var ACCUMULATING_LINE={};var EXPECTING_LIST_ITEM={};var ACCUMULATING_LIST_ITEM={};return{getBrowserMarkupFrom:function(applicationMarkup){var container=new Element("div").update(applicationMarkup);function spanify(element,style){element.replace('<span style="'+style+'" class="Apple-style-span">'+element.innerHTML+"</span>")}function convertStrongsToSpans(){container.select("strong").each(function(element){spanify(element,"font-weight: bold")})}function convertEmsToSpans(){container.select("em").each(function(element){spanify(element,"font-style: italic")})}function convertDivsToParagraphs(){container.select("div").each(function(element){element.replace("<p>"+element.innerHTML+"</p>")})}if(Prototype.Browser.WebKit||Prototype.Browser.Gecko){convertStrongsToSpans();convertEmsToSpans()}else{if(Prototype.Browser.IE||Prototype.Browser.Opera){convertDivsToParagraphs()}}return container.innerHTML},getApplicationMarkupFrom:function(element){var mode=ACCUMULATING_LINE,result,container,line,lineContainer,previousAccumulation;function walk(nodes){var length=nodes.length,node,tagName,i;for(i=0;i<length;i++){node=nodes[i];if(node.nodeType==Node.ELEMENT_NODE){tagName=node.tagName.toLowerCase();open(tagName,node);walk(node.childNodes);close(tagName)}else{if(node.nodeType==Node.TEXT_NODE){read(node.nodeValue)}}}}function open(tagName,node){if(mode==ACCUMULATING_LINE){if(isBlockElement(tagName)){if(isEmptyParagraph(node)){accumulate(new Element("br"))}flush();if(isListElement(tagName)){container=insertList(tagName);mode=EXPECTING_LIST_ITEM}}else{if(isLineBreak(tagName)){if(isLineBreak(getPreviouslyAccumulatedTagName())){previousAccumulation.parentNode.removeChild(previousAccumulation);flush()}accumulate(node.cloneNode(false));if(!previousAccumulation.previousNode){flush()}}else{accumulateInlineElement(tagName,node)}}}else{if(mode==EXPECTING_LIST_ITEM){if(isListItemElement(tagName)){mode=ACCUMULATING_LIST_ITEM}}else{if(mode==ACCUMULATING_LIST_ITEM){if(isLineBreak(tagName)){accumulate(node.cloneNode(false))}else{if(!isBlockElement(tagName)){accumulateInlineElement(tagName,node)}}}}}}function close(tagName){if(mode==ACCUMULATING_LINE){if(isLineElement(tagName)){flush()}if(line!=lineContainer){lineContainer=lineContainer.parentNode}}else{if(mode==EXPECTING_LIST_ITEM){if(isListElement(tagName)){container=result;mode=ACCUMULATING_LINE}}else{if(mode==ACCUMULATING_LIST_ITEM){if(isListItemElement(tagName)){flush();mode=EXPECTING_LIST_ITEM}if(line!=lineContainer){lineContainer=lineContainer.parentNode}}}}}function isBlockElement(tagName){return isLineElement(tagName)||isListElement(tagName)}function isLineElement(tagName){return tagName=="p"||tagName=="div"}function isListElement(tagName){return tagName=="ol"||tagName=="ul"}function isListItemElement(tagName){return tagName=="li"}function isLineBreak(tagName){return tagName=="br"}function isEmptyParagraph(node){return node.tagName.toLowerCase()=="p"&&node.childNodes.length==0}function read(value){accumulate(document.createTextNode(value))}function accumulateInlineElement(tagName,node){var element=node.cloneNode(false);if(tagName=="span"){if($(node).getStyle("fontWeight")=="bold"){element=new Element("strong")}else{if($(node).getStyle("fontStyle")=="italic"){element=new Element("em")}}}accumulate(element);lineContainer=element}function accumulate(node){if(mode!=EXPECTING_LIST_ITEM){if(!line){line=lineContainer=createLine()}previousAccumulation=node;lineContainer.appendChild(node)}}function getPreviouslyAccumulatedTagName(){if(previousAccumulation&&previousAccumulation.nodeType==Node.ELEMENT_NODE){return previousAccumulation.tagName.toLowerCase()}}function flush(){if(line&&line.childNodes.length){container.appendChild(line);line=lineContainer=null}}function createLine(){if(mode==ACCUMULATING_LINE){return new Element("div")}else{if(mode==ACCUMULATING_LIST_ITEM){return new Element("li")}}}function insertList(tagName){var list=new Element(tagName);result.appendChild(list);return list}result=container=new Element("div");walk(element.childNodes);flush();return result.innerHTML}}})();WysiHat.Toolbar=Class.create((function(){function initialize(editor){this.editor=editor;this.element=this.createToolbarElement()}function createToolbarElement(){var toolbar=new Element("div",{"class":"editor_toolbar"});this.editor.insert({before:toolbar});return toolbar}function addButtonSet(set){$A(set).each(function(button){this.addButton(button)}.bind(this))}function addButton(options,handler){options=$H(options);if(!options.get("name")){options.set("name",options.get("label").toLowerCase())}var name=options.get("name");var button=this.createButtonElement(this.element,options);var handler=this.buttonHandler(name,options);this.observeButtonClick(button,handler);var handler=this.buttonStateHandler(name,options);this.observeStateChanges(button,name,handler)}function createButtonElement(toolbar,options){var button=new Element("a",{"class":"button",href:"#"});button.update("<span>"+options.get("label")+"</span>");button.addClassName(options.get("name"));toolbar.appendChild(button);return button}function buttonHandler(name,options){if(options.handler){return options.handler}else{if(options.get("handler")){return options.get("handler")}else{return function(editor){editor.execCommand(name)}}}}function observeButtonClick(element,handler){element.on("click",function(event){handler(this.editor);event.stop()}.bind(this))}function buttonStateHandler(name,options){if(options.query){return options.query}else{if(options.get("query")){return options.get("query")}else{return function(editor){return editor.queryCommandState(name)}}}}function observeStateChanges(element,name,handler){var previousState;this.editor.on("selection:change",function(event){var state=handler(this.editor);if(state!=previousState){previousState=state;this.updateButtonState(element,name,state)}}.bind(this))}function updateButtonState(element,name,state){if(state){element.addClassName("selected")}else{element.removeClassName("selected")}}return{initialize:initialize,createToolbarElement:createToolbarElement,addButtonSet:addButtonSet,addButton:addButton,createButtonElement:createButtonElement,buttonHandler:buttonHandler,observeButtonClick:observeButtonClick,buttonStateHandler:buttonStateHandler,observeStateChanges:observeStateChanges,updateButtonState:updateButtonState}})());WysiHat.Toolbar.ButtonSets={};WysiHat.Toolbar.ButtonSets.Basic=$A([{label:"Bold"},{label:"Underline"},{label:"Italic"}]);(function(){if(document.selection){Object.extend(Selection.prototype,{makeInactiveSelection:function(){var range=this._document.selection.createRange();var dummy=new Element("div");var wrapper=new Element("span",{"class":"inactive_selection"}).update(range.htmlText);dummy.appendChild(wrapper);range.pasteHTML(dummy.innerHTML)},restoreInactiveSelection:function(element){var range=this._document.selection.createRange();range.moveToElementText(element);element.removeClassName("inactive_selection");range.select()}})}else{Object.extend(Selection.prototype,{makeInactiveSelection:function(){var range=this.getRangeAt(0);var wrapper=new Element("span",{"class":"inactive_selection"});range.surroundContents(wrapper)},restoreInactiveSelection:function(element){var range=document.createRange();range.selectNodeContents(element);element.removeClassName("inactive_selection");this.removeAllRanges();this.addRange(range)}})}document.observe("focus:in",function(event){var element=event.findElement("div[contentEditable=true]");if(element){element.select("span.inactive_selection").each(function(element){element.removeClassName("inactive_selection")})}})})();var RichTextArea=Class.create({initialize:function(editor){this.editor=$(editor);this.element=this.editor.up("div.rich_text_area");this.hiddenField=this.editor.next("input");this.element.addClassName("uses_"+this.getParagraphType());Object.extend(this.editor,WysiHat.Commands);this.loadContents(this.hiddenField.value);this.toolbar=this.element.down("div.rich_text_toolbar");this.initializeToolbarButtons();this.element.observe("selection:change",this.onCursorMove.bind(this));this.element.observe("field:change",this.onChange.bind(this));this.editor.observe("paste",this.onPaste.bind(this));this.editor.observe("blur",this.onBlur.bind(this));this.element.observe("link:selection",this.onLinkSelection.bind(this))},getParagraphType:function(){if(Prototype.Browser.WebKit){return"div"}if(Prototype.Browser.Gecko){return"br"}return"p"},content:function(){return WysiHat.Formatting.getApplicationMarkupFrom(this.editor)},loadContents:function(applicationMarkup){var html=WysiHat.Formatting.getBrowserMarkupFrom(applicationMarkup);if(html.blank()&&Prototype.Browser.Gecko){html="<br>"}this.editor.update(html)},saveContents:function(text){this.hiddenField.setValue(this.content())},initializeToolbarButtons:function(){this.toolbarButtons=this.toolbar.select("a.button['data-state']");this.toolbar.observe("mousedown",this.onToolbarMousedown.bind(this));this.toolbar.observe("mouseup",this.onToolbarMouseup.bind(this));this.toolbar.observe("click",this.onToolbarClicked.bind(this));this.menuObserver=new MenuObserver(this.toolbar);this.toolbar.observe("menu:prepared",this.onMenuPrepared.bind(this));this.toolbar.observe("menu:activated",this.onMenuActivated.bind(this));this.toolbar.observe("menu:deactivated",this.onMenuDeactivated.bind(this))},onToolbarMousedown:function(event){var button=this.findButtonFromEvent(event);if(button){if(this.editorHasFocus()){var state=this.getButtonState(button);this["on"+state.capitalize()+"Clicked"].call(this);this.updateToolbar()}event.stop()}},onToolbarMouseup:function(event){var element=this.findButtonFromEvent(event);if(element&&!element.hasClassName("menu_target")){this.editor.focus()}},onToolbarClicked:function(event){if(this.findButtonFromEvent(event)){event.stop()}},onMenuPrepared:function(event){if(!this.editorHasFocus()){event.stop()}},onMenuActivated:function(event){event.findElement().autofocus()},onMenuDeactivated:function(event){this.editor.focus()},findButtonFromEvent:function(event){return event.findElement("a.button['data-state']")},editorHasFocus:function(){return this.element.hasClassName("editor_has_focus")},onPaste:function(){this.onAfterPaste.bind(this).defer()},onAfterPaste:function(){var selection=window.getSelection();var selectedRange=selection.getRangeAt(0);var bookmark=new Element("bookmark");selectedRange.surroundContents(bookmark);this.reformatPaste(this.editor);bookmark=this.editor.down("bookmark");selectedRange=document.createRange();selectedRange.selectNode(bookmark);selection.removeAllRanges();selection.addRange(selectedRange);selectedRange.deleteContents()},reformatPaste:function(pasteContainer){pasteContainer.sanitizeContents({remove:"style, link, meta",allow:"span, p, br, strong, b, em, i, a[href], ul, ol, li, div, bookmark",skip:"[_moz_dirty]"});pasteContainer.select("p").each(function(paragraph){if(paragraph.childNodes.length==2){var first=paragraph.childNodes[0],second=paragraph.childNodes[1];if(first.tagName&&first.tagName.toLowerCase()=="span"&&first.innerHTML==""&&second.tagName&&second.tagName.toLowerCase()=="br"){paragraph.remove();return}}else{if(Prototype.Browser.IE&&paragraph.innerText==""){paragraph.update("&nbsp;")}else{if(!Prototype.Browser.IE){var html=paragraph.innerHTML.toLowerCase();if(html.match(/^<br>$/)){paragraph.remove()}else{if(!html.match(/<br><br>$/)){paragraph.insert("<br><br>")}}}}}})},onBlur:function(){this.saveContents()},onCursorMove:function(event){this.updateToolbar()},onBoldClicked:function(){this.editor.boldSelection()},onItalicClicked:function(){this.editor.italicSelection()},onOrderedlistClicked:function(){var node=window.getSelection().getNode();if(this.editor.orderedListSelected()&&!node.match("ol li:last-child *")){window.getSelection().selectNode(node.up("ol"))}else{if(this.editor.unorderedListSelected()){window.getSelection().selectNode(node.up("ul"))}}this.editor.toggleOrderedList()},onUnorderedlistClicked:function(){var node=window.getSelection().getNode();if(this.editor.unorderedListSelected()&&!node.match("ul li:last-child *")){window.getSelection().selectNode(node.up("ul"))}else{if(this.editor.orderedListSelected()){window.getSelection().selectNode(node.up("ol"))}}this.editor.toggleUnorderedList()},onLinkClicked:function(){this.selectionBookmark=null;var container=this.element.down(".link_container");var input=container.down(".menu_content input");var selectedElement=window.getSelection().getNode();if(selectedElement&&this.editor.linkSelected()){window.getSelection().selectNode(selectedElement);selectedElement.value=selectedElement.href}else{input.value=""}window.getSelection().makeInactiveSelection()},onLinkSelection:function(event){var container=this.element.down(".link_container");this.menuObserver.deactivate(container);var inactiveSelection=this.editor.down("span.inactive_selection");if(!inactiveSelection){return}this.editor.focus();window.getSelection().restoreInactiveSelection(inactiveSelection);var value=container.down(".menu_content input").value;if(value.blank()){this.editor.unlinkSelection()}else{this.editor.linkSelection(this.tidyUrl(value))}},tidyUrl:function(url){if(!url.match(/^[a-z]+:\/\//i)){url="http://"+url}return url},onChange:function(event){this.saveContents();this.updateToolbar()},updateToolbar:function(){this.toolbarButtons.each(function(button){var state=this.getButtonState(button);if(this.editor.queryCommandState(state)){button.addClassName("selected")}else{button.removeClassName("selected")}},this)},getButtonState:function(button){return button.readAttribute("data-state")}});Object.extend(RichTextArea,{findAll:function(parent){return $(parent||document.body).select("div.rich_text_area div.editor[contentEditable=true]")},initializeAll:function(){RichTextArea.findAll().each(function(contentEditable){if(!contentEditable.retrieve("richTextArea")){var richTextArea=new RichTextArea(contentEditable);contentEditable.store("richTextArea",richTextArea)}})}});document.observe("dom:modified",function(){RichTextArea.initializeAll()});(function(){var childSelector="div.rich_text_area div.editor";var parentSelector="div.rich_text_area";var className="editor_has_focus";document.observe("focus:in",function(event){var element=event.findElement(childSelector);if(element){element.up(parentSelector).addClassName(className)}});document.observe("focus:out",function(event){var element=event.findElement(childSelector);if(element){element.up(parentSelector).removeClassName(className)}})})();document.observe("click",function(event){var element=event.findElement("a.formatting_switch");if(element){event.stop();if(element.hasClassName("busy")){return}var formattableBody=element.up("div.formattable_body");var confirmation=element.readAttribute("data-confirm");var body=formattableBody.down("input.body[type=hidden], textarea.body");var url=element.readAttribute("href");if(body.getValue().blank()||confirm(confirmation)){element.addClassName("busy");new Ajax.Request(url,{parameters:element.up("form").serialize()})}}});(function(){window.Beanstalk={enablePageviewTracking:true,enablePresenceTracking:false,presenceGranularity:60,dev:location.host.match(/.*?\.dev/),uuid:null,site_id:null,beaconURL:function(){var host,url;host=Beanstalk.dev?"dash.dev":"dash.37signals.com";return url=""+window.location.protocol+"//"+host+"/beacon.gif?"}};Beanstalk.enablePageviewTracking=!Beanstalk.dev}).call(this);(function(){var __slice=[].slice;Beanstalk.beacon={params:[],enabled:true,log:function(params){var key,value,_results;_results=[];for(key in params){value=params[key];_results.push(Beanstalk.beacon.params.push([key,value]))}return _results},send:function(){var image,key,params,value,_ref;if(!Beanstalk.beacon.enabled){return}params=[];_ref=Beanstalk.beacon.params;for(key in _ref){value=_ref[key];if(typeof value!=="function"){params.push(""+(encodeURIComponent(value[0]))+"="+(encodeURIComponent(value[1])))}}if(params.length){if(Beanstalk.uuid){params.unshift("uuid="+Beanstalk.uuid)}if(Beanstalk.site_id){params.unshift("site_id="+Beanstalk.site_id)}params.unshift("tz="+(new Date().getTimezoneOffset()/60));image=new Image;image.src=[Beanstalk.beaconURL()].concat(__slice.call(params)).join("&");image.onerror=function(){if(Beanstalk.dev){Beanstalk.beacon.enabled=false;return console.warn("disabling instrumentation beacon")}}}return Beanstalk.beacon.params=[]}}}).call(this);(function(){Beanstalk.logCohort=function(test,variation){Beanstalk.beacon.log({"cohort[][experiment]":test,"cohort[][group]":variation});return Beanstalk.beacon.send()}}).call(this);(function(){Beanstalk.logEvent=function(name,value){Beanstalk.beacon.log({"event[][name]":name,"event[][value]":value});return Beanstalk.beacon.send()}}).call(this);(function(){Beanstalk.logPageview=function(){if(Beanstalk.enablePageviewTracking){Beanstalk.beacon.log({"pageview[host]":document.location.host,"pageview[path]":document.location.pathname,"pageview[query]":document.location.search,"pageview[title]":document.title,"pageview[referrer]":document.referrer});if(Object.keys(Beanstalk.Timing.times).length===0){return setTimeout(Beanstalk.beacon.send,500)}}};if(document.addEventListener){document.addEventListener("DOMContentLoaded",function(){return Beanstalk.logPageview()},false)}}).call(this);(function(){if(Beanstalk.enablePresenceTracking){setInterval(function(){Beanstalk.beacon.log({presence:true});return Beanstalk.beacon.send()},Beanstalk.presenceGranularity*1000)}}).call(this);(function(){Beanstalk.logSignup=function(product,account_id){Beanstalk.beacon.log({"signup[product]":product,"signup[account_id]":account_id});return Beanstalk.beacon.send()}}).call(this);(function(){var Timing;Timing=Timing||{times:{}};Beanstalk.Timing={times:Timing.times,mark:function(e,t){if(!t){t=new Date().getTime()}return Beanstalk.Timing.times[e]=t},init:function(times){if(times!==void 0){Beanstalk.Timing.times=times}Beanstalk.Timing.findStartTime();Beanstalk.Timing.addEventListener("beforeunload",Beanstalk.Timing.beforeUnload,false);return Beanstalk.Timing.addEventListener("load",Beanstalk.Timing.onload,false)},addEventListener:function(sType,callback,bCapture){try{if("undefined"!==typeof window.attachEvent){return window.attachEvent("on"+sType,callback)}else{if(window.addEventListener){return window.addEventListener(sType,callback,bCapture)}}}catch(_error){}},onload:function(){Beanstalk.Timing.mark("onload");return Beanstalk.Timing.done()},findStartTime:function(){var startTime;startTime=Beanstalk.Timing.findStartWebTiming()||Beanstalk.Timing.findStartGToolbar();if(startTime){return Beanstalk.Timing.mark("starttime",startTime)}},findStartWebTiming:function(){var performance,startTime;startTime=void 0;performance=window.performance||window.mozPerformance||window.msPerformance||window.webkitPerformance;if("undefined"!==typeof performance&&"undefined"!==typeof performance.timing&&"undefined"!==typeof performance.timing.navigationStart){startTime=performance.timing.navigationStart}return startTime},findStartGToolbar:function(){var startTime;startTime=void 0;if("undefined"!==typeof window.external&&"undefined"!==typeof window.external.pageT){startTime=(new Date().getTime())-window.external.pageT}else{if("undefined"!==typeof window.gtbExternal&&"undefined"!==typeof window.gtbExternal.pageT){startTime=(new Date().getTime())-window.gtbExternal.pageT()}else{if("undefined"!==typeof window.chrome&&"undefined"!==typeof window.chrome.csi){startTime=(new Date().getTime())-window.chrome.csi().pageT}}}if(startTime){Beanstalk.Timing.dprint("Beanstalk.Timing.findStartGToolbar: startTime = "+startTime)}return startTime},done:function(){var key,times,value,_ref;Beanstalk.Timing.mark("done");times=[];_ref=Beanstalk.Timing.times;for(key in _ref){value=_ref[key];times.push(""+key+":"+value)}times=times.join(",");Beanstalk.beacon.log({timing:times});Beanstalk.Timing.times={};return setTimeout(Beanstalk.beacon.send,100)}}}).call(this);var AccountInvoice={email_regex:/^\s*[\w\.%\+\-]+@(?:[a-z0-9\-]+\.)+(?:[a-z]{2,})\s*$/i,validateEmail:function(email){var errors=new Array;if(!email.present()){errors.push("You must provide your email address.")}else{if(!this.email_regex.match(email.value)){errors.push("Invoice email address doesn't appear to be valid. Example: billing@example.com")}}return errors},toggle:function(){$("invoice").down(".show").toggle();$("invoice").down(".edit").toggle()},submit:function(){errors=this.validateEmail($("invoice_receiver"));if(errors.any()){alert(errors.join("\n"));return false}$("invoice").down(".cancel").hide();$("invoice").down(".submitting").show();new Ajax.Request($("invoice").down("form").action,{asynchronous:true,method:"post",parameters:$("invoice").down("form").serialize(),onComplete:this.onComplete})},onComplete:function(response){$("invoice").down(".submitting").hide();$("invoice").down(".cancel").show();$("invoice").down(".edit").hide();$("invoice").down(".show").show();$("invoice").down("strong").update($F("invoice_receiver").strip().escapeHTML());$("invoice").down("pre").update($F("invoice_notes").strip().escapeHTML())}};document.observe("mousedown",function(event){var label=event.findElement("label");if(label&&!label.hasAttribute("for")){var element=label.down("input[type=radio], input[type=checkbox], input[type=submit],input[type=text],  input[type=password], select, textarea");if(element){label.writeAttribute("for",element.identify())}}});document.observe("dom:loaded",function(){if(window.localStorage&&!navigator.userAgent.match("MSIE 8")&&!navigator.userAgent.match("MSIE 7")){$$("[data-behavior~=autosave]").each(function(input){new Autosave(input)})}});Autosave=function(input){generateStorageKey=function(input){return["autosave:",$$("meta[name~=current-user]")[0].content,input.name,input.up("form").action,escape(window.location.pathname)].join("")};restore=function(){if(window.localStorage.getItem(self.storageKey)){if(!self.input.value){return self.input.value=window.localStorage.getItem(self.storageKey)}}};watchForChanges=function(){$(document).observe("change",self.save);$(document).observe("paste",self.save);$(document).observe("keyup",self.save)};save=function(){window.localStorage.setItem(self.storageKey,self.input.value)};clear=function(){$(document).stopObserving("change",self.save);$(document).stopObserving("paste",self.save);$(document).stopObserving("keyup",self.save);window.localStorage.removeItem(self.storageKey)};clearWhenSubmit=function(){self.input.up("form").observe("form:submit",function(){self.clear()})};var self=this;self.input=input;self.storageKey=generateStorageKey(input);self.save=save;self.clear=clear;restore();watchForChanges();clearWhenSubmit()};String.prototype.byteSize=function(){var bytes=0;for(i=0;i<this.length;i++){var charCode=this.charCodeAt(i);if(charCode<=127){bytes+=1}else{if(charCode<=2047){bytes+=2}else{if(charCode<=65535){bytes+=3}else{bytes+=4}}}}return bytes};var Calendar=Class.create({initialize:function(container,options){this.container=container;options=options||{};this.start_date=this.original_start_date=options.start_date||CalendarDate.parse(this.container.readAttribute("data-start-date"));this.today=options.today||CalendarDate.parse(this.container.readAttribute("data-today-date")||"");this.first_day_of_the_week=parseInt(this.container.readAttribute("data-calendar-start-day")||1);this.week_count=options.week_count||6;this.today_label=options.today_label||this.container.readAttribute("data-today-label")||"Today";this.registerObservers();this.activeRequests=0},registerObservers:function(){CalendarEntry.on("entry:create",this.onEntryCreate.bind(this));CalendarEntry.on("entry:updated",this.onEntryUpdate.bind(this));CalendarEntry.on("entry:destroy",this.render.bind(this))},registerNavigationObservers:function(navigation_container){var next_link=navigation_container.down("a.calendar_next");if(next_link){next_link.observe("click",function(event){event.stop();this.nextPage()}.bind(this))}var previous_link=navigation_container.down("a.calendar_previous");if(previous_link){previous_link.observe("click",function(event){event.stop();this.previousPage()}.bind(this))}var today_link=navigation_container.down("a.calendar_today");if(today_link){today_link.observe("click",function(event){event.stop();this.todayPage()}.bind(this))}},spannedEntryMapForWeek:function(week_start_date){return CalendarEntry.spannedEntryMapForWeek(week_start_date)},regularEntriesForDate:function(date){return CalendarEntry.regularEntriesForDate(date)},forEachDate:function(callback){for(var week=0;week<this.week_count;week++){for(var day=0;day<7;day++){var date=this.start_date.next(week*7+day);callback(date.toString())}}},todayPage:function(){var start=this.today.beginningOfWeek(this.first_day_of_the_week);this.changeStartDate(start,"direct")},nextPage:function(){var start=this.start_date.next(6).nextMonth().beginningOfWeek(this.first_day_of_the_week);this.changeStartDate(start,"forward")},previousPage:function(){var start=this.start_date.next(6).previousMonth().beginningOfWeek(this.first_day_of_the_week);this.changeStartDate(start,"backward")},changeStartDate:function(new_start_date,direction,on_complete_callback){if(CalendarEntry.loadURL){this.startLazyLoadRequest(new_start_date,direction,on_complete_callback)}this.start_date=new_start_date;this.render();if(this.activeRequests<1&&on_complete_callback){on_complete_callback()}this.startDateChanged()},startLazyLoadRequest:function(start_date,direction,on_complete_callback){var inc=direction=="backward"?-1:1;var start=direction=="backward"?start_date.next(42):start_date;var window_open,window_close;for(var day=0;day<=42;day++){var calendar_date=start.next(inc*day);if(CalendarEntry.needsLoad(calendar_date.toString())){window_open=calendar_date;break}}if(window_open){window_close=window_open.next(inc*84);if(inc<0){var tmp=window_open;window_open=window_close;window_close=tmp.next(1)}var date_wrapper=$$(".schedule_date_wrapper")[0];date_wrapper.addClassName("busy");var grid_wrapper=$$(".schedule_wrapper")[0];grid_wrapper.addClassName("busy");CalendarEntry.markDateRange(window_open,window_close,"loading");this.activeRequests+=1;new Ajax.Request(CalendarEntry.loadURL,{method:"get",evalScripts:true,parameters:"window_open="+window_open.toString()+"&window_close="+window_close.toString(),onComplete:function(){this.activeRequests-=1;if(this.activeRequests<1){date_wrapper.removeClassName("busy");grid_wrapper.removeClassName("busy");this.render();if(on_complete_callback){on_complete_callback()}}}.bind(this)})}},startDateChanged:function(){},highlightDay:function(day){var day_block=this.container.down("td[data-date='"+day+"']");if(day_block){day_block.slideIntoView();new Effect.Highlight(day_block,{duration:5})}},goToEvent:function(event_id){var calendar_event_container=this.container.down("div.calendar_entry_container[data-entry-id="+event_id+"]");if(calendar_event_container){calendar_event_container.down(".calendar_entry_menu_target").fire("menu:activate")}},onEntryUpdate:function(new_entry,old_entry){if(!new_entry.startDate().equals(old_entry.startDate())||!new_entry.endDate().equals(old_entry.endDate())){this.onEntryCreate(new_entry)}else{this.render()}},onEntryCreate:function(entry){if(!this.isEntryDisplayed(entry)){var entry_date=entry.isSpanned()?entry.startDate():entry.endDate();var calendar_date=entry_date.beginningOfMonth().beginningOfWeek(this.first_day_of_the_week);this.changeStartDate(calendar_date,"direct",function(){this.highlightDay(entry_date)}.bind(this))}else{this.render()}},render:function(){this.container.update(templates.calendar(this));this.resizeBottomPadding()},fixPrintLink:function(){var link=$(document.body).down("#print_button a");if(link){link.href=link.readAttribute("data-path")+"&from_date="+this.start_date.toString()}},fixTodayLink:function(navigation_container){var link_element=navigation_container.down("a.today");if(this.isTodayDisplayed()){link_element.hide()}else{link_element.show()}},showDateRange:function(navigation_container){if(this.isTodayDisplayed()){$("schedule_next_x_weeks").show();$("schedule_date_range").hide()}else{var d=this.start_date.next(6);var title=d.getMonthName();if(d.year!=this.today.year){title+=" "+d.year}$("schedule_date_range").update(title);$("schedule_next_x_weeks").hide();$("schedule_date_range").show()}},renderEntry:function(entry,options){options=options||{};return templates._long_entry({entry:entry,options:options})},getSpannedEntryClasses:function(spanned_entry,current_date,week_start_date){var classes=$A();if(spanned_entry.startDate()<current_date){classes.push("wraps_prev")}if(spanned_entry.endDate()>week_start_date.next(6)){classes.push("wraps_next")}return classes.join(" ")},getCurrentDateClass:function(date){var result=[];if(date.value==this.today.value){result.push("today")}else{if(date.isWeekend()){result.push("weekend")}}return result.join(", ")},formatDate:function(date){return date.getFullYear()+this.padWithZero(date.getMonth()+1,2)+this.padWithZero(date.getDate(),2)},padWithZero:function(value,length){v=""+value;while(v.length<length){v="0"+v}return v},isEntryDisplayed:function(entry){var calendar_end_date=this.start_date.next((7*this.week_count)-1);var entry_end_date=entry.endDate();if(entry.isSpanned()){var entry_start_date=entry.startDate();if(entry_start_date<=this.start_date){entry_start_date=this.start_date}if(calendar_end_date<=entry_end_date){entry_end_date=calendar_end_date}return(entry_end_date>=entry_start_date)}else{return(entry_end_date>=this.start_date&&entry_end_date<=calendar_end_date)}},isTodayDisplayed:function(){var todays_value=this.today.value;return(this.today>=this.start_date&&this.today<this.start_date.next(7))},resizeBottomPadding:function(){var min_padding=18;var bottom_padding=min_padding;var month_rows=this.container.select("div.month_row");month_rows.each(function(el){var container_height=el.getHeight();var content_height=el.down("table.month_row_events").getHeight();if(content_height<container_height){bottom_padding=(container_height-content_height)+min_padding}el.select("div.bottom_padding").each(function(el){el.setStyle({height:bottom_padding+"px"})})})}});var CalendarEntry=Class.create(Hash,{initialize:function($super,attributes){$super(attributes)},set:function($super,key,value){var previous_value=this.get(key);var result=$super(key,value);CalendarEntry.fire("entry:change:"+key,[this,previous_value]);return result},isMilestone:function(){return this.get("entry_class")=="milestone"},isLateMilestone:function(){var value=this.get("overdue_days_count");return this.isMilestone()&&(typeof value!=="undefined"&&value!=null)},isAllDay:function(){return this.get("event_type")=="all_day"},isSpanned:function(){return this.get("event_type")=="spanned"},isEditable:function(){return this.get("is_editable")},isCompletable:function(){return this.get("is_completable")},completePath:function(){return"/projects/"+this.get("project_id")+"/milestones/"+this.get("id")+"/complete"},uncompletePath:function(){return"/projects/"+this.get("project_id")+"/milestones/"+this.get("id")+"/uncomplete"},editPath:function(){return this.detailsPath()+"/edit"},detailsPath:function(){return"/projects/"+this.get("project_id")+"/calendar_entries/"+this.get("id")},startDate:function(){return CalendarDate.parse(this.get("start_at"))},endDate:function(){return CalendarDate.parse(this.get("date"))},forEachDateInRange:function(calendar_start_date,calendar_end_date,callback){if(calendar_start_date>calendar_end_date){return}var date_collection=$A();var end_date=CalendarDate.parse(this.get("date"));if(this.isSpanned()){var start_date=CalendarDate.parse(this.get("start_at"));if(calendar_start_date>start_date){start_date=calendar_start_date}if(calendar_end_date<=end_date){end_date=calendar_end_date}while(end_date>=start_date){date_collection.push(start_date);start_date=start_date.next()}}else{if(calendar_start_date<=end_date&&end_date<=calendar_end_date){date_collection.push(end_date)}}date_collection.each(function(date){callback(date.toString())}.bind(this))}});Object.extend(CalendarEntry,{callbacks:$H(),indexes:{},on:function(event_name,callback){if(!this.callbacks.get(event_name)){this.callbacks.set(event_name,$A())}this.callbacks.get(event_name).push(callback)},fire:function(event_name,callback_arguments){var collection=this.callbacks.get(event_name);if(collection){collection.each(function(callback){callback.apply(this,callback_arguments)}.bind(this))}},registerIndexes:function(){this.indexes.id=$H();this.indexes.regular_entries_by_date=$H();this.indexes.loaded_by_date=$H();$A(["regular_entries","spanned_entries","late_milestones"]).each(function(index){this.indexes[index]=$A()}.bind(this))},markDateRange:function(fromDate,toDate,state){fromDate=CalendarDate.parse(fromDate);toDate=CalendarDate.parse(toDate);while(true){this.indexes.loaded_by_date[fromDate.toString()]=state;fromDate=fromDate.next();if(fromDate.equals(toDate)){break}}},isLoading:function(date){return(this.indexes.loaded_by_date[date]==="loading")},isLoaded:function(date){return(this.indexes.loaded_by_date[date]==="loaded")},needsLoad:function(date){return !this.indexes.loaded_by_date[date]},populateRepository:function(entries){entries=$A(entries);entries.each(function(entry_attributes){var entry=new CalendarEntry(entry_attributes);if(!this.indexes.id.get(entry.get("id"))){this.indexes.id.set(entry.get("id"),entry);if(entry.isSpanned()){this.indexes.spanned_entries.push(entry)}else{this.indexes.regular_entries.push(entry);var date=entry.get("date");if(!this.indexes.regular_entries_by_date.get(date)){this.indexes.regular_entries_by_date.set(date,$A())}this.indexes.regular_entries_by_date.get(date).push(entry)}if(entry.isLateMilestone()){this.indexes.late_milestones.push(entry)}}}.bind(this))},create:function(entry_attributes){this.populateRepository([entry_attributes]);var entry=this.find(entry_attributes.id);this.fire("entry:create",[entry])},destroy:function(entry_id){var entry=this.find(entry_id);if(!entry){return}this._removeEntry(entry);this.fire("entry:destroy",[entry])},updateEntries:function(entries){entries.each(function(entry_attributes){var old_entry=this.find(entry_attributes.id);if(old_entry){this._removeEntry(old_entry)}this.populateRepository([entry_attributes]);var new_entry=this.find(entry_attributes.id);this.fire("entry:updated",[new_entry,old_entry])}.bind(this))},find:function(id){return this.indexes.id.get(parseInt(id))},spannedEntryMapForWeek:function(week_start_date,reduce_function){var entries_map=$A();var size=1;while(size<=7){entries_map.push($A());size=size+1}var week_end_date=week_start_date.next(6);var spanned_entries=CalendarEntry.findSpannedEntriesForDateRange(week_start_date,week_end_date);if(reduce_function){spanned_entries=spanned_entries.findAll(reduce_function)}spanned_entries.each(function(entry){var entry_start_date=entry.startDate();var entry_end_date=entry.endDate();var affected_enties_on_map=$A();entries_map.each(function(em,index){var this_day=week_start_date.next(index);if(entry.startDate()<=this_day&&this_day<=entry.endDate()){affected_enties_on_map.push(em)}}.bind(this));var position=this._findEmptyPosition(affected_enties_on_map);affected_enties_on_map.each(function(ae,index){if(index==0){ae[position]=$A();ae[position].push(entry);ae[position].push(affected_enties_on_map.size())}else{ae[position]="skip"}}.bind(this))}.bind(this));return entries_map},findSpannedEntriesForDateRange:function(range_start_date,range_end_date){var collection=$A();this.spannedEntries().each(function(entry){var start_date=entry.startDate();var end_date=entry.endDate();if(start_date<=range_start_date&&end_date>=range_start_date){collection.push(entry)}else{if(start_date>=range_start_date&&start_date<=range_end_date){collection.push(entry)}}}.bind(this));collection=collection.sortBy(function(entry){return entry.get("id")});return collection},regularEntries:function(){return this.indexes.regular_entries},regularEntriesForDate:function(date){if(!this.indexes.regular_entries_by_date.get(date)){this.indexes.regular_entries_by_date.set(date,$A())}return this.indexes.regular_entries_by_date.get(date)},spannedEntries:function(){return this.indexes.spanned_entries},lateMilestones:function(){return this.indexes.late_milestones.sortBy(function(entry){return entry.get("overdue_days_count")})},_findEmptyPosition:function(collection){var position=0;var position_found=false;while(!position_found){var position_taken=collection.any(function(e){return e[position]}.bind(this));if(position_taken){position=position+1}else{position_found=true}}return position},_removeEntry:function(entry){this.indexes.id.unset(entry.get("id"));var find_by_id=function(e){if(e.get("id")==entry.get("id")){return(entry)}}.bind(this);if(entry.isSpanned()){this.indexes.spanned_entries=this.indexes.spanned_entries.reject(find_by_id)}else{this.indexes.regular_entries=this.indexes.regular_entries.reject(find_by_id);var collection=this.indexes.regular_entries_by_date.get(entry.get("date"));if(collection){collection=collection.reject(find_by_id);this.indexes.regular_entries_by_date.set(entry.get("date"),collection)}}if(entry.isLateMilestone()){this.indexes.late_milestones=this.indexes.late_milestones.reject(find_by_id)}},_addEntryFromAttributes:function(entry_attributes){this.populateRepository([entry_attributes]);var entry=this.find(entry_attributes.id);return entry}});CalendarEntry.registerIndexes();var CalendarEntryBehavior=Class.create({initialize:function(container,options){this.container=container;this.options=options||{};this.registerContainerBehavior()},registerContainerBehavior:function(){this.container.on("menu:activated",".calendar_entry_container",this.onCalendarEntryMenuTarget.bind(this));this.container.on("menu:request:started",this.onMenuRequestStarted.bind(this));this.container.on("menu:request:finished",this.onMenuRequestFinished.bind(this));this.container.on("menu:deactivated",this.onMenuRequestFinished.bind(this));this.container.on("click","span.calendar_entry_show_delete_button",this.onDeleteEntry.bind(this));this.container.on("click","input.milestone_status_checkbox",this.onMilestoneStatusChange.bind(this))},onCalendarEntryMenuTarget:function(event,container){event.stop();var entry=CalendarEntry.find(container.readAttribute("data-entry-id"));if(!entry.isEditable()){this.loadEntryDetails(container)}else{this.loadEditForm(container)}},onMenuRequestStarted:function(event,container){container.down(".menu_content").hide();var event_meta=container.down(".event_meta_wrapper");if(event_meta){event_meta.addClassName("busy")}},onMenuRequestFinished:function(event,container){if(container.hasClassName("active_menu")){container.down(".menu_content").show()}var event_meta=container.down(".event_meta_wrapper");if(event_meta){event_meta.removeClassName("busy")}},onDeleteEntry:function(event,delete_span){event.stop();var delete_link=delete_span.down("a");var confirmation_message=delete_link.readAttribute("data-calendar-confirm");if(confirmation_message&&!confirm(confirmation_message)){return}delete_span.hide();var submit_wrapper=delete_span.up("div.submit");submit_wrapper.down("span.edit_milestone_button_container").hide();submit_wrapper.down("img.spinner").show();new Ajax.Request(delete_link.href,{method:"delete"})},onMilestoneStatusChange:function(event,milestone_status_checkbox){var container=milestone_status_checkbox.up(".calendar_entry_container");var label=milestone_status_checkbox.next(".event_label_wrapper",0);var entry=CalendarEntry.find(container.readAttribute("data-entry-id"));label.addClassName("busy");var action=milestone_status_checkbox.checked?entry.completePath():entry.uncompletePath();new Ajax.Request(action,{method:"put",onComplete:function(){label.removeClassName("busy")}.bind(this)})},loadEntryDetails:function(container){var menu_target=container.down("a.calendar_entry_menu_target");var details_wrapper=container.down("div.details_wrapper");if(details_wrapper.down("div.event_details")){return}container.fire("menu:request:started");new Ajax.Request(menu_target.readAttribute("data-details-path"),{method:"get",evalScripts:true,onSuccess:function(response){container.fire("menu:request:finished");details_wrapper.update(response.responseText);details_wrapper.slideIntoView()}.bind(this),onFailure:function(){container.fire("menu:request:finished");this.deactivateMenu(container)}.bind(this)})},loadEditForm:function(container){container.fire("menu:request:started");new Ajax.Request(container.readAttribute("data-edit-path"),{method:"get",evalScripts:true,onSuccess:function(response){container.fire("menu:request:finished");var form_wrapper=container.down(".form_wrapper");form_wrapper.update(response.responseText);form_wrapper.select(".resize_to_fit_contents").each(function(ta){CalendarEntryFormBehavior.resizeTextarea(ta)});form_wrapper.slideIntoView()}.bind(this),onFailure:function(response){container.fire("menu:request:finished");this.deactivateMenu(container)}.bind(this)})},deactivateMenu:function(container){var menu_content=container.down(".menu_content");if(menu_content){menu_content.hide();menu_content.fire("menu:deactivate")}}});CalendarEntryBehavior.getDateLabel=function(container){var day_block=container.up("td");var daynum=parseInt(day_block.readAttribute("data-daynum"));return container.up("tr").siblings()[0].down("td[data-daynum="+daynum+"]")};var CalendarEntryFormBehavior=Class.create({initialize:function(wrapper){this.wrapper=wrapper;this.prepareForm()},prepareForm:function(){this.wrapper.on("form:submit","form.calendar_entry_form",this.onFormSubmit.bind(this));this.wrapper.on("click","span.calendar_entry_delete_button",this.onDeleteEntry.bind(this));this.wrapper.on("click","input.event_type_radio",this.toggleMilestone.bind(this));this.wrapper.on("responsible_party:changed","select.responsible_party_select",this.toggleNotificationCheckbox.bind(this));this.wrapper.on("calendar:dateSelected","td.calendar_due_at_container",this.onDueDateChange.bind(this));this.wrapper.on("calendar:dateSelected","td.calendar_end_at_container",this.onDueDateChange.bind(this));this.wrapper.on("calendar:dateSelected",".calendar_start_at_container",this.onStartDateChange.bind(this));this.wrapper.on("click","a.toggle_span_selection",this.toggleSpanSection.bind(this));$A(["input","keypress"]).each(function(callback){this.wrapper.on(callback,"textarea.event_title",this.onTextareaKeyPress)}.bind(this));this.wrapper.on("focus:in",function(event,element){if(element.up("div.due_pop_wrapper")){return}$$("div.due_pop_wrapper").invoke("hide");$$("div.event_date_wrapper").invoke("removeClassName","active_menu");if(element.hasClassName("event_date")){element.up("div.event_date_wrapper").addClassName("active_menu");var due_pop_wrapper=element.adjacent("div.due_pop_wrapper")[0];due_pop_wrapper.show();this.slideBalloonIntoView(due_pop_wrapper)}}.bind(this));var hideDuePop=(function(event,element){if(element.up("div.due_pop_wrapper")){return}if(element.hasClassName("event_date")){var due_pop=element.adjacent("div.due_pop_wrapper")[0];var date_wrapper=due_pop.up("div.event_date_wrapper");var due_pop_visible=due_pop.visible();$$("div.due_pop_wrapper").invoke("hide");if(!due_pop_visible){due_pop.show()}date_wrapper.addClassName("active_menu");event.stop();element.activate()}else{$$("div.due_pop_wrapper").invoke("hide");$$("div.event_date_wrapper").invoke("removeClassName","active_menu")}}).bind(this);document.on("mousedown",hideDuePop);if(Prototype.BrowserFeatures.Multitouch){document.on("touchstart",hideDuePop)}this.wrapper.on("calendar:dateSelected","div.event_date_wrapper",function(event,date_wrapper){date_wrapper.removeClassName("active_menu");date_wrapper.down("div.due_pop_wrapper").hide();var value_input=date_wrapper.down("input.value_field");var display_input=date_wrapper.down("input.display_field");display_input.value=event.memo.date.format(display_input.readAttribute("data-format"));value_input.value=event.memo.date.toString()});this.wrapper.on("menu:deactivated",".calendar_entry_container",function(event,form_container){var form=form_container.down("form.calendar_entry_form");if(form){var cancel_link=form_container.down("a.cancel_form");if(cancel_link){cancel_link.fire("calendar_entry_form:cancel")}var form_wrapper=form_container.down(".form_wrapper");var spinners=form_wrapper.adjacent("img.spinner");if(spinners[1]){spinners[1].show()}form_wrapper.update("")}});this.wrapper.on("project_option:changed","select.new_calendar_entry_project_select",this.onProjectOptionChange.bind(this));this.setupMoveOperations()},setupMoveOperations:function(){var click=(function(event,element){if(element.up("div.calendar_entry_move_menu_container")){if(element.readAttribute("data-menuaction")==="close"){event.stop()}else{return}}if(element.hasClassName("calendar_entry_move_link")){var link_container=element.up("div.calendar_entry_move_container");link_container.addClassName("menu_container");$(link_container.readAttribute("data-menucontent")).show()}else{$$("div.calendar_entry_move_container").each(function(lc){lc.removeClassName("menu_container");$(lc.readAttribute("data-menucontent")).hide()})}}).bind(this);document.on("mousedown",click);if(Prototype.BrowserFeatures.Multitouch){document.on("touchstart",click)}},setScopeFor:function(form){if(Calendar.scope){var scope=form.down("input[name=scope]");scope.value=Calendar.scope}},onProjectOptionChange:function(event,select){var form=select.up("form.calendar_entry_form");var responsible_party_options_container=form.down("select.responsible_party_select");var project_id=select.value;form.action="/projects/"+project_id+"/calendar_entries";var rp_options_html=CalendarEntryFormBehavior.responsible_party_options_html[project_id];if(rp_options_html){responsible_party_options_container.update(rp_options_html)}else{form.disable();var url="/projects/"+project_id+"/milestones/responsible_party_options";new Ajax.Request(url,{method:"get",onSuccess:function(response){CalendarEntryFormBehavior.responsible_party_options_html[project_id]=response.responseText;responsible_party_options_container.update(response.responseText);form.enable()}.bind(this)})}},onFormSubmit:function(event,form){event.stop();var title=form.down(".event_title");var content=title.value;if(content.byteSize()>100){while(content.byteSize()>100){content=content.substring(0,content.length-1)}alert("The title is too long. Please shorten it and try again.\n\nFor example, the following is the longest version that we can accept of what you entered:\n\n"+content);title.focus();return false}var single_block=form.down("div.calendar_entry_form_single_block");var span_block=form.down("div.span_block");var responsible_block=form.down("div.responsible_block");$A([single_block,span_block,responsible_block]).each(function(element){if(!element.visible()){Form.disable(element)}}.bind(this));this.toggleSpinner(form);this.setScopeFor(form);form.request()},onDeleteEntry:function(event,delete_span){event.stop();var form=delete_span.up("div.form_wrapper").down("form.calendar_entry_form");var confirmation_message=delete_span.down("a").readAttribute("data-calendar-confirm");if(confirmation_message&&!confirm(confirmation_message)){return}this.toggleSpinner(form);this.setScopeFor(form);form.request({method:"delete"})},toggleSpanSection:function(event,toggle_link){event.stop();var form=toggle_link.up("form.calendar_entry_form");var single_block=form.down("div.calendar_entry_form_single_block");var span_block=form.down("div.span_block");var shift_block=form.down("div.shift");if(single_block.visible()){this.disableBlock(single_block);this.enableBlock(span_block);if(shift_block){this.disableBlock(shift_block)}}else{this.enableBlock(single_block);this.disableBlock(span_block);if(shift_block){this.enableBlock(shift_block)}}},toggleMilestone:function(event,radio){var form=radio.up("form.calendar_entry_form");var form_wrapper=form.up(".form_wrapper");var responsible_block=form.down("div.responsible_block");radio.up("div.select_event_type").select("label").each(function(el){el.removeClassName("active")});radio.up("label").addClassName("active");if(radio.checked&&radio.hasClassName("milestone")){this.enableBlock(responsible_block);this.slideBalloonIntoView(form_wrapper)}else{this.disableBlock(responsible_block)}},toggleNotificationCheckbox:function(event,control){var responsible_block=control.up("div.responsible_block");var responsible_notify=responsible_block.down("div.responsible_notify");var form_wrapper=control.up(".form_wrapper");var send_reminder=responsible_block.down(".send_reminder");var send_reminder_now_and_then=responsible_block.down(".send_reminder_now_and_then");var person_id=control.readAttribute("data-person-id");var item=control.options[control.selectedIndex];var match=control.name.match(/\[(\d+)\]/);var suffix=match?("_"+match[1]):"";if(responsible_notify){send_reminder.hide();if(send_reminder_now_and_then){send_reminder_now_and_then.hide()}if(!item.value.match(/^c/)&&item.value){responsible_notify.show();(!send_reminder_now_and_then||item.value==person_id)?send_reminder.show():send_reminder_now_and_then.show();this.slideBalloonIntoView(form_wrapper)}else{responsible_notify.hide()}}},onDueDateChange:function(event,container){var single_block=container.up("div.fields");var form=single_block.up("form.calendar_entry_form");var form_wrapper=form.up(".form_wrapper");var shift_block=form.down("div.shift");if(!shift_block){return}var shift_wrapper=shift_block.down("div.shift_wrapper");var due_date=single_block.down("input.event_date[data-original-value]");shift_block.show();this.slideBalloonIntoView(form_wrapper);if(due_date.readAttribute("data-original-value")==event.memo.date.toString()){shift_wrapper.hide()}else{shift_wrapper.show();this.slideBalloonIntoView(form_wrapper)}},onStartDateChange:function(event,element){var end_date_container=element.up("div.calendar_entry_form_span_block").down(".calendar_end_at_container");var start_date=event.memo.date;var end_date=CalendarDate.parse(end_date_container.down("input.value_field").value);if(end_date<=start_date){CalendarEntryFormBehavior.renderDateSelection(end_date_container,"due_at",start_date.next());new CalendarDateSelect(end_date_container.down("input.calendar_date_select_input"),{})}},onTextareaKeyPress:function(event,element){CalendarEntryFormBehavior.resizeTextarea(element)},toggleSpinner:function(container){container.down(".submit_buttons_block").toggle();container.down(".spinner").toggle()},enableBlock:function(block){Form.enable(block);block.show()},disableBlock:function(block){Form.disable(block);block.hide()},slideBalloonIntoView:function(element){var balloon=element.up("div.balloon");var balloon_pos=balloon.getStyle("position");var month_row=balloon.up("table.month_row_events");if(month_row){balloon.setStyle({position:"relative"});element.slideIntoView();balloon.setStyle({position:balloon_pos})}else{element.slideIntoView()}}});CalendarEntryFormBehavior.resizeTextarea=function(element){element=$(element);var height=element.valueDimensions("height");var min_height=element.readAttribute("data-min-height");if(min_height){height=Math.max(min_height,height)}element.setStyle({height:height+"px"})};CalendarEntryFormBehavior.renderDateSelection=function(container,name,date){container.update(templates._event_date_wrapper({name:name,human_date:date.format("#{abbreviated_month} #{day}, #{year}"),date:date.toString()}))};CalendarEntryFormBehavior.initializeNewEntryForm=function(entry_form_container){var date=CalendarDate.parse(entry_form_container.readAttribute("data-date"));var form_wrapper=entry_form_container.down("div.form_wrapper");form_wrapper.update(CalendarEntryFormBehavior.new_entry_form_html);CalendarEntryFormBehavior.renderDateSelection(form_wrapper.down("td.calendar_due_at_container"),"due_at",date);CalendarEntryFormBehavior.renderDateSelection(form_wrapper.down("td.calendar_start_at_container"),"start_at",date);CalendarEntryFormBehavior.renderDateSelection(form_wrapper.down("td.calendar_end_at_container"),"due_at",date.next());form_wrapper.select("input.calendar_date_select_input").each(function(calendar_select_input){new CalendarDateSelect(calendar_select_input,{})})};document.observe("dom:loaded",function(){if($("project_calendar")){new CalendarEntryFormBehavior(document)}var form_container=$("new_calendar_entry_form_container");if(form_container){CalendarEntryFormBehavior.new_entry_form_html=form_container.down("div.form_wrapper").innerHTML;var new_calendar_entry_project=form_container.down("select.new_calendar_entry_project_select");if(new_calendar_entry_project){CalendarEntryFormBehavior.responsible_party_options_html={};var rp_options=form_container.down("select.responsible_party_select").innerHTML;CalendarEntryFormBehavior.responsible_party_options_html[new_calendar_entry_project.value]=rp_options}CalendarEntryFormBehavior.initializeNewEntryForm(form_container)}});var DashboardCalendar=Class.create(Calendar,{initialize:function($super,dashboard_calendar_container,options){this.dashboard_calendar_container=dashboard_calendar_container;this.calendar_container=dashboard_calendar_container.down(".calendar_container");if(!options){options={}}options.week_count=options.week_count||2;$super(this.calendar_container,options);this.calendar_entry_form_behavior=new CalendarEntryFormBehavior(document);this.calendar_entry_behavior=new GridCalendarEntryBehavior(this.calendar_container,{skip_bubble_shifting:true})},onEntryCreate:function($super,entry){if(!this.isEntryDisplayed(entry)){var entry_date=entry.isSpanned()?entry.startDate():entry.endDate();var calendar_date=entry_date.beginningOfMonth().beginningOfWeek(this.first_day_of_the_week);document.location=entry.get("project_path")+"/milestones?from_date="+calendar_date.toString()+"&highlight="+entry_date.toString()}else{this.render()}}});document.observe("dom:loaded",function(){var containers=$$(".dashboard_calendar_container");containers.each(function(container){(new DashboardCalendar(container)).render()})});var GlobalCalendar=Class.create(Calendar,{initialize:function($super,global_calendar_container,options){this.global_calendar_container=global_calendar_container;this.calendar_container=global_calendar_container.down(".calendar_container");if(!options){options={}}$super(this.calendar_container,options);this.calendar_entry_form_behavior=new CalendarEntryFormBehavior(document);this.calendar_entry_behavior=new GridCalendarEntryBehavior(this.calendar_container,{skip_bubble_shifting:true})},registerObservers:function($super){$super();this.registerNavigationObservers(this.global_calendar_container);CalendarEntry.on("entry:create",this.ensureResponsiblePartyExistsInFilter.bind(this));CalendarEntry.on("entry:updated",this.ensureResponsiblePartyExistsInFilter.bind(this));document.on("responsible_party:changed","select.responsible_party_options",this.render.bind(this))},fixPrintLink:function($super){$super();var responsible_party=ResponsiblePartyObserver.currentValue();var link=$(document.body).down("#print_button a");if(link&&responsible_party){link.href=link.href+"&responsible_party="+responsible_party}},render:function($super){$super();this.fixPrintLink();this.fixTodayLink(this.global_calendar_container);this.showDateRange()},spannedEntryMapForWeek:function($super,week_start_date){var reduce_function;if(ResponsiblePartyObserver.currentValue()){reduce_function=function(entry){return entry.get("responsible_party_filter")==ResponsiblePartyObserver.currentValue()}}return CalendarEntry.spannedEntryMapForWeek(week_start_date,reduce_function)},regularEntriesForDate:function($super,date){var result=$super(date);if(ResponsiblePartyObserver.currentValue()){result=result.findAll(function(entry){return entry.get("responsible_party_filter")==ResponsiblePartyObserver.currentValue()})}return result},ensureResponsiblePartyExistsInFilter:function(entry){if(!entry.isMilestone()){return}var responsible_party_dom=$$("select.responsible_party_options")[0];var responsible_party_options=responsible_party_dom.select("option").map(function(o){return o.value});var responsible_party_filter=entry.get("responsible_party_filter");if(responsible_party_filter&&responsible_party_options.indexOf(responsible_party_filter)<0){var new_option=new Element("option",{value:responsible_party_filter}).update(entry.get("responsible_party_name"));responsible_party_dom.down("optgroup").insert(new_option)}}});document.observe("dom:loaded",function(){var containers=$$(".global_calendar_container");containers.each(function(container){(new GlobalCalendar(container)).render()})});var GridCalendarEntryBehavior=Class.create(CalendarEntryBehavior,{registerContainerBehavior:function($super){$super();this.container.on("mousedown",".comments_target",this.onCommentClick.bind(this));if(Prototype.BrowserFeatures.Multitouch){this.container.on("touchstart",".comments_target",this.onCommentClick.bind(this))}this.container.on("menu:activated",".new_entry_form_menu_container",this.onMenuShow.bind(this));this.container.on("menu:deactivated",".new_entry_form_menu_container",this.onMenuHide.bind(this));if($("new_calendar_entry_form_container")){this.container.on("mousedown",".load_new_entry_on_click",this.loadNewEntryForm.bind(this));if(Prototype.BrowserFeatures.Multitouch){this.container.on("touchstart",".load_new_entry_on_click",this.loadNewEntryForm.bind(this))}}},onMenuRequestStarted:function(event,container){container.down(".menu_content").hide();var day_block=this.findDayBlockForMenuContainer(container);if(day_block){day_block.addClassName("busy")}},onMenuRequestFinished:function(event,container){if(container.hasClassName("active_menu")){container.down(".menu_content").show()}var day_block=this.findDayBlockForMenuContainer(container);if(day_block){day_block.removeClassName("busy")}},onMenuShow:function(event,container){container.up("td").addClassName("active_menu")},onMenuHide:function(event,container){container.up("td").removeClassName("active_menu")},onCommentClick:function(event,comments_container){event.stop();if(event.button==0){window.location=comments_container.down("a").href}},loadNewEntryForm:function(event,element){if(!event.element().hasClassName("load_new_entry_on_click")){return}var entry_form_container=this.container.down("div.new_entry_form_container[data-date="+element.readAttribute("data-date")+"]");var menu_container=entry_form_container.down("div.new_entry_form_menu_container");if(menu_container.hasClassName("active_menu")){return}event.stop();var offset=entry_form_container.cumulativeOffset();var left=event.pointerX()-offset.left+5;var right=event.pointerX()-(offset.left+346);var top=event.pointerY()-offset.top;var balloon=entry_form_container.down("div.balloon");if(balloon.hasClassName("right")){balloon.setStyle({left:right+"px",top:top+"px"})}else{balloon.setStyle({left:left+"px",top:top+"px"})}menu_container.down("div.menu_target").fire("menu:activate");this.prepareNewEntryForm(entry_form_container)},findDayBlockForMenuContainer:function(menu_container){var menu_date=menu_container.readAttribute("data-menu-date");if(!menu_date){return}return this.container.down("div.date_label[data-date="+menu_date+"]")},prepareNewEntryForm:function(entry_form_container){CalendarEntryFormBehavior.initializeNewEntryForm(entry_form_container);var form_wrapper=entry_form_container.down("div.form_wrapper");form_wrapper.down("input.autofocus").focus();form_wrapper.slideIntoView()},renderDateSelection:function(container,name,date){container.update(templates._event_date_wrapper({name:name,human_date:date.format("#{abbreviated_month} #{day}, #{year}"),date:date.toString()}))}});document.observe("dom:loaded",function(){if(window.PIE){Calendar.roundRectanglesForIE=function(){$$("div.month_row_spanned div.event").each(function(element){PIE.attach(element)})};Calendar.prototype.render=Calendar.prototype.render.wrap(function(render){var result=render();Calendar.roundRectanglesForIE();return result});Calendar.roundRectanglesForIE()}});var ListView=Class.create({initialize:function(container){this.container=container;this.registerObservers()},registerObservers:function(){this.container.on("click","input.list_view_milestone",this.onMilestoneStatusChange.bind(this))},onMilestoneStatusChange:function(event,checkbox){var event_container=checkbox.up("div.event");var event_id=event_container.readAttribute("data-event-id");var form=checkbox.up("form");event_container.addClassName("busy");form.request({method:"put",onComplete:function(response){this.container.update(response.responseText);var event_dom=this.container.down("div.event[data-event-id="+event_id+"]");event_dom.slideIntoView();new Effect.Highlight(event_dom,{duration:5})}.bind(this)})}});document.observe("dom:loaded",function(){var list_view_container=$("list_view_content");if(list_view_container){new ListView(list_view_container)}});var OverdueMilestones=Class.create({initialize:function(wrapper){this.wrapper=wrapper;this.project_id=this.wrapper.readAttribute("data-project-id");this.render();this.registerObservers()},registerObservers:function(){new CalendarEntryBehavior(this.wrapper);this.wrapper.on("click","a.show_late_milestones",this.showOverdueMilestones.bind(this));this.wrapper.on("click","a.hide_late_milestones",this.hideOverdueMilestones.bind(this));document.on("responsible_party:changed","select.responsible_party_options",this.render.bind(this));this.registerCalendarEntryObservers()},registerCalendarEntryObservers:function(){var render_if_overdue=function(entry){if(entry.isLateMilestone()){this.render()}}.bind(this);CalendarEntry.on("entry:create",render_if_overdue);CalendarEntry.on("entry:destroy",render_if_overdue);CalendarEntry.on("entry:updated",this.render.bind(this))},showOverdueMilestones:function(event){event.stop();$("link_to_show_late_milestones").hide();$("link_to_hide_late_milestones").show();Effect.toggle($("all_late_milestones"),"blind",{duration:0.15,transition:Effect.Transitions.sinoidal})},hideOverdueMilestones:function(event){event.stop();$("link_to_hide_late_milestones").hide();$("link_to_show_late_milestones").show();Effect.toggle($("all_late_milestones"),"blind",{duration:0.1,transition:Effect.Transitions.sinoidal})},lateMilestones:function(){var result=CalendarEntry.lateMilestones();if(ResponsiblePartyObserver.currentValue()){result=result.findAll(function(entry){return entry.get("responsible_party_filter")==ResponsiblePartyObserver.currentValue()})}return result},render:function(){$("all_late_milestones").update(templates.overdue_milestones(this));var late_milestones_length=this.lateMilestones().length;late_milestones_length>0?$("late_milestones").show():$("late_milestones").hide();this.wrapper.down("a.show_late_milestones").update(I18n.t("project.calendar.show_all_late_milestones_link",{count:late_milestones_length}))}});document.observe("dom:loaded",function(){var wrapper=$("late_milestones_wrapper");if(wrapper){new OverdueMilestones(wrapper)}});var ProjectCalendar=Class.create(Calendar,{initialize:function($super,project_calendar_container,options){this.project_calendar_container=project_calendar_container;this.calendar_container=project_calendar_container.down(".calendar_container");$super(this.calendar_container,options);this.calendar_entry_behavior=new GridCalendarEntryBehavior(this.calendar_container)},registerObservers:function($super){$super();this.registerNavigationObservers(this.project_calendar_container);window.onpopstate=this.onPopState},render:function($super){$super();this.fixPrintLink();this.fixTodayLink(this.project_calendar_container);this.showDateRange()},startDateChanged:function($super){if(window.history&&window.history.pushState){var start_date_string=this.start_date.toString();var state={start_date:start_date_string};var location=window.location.pathname;if(!this.isTodayDisplayed()){location+="?from_date="+start_date_string+"#cal"}window.history.pushState(state,"",location)}},onPopState:function(event){var state=event.state;if(state){this.start_date=CalendarDate.parse(state.start_date);this.render()}else{if(window.location.hash=="#cal"){this.start_date=CalendarDate.parse(this.original_start_date.toString());this.render()}}}});document.observe("dom:loaded",function(){var pc_container=$("project_calendar");if($("project_calendar")){var p_cal=new ProjectCalendar(pc_container);p_cal.render();var parameters=document.location.search.slice(1).toQueryParams();if(parameters.show_event_id){setTimeout(function(){p_cal.goToEvent(parameters.show_event_id)}.bind(this),1)}else{if(parameters.highlight){p_cal.highlightDay(parameters.highlight)}}}});var ResponsiblePartyObserver={current_responsible_party:null,activate:function(responsible_party_options){responsible_party_options.observe("change",ResponsiblePartyObserver.responsiblePartyChanged)},responsiblePartyChanged:function(event){var element=event.element();ResponsiblePartyObserver.current_responsible_party=element.value;element.fire("responsible_party:changed")},currentValue:function(){return ResponsiblePartyObserver.current_responsible_party||document.location.search.slice(1).toQueryParams().responsible_party}};document.observe("dom:loaded",function(){$$("select.responsible_party_options").each(function(responsible_party_options){ResponsiblePartyObserver.activate(responsible_party_options)})});var CalendarDate=Class.create({initialize:function(year,month,day){this.date=new Date(Date.UTC(year,month-1));this.date.setUTCDate(day);this.year=this.date.getUTCFullYear();this.month=this.date.getUTCMonth()+1;this.day=this.date.getUTCDate();this.value=this.date.getTime()},beginningOfMonth:function(){return new CalendarDate(this.year,this.month,1)},beginningOfWeek:function(start){var adjustment=this.date.getUTCDay()-(start||CalendarDate.FIRST_DAY_OF_THE_WEEK);if(adjustment<0){adjustment+=7}return this.previous(adjustment)},nextMonth:function(value){if(value===0){return this.beginningOfMonth()}var m=this.month+(value||1);var y=this.year;while(m>12){m-=12;y++}while(m<1){m+=12;y--}return new CalendarDate(y,m,1)},previousMonth:function(value){return this.nextMonth(-(value||1))},next:function(value){if(value===0){return this}return new CalendarDate(this.year,this.month,this.day+(value||1))},previous:function(value){if(value===0){return this}return this.next(-(value||1))},succ:function(){return this.next()},equals:function(calendarDate){return calendarDate&&this.value==calendarDate.value},isWeekend:function(){var day=this.date.getUTCDay();return day==0||day==6},getMonthName:function(){return CalendarDate.MONTHS[this.month-1]},getAbbreviatedMonthName:function(){return CalendarDate.ABBREVIATED_MONTHS[this.month-1]},toString:function(){return this.stringValue=this.stringValue||[this.year,this.month,this.day].invoke("toPaddedString",2).join("-")}});Object.extend(CalendarDate,{MONTHS:$w("January February March April May June July August September October November December"),ABBREVIATED_MONTHS:$w("Jan Feb Mar Apr May Jun Jul Aug Sep Oct Nov Dec"),WEEKDAYS:$w("Sunday Monday Tuesday Wednesday Thursday Friday Saturday"),FIRST_DAY_OF_THE_WEEK:0,parse:function(date){if(!(date||"").toString().strip()){return CalendarDate.parse(new Date())}else{if(date.constructor==Date){return new CalendarDate(date.getFullYear(),date.getMonth()+1,date.getDate())}else{if(Object.isArray(date)){var year=date[0],month=date[1],day=date[2];return new CalendarDate(year,month,day)}else{return CalendarDate.parse(date.toString().split("-"))}}}},weekdays:function(){return this.WEEKDAYS.slice(this.FIRST_DAY_OF_THE_WEEK).concat(this.WEEKDAYS.slice(0,this.FIRST_DAY_OF_THE_WEEK))}});CalendarDate.prototype.format=function(format){return format.interpolate({abbreviated_month:this.getAbbreviatedMonthName(),month:this.getMonthName(),day:this.day,year:this.year})};var CalendarDateSelect=Class.create({initialize:function(field,options){this.field=$(field);this.options=options||{};if(this.field.calendar){this.field.calendar.element.fire("calendar:fieldChanged");return false}this.onFieldChanged();this.createElement();this.field.insert({after:this});this.field.calendar=this},createElement:function(){this.element=new Element("div",{className:"calendar_date_select"});this.header=new Element("div",{className:"header"});this.pager=new CalendarDateSelect.Pager(this.cursor);this.header.insert(this.pager);this.element.insert(this.header);this.body=new Element("div",{className:"body"});this.updateBody();this.element.insert(this.body);this.footer=new Element("div",{className:"footer"});this.title=new Element("span").update((this.options.title||"Due:")+" ");this.description=new Element("span");this.updateDescription();this.footer.insert(this.title);this.footer.insert(this.description);this.element.insert(this.footer);this.element.observe("calendar:cursorChanged",this.onCursorChanged.bind(this));this.element.observe("calendar:dateSelected",this.onDateSelected.bind(this));this.element.observe("calendar:fieldChanged",this.onFieldChanged.bind(this))},onCursorChanged:function(event){this.setCursor(event.memo.cursor)},onDateSelected:function(event){this.setDate(event.memo.date)},onFieldChanged:function(event){var value=$F(this.field);var date=CalendarDate.parse(value);if(!value.blank()){this.setDate(date)}this.setCursor(date);if(this.pager){this.pager.setCursor(this.cursor)}},setCursor:function(date){this.cursor=date.beginningOfMonth();this.updateBody()},setDate:function(date){this.date=date;if(this.date){this.field.setValue(this.date)}else{this.field.setValue("")}this.updateDescription()},updateBody:function(){if(this.body){this.grid=new CalendarDateSelect.Grid(this.date,this.cursor);this.body.update(this.grid)}},updateDescription:function(){if(this.description){if(this.date){var description=(this.options.description||"#{month} #{day}, #{year}").interpolate({month:this.date.getMonthName(),day:this.date.day,year:this.date.year})}else{var description="No date selected"}if(this.description.parentNode){var element=new Element("span").update(description);this.description.replace(element);this.description=element}else{this.description.update(description)}}},toElement:function(){return this.element}});CalendarDateSelect.Pager=Class.create({initialize:function(cursor){this.cursor=cursor;this.createElement()},createElement:function(){this.element=new Element("div",{className:"pager"});this.left=new Element("a",{href:"#",method:"previous"});this.left.update('<img src="/images/calendar_date_select-previous_month.gif" />');this.left.observe("click",this.onButtonClicked.bind(this));this.element.insert(this.left);this.select=new Element("select",{className:"months"});this.updateSelect();this.select.observe("change",this.onSelectChanged.bind(this));this.element.insert(this.select);this.right=new Element("a",{href:"#",method:"next"});this.right.update('<img src="/images/calendar_date_select-next_month.gif" />');this.right.observe("click",this.onButtonClicked.bind(this));this.element.insert(this.right)},onButtonClicked:function(event){var element=event.findElement("a[method]");if(element){this[element.readAttribute("method")]();event.stop()}},onSelectChanged:function(event){this.setCursor(CalendarDate.parse($F(this.select)))},previous:function(){this.setCursor(this.cursor.beginningOfMonth().previous())},next:function(){this.setCursor(new CalendarDate(this.cursor.year,this.cursor.month+1,1))},setCursor:function(cursor){cursor=cursor.beginningOfMonth();var event=this.element.fire("calendar:cursorChanged",{cursor:cursor});if(!event.stopped){var oldCursor=this.cursor;this.cursor=cursor;this.updateSelect(oldCursor)}},updateSelect:function(oldCursor){if(!oldCursor||this.cursor.year!=oldCursor.year){this.months=this.getDatesForSurroundingMonths();this.select.options.length=0;this.getDatesForSurroundingMonths().each(function(date,index){var title=[date.getAbbreviatedMonthName(),date.year].join(" ");this.select.options[index]=new Option(title,date.toString());if(this.cursor.equals(date)){this.select.selectedIndex=index}},this)}else{this.select.selectedIndex=this.months.pluck("value").indexOf(this.cursor.value)}},getDatesForSurroundingMonths:function(){return $R(this.cursor.year-1,this.cursor.year+2).map(function(year){return $R(1,12).map(function(month){return new CalendarDate(year,month,1)})}).flatten()},toElement:function(){return this.element}});CalendarDateSelect.Grid=Class.create({initialize:function(date,cursor){this.date=date?CalendarDate.parse(date):null;this.cursor=CalendarDate.parse(cursor).beginningOfMonth();this.today=CalendarDate.parse();this.createElement()},createElement:function(){var table=new Element("table");var tbody=new Element("tbody");var html=[];html.push('<tr class="weekdays">');CalendarDate.weekdays().each(function(weekday){html.push("<th>",weekday.substring(0,1),"</th>")});html.push("</tr>");this.getWeeks().each(function(week){html.push('<tr class="days">');week.each(function(date){html.push('<td class="',this.getClassNamesForDate(date).join(" "));html.push('" date="',date,'"><a href="#">',date.day,"</a></td>")},this);html.push("</tr>")},this);tbody.insert(html.join(""));table.insert(tbody);table.observe("click",function(event){event.stop()});table.observe("mousedown",this.onDateMouseDown.bind(this));table.observe("mouseup",this.onDateMouseUp.bind(this));return this.element=table},getStartDate:function(){return this.cursor.beginningOfWeek()},getEndDate:function(){return this.getStartDate().next(41)},getDates:function(){return $R(this.getStartDate(),this.getEndDate())},getWeeks:function(){return this.getDates().inGroupsOf(7)},getClassNamesForDate:function(date){var classNames=[];if(date.equals(this.today)){classNames.push("today")}if(date.equals(this.date)){classNames.push("selected")}if(date.isWeekend()){classNames.push("weekend")}if(!date.beginningOfMonth().equals(this.cursor)){classNames.push("other")}return classNames},onDateMouseDown:function(event){var element=event.findElement("td[date]");if(element){this.highlightDate(element);event.stop()}},onDateMouseUp:function(event){var element=event.findElement("td[date]");if(element){this.selectDate(element);event.stop()}},highlightDate:function(element){var date=null;if(element){var date=CalendarDate.parse(element.readAttribute("date"))}else{element=this.element}var selection=this.element.down("td.selected");if(selection){selection.removeClassName("selected")}var oldSelectedElement=this.selectedElement;var oldDate=this.date;this.selectedElement=element;this.date=date;element.addClassName("selected");this.revertHighlight=(function(){element.removeClassName("selected");this.selectedElement=oldSelectedElement;this.date=oldDate;if(selection){selection.addClassName("selected")}}).bind(this)},selectDate:function(element){var date=null;if(element){var date=CalendarDate.parse(element.readAttribute("date"))}else{element=this.element}var event=element.fire("calendar:dateSelected",{date:date});if(this.revertHighlight&&event.stopped){this.revertHighlight()}this.revertHighlight=null},toElement:function(){return this.element}});var Category={add:function(options){options=Object.extend({onValidName:Prototype.emptyFunction,onInvalidName:Prototype.emptyFunction,onFailure:Prototype.emptyFunction},options);var element=$(options.element);var name=prompt(options.prompt,"");if(name){name=name.strip()}if(!name||name.blank()){options.onInvalidName(name)}else{element.addClassName("busy");options.onValidName(name);new Ajax.Request(options.url,{parameters:"category[name]="+encodeURIComponent(name),onComplete:function(){element.removeClassName("busy")},onFailure:options.onFailure.wrap(function(proceed){alert(options.error);proceed()})})}},edit:function(options){var element=$(options.element);var name=prompt(options.prompt,options.name);if(name){element.addClassName("busy");new Ajax.Request(options.url,{method:"put",parameters:"category[name]="+encodeURIComponent(name),onComplete:function(){element.removeClassName("busy")}})}}};Category.Select={controls:[],register:function(element){var control=$(element);var optionsIncludeAddCommand=(control.options[control.options.length-1].value=="!");if(!this.controls.include(control)&&optionsIncludeAddCommand){this.controls.push(control);control.observe("change",this.detectChange.bind(this))}},detectChange:function(event){var control=Event.element(event);if(control.selectedIndex==control.options.length-1){Category.add({element:control,url:control.readAttribute("data-url"),prompt:control.readAttribute("data-prompt"),error:control.readAttribute("data-error"),onValidName:function(name){Category.Select.control=control;Category.Select.enableControls(false)},onInvalidName:function(){control.selectedIndex=0},onFailure:function(req){Category.Select.enableControls(true);Category.Select.control.selectedIndex=0}})}},enableControls:function(setting){this.controls.each(function(item){item.disabled=!setting})},addCategory:function(id,name,position){position++;this.controls.each(function(item){var options=$A(item.options);options.splice(position,0,new Option(name,id));for(var idx=0;idx<options.length;idx++){item.options[idx]=options[idx]}});this.reset(position)},reset:function(selected){if(this.control){this.control.selectedIndex=(selected||0)}this.enableControls(true)},renameCategory:function(id,name){this.controls.each(function(item){for(var idx=0;idx<item.options.length;idx++){if(parseInt(item.options[idx].value)==id){item.options[idx].text=name;break}}})},deleteCategory:function(id){this.controls.each(function(item){for(var idx=0;idx<item.options.length;idx++){if(parseInt(item.options[idx].value)==id){item.options[idx]=null;break}}})}};var Color={TOLERANCE:1e-10};Color.HSV=Class.create({initialize:function(h,s,v){this.h=h>1?1:h<0?0:h;this.s=s>1?1:s<0?0:s;this.v=v>1?1:v<0?0:v},toRGB:function(){var h=this.h,s=this.s,v=this.v;if(h+Color.TOLERANCE>=1){h=0}h*=6;var i=parseInt(h);var f=h-i;var p=v*(1-s);var q=v*(1-s*f);var t=v*(1-s*(1-f));var r,g,b;switch(i){case 0:r=v,g=t,b=p;break;case 1:r=q,g=v,b=p;break;case 2:r=p,g=v,b=t;break;case 3:r=p,g=q,b=v;break;case 4:r=t,g=p,b=v;break;case 5:r=v,g=p,b=q;break}return new Color.RGB(Math.round(r*255),Math.round(g*255),Math.round(b*255))},toHSV:function(){return this},toHTML:function(){return this.toRGB().toHTML()}});Color.RGB=Class.create({initialize:function(r,g,b){this.r=parseInt(r>255?255:r<0?0:r);this.g=parseInt(g>255?255:g<0?0:g);this.b=parseInt(b>255?255:b<0?0:b)},toHSV:function(){var r=this.r,g=this.g,b=this.b;var max=Math.max(r,g,b),min=Math.min(r,g,b);var d=max-min,h,s=max>0?d/max:0,v=max;if(s-Color.TOLERANCE<=0){h=0}else{if(max==r){h=(g-b)/d}else{if(max==g){h=2+(b-r)/d}else{h=4+(r-g)/d}}}if(h<0){h+=6}h/=6,v/=255;return new Color.HSV(h,s,v)},toRGB:function(){return this},toHTML:function(){var html="#"+this.r.toColorPart()+this.g.toColorPart()+this.b.toColorPart();return html}});Color.RGB.fromHTML=function(html){var color=(html.toString().match(/#?([0-9A-Fa-f]{3}(?:[0-9A-Fa-f]{3})?)/)||[])[1];if(color){if(color.length==3){color=color.split("");var r=color[0]+color[0],g=color[1]+color[1],b=color[2]+color[2]}else{var r=color.slice(0,2),g=color.slice(2,4),b=color.slice(4,6)}return new Color.RGB(parseInt(r,16),parseInt(g,16),parseInt(b,16))}};var ColorPicker=Class.create({initialize:function(element,color){this.element=$(element);this.satPicker=this.element.down("div.saturation_and_brightness_picker");this.satCursor=this.satPicker.down("div.cursor");this.huePicker=this.element.down("div.hue_picker");this.hueCursor=this.huePicker.down("div.cursor");this.document=document;this.observers=$H();this.setColor(Color.RGB.fromHTML(color||"#f00"));this.start()},start:function(){if(this.observers.keys().length){return}this.observe("satPicker","mousedown","didStartSatPickerDrag");this.observe("huePicker","mousedown","didStartHuePickerDrag")},stop:function(){this.observers.keys().each(function(o){this.stopObserving(o)},this)},observe:function(elementName,eventName,methodName){var key=$A(arguments).join(":");var observer=this[methodName].bind(this),element=this[elementName];element.observe(eventName,observer);this.observers.set(key,{element:element,event:eventName,observer:observer})},stopObserving:function(){var o=this.observers.get($A(arguments).join(":"));if(o){o.element.stopObserving(o.event,o.observer)}},setColor:function(color){var hsv=color.toHSV();if(hsv.s>0){this.setHue(parseInt(hsv.h*255),true)}this.setSaturationAndValue(parseInt(hsv.s*255),parseInt(hsv.v*255),true);this.color=color;this.fireChangedEvent()},setColor:function(color,animate){var hsv=color.toHSV();var h=this.h,s=parseInt(hsv.s*255),v=parseInt(hsv.v*255);if(!h||hsv.s>0){h=parseInt(hsv.h*255)}var finish=(function(){this.color=color;this.fireChangedEvent()}).bind(this);if(animate){this.effect=new Effect.Parallel([new Effect.Tween(this.element,this.h,h,function(position){this.setHue(position,true)}.bind(this)),new Effect.Tween(this.element,this.s,s,function(position){this.setSaturationAndValue(position,this.v,true)}.bind(this)),new Effect.Tween(this.element,this.v,v,function(position){this.setSaturationAndValue(this.s,position,true)}.bind(this))],{duration:0.35,afterFinish:finish})}else{this.setHue(h,true);this.setSaturationAndValue(s,v,true);finish()}},updateColor:function(){this.color=new Color.HSV(this.h/255,this.s/255,this.v/255);this.fireChangedEvent()},setHue:function(h,aggregate){this.h=h<0?0:h>255?255:h;this.moveHueCursorTo(255-this.h);this.updateSatPickerBackground();if(!aggregate){this.updateColor()}},setSaturationAndValue:function(s,v,aggregate){this.s=s<0?0:s>255?255:s;this.v=v<0?0:v>255?255:v;this.moveSatCursorTo(this.s,255-this.v);if(!aggregate){this.updateColor()}},getColor:function(){return this.color},didStartSatPickerDrag:function(event){this.observe("document","mousemove","didDragSatPicker");this.observe("document","mouseup","didEndSatPickerDrag");this.didDragSatPicker(event)},didDragSatPicker:function(event){var offsets=this.getOffsetsFrom("satPicker",event);this.setSaturationAndValue(offsets.left,255-offsets.top);event.stop()},didEndSatPickerDrag:function(event){this.stopObserving("document","mousemove","didDragSatPicker");this.stopObserving("document","mouseup","didEndSatPickerDrag");event.stop()},didStartHuePickerDrag:function(event){this.observe("document","mousemove","didDragHuePicker");this.observe("document","mouseup","didEndHuePickerDrag");this.didDragHuePicker(event)},didDragHuePicker:function(event){var offsets=this.getOffsetsFrom("huePicker",event);this.setHue(255-offsets.top);event.stop()},didEndHuePickerDrag:function(event){this.stopObserving("document","mousemove","didDragHuePicker");this.stopObserving("document","mouseup","didEndHuePickerDrag");event.stop()},getOffsetsFrom:function(elementName,event){var element=this[elementName];var offset=element.cumulativeOffset();return{left:event.pointerX()-offset.left,top:event.pointerY()-offset.top}},moveSatCursorTo:function(x,y){this.satCursor.setStyle({left:x+"px",top:y+"px"})},moveHueCursorTo:function(y){this.hueCursor.setStyle({top:y+"px"})},updateSatPickerBackground:function(){var color=new Color.HSV(this.h/255,1,1).toRGB();this.satPicker.setStyle({backgroundColor:color.toHTML()})},fireChangedEvent:function(){this.element.fire("color:changed",{color:this.color})}});var ColorScheme={styles:{header_background:["backgroundColor"],client_name:["color"],project_name:["color"],current_tab_text:["color"],tab_background:["backgroundColor","borderColor"],tab_text:["color"],tab_hover_background:["backgroundColor","borderColor"],tab_hover_text:["color"],link_text:["color"]},initialize:function(colors){this.setSwatchColors(colors);this.rememberOriginalColors()},getSwatch:function(swatch){return this.getSwatchInput(swatch).up("div.color_swatch")},getSwatchInput:function(swatch){return $(swatch+"_input")},setSwatchColor:function(swatch,color){this.getSwatchInput(swatch).setValue(color);this.getSwatch(swatch).setStyle({backgroundColor:"#"+color});this.updateSwatchPreview(swatch)},getSwatchColor:function(swatch){return"#"+this.getSwatchInput(swatch).getValue()},editSwatchColor:function(swatch){ColorScheme.SwatchEditor.edit(swatch)},updateSwatchPreview:function(swatch){var preview=$(swatch+"_preview");if(preview){var color=this.getSwatchColor(swatch);this.styles[swatch].each(function(style){preview.style[style]=color})}},setSwatchColors:function(colors){ColorScheme.SwatchEditor.close();$H(colors).each(function(pair){this.setSwatchColor.apply(this,pair)},this)},setCustomScheme:function(){$("custom_scheme_selector").checked="checked"},serialize:function(){return Form.serialize("scheme_colors")},rememberOriginalColors:function(){this.originalColors=this.serialize()},colorsHaveChanged:function(){return this.originalColors&&(this.originalColors!=this.serialize())},onSave:function(){this.rememberOriginalColors()},onCancel:function(){this.rememberOriginalColors()},onUnload:function(){if(this.colorsHaveChanged()){return $("color_scheme_form").readAttribute("data-unload-message")}else{return}},SwatchEditor:{edit:function(swatch){this.close(true);this.swatch=swatch;this.originalColor=this.getSwatchColor();this.getSwatchContainer().addClassName("selected");this.show(ColorScheme.getSwatchColor(swatch))},close:function(fromEdit){if(this.swatch){this.getSwatchContainer().removeClassName("selected");this.swatch=null;if(!fromEdit){this.hide()}}},revert:function(){this.setColor(this.originalColor);this.show(this.originalColor)},show:function(color){this.createEditor();this.picker.setColor(Color.RGB.fromHTML(color));this.editor.removeClassName("changed");this.editor.addClassName("editing")},hide:function(){this.editor.removeClassName("editing")},visible:function(){return this.editor.hasClassName("editing")},getSwatchContainer:function(){return ColorScheme.getSwatch(this.swatch).up(".color")},getSwatchColor:function(){return ColorScheme.getSwatchColor(this.swatch).slice(1)},getColor:function(){return this.picker.getColor().toHTML().slice(1)},setColor:function(color){ColorScheme.setSwatchColor(this.swatch,color);ColorScheme.setCustomScheme()},createEditor:function(){if(!this.editor){this.editor=$("swatch_editor");var element=this.editor.down(".color_picker");this.picker=new ColorPicker(element);element.observe("color:changed",this.onColorChanged.bind(this));this.input=this.editor.down("input.color");this.input.observe("change",this.onInputChanged.bind(this))}},onColorChanged:function(event){var color=this.getColor();this.setColor(color);this.input.setValue("#"+color);this.editor.addClassName("changed")},onInputChanged:function(event){var color=Color.RGB.fromHTML(this.input.getValue());if(color){this.picker.setColor(color)}else{this.input.setValue("#"+this.getColor())}}}};document.observe("dom:loaded",function(){if($(document.body).hasClassName("appearance")){preload("/images/color_picker/arrow.png","/images/color_picker/circle.png","/images/color_picker/hue.png","/images/color_picker/saturation_and_brightness.png");window.onbeforeunload=ColorScheme.onUnload.bind(ColorScheme)}});document.on("form:submit","body.commentable form.uppity_upload",function(event,form){var uploadsWithHTML=form.readAttribute("current_attachment_manager")==="html";var hasAttachments=event.memo.form.hasAttachments();var isEditing=form.up("div.comment").hasClassName("edit_comment");if(isEditing){return}if(!hasAttachments){event.memo.form.submitBarControl.hideProgress();form.addClassName("without_attachments")}if(!(uploadsWithHTML&&hasAttachments)){form.request({onFailure:function(){alert("An error prevented your comment from being saved. Please try again. If the error continues, please contact support.");event.memo.form.enable();event.memo.form.submitBarControl.hideProgress();form.removeClassName("without_attachments")}});event.stop()}});function validateField(fieldId,alertMessage){var field=$(fieldId);if(field.value==""){alert(alertMessage||field.readAttribute("data-invalid-message"));field.focus();return false}else{return true}}function popup(url,width,height){window.open(url,"popup","width="+width+",height="+height+",scrollbars=auto,resizable=yes,toolbar=no,directories=no,menubar=no,status=no,left=100,top=100");return false}function milestoneResponsibleParty(control,currentUserId,suffix){var item=control.options[control.selectedIndex];var match=control.name.match(/\[(\d+)\]/);suffix=suffix||"";suffix+=match?("_"+match[1]):"";if(item.value.match(/^c/)||!item.value){Element.hideIf("reminder"+suffix)}else{Element.showIf("reminder"+suffix)}if(item.value.match(new RegExp("^"+currentUserId+"$"))){Element.hideIf("now_and")}else{Element.showIf("now_and")}}var ShowHide=Class.create();ShowHide.prototype={initialize:function(element,callbacks){this.element=element=$(element);this.effect=element.getAttribute("effect")||"slide";this.duration=parseFloat(element.getAttribute("duration"))||0.25;this.activeClassName=element.getAttribute("activeclassname")||"active";this.callbacks=callbacks;this.active=Element.visible(element);this.element.showHide=this},togglers:function(){return document.getElementsByClassName("show_hide_toggler_"+this.element.id)},toggle:function(){if(this.callbacks.beforeToggle){this.callbacks.beforeToggle(this)}Effect.toggle(this.element,this.effect,{duration:this.duration,afterFinish:function(effect){effect.element.firstChild.style.bottom="0px";(this.callbacks.afterToggle||Prototype.K)(this)}.bind(this)});this.active=!this.active;this.togglers().concat(this.element).each(this.adjustClassName.bind(this))},show:function(){if(this.active){return}this.toggle()},hide:function(){if(!this.active){return}this.toggle()},adjustClassName:function(element){Element[this.active?"addClassName":"removeClassName"](element,this.activeClassName)}};function closeKeepAlive(){if(/AppleWebKit|MSIE/.test(navigator.userAgent)){new Ajax.Request("/ping/close",{asynchronous:false})}}var Companies={newClientName:"",showCreateNewCompany:function(){$("new_company").show();$("existing_company").hide();$("new_client_name").setValue(Companies.newClientName);$("new_client_name").focus()},showSelectExistingCompany:function(){$("new_company").hide();$("existing_company").show();Companies.newClientName=$("new_client_name").getValue();$("new_client_name").setValue("")},localeChanged:function(){var locale=$F("company_locale");if(locale!="en"){$("company_language_selection").addClassName("not_english");$("i18n_beta_notice").show()}else{$("company_language_selection").removeClassName("not_english");$("i18n_beta_notice").hide()}}};document.observe("dom:loaded",function(){if($("company_language_selection")){Companies.localeChanged();$("company_locale").observe("change",Companies.localeChanged)}});Element.empty=function(id){return $(id).innerHTML.match(/^\s*$/)};Element.showIf=function(){for(var i=0;i<arguments.length;i++){var element=$(arguments[i]);if(element){Element.show(element)}}};Element.hideIf=function(){for(var i=0;i<arguments.length;i++){var element=$(arguments[i]);if(element){Element.hide(element)}}};Element.getY=function(element){if(element.y){return element.y}if(element.offsetTop||element.offsetParent){var y=element.offsetTop;while(element=element.offsetParent){y+=element.offsetTop}return y}return 0};Element.resizeTo=function(container,extra){container=$(container);var width=container.clientWidth||container.scrollWidth;width+=extra;if(width>0){for(var i=2;i<arguments.length;i++){$(arguments[i]).style.width=width+"px"}}};Element.activate=function(element,activate){element=$(element);var inactive_text=element["bc:inactive_text"];if(!inactive_text){element["bc:inactive_text"]=element.innerHTML;inactive_text=element.innerHTML}var active_text=element.getAttribute("bc:active_text")||element.innerHTML;var active_class=element.getAttribute("bc:active_class")||element.className;if(!activate){element.innerHTML=inactive_text;if(active_class){Element.removeClassName(element,active_class)}element["bc:active"]=false}else{element.innerHTML=active_text;if(active_class){Element.addClassName(element,active_class)}element["bc:active"]=true}};Effect.Zoom=Class.create();Effect.Zoom.prototype={initialize:function(from,to,duration,onFinish){this.target=$(to);this.initializeZoomer();var from=$(from);this.onFinish=onFinish;this.target.style.opacity=0;this.target.style.visibility="hidden";Element.show(this.target);this.startTop=this.getY(from);this.startLeft=this.getX(from);var endTop=this.getY(this.target);var endLeft=this.getX(this.target);this.steps=30*duration;this.dx=(endLeft-this.startLeft)/this.steps;this.dy=(endTop-this.startTop)/this.steps;this.currentStep=0;this.zoomer.style.display="block";this.zoom()},initializeZoomer:function(){this.zoomer=document.createElement("DIV");this.zoomer.id="zoomer";this.target.parentNode.appendChild(this.zoomer)},getX:function(element){if(element.x){return element.x}if(element.offsetLeft||element.offsetParent){var x=element.offsetLeft;while(element=element.offsetParent){x+=element.offsetLeft}return x}return 0},getY:function(element){return Element.getY(element)},zoom:function(){opacity=100-(100/this.steps)*this.currentStep;this.zoomer.style.filter="alpha(opacity="+opacity+")";this.zoomer.style.opacity=opacity/100;var pct=this.currentStep/this.steps;this.zoomer.style.top=this.startTop+this.dy*this.currentStep+"px";this.zoomer.style.left=this.startLeft+this.dx*this.currentStep+"px";this.zoomer.style.width=this.target.offsetWidth*pct+"px";this.zoomer.style.height=this.target.offsetHeight*pct+"px";this.currentStep++;if(this.currentStep<this.steps){setTimeout(this.zoom.bind(this),20)}else{Element.remove(this.zoomer);this.target.style.opacity=1;this.target.style.visibility="visible";if(this.onFinish){this.onFinish()}}}};Effect.ZoomOut=Class.create();Effect.ZoomOut.prototype={initialize:function(from,to,time){this.target=$(to);this.initializeZoomer();var from=$(from);this.startTop=this.getY(from);this.startLeft=this.getX(from);var endTop=this.getY(this.target);var endLeft=this.getX(this.target);this.startWidth=from.offsetWidth;this.startHeight=from.offsetHeight;var endWidth=this.target.offsetHeight;var endHeight=this.target.offsetHeight;this.steps=30*time;this.dx=(endLeft-this.startLeft)/this.steps;this.dy=(endTop-this.startTop)/this.steps;this.dh=(endHeight-this.startHeight)/this.steps;this.dw=(endWidth-this.startWidth)/this.steps;this.currentStep=0;this.zoomer.style.display="block";new Element.hide(from);this.zoom()},initializeZoomer:function(){this.zoomer=document.createElement("DIV");this.zoomer.id="zoomer";this.target.parentNode.appendChild(this.zoomer)},getX:function(element){if(element.x){return element.x}if(element.offsetLeft||element.offsetParent){var x=element.offsetLeft;while(element=element.offsetParent){x+=element.offsetLeft}return x}return 0},getY:function(element){return Element.getY(element)},zoom:function(){opacity=100-(100/this.steps)*this.currentStep;this.zoomer.style.filter="alpha(opacity="+opacity+")";this.zoomer.style.opacity=opacity/100;var pct=this.currentStep/this.steps;this.zoomer.style.top=this.startTop+this.dy*this.currentStep+"px";this.zoomer.style.left=this.startLeft+this.dx*this.currentStep+"px";this.zoomer.style.width=this.startWidth+this.dw*this.currentStep+"px";this.zoomer.style.height=this.startHeight+this.dh*this.currentStep+"px";this.currentStep++;if(this.currentStep<this.steps){setTimeout(this.zoom.bind(this),20)}else{Element.remove(this.zoomer)}}};Date.MONTHS=$w("January February March April May June July August September October November December");Date.CANONICAL_WEEKDAYS=$w("Sunday Monday Tuesday Wednesday Thursday Friday Saturday");Date.WEEKDAYS=Date.CANONICAL_WEEKDAYS;Date.weekStartsOn=0;Date.startWeekOn=function(day){if(day==Date.weekStartsOn){return}var list=[];for(var i=day;i<7;i++){list.push(Date.CANONICAL_WEEKDAYS[i])}for(var i=0;i<day;i++){list.push(Date.CANONICAL_WEEKDAYS[i])}Date.WEEKDAYS=list;Date.weekStartsOn=day};Object.extend(Date.prototype,{clone:function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate(),this.getHours(),this.getMinutes(),this.getSeconds(),this.getMilliseconds())},withoutTime:function(){return new Date(this.getFullYear(),this.getMonth(),this.getDate())},set:function(values){for(var key in values){this["set"+key.charAt(0).toUpperCase()+key.substring(1)](values[key])}return this},next:function(offset){offset=offset===undefined?1:offset;return this.clone().set({date:this.getDate()+offset})},previous:function(offset){offset=offset===undefined?1:offset;return this.next(-offset)},beginningOfWeek:function(){var adjustment=this.getDay()-Date.weekStartsOn;if(adjustment<0){adjustment+=7}return this.previous(adjustment)},beginningOfMonth:function(){return this.clone().set({date:1})},getMonthName:function(){return Date.MONTHS[this.getMonth()]},getDayName:function(){return Date.WEEKDAYS[this.getDay()]},isWeekend:function(){return(this.getDay()==0||this.getDay()==6)},equal:function(date){return this.getTime()==date.getTime()},toDateString:function(){return[this.getFullYear(),this.getMonth()+1,this.getDate()].invoke("toPaddedString",2).join("-")}});Date.prototype.succ=Date.prototype.next;var $D=function(date){if(!date){return $D(new Date())}else{if(date.constructor==Date){return date.withoutTime()}else{if(date.constructor==Array){return new Date(date[0],date[1]-1,date[2])}else{if(arguments.length==3){return $D.call(null,$A(arguments))}else{return $D.call(null,date.split("-"))}}}}};(function(){function handlePost(element){var url=element.readAttribute("href"),csrf_param=$$("meta[name=csrf-param]")[0],csrf_token=$$("meta[name=csrf-token]")[0];var form=new Element("form",{method:"POST",action:url,style:"display: none;"});element.parentNode.insert(form);if(csrf_param){var param=csrf_param.readAttribute("content"),token=csrf_token.readAttribute("content"),field=new Element("input",{type:"hidden",name:param,value:token});form.insert(field)}form.submit()}$(document).on("click","a[behavior~=undelete]",function(event,element){if(event.stopped){return}event.stop();var message=element.readAttribute("data-undelete-confirm");if(!message||confirm(message)){element.up().addClassName("busy");handlePost(element)}})})();(function(){var propertiesToCopy=$A(["fontSize","fontStyle","fontWeight","fontFamily","lineHeight"]);function valueDimensions(element,dimension){element=$(element);var dimensions,contents;var div=new Element("div");dimensions=$(element).getDimensions();if(dimension=="height"){div.setStyle({width:(dimensions.width-12)+"px"})}else{if(dimension=="width"){div.setStyle({height:(dimensions.height-12)+"px"})}}var styles={};propertiesToCopy.each(function(property){styles[property]=$(element).getStyle(property)});div.setStyle(styles);div.setStyle({position:"absolute",display:"none"});contents=element.getValue().replace(/\n/g,"<br>").replace(/</g,"&lt;").replace(/>/g,"&gt;");div.update(contents);$(document.body).insert(div);dimensions=div.getDimensions();div.remove();return dimensions[dimension]}var methods={valueDimensions:valueDimensions};Element.addMethods("INPUT",methods);Element.addMethods("TEXTAREA",methods)})();Effect.Transitions.easeInQuad=function(pos){return Math.pow(pos,2)};Effect.Transitions.easeOutQuad=function(pos){return -(Math.pow((pos-1),2)-1)};Effect.Transitions.easeInOutQuad=function(pos){if((pos/=0.5)<1){return 0.5*Math.pow(pos,2)}return -0.5*((pos-=2)*pos-2)};Effect.Transitions.easeInCubic=function(pos){return Math.pow(pos,3)};Effect.Transitions.easeOutCubic=function(pos){return(Math.pow((pos-1),3)+1)};Effect.Transitions.easeInOutCubic=function(pos){if((pos/=0.5)<1){return 0.5*Math.pow(pos,3)}return 0.5*(Math.pow((pos-2),3)+2)};Effect.Transitions.easeInQuart=function(pos){return Math.pow(pos,4)};Effect.Transitions.easeOutQuart=function(pos){return -(Math.pow((pos-1),4)-1)};Effect.Transitions.easeInOutQuart=function(pos){if((pos/=0.5)<1){return 0.5*Math.pow(pos,4)}return -0.5*((pos-=2)*Math.pow(pos,3)-2)};Effect.Transitions.easeInQuint=function(pos){return Math.pow(pos,5)};Effect.Transitions.easeOutQuint=function(pos){return(Math.pow((pos-1),5)+1)};Effect.Transitions.easeInOutQuint=function(pos){if((pos/=0.5)<1){return 0.5*Math.pow(pos,5)}return 0.5*(Math.pow((pos-2),5)+2)};Effect.Transitions.easeInSine=function(pos){return -Math.cos(pos*(Math.PI/2))+1};Effect.Transitions.easeOutSine=function(pos){return Math.sin(pos*(Math.PI/2))};Effect.Transitions.easeInOutSine=function(pos){return(-0.5*(Math.cos(Math.PI*pos)-1))};Effect.Transitions.easeInExpo=function(pos){return(pos==0)?0:Math.pow(2,10*(pos-1))};Effect.Transitions.easeOutExpo=function(pos){return(pos==1)?1:-Math.pow(2,-10*pos)+1};Effect.Transitions.easeInOutExpo=function(pos){if(pos==0){return 0}if(pos==1){return 1}if((pos/=0.5)<1){return 0.5*Math.pow(2,10*(pos-1))}return 0.5*(-Math.pow(2,-10*--pos)+2)};Effect.Transitions.easeInCirc=function(pos){return -(Math.sqrt(1-(pos*pos))-1)};Effect.Transitions.easeOutCirc=function(pos){return Math.sqrt(1-Math.pow((pos-1),2))};Effect.Transitions.easeInOutCirc=function(pos){if((pos/=0.5)<1){return -0.5*(Math.sqrt(1-pos*pos)-1)}return 0.5*(Math.sqrt(1-(pos-=2)*pos)+1)};Effect.Transitions.easeInBounce=function(pos){return 1};Effect.Transitions.easeOutBounce=function(pos){if((pos)<(1/2.75)){return(7.5625*pos*pos)}else{if(pos<(2/2.75)){return(7.5625*(pos-=(1.5/2.75))*pos+0.75)}else{if(pos<(2.5/2.75)){return(7.5625*(pos-=(2.25/2.75))*pos+0.9375)}else{return(7.5625*(pos-=(2.625/2.75))*pos+0.984375)}}}};Effect.Transitions.easeInOutBounce=function(pos){return 1};Effect.Transitions.easeInBack=function(pos){var s=1.70158;return(pos)*pos*((s+1)*pos-s)};Effect.Transitions.easeOutBack=function(pos){var s=1.70158;return(pos=pos-1)*pos*((s+1)*pos+s)+1};Effect.Transitions.easeInOutBack=function(pos){var s=1.70158;if((pos/=0.5)<1){return 0.5*(pos*pos*(((s*=(1.525))+1)*pos-s))}return 0.5*((pos-=2)*pos*(((s*=(1.525))+1)*pos+s)+2)};Effect.Transitions.easeInElastic=function(pos){return 1};Effect.Transitions.easeOutElastic=function(pos){return 1};Effect.Transitions.easeInOutElastic=function(pos){return 1};Object.extend(String.prototype,{ensureEndsWith:function(str){return this.endsWith(str)?this:this+str},px:function(){return this.ensureEndsWith("px")}});Object.extend(Number.prototype,{px:function(){return this.toString().px()}});var Window={size:function(){var width=window.innerWidth||(window.document.documentElement.clientWidth||window.document.body.clientWidth);var height=window.innerHeight||(window.document.documentElement.clientHeight||window.document.body.clientHeight);var x=window.pageXOffset||(window.document.documentElement.scrollLeft||window.document.body.scrollLeft);var y=window.pageYOffset||(window.document.documentElement.scrollTop||window.document.body.scrollTop);return{width:width,height:height,x:x,y:y}}};var FancyZoom={DOWNLOAD_IMAGE:"Download this image to your computer",window:function(){if(!FancyZoom._window){FancyZoom._window=new FancyZoom.Window()}return FancyZoom._window}};FancyZoom.Images=[];document.observe("dom:loaded",function(){if(FancyZoom.Images.any()){new FancyZoom.Preloader(FancyZoom.Images[0].project_id,FancyZoom.Images).start()}});FancyZoom.Preloader=Class.create({initialize:function(project_id,images){this.project_id=project_id;this.images=$A(images);this.ids=this.images.collect(function(img){return img.id})},start:function(callback){if(!this.ids.any()){return false}var preloader=this;new Ajax.Request("/projects/"+this.project_id+"/files/preload",{parameters:{ids:this.ids.join(",")},requestHeaders:{Accept:"application/json"},evalJSON:true,onSuccess:function(transport){transport.responseJSON.files.each(function(file){var img=preloader.images.find(function(img){return img.id==file.id});if(img){img.location=file.location;if(callback){callback(img)}}})}})}});FancyZoom.Image=Class.create({initialize:function(project_id,id,thumb,name){this.project_id=project_id;this.loaded=false;this.loading=false;this.id=id;this.thumb=$(thumb);this.spinner=this.thumb.select(".loading").first();FancyZoom.Images.push(this);this.showHandler=this.show.bind(this);this.thumb.observe("click",this.showHandler);this.zoom_image=new Element("img",{onclick:"FancyZoom.window().hide(Event.extend(event))"});this.zoom_image.onload=this.finishLoading.bind(this);this.zoom_image.name=name;this.thumb.observe("mouseover",this.preload.bind(this))},preload:function(){if(this.loaded||this.loading){return false}this.loaded=false;this.loading=true;if(this.location){this.zoom_image.src=this.location}else{var img=this;new FancyZoom.Preloader(this.project_id,[img]).start(function(){img.zoom_image.src=img.location})}},show:function(e){if(e.metaKey){return}e.stop();if(Prototype.Browser.IE){e=Object.extend({},e)}if(this.loaded){this.spinner.hide();if(!FancyZoom.window().visible()){FancyZoom.window().show(e)}}else{this.spinner.show();this.showHandler.delay(0.25,e)}},finishLoading:function(){this.createElements();this.loading=false;this.loaded=true},createElements:function(){FancyZoom.window();var d=Window.size();this.zoom_image.setStyle({maxHeight:(d.height-200).px(),maxWidth:(d.width-200).px(),height:"auto",width:"auto"});this.thumb.content_div=new Element("div");var label=new Element("div",{"class":"label"});label.update("<strong>"+this.zoom_image.name+'</strong><br /><a href="'+this.zoom_image.src+'" target="_blank">View full size in another window</a>');this.thumb.content_div.insert(this.zoom_image);this.thumb.content_div.insert(label);this.thumb.content_div.hide();this.thumb.up(".innercol").insert({top:this.thumb.content_div})}});FancyZoom.Window=Class.create({initialize:function(){this.zooming=false;this.createElements()},createElements:function(){var ie=navigator.userAgent.match(/MSIE\s(\d)+/);if(ie){var version=parseInt(ie[1]);Prototype.Browser["IE"+version.toString()]=true;Prototype.Browser.ltIE7=(version<7)?true:false}var html='<div id="zoom" style="display:none"><table id="zoom_table"><tbody><tr><td class="tl" /><td class="tm" /><td class="tr" /></tr><tr><td class="ml" style="" /><td class="mm" style=""><div id="zoom_content"></div></td><td class="mr" /></tr><tr><td class="bl" /><td class="bm" /><td class="br" /></tr></tbody></table><a href="#" title="Close" id="zoom_close"><img src="/images/zoom/closebox.png" alt="Close" /></a></div>';$$("body").first().insert(html);var box=this;this.zoom=$("zoom");this.zoom_table=$("zoom_table");this.zoom_close=$("zoom_close");this.zoom_content=$("zoom_content");this.zoom_close.observe("click",this.hide.bind(this));this.middle_row=$A([$$("td.ml"),$$("td.mm"),$$("td.mr")]).flatten();this.cells=this.zoom_table.select("td");this.shade=new DimZum.Shade({opacity:0.0001,zIndex:999});this.shade.element.observe("shade:clicked",this.hide.bind(this));$(document).observe("keyup",function(e){var zoom_display=box.zoom.getStyle("display");if(e.keyCode==Event.KEY_ESC&&zoom_display=="block"){box.hide(e)}});if(Prototype.Browser.ltIE7){this.switchBackgroundImagesTo("gif")}},visible:function(){return this.zoom.getStyle("display")=="block"},show:function(e){e.stop();if(this.zooming){return}this.zooming=true;var element=e.findElement("a");var related_div=element.content_div;var image=related_div.down("img");related_div.show();var innerWidth=image.getWidth();var innerHeight=related_div.getHeight();related_div.hide();var width=innerWidth+60;var height=innerHeight+60;var d=Window.size();var yOffset=document.viewport.getScrollOffsets()[1];var newTop=Math.max((d.height/2)-(height/2)+yOffset,0);var newLeft=(d.width/2)-(width/2);this.curTop=e.pointerY();this.curLeft=e.pointerX();this.moveX=-(this.curLeft-newLeft);this.moveY=-(this.curTop-newTop);this.zoom_content.setStyle({width:"",height:""});this.zoom.hide().setStyle({position:"absolute",top:this.curTop.px(),left:this.curLeft.px()});this.shade.show();var box=this;new Effect.Parallel([new Effect.Appear(this.zoom,{sync:true}),new Effect.Move(this.zoom,{x:this.moveX,y:this.moveY,sync:true}),new Effect.Morph(this.zoom_content,{style:{width:innerWidth.px(),height:innerHeight.px()},sync:true,beforeStart:function(effect){if(Prototype.Browser.IE){box.middle_row.invoke("setStyle",{height:(height-40).px()})}box.fixBackgroundsForIE()},afterFinish:function(effect){related_div.childElements().each(function(child){box.zoom_content.appendChild(child.cloneNode(true))});box.unfixBackgroundsForIE();box.zoom_close.show();box.zooming=false}})],{duration:0.5})},hide:function(e){e.stop();if(this.zooming){return}this.zooming=true;this.shade.hide();var box=this;new Effect.Parallel([new Effect.Move(this.zoom,{x:this.moveX*-1,y:this.moveY*-1,sync:true}),new Effect.Morph(this.zoom_content,{style:{width:"1".px(),height:"1".px()},sync:true,beforeStart:function(effect){box.fixBackgroundsForIE();box.zoom_content.innerHTML="";box.zoom_close.hide()},afterFinish:function(effect){box.unfixBackgroundsForIE();box.zooming=false}}),new Effect.Fade(this.zoom,{sync:true})],{duration:0.5})},switchBackgroundImagesTo:function(to){this.cells.each(function(td){var bg=td.getStyle("background-image").gsub(/\.(png|gif|none)\)$/,"."+to+")");td.setStyle("background-image: "+bg)});var close_img=this.zoom_close.firstDescendant();var new_img=close_img.readAttribute("src").gsub(/\.(png|gif|none)$/,"."+to);close_img.writeAttribute("src",new_img)},fixBackgroundsForIE:function(){if(Prototype.Browser.IE7){this.switchBackgroundImagesTo("gif")}},unfixBackgroundsForIE:function(){if(Prototype.Browser.IE7){this.switchBackgroundImagesTo("png")}}});var Files={getOutermostFileIDFrom:function(element){var id;while(element=$(element)){if(!Object.isElement(element)){break}var matches=(element.id||"").match(/^(?:edit_)?file-(\d+)$/);if(matches){id=matches[1]}element=element.parentNode}return id},replace:function(element,content){var id=this.getOutermostFileIDFrom(element);if(id){var show=$("file-"+id);var edit=$("edit_file-"+id);if(edit){edit.remove()}show.replace(content)}}};document.observe("dom:loaded",function(){if($(document.body).hasClassName("files")){function onAttachmentsChanged(event){var memo=event.memo,form=memo.form,element=form.element;var count=form.getAttachments().length;var button=element.down("input[type=submit]");if(count==0){element.addClassName("empty");button.disable()}else{element.removeClassName("empty");button.enable()}button.setValue(button.readAttribute((count>1)?"data-plural-label":"data-singular-label"))}document.observe("attachment:added",onAttachmentsChanged);document.observe("attachment:removed",onAttachmentsChanged);if($("attachment_metadata_template")){document.observe("attachment:added",function(event){var memo=event.memo,form=memo.form,id=memo.id;var metadataTemplate=new Template($("attachment_metadata_template").innerHTML);var attachmentControl=form.getAttachmentControl(id);attachmentControl.element.addClassName("privacy_container");attachmentControl.update(metadataTemplate.evaluate({id:id}));Category.Select.register(form.getAttachmentControl(id).element.down("select.category_select"))})}}});document.observe("dom:loaded",function(){document.cookie="flashVersion="+encodeURIComponent(FlashDetect.raw)+";path=/";if(FlashDetect.versionAtLeast(9)){$(document.body).addClassName("has_flash_support")}});$(document).on("change","input[type=radio][behavior~=highlight_label]",function(event,input){var form=input.form;form.select("input[name="+input.name+"]").each(function(i){form.down("label[for="+i.id+"]")[i.checked?"addClassName":"removeClassName"]("highlight")})});var I18n=Class.create();Object.extend(I18n,{translations:{},interpolatePattern:/\%\{([^}]+)\}/g,interpolate:function(str,obj){return str.replace(this.interpolatePattern,function(){return typeof obj[arguments[1]]=="undefined"?arguments[0]:obj[arguments[1]]})},translate:function(key,opts){opts=opts||{};var value=this.translations[key];if(typeof value!="string"&&value){value=this.pluralize(value,opts.count)}if(typeof value=="string"){value=this.interpolate(value,opts)}return value},pluralize:function(value,count){if(typeof count!="number"){return value}return count==1?value.one:value.other}});I18n.t=I18n.translate;Beanstalk.site_id=66;if($$("meta[name='current-user']").length>0){Beanstalk.uuid="bc/"+$$("meta[name='current-user']")[0].content+",id/"+$$("meta[name='current-identity']")[0].content+",qb/"+$$("meta[name='current-account']")[0].content}setInterval(Beanstalk.beacon.send,5000);if(navigator.userAgent.match(/MSIE 8.0/)){Beanstalk.beacon.enabled=false}var Layout={swapWithScreenBody:function(element_to_swap){element_to_swap=$(element_to_swap);var screen_body=$("screen_body");var from=element_to_swap.visible()?element_to_swap:screen_body;var to=element_to_swap.visible()?screen_body:element_to_swap;$("swap_from").appendChild(from);$("swap_to").appendChild(to);var field_to_preselect=to.down(".sheet_autofocus");from.hide();to.show();if(field_to_preselect){Field.activate.delay(0.25,field_to_preselect)}}};var Locations={check:function(response){var result=response.responseJSON;if(result.available||result.subdomain.blank()){$("subdomain_notice").hide()}else{var sanitized=result.subdomain.replace(/&/,"&amp;").replace(/</,"&lt");$("subdomain_notice").innerHTML='"'+sanitized+'" is not available. Please choose another URL.';$("subdomain_notice").show()}}};var Login={supportsLocalStorage:function(){try{return"localStorage" in window&&window.localStorage!==null}catch(e){return false}},getToken:function(name){if(Login.supportsLocalStorage()){var token=localStorage.getItem(name);if(token&&token.length>0){return token}}return null},clearPersistedTokens:function(){if(Login.supportsLocalStorage()){localStorage.removeItem("session_token");localStorage.removeItem("twisted_token")}},persistSessionToken:function(){if(Login.supportsLocalStorage()){var sessionToken=Cookie.get("session_token");var twistedToken=Cookie.get("twisted_token");if(sessionToken){localStorage.setItem("session_token",sessionToken)}if(twistedToken){localStorage.setItem("twisted_token",twistedToken)}}},recoverSessionToken:function(){var sessionToken=Login.getToken("session_token");var twistedToken=Login.getToken("twisted_token");if(sessionToken){Cookie.set("session_token",sessionToken)}if(twistedToken){Cookie.set("twisted_token",twistedToken)}return sessionToken&&twistedToken}};document.observe("dom:loaded",function(){if(!$(document.body).hasClassName("login")){Login.persistSessionToken()}});document.observe("dom:loaded",function(){if($(document.body).hasClassName("migration")){$$("[data-behavior~=slide]").first().appear({duration:0.5})}$$("[data-behavior~=slide_next]").each(function(button){button.observe("click",function(event){button.up("[data-behavior~=slide]").hide();button.up("[data-behavior~=slide]").next("[data-behavior~=slide]").appear({duration:0.5});Event.stop(event)})});$$("[data-behavior~=slide_prev]").each(function(button){button.observe("click",function(event){button.up("[data-behavior~=slide]").hide();button.up("[data-behavior~=slide]").previous("[data-behavior~=slide]").appear({duration:0.5});Event.stop(event)})});$$("[data-behavior~=slide_finish]").each(function(button){button.observe("click",function(event){button.up("[data-behavior~=slide]").hide();button.up("[data-behavior~=slide]").next("[data-behavior~=slide]").appear({duration:0.5})})})});document.observe("dom:loaded",function(){if($(document.body).hasClassName("milestones_add_many")){$(document.body).observe("calendar:dateSelected",function(event){var date=event.findElement(".calendar_date_select").previous("input").value;date=CalendarDate.parse(date);var element=event.findElement(".calendar_date_select");var container=element.up(".menu_container");var displayField=container.down(".due_date");var dateField=container.down(".due_date").next("input");container.fire("menu:deactivate");displayField.value=date.format(displayField.readAttribute("format"));dateField.value=date})}});function validateMilestones(){for(i=1;i<=10;i++){var title=$("milestone_"+i+"_title");var dateField=$("milestone_"+i+"_deadline");if(title.present()&&dateField.value.blank()){alert(dateField.readAttribute("data-invalid-message"));title.select();return false}}return true}function createMilestone(){$("new_milestone_spinner").show();$("new_milestone_controls").hide()}var MoveOperation=Class.create({initialize:function(container){this.container=$(container);this.menuContainer=this.container.down(".move_container.menu_container");this.menuContent=this.container.down(".move_menu.menu_content");this.wrapper=this.container.down(".wrapper");this.form=this.menuContent.down("form");this.attributes={};this.menuContainer.on("menu:deactivated",this.onMenuDeactivated.bind(this))},request:function(){this.transitionTo("progress");this.activeRequest=this.form.request({onSuccess:this.onResponseReceived.bind(this)})},poll:function(){this.activeRequest=new Ajax.Request(this.getURL(),{method:"get",onSuccess:this.onResponseReceived.bind(this)})},reset:function(){this.menuContainer.fire("menu:deactivate");this.stopPolling();if(this.activeRequest){this.activeRequest.transport.abort()}},onMenuDeactivated:function(event){this.makeMenuModeless();this.form.reset();this.transitionTo("move")},onResponseReceived:function(response){var oldAttributes=this.attributes;this.attributes=(response.responseJSON||{}).move_operation;var state=this.attributes.state;if(state!=oldAttributes.state){this["onState"+state.capitalize()]()}if(this.polling){this.poll.bind(this).delay(1)}this.activeRequest=false},onStatePending:function(){this.startPolling();this.makeMenuModal()},onStateProcessing:function(){},onStateFailed:function(){this.stopPolling();this.transitionTo("error")},onStateCompleted:function(){this.stopPolling();this.activeRequest=new Ajax.Request(this.getURL("completed"),{method:"get",parameters:{container_id:this.container.identify()},onComplete:(function(){this.makeMenuModeless();this.activeRequest=false}).bind(this)})},startPolling:function(){this.polling=true},stopPolling:function(){this.polling=false},transitionTo:function(state){this.wrapper.transition(function(wrapper){wrapper.childElements().each(function(element){if(element.hasClassName(state)){element.show()}else{element.hide()}})})},makeMenuModal:function(){this.menuContainer.addClassName("modal")},makeMenuModeless:function(){this.menuContainer.removeClassName("modal")},getURL:function(){var args=$A(arguments);return[this.form.action,this.attributes.id].concat(args).join("/")}});MoveOperation.submit=function(form){var container=$(form).up("[behavior~=move_operation_container]");new MoveOperation(container).request();return false};document.observe("dom:loaded",function(){if($(document.body).hasClassName("message_form")){$("message_form").autofocus();$("message_form").observe("form:beforesubmit",function(event){if(!validateField("post_title")){event.stop()}})}else{if($(document.body).hasClassName("commentable")){var commentForm=$("comment_form");commentForm.autofocus();commentForm.observe("form:beforesubmit",function(event){if(!validateField("comment_body")){event.stop()}});commentForm.observe("uploadPreference:changed",function(event){commentForm.down("div.link_to_toggle a").onclick()})}}});var msgs={beforeRemoveAttachment:function(id){Element.show("spin_"+id)},afterRemoveAttachment:function(id){new Effect.Fade("attachment_"+id,{duration:0.5,afterFinish:function(){Element.remove("attachment_"+id)}})},adjustTextarea:function(textarea,collapsed){var height=$(textarea).measure("height");if(height!=collapsed&&height!=2*collapsed){return}var lines=textarea.value.split("\n");var count=lines.length;lines.each(function(line){count+=parseInt(line.length/70)});var rows=parseInt(collapsed/20);if(count>rows){textarea.style.height=(collapsed*2)+"px"}if(count<=rows){textarea.style.height=collapsed+"px"}},commentEditCountdown:function(comment,cutoff){var diff=cutoff-new Date().getTime();if(isNaN(diff)||diff<=0){$(comment).down(".editable_until").hide()}else{var minutes=Math.round(diff/60000);$(comment).down(".editable_minutes").update(minutes);setTimeout(msgs.commentEditCountdown.curry(comment,cutoff),60000)}},submitter:{prepareComment:function(form){if(!validateField("comment_body")){return false}$("buttons","please_wait").invoke("toggle");msgs.submitter.fixAction(form);return true},fixAction:function(form){var needs_upload=false;$$("#attachment_fields input").each(function(field){if(field.value.match(/^\s*$/)==null){needs_upload=true}});if(!needs_upload){form.action=form.action.replace(/\/upload\//,"/")}},cancelPreview:function(){$("Preview").hide();$("post_form_container").show();$("preview_button").down().disabled=false;$("preview_button").show();$("edit_button").hide();$("post_body").focus()}},milestoner:{updateCompletionCheckboxVisibility:function(){var select=$("post_milestone_id");var completed=select.options[select.selectedIndex].text.startsWith("COMPLETED");if(select.selectedIndex==0||completed){$("completion_option").hide();$("completes_milestone").writeAttribute("disabled",true)}else{$("completion_option").show();$("completes_milestone").writeAttribute("disabled",false)}}}};var SelectionObserver=Class.create({initialize:function(region){this.region=$(region);this.boundMethods={};this.registerObservers();this.start()},start:function(){if(this.started){return}this.started=true},stop:function(){if(!this.started){return}this.started=false},bind:function(name){return this.boundMethods[name]||(this.boundMethods[name]=this[name].bind(this))},prepareSelection:function(selectable){this.deactivateSelection();this.pendingSelection=selectable;this.pendingSelection.fire("selection:prepared");this.pendingSelection.addClassName("selected")},cancelPendingSelection:function(){if(!this.pendingSelection){return}this.pendingSelection.removeClassName("selected");this.pendingSelection.fire("selection:canceled");delete this.pendingSelection},activatePendingSelection:function(memo){if(!this.pendingSelection){return}this.activeSelection=this.pendingSelection;this.activeSelection.fire("selection:activated",memo);this.activeSelection.addClassName("active_selection");delete this.pendingSelection},deactivateSelection:function(){if(!this.activeSelection){return}this.activeSelection.removeClassName("active_selection");this.activeSelection.removeClassName("selected");try{this.activeSelection.fire("selection:deactivated")}catch(e){}delete this.activeSelection},getPendingSelection:function(){return this.pendingSelection},getActiveSelection:function(){return this.activeSelection},findTargetFromElement:function(element){return element.trace("*[behavior~=selectable_target]")},findSelectableFromTarget:function(target){return target.trace("*[behavior~=selectable]")},findSelectableFromElement:function(element){var target=this.findTargetFromElement(element);if(target){return this.findSelectableFromTarget(target)}},elementBelongsToPendingSelection:function(element){if(this.pendingSelection){return this.findSelectableFromElement(element)==this.pendingSelection}},elementBelongsToActiveSelection:function(element){if(this.activeSelection){return this.findSelectableFromElement(element)==this.activeSelection}},handleEvent:function(eventName){this.region.observe(eventName.toLowerCase(),this.bind("on"+eventName))}});var HoverSelectionObserver=Class.create(SelectionObserver,{registerObservers:function(){this.handleEvent("MouseOver");this.handleEvent("MouseOut")},onMouseOver:function(event){var element=event.findElement();if(this.elementBelongsToActiveSelection(element)){this.cancelDelayedDeactivation()}else{var selectable=this.findSelectableFromElement(element);if(selectable){this.cancelDelayedDeactivation();this.prepareSelection(selectable);this.activatePendingSelection()}else{this.beginDelayedDeactivation()}}},onMouseOut:function(event){if(this.getActiveSelection()){this.beginDelayedDeactivation()}},beginDelayedDeactivation:function(){if(!this.delayedDeactivation){this.delayedDeactivation=this.bind("deactivateSelection").delay(HoverSelectionObserver.DEACTIVATION_DELAY)}},cancelDelayedDeactivation:function(){if(this.delayedDeactivation){window.clearTimeout(this.delayedDeactivation);delete this.delayedDeactivation}}});Object.extend(HoverSelectionObserver,{DEACTIVATION_DELAY:0.5});var TouchSelectionObserver=Class.create(SelectionObserver,{registerObservers:function(){this.handleEvent("TouchStart");this.handleEvent("TouchMove");this.handleEvent("TouchEnd")},onTouchStart:function(event){if(event.touches.length>1){this.cancelPendingSelection();return}var element=event.findElement();if(this.elementBelongsToActiveSelection(element)){return}var selectable=this.findSelectableFromElement(element);if(selectable){this.x=event.touches[0].pageX;this.y=event.touches[0].pageY;this.prepareSelection(selectable)}else{this.deactivateSelection()}},onTouchMove:function(event){this.cancelPendingSelection()},onTouchEnd:function(event){var element=event.findElement();if(this.elementBelongsToPendingSelection(element)){this.activatePendingSelection({offset:new Element.Offset(this.x,this.y)});event.stop()}else{this.cancelPendingSelection()}}});Object.extend(SelectionObserver,{create:function(region){if(Prototype.BrowserFeatures.Multitouch&&Prototype.Browser.Mobile){return new TouchSelectionObserver(region)}else{return new HoverSelectionObserver(region)}}});var Nubbins={buttonClicked:function(element){var nubbin=element.up(".nubbin");if(element.hasClassName("busy")){return}nubbin.on("ajax:before",function(){nubbin.addClassName("busy")});nubbin.on("ajax:complete",function(){window.selectionObserver.deactivateSelection();nubbin.removeClassName("busy")})}};document.on("dom:loaded",function(){window.selectionObserver=SelectionObserver.create(document.body);Draggables.addObserver({onStart:function(){selectionObserver.stop()},onEnd:function(){selectionObserver.start()}})});document.on("click","div.nubbin span.button > a",function(event,element){Nubbins.buttonClicked(element)});var Participants={setAll:function(company_id,change,confirm_message){if(confirm(confirm_message)){$$(".access_check_box_for_"+company_id).each(function(check_box){check_box.checked=(change=="grant"?"checked":"")});$("spinning_access_for_"+company_id).show();$("access_controls").submit()}},toggleRights:function(person_id,checkbox){new_value=checkbox.checked?"visible":"hidden";$("scheduling_checkbox_"+person_id).checked=checkbox.checked;this.permissionRadioButtonsFor(person_id).slice(1).each(function(radio_button_name){$(radio_button_name).style.visibility=new_value});this.updateBackgroundColorsFor(person_id,"scheduling");this.updateRights(person_id)},updateRights:function(person_id){var spinner=$("spinning_abilities_for_"+person_id);spinner.show();new Ajax.Request($("access_controls").action,{parameters:$("access_controls").serialize(),onComplete:function(){spinner.hide()}})},permissionRadioButtonsFor:function(person_id){return["scheduling_checkbox_","communication_","prioritizing_","scheduling_"].map(function(element){return element+person_id})},updateAbilitiesFor:function(person_id){this.updateBackgroundColorsFor(person_id);this.updateRights(person_id)},updateBackgroundColorsFor:function(person_id){var radio_button_names=this.permissionRadioButtonsFor(person_id);var selected_radio_button_name=radio_button_names.slice(1).detect(function(radio_button_name){return $(radio_button_name).getElementsByTagName("input")[0].checked});var current_radio_button_position=radio_button_names.indexOf(selected_radio_button_name);var results=radio_button_names.partition(function(radio_button_name){return current_radio_button_position>=radio_button_names.indexOf(radio_button_name)});var included=results.first(),excluded=results.last();included.each(function(radio_button_name){$(radio_button_name).removeClassName("disabled")});excluded.each(function(radio_button_name){$(radio_button_name).addClassName("disabled")})}};var PendingAttachments={add:function(file_selector,id){var offscreen=$(id).down("p.offscreen"),template=$(id).down("p.template");var templateHTML=template.innerHTML;if(template.down("input").name.match(/^\w+\[\d\]\[\w+\]$/)){var last_key=(offscreen.lastChild)?Number(offscreen.lastChild.name.match(/(\d+)/).last()):0;file_selector.name=file_selector.name.sub(/\d/,last_key+1)}this.updatePendingAttachments(id);offscreen.appendChild(file_selector);template.innerHTML=templateHTML},remove:function(path,id){this.removeFileSelector(path,id);this.updatePendingAttachments(id)},hasPendingAttachments:function(id){if($(id).down(".pending_attachments")){var pending_attachments=$(id).down(".pending_attachments").down();return pending_attachments&&pending_attachments.down()}else{return false}},hasExistingAttachments:function(id){if($(id).getElementsBySelector(".attachments li")){var existing_attachments=$(id).getElementsBySelector(".attachments li");return existing_attachments.detect(function(item){return item.visible()})}else{return false}},findFileSelector:function(path,id){return $(id).select("input.file_selectors").select(function(file_selector){return file_selector.value==decodeURIComponent(path)}).first()},removeFileSelector:function(path,id){this.findFileSelector(path,id).remove()},updatePendingAttachments:function(id){new Ajax.Request("/pending_attachments",{parameters:this.pendingFilesAsParameters(id)+"&id="+id})},pendingFilesAsParameters:function(id){return $(id).getElementsBySelector("input.file_selectors").select(function(file_selector){return file_selector.value!=""}).collect(function(file_selector){return"files[]="+encodeURIComponent(file_selector.value)}).join("&")}};People={toggleAccessibleCompanyProjects:function(company_id,checked){if(checked){$$(".accessible_projects_for_"+company_id).each(function(box){box.checked="checked"})}else{$$(".accessible_projects_for_"+company_id).each(function(box){box.checked=""})}},checkAllAccessibleProjects:function(){$$(".accessible_projects").each(function(box){box.checked="checked"})},uncheckAllAccessibleProjects:function(){$$(".accessible_projects").each(function(box){box.checked=""})}};document.observe("dom:loaded",function(){function toggle(element,className,classNameIsPresent){if(classNameIsPresent){element.addClassName(className)}else{element.removeClassName(className)}}$(document.body).observe("click",function(event){var element=event.findElement("input[type=checkbox].privacy_toggle");if(element){var privacyContainer,form=$(element.form);if(privacyContainer=element.up(".privacy_container")){toggle(privacyContainer,"private",element.checked);toggle(form,"private",form.select(".privacy_container").invoke("hasClassName","private").any())}else{toggle(form,"private",element.checked)}}})});var ProjectTemplates={previousSelectedIndex:0,toggle:function(){$$(".using_project_template").invoke("toggle")},useTemplate:function(){ProjectTemplates.toggle()},fromScratch:function(){ProjectTemplates.toggle();$("project_id").value=""},selected:function(templateSelect,nameInput){templateSelect=$(templateSelect),nameInput=$(nameInput);var name=nameInput.getValue();var previousSelectionName=templateSelect.options[this.previousSelectedIndex].text;if(name===previousSelectionName||name===""){if(templateSelect.selectedIndex==0){nameInput.setValue("")}else{var option=templateSelect.down("option[value="+$F(templateSelect)+"]");nameInput.setValue(option.text)}}this.previousSelectedIndex=templateSelect.selectedIndex}};document.on("form:submit","[behavior~=new_project_form]",function(event,form){var nameInput=$("new_project_name");if(nameInput.value.blank()){nameInput.value=nameInput.readAttribute("data-default-value")}form.down("[behavior~=go_back]").hide()});document.on("dom:loaded",function(){var highrisePeople=$(document.body).down("[behavior~=highrise_people]");if(!highrisePeople){return}var invitationBlock=highrisePeople.down("[behavior~=invitation_block]");highrisePeople.on("click","[behavior~=highrise_person]",function(event,person){if(event.element().match("input")){return}var input=person.down("input[type=checkbox]");input.checked=!input.checked;renderInvitationBlock()});highrisePeople.on("change","[behavior~=highrise_person]",function(event,person){renderInvitationBlock()});function renderInvitationBlock(){if(highrisePeople.down("input[checked]")){showInvitationBlock()}else{hideInvitationBlock()}}function showInvitationBlock(){if(!invitationBlock.visible()){invitationBlock.setStyle({opacity:"0"});new Effect.BlindDown(invitationBlock,{duration:0.3,afterFinish:function(){new Effect.Opacity(invitationBlock,{from:0,to:1,delay:0.05,duration:0.25,transition:Effect.Transitions.linear})}})}}function hideInvitationBlock(){if(invitationBlock.visible()){new Effect.Opacity(invitationBlock,{from:1,to:0,duration:0.25,transition:Effect.Transitions.linear,afterFinish:function(){new Effect.BlindUp(invitationBlock,{delay:0.05,duration:0.3})}})}}});document.on("dom:loaded",function(){var clientOptions=$(document.body).down("[behavior~=client_options]");if(!clientOptions){return}$(document.body).on("click","[behavior~=show_client_options]",showClientOptions);$(document.body).on("click","[behavior~=hide_client_options]",hideClientOptions);function showClientOptions(event,control){if(!clientOptions.visible()){clientOptions.setStyle({opacity:"0"});new Effect.SlideDown(clientOptions,{delay:0.05,duration:Math.max(0.2,clientOptions.measure("padding-box-height")/700),transition:Effect.Transitions.easeOutQuad,afterFinish:function(){new Effect.Opacity(clientOptions,{from:0,to:1,duration:0.2,transition:Effect.Transitions.linear,afterFinish:focusFirstClientOption()})}})}}function hideClientOptions(){if(clientOptions.visible()){new Effect.Opacity(clientOptions,{from:1,to:0,duration:0.2,transition:Effect.Transitions.linear,afterFinish:function(){new Effect.SlideUp(clientOptions,{delay:0.05,duration:Math.max(0.2,clientOptions.measure("padding-box-height")/700),transition:Effect.Transitions.easeOutQuad})}})}}function focusFirstClientOption(){[$("existing_company"),$("new_company")].detect(function(el){return el.visible()}).down("select,input").focus()}});(function(){Ajax.Responders.register({onCreate:function(request){var token=$$("meta[name=csrf-token]")[0];if(token){if(!request.options.requestHeaders){request.options.requestHeaders={}}request.options.requestHeaders["X-CSRF-Token"]=token.readAttribute("content")}}});function isEventSupported(eventName){var el=document.createElement("div");eventName="on"+eventName;var isSupported=(eventName in el);if(!isSupported){el.setAttribute(eventName,"return;");isSupported=typeof el[eventName]=="function"}el=null;return isSupported}function isForm(element){return Object.isElement(element)&&element.nodeName.toUpperCase()=="FORM"}function isInput(element){if(Object.isElement(element)){var name=element.nodeName.toUpperCase();return name=="INPUT"||name=="SELECT"||name=="TEXTAREA"}else{return false}}var submitBubbles=isEventSupported("submit"),changeBubbles=isEventSupported("change");if(!submitBubbles||!changeBubbles){Event.Handler.prototype.initialize=Event.Handler.prototype.initialize.wrap(function(init,element,eventName,selector,callback){init(element,eventName,selector,callback);if((!submitBubbles&&this.eventName=="submit"&&!isForm(this.element))||(!changeBubbles&&this.eventName=="change"&&!isInput(this.element))){this.eventName="emulated:"+this.eventName}})}if(!submitBubbles){document.on("focusin","form",function(focusEvent,form){if(!form.retrieve("emulated:submit")){form.on("submit",function(submitEvent){var emulated=form.fire("emulated:submit",submitEvent,true);if(emulated.returnValue===false){submitEvent.preventDefault()}});form.store("emulated:submit",true)}})}if(!changeBubbles){document.on("focusin","input, select, textarea",function(focusEvent,input){if(!input.retrieve("emulated:change")){input.on("change",function(changeEvent){input.fire("emulated:change",changeEvent,true)});input.store("emulated:change",true)}})}function handleRemote(element){var method,url,params;var event=element.fire("ajax:before");if(event.stopped){return false}if(element.tagName.toLowerCase()==="form"){method=element.readAttribute("method")||"post";url=element.readAttribute("action");params=element.serialize({submit:element.retrieve("rails:submit-button")});element.store("rails:submit-button",null)}else{method=element.readAttribute("data-method")||"get";url=element.readAttribute("href");params={}}new Ajax.Request(url,{method:method,parameters:params,evalScripts:true,onCreate:function(response){element.fire("ajax:create",response)},onComplete:function(response){element.fire("ajax:complete",response)},onSuccess:function(response){element.fire("ajax:success",response)},onFailure:function(response){element.fire("ajax:failure",response)}});element.fire("ajax:after")}function insertHiddenField(form,name,value){form.insert(new Element("input",{type:"hidden",name:name,value:value}))}function handleMethod(element){var method=element.readAttribute("data-method"),url=element.readAttribute("href"),csrf_param=$$("meta[name=csrf-param]")[0],csrf_token=$$("meta[name=csrf-token]")[0];var form=new Element("form",{method:"POST",action:url,style:"display: none;"});$(element.parentNode).insert(form);if(method!=="post"){insertHiddenField(form,"_method",method)}if(csrf_param){insertHiddenField(form,csrf_param.readAttribute("content"),csrf_token.readAttribute("content"))}form.submit()}function disableFormElements(form){form.select("input[type=submit][data-disable-with]").each(function(input){input.store("rails:original-value",input.getValue());input.setValue(input.readAttribute("data-disable-with")).disable()})}function enableFormElements(form){form.select("input[type=submit][data-disable-with]").each(function(input){input.setValue(input.retrieve("rails:original-value")).enable()})}function allowAction(element){var message=element.readAttribute("data-confirm");return !message||confirm(message)}document.on("click","a[data-confirm], a[data-remote], a[data-method]",function(event,link){if(!allowAction(link)){event.stop();return false}if(link.readAttribute("data-remote")){handleRemote(link);event.stop()}else{if(link.readAttribute("data-method")){handleMethod(link);event.stop()}}});document.on("click","form input[type=submit], form button[type=submit], form button:not([type])",function(event,button){event.findElement("form").store("rails:submit-button",button.name||false)});document.on("submit",function(event){var form=event.findElement();if(!allowAction(form)){event.stop();return false}if(form.readAttribute("data-remote")){handleRemote(form);event.stop()}else{disableFormElements(form)}});document.on("ajax:create","form",function(event,form){if(form==event.findElement()){disableFormElements(form)}});document.on("ajax:complete","form",function(event,form){if(form==event.findElement()){enableFormElements(form)}})})();Search={setScope:function(scope,search_terms){$("scope").value=scope;$("scope").form.submit()}};var CustomLogo={showForm:function(which){$("logos_current").down("tr.details").hide();$("logos_current").down("tr.arrows td."+which+" img").show();$("upload_image_"+which).show()},hideForm:function(which){$("logos_current").down("tr.details").show();$("logos_current").down("tr.arrows td."+which+" img").hide();$("upload_image_"+which).hide()}};$(document).on("dom:loaded",function(){if($$("[behavior~=new_todo_template_item_field]").length===0){return}$(document).on("keydown","[behavior~=new_todo_template_item_field]",function(event,input){if(event.keyCode===Event.KEY_RETURN){event.stop();input.up("form").onsubmit()}})});function isNotifiable(me,value){return value!=me&&/^\d+$/.test(value)}function setNotifyVisible(list,me,id){text=$("item_"+id+"_content");if(!list){list=$("responsible_parties_"+id)}selected=list.options[list.selectedIndex].value;selected_is_valid=isNotifiable(me,selected);original_is_valid=false;if(text){original=list.options[eval("original_"+id)].value;original_is_valid=isNotifiable(me,original)}visible=original_is_valid?(original!=selected&&selected_is_valid):selected_is_valid;if(selected_is_valid&&!visible){visible=(text?(text.defaultValue!=text.value):false)}if(text){visible=visible&&!/^\s*$/.test(text.value)}span=$("notify_"+id);if(span){span.style.display=(visible?"inline":"none")}delete_span=$("delete_"+id);if(delete_span){delete_span.style.display=(visible?"none":"inline")}}var Hover={EXIT_DELAY:600,lastTimer:null,lastCommand:null,inhibit:false,clearCurrent:function(){if(!this.lastTimer){return}clearTimeout(this.lastTimer);eval(this.lastCommand);this.lastTimer=this.lastCommand=null},endWith:function(command){if(this.inhibit){return}this.lastCommand=command;this.lastTimer=setTimeout(command,this.EXIT_DELAY)},toggle:function(on,container,nubbin){if(this.inhibit){return}if(on){if($(container)){$(container).addClassName("highlighted")}Element.showIf(nubbin)}else{if($(container)){$(container).removeClassName("highlighted")}Element.hideIf(nubbin)}}};var lists={hover:{begin:function(id){Hover.clearCurrent();Hover.toggle(true,"list_head_"+id,"nubbin_list_"+id)},end:function(id,delay){if(delay){Hover.endWith("lists.hover.end("+id+")")}else{Hover.toggle(false,"list_head_"+id,"nubbin_list_"+id)}}},editor:{toggle:function(id,errorMessage){var div=$("edit_list_"+id+"_title");if(!div.populated){Element.show("list_spinner_"+id);new Ajax.Updater({success:div},todos.list_edit_url,{asynchronous:true,parameters:"id="+id,onComplete:function(request){Element.hide("list_spinner_"+id);if(request.status==200){div.populated=true;lists.editor.toggle(id,errorMessage)}else{alert(errorMessage)}}})}else{lists.hover.end(id,false);$(div,"list_head_"+id,"list_body_"+id).invoke("toggle");Hover.inhibit=Element.visible(div)}},active:function(id){return Element.visible("edit_list_"+id+"_title")}},save:{before:function(id){Element.show("update_list_"+id)},failure:function(request,id,errorMessage){Element.hide("update_list_"+id);alert(errorMessage)}},deleter:{before:function(id){Element.show("list_spinner_"+id)},failure:function(request,id,errorMessage){Element.hide("list_spinner_"+id);alert(errorMessage)}},reorder:{toggle:function(){var link=$("lists_reorder_link");Element.activate(link,!link["bc:active"]);if(link["bc:active"]){Hover.clearCurrent();this.makeDraggableLists();Element.hide("new_list_link");Element.hide("new_reorder_separator")}else{Element.show("new_list_link");this.setSeparatorVisibility()}Hover.inhibit=link["bc:active"];$$("#lists div.list").each(function(list){var id=todos.idOf(list);Element.toggle("list_body_"+id);if($("drag_list_"+id)){Element.toggle("drag_list_"+id)}if($("privatebug_"+id)){Element.toggle("privatebug_"+id)}if($("list_desc_"+id)){Element.toggle($("list_desc_"+id))}if($("list_controls_"+id)){Element.toggle($("list_controls_"+id))}if(lists.editor.active(id)){lists.editor.toggle(id)}})},makeDraggableLists:function(id){Sortable.create($("lists"),{tag:"div",handle:"drag_list"});todos.installDragObserver()},setSeparatorVisibility:function(){if(todos.uncompletedListsCount()<2){Element.hideIf("new_reorder_separator")}else{Element.showIf("new_reorder_separator")}},setLinkVisibility:function(){if(todos.uncompletedListsCount()<2){Element.hideIf("lists_reorder_link")}else{Element.showIf("lists_reorder_link")}}},creator:{toggle:function(){var link=$("new_list_link");Element.activate(link,!link["bc:active"]);if(link["bc:active"]){$("new_list_name").value="";$("description").value="";if($("template_id")){$("template_id").selectedIndex=0}Element.hideIf("lists_reorder_link","new_reorder_separator");if(this.templateListVisible()){this.toggleTitleOrTemplate()}Element.hideIf("blankslate");new Effect.BlindDown("new_list",{duration:0.2,afterFinish:function(){Field.focus("new_list_name")}})}else{new Effect.BlindUp("new_list",{duration:0.2});lists.reorder.setLinkVisibility();lists.reorder.setSeparatorVisibility();if(todos.uncompletedListsCount()<1){Element.showIf("blankslate")}}},templateListVisible:function(){return $("template_id")&&$("template_id").style.display!="none"},toggleTitleOrTemplate:function(){var span=$("title_or_template");if(span.style.display=="none"){$(span,"new_list_name","new_list_description").invoke("show");$("template_or_title","template_id").invoke("hide");$("use_template").value="0"}else{$(span,"new_list_name","new_list_description").invoke("hide");$("template_or_title","template_id").invoke("show");$("use_template").value="1"}$("new_list").style.height="";$("new_list").style.paddingBottom="10px"},validate:function(){var use_template=$("use_template");if(use_template&&use_template.value=="1"){if($("template_id").selectedIndex==0){alert("You must select a template first.");return false}}else{if(!Field.present("new_list_name")){alert("You must enter a name for the list.");return false}}return true},before:function(){Element.show("new_list_spinner")},failure:function(request,url,errorMessage){Element.hide("new_list_spinner");alert(errorMessage)}}};var todos={hover:{begin:function(id){Hover.clearCurrent();Hover.toggle(true,"show_item_"+id,"nubbin_item_"+id)},end:function(id,delay){if(delay){Hover.endWith("todos.hover.end("+id+")")}else{Hover.toggle(false,"show_item_"+id,"nubbin_item_"+id)}}},reorder:{toggle:function(id){if($("completed_items_"+id)){Element.toggle("completed_items_"+id)}var link=$("reorder_list_"+id+"_link");Element.activate(link,!link["bc:active"]);if(link["bc:active"]){todos.makeDraggable(id);lists.hover.end(id,false)}Hover.inhibit=link["bc:active"];todos.childrenOf("uncompleted_items_list_"+id,"li",function(item){var id=todos.idOf(item);Element.toggle("check_box_for_item_"+id);if($("drag_"+id)){Element.toggle("drag_"+id)}});todos.toggleAddItemLink(id)}},toggleAddItemLink:function(id){if($("add_item_"+id)){Element.toggle("add_item_"+id)}},toggleEditItem:function(id,errorMessage){var div=$("edit_item_"+id);if(!div.populated){Element.show("ucspin_"+id);new Ajax.Updater({success:div},this.item_edit_url,{asynchronous:true,parameters:"id="+id,onComplete:function(request){Element.hide("ucspin_"+id);if(request.status==200){div.populated=true;todos.toggleEditItem(id)}else{alert(errorMessage)}}})}else{$("show_item_"+id,"edit_item_"+id).invoke("toggle");$("edit_item_"+id).autofocus()}},toggleAddItem:function(id){$("new_content_"+id).value="";$("add_item_to_list_"+id,"add_item_"+id+"_link").invoke("toggle");if($("add_item_to_list_"+id).style.display!="none"){Field.focus("new_content_"+id)}},onAddItem:function(id){Element.addClassName("add_item_"+id,"busy");Element.show("add_item_spinner_"+id)},onAddedItemFailed:function(request,id,errorMessage){Element.hide("add_item_spinner_"+id);Element.removeClassName("add_item_"+id,"busy");alert(errorMessage)},onDeleteItem:function(id,list,wantsConfirmation,deleteConfirmation,errorMessage){var allow=!wantsConfirmation||confirm(deleteConfirmation);if(allow){Element.showIf("ucspin_"+id,"cspin_"+id);new Ajax.Request(this.item_delete_url,{asynchronous:true,evalScripts:true,parameters:"id="+id,onFailure:function(request){Element.hideIf("ucspin_"+id,"cspin_"+id);alert(errorMessage)}})}},onEditItem:function(id,list,form,errorMessage){if(Field.present("item_content_"+id)){Element.show("saving_item_"+id);new Ajax.Request(this.item_update_url,{asynchronous:true,evalScripts:true,parameters:Form.serialize(form)+"&id="+id,onFailure:function(request){Element.hide("saving_item_"+id);alert(errorMessage)}})}},setListControlVisibility:function(id){if(this.accessibleUncompletedCount(id)<1){Element.hide("list_controls_"+id)}else{Element.show("list_controls_"+id)}},setReorderLinkVisibility:function(id){if(this.uncompletedCount(id)<2){Element.hideIf("reorder_list_"+id+"_link")}else{Element.showIf("reorder_list_"+id+"_link")}this.setListControlVisibility(id)},makeDraggable:function(id){Sortable.create($("uncompleted_items_list_"+id),{handle:"drag_item"});this.installDragObserver()},installDragObserver:function(){if(!this.observer_installed){this.observer_installed=true;Draggables.addObserver({onStart:function(name,draggable,event){},onEnd:function(name,draggable,event){var element=draggable.element;var siblings=todos.siblingsOf(element);var position=siblings.indexOf(element)+1;var parms="id="+todos.idOf(element)+"&to="+position+"&only_active=1";new Ajax.Request(element.tagName=="LI"?todos.item_reorder_url:todos.list_reorder_url,{parameters:parms,asynchronous:true})}})}},idOf:function(element){return element?element.id.split("_")[1]:""},siblingsOf:function(element){return $A(element.parentNode.childNodes).select(function(sibling){return sibling.tagName==element.tagName})},accessibleUncompletedCount:function(id){var count=0;this.childrenOf("uncompleted_items_list_"+id,"li",function(item){var id=todos.idOf(item);if($("drag_"+id)){count+=1}});return count},uncompletedCount:function(id){return this.childrenOf("uncompleted_items_list_"+id,"li").length},uncompletedListsCount:function(){return this.childrenOf("lists","div").length},reordering:function(id){return $("reorder_list_"+id+"_link").innerHTML!="Reorder"},childrenOf:function(element,tag,callback){var nodes=$(element).childNodes;var result;if(!callback){result=new Array()}tag=tag.toUpperCase();for(var i=0;i<nodes.length;i++){if(nodes[i].tagName&&nodes[i].tagName==tag){if(callback){callback(nodes[i])}else{result.push(nodes[i])}}}if(!callback){return result}},zzz_placeholder:false};(function(){this.templates||(this.templates={});this.templates._event_date_wrapper=function(__obj){if(!__obj){__obj={}}var __out=[],__capture=function(callback){var out=__out,result;__out=[];callback.call(this);result=__out.join("");__out=out;return __safe(result)},__sanitize=function(value){if(value&&value.ecoSafe){return value}else{if(typeof value!=="undefined"&&value!=null){return __escape(value)}else{return""}}},__safe,__objSafe=__obj.safe,__escape=__obj.escape;__safe=__obj.safe=function(value){if(value&&value.ecoSafe){return value}else{if(!(typeof value!=="undefined"&&value!=null)){value=""}var result=new String(value);result.ecoSafe=true;return result}};if(!__escape){__escape=__obj.escape=function(value){return(""+value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){__out.push('<div class="event_date_wrapper">\n  <input class="event_date small display_field" data-format="');__out.push(I18n.t("date.formats.medium_js"));__out.push('" readonly="readonly" type="text" tabindex="2" value=\'');__out.push(__sanitize(this.human_date));__out.push('\'/>\n  <input class="event_date small value_field" type="hidden" name="" size="26" value="');__out.push(__sanitize(this.date));__out.push('" data-original-value="');__out.push(__sanitize(this.date));__out.push('" />\n\n  <div class="due_pop_wrapper" style="display:none;">\n    <div class="liner">\n\n      <span class="due_pop">\n        <input name="calendar_entry[');__out.push(__sanitize(this.name));__out.push(']" type="hidden" value="');__out.push(__sanitize(this.date));__out.push('" class=\'calendar_date_select_input\'/>\n        <span class="no_date_link"></span>\n      </span>\n    </div>\n  </div>\n</div>\n')}).call(this)}).call(__obj);__obj.safe=__objSafe,__obj.escape=__escape;return __out.join("")}}).call(this);(function(){this.templates||(this.templates={});this.templates._long_entry=function(__obj){if(!__obj){__obj={}}var __out=[],__capture=function(callback){var out=__out,result;__out=[];callback.call(this);result=__out.join("");__out=out;return __safe(result)},__sanitize=function(value){if(value&&value.ecoSafe){return value}else{if(typeof value!=="undefined"&&value!=null){return __escape(value)}else{return""}}},__safe,__objSafe=__obj.safe,__escape=__obj.escape;__safe=__obj.safe=function(value){if(value&&value.ecoSafe){return value}else{if(!(typeof value!=="undefined"&&value!=null)){value=""}var result=new String(value);result.ecoSafe=true;return result}};if(!__escape){__escape=__obj.escape=function(value){return(""+value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){var comments_bubble;__out.push("<div class='event ");__out.push(__sanitize(this.entry.get("status")));__out.push(" ");__out.push(__sanitize(this.entry.get("entry_class")));__out.push(" ");__out.push(__sanitize(this.entry.get("event_type")));__out.push(" menu_container calendar_entry_container ");__out.push(__sanitize(this.options.entry_classes));__out.push("' data-edit-path=\"");__out.push(__sanitize(this.entry.editPath()));__out.push('" data-entry-id="');__out.push(__sanitize(this.entry.get("id")));__out.push("\" data-menu-date='");__out.push(__sanitize((this.options.menuDate||this.entry.get("date")).toString()));__out.push("'>\n  <div class='item'>\n\n    <div class=\"item_wrapper\">\n\n      ");if(this.entry.get("entry_class")==="milestone"){__out.push("\n        ");if(this.entry.isCompletable()){__out.push('\n          <input type="checkbox" class="milestone_status_checkbox" ');if(this.entry.get("status")==="complete"){__out.push("checked='checked'")}__out.push(" />\n        ")}else{__out.push('\n          <input type="checkbox" class="milestone_status_checkbox" disabled="disabled" ');if(this.entry.get("status")==="complete"){__out.push("checked='checked'")}__out.push(" />\n        ")}__out.push("\n      ")}__out.push('\n\n      <div class="event_label_wrapper menu_target commentable">\n        ');if(this.options.spanned){__out.push('\n          <table border="0" cellspacing="0" cellpadding="0" class="spanned_event">\n            <tr>\n              <td class="spanned_event_label">\n                <span class="event_label">\n                  <a class="entry_title calendar_entry_menu_target" data-details-path="');__out.push(__sanitize(this.entry.detailsPath()));__out.push('" title="');__out.push(__sanitize(Calendar.scope==="global"?"Project: "+this.entry.get("project_name"):this.entry.get("title")));__out.push('">\n                    ');__out.push(__sanitize(this.entry.get("title")));__out.push('\n                  </a>\n\n                  <span class="entry_meta">\n                    ');if(this.entry.get("responsible_party_familiar_name")){__out.push("\n                      - ");__out.push(__sanitize(this.entry.get("responsible_party_familiar_name")));__out.push("\n                    ")}__out.push("\n\n                    ");__out.push(__sanitize(this.entry.get("due_time")));__out.push("\n                  </span>\n                </span>\n              </td>\n              <td>\n                ");comments_bubble=this.entry.get("comments_bubble");__out.push("\n                ");if(comments_bubble){__out.push("\n                  <span class='comments_target'>");__out.push(comments_bubble);__out.push("</span>\n                ")}__out.push("\n              </td>\n            </tr>\n          </table>\n        ")}else{__out.push('\n          <span class="event_label">\n            <span class="bullet">&bull;</span><a class="entry_title calendar_entry_menu_target" data-details-path="');__out.push(__sanitize(this.entry.detailsPath()));__out.push('" title="');__out.push(__sanitize(Calendar.scope==="global"?"Project: "+this.entry.get("project_name"):this.entry.get("title")));__out.push('">\n              ');__out.push(__sanitize(this.entry.get("title")));__out.push('\n            </a>\n\n            <span class="entry_meta">\n              ');if(this.entry.get("responsible_party_familiar_name")){__out.push("\n                - ");__out.push(__sanitize(this.entry.get("responsible_party_familiar_name")));__out.push("\n              ")}__out.push("\n\n              ");__out.push(__sanitize(this.entry.get("due_time")));__out.push("\n            </span>\n          </span>\n\n          ");comments_bubble=this.entry.get("comments_bubble");__out.push("\n          ");if(comments_bubble){__out.push("\n            <span class='comments_target'>");__out.push(comments_bubble);__out.push("</span>\n          ")}__out.push("\n        ")}__out.push("\n      </div>\n\n    </div>\n\n    ");__out.push(templates.edit_balloon({entry:this.entry,balloon_class:this.options.daynum>=4?"top_right":"top_left"}));__out.push("\n  </div>\n</div>\n")}).call(this)}).call(__obj);__obj.safe=__objSafe,__obj.escape=__escape;return __out.join("")}}).call(this);(function(){this.templates||(this.templates={});this.templates.calendar=function(__obj){if(!__obj){__obj={}}var __out=[],__capture=function(callback){var out=__out,result;__out=[];callback.call(this);result=__out.join("");__out=out;return __safe(result)},__sanitize=function(value){if(value&&value.ecoSafe){return value}else{if(typeof value!=="undefined"&&value!=null){return __escape(value)}else{return""}}},__safe,__objSafe=__obj.safe,__escape=__obj.escape;__safe=__obj.safe=function(value){if(value&&value.ecoSafe){return value}else{if(!(typeof value!=="undefined"&&value!=null)){value=""}var result=new String(value);result.ecoSafe=true;return result}};if(!__escape){__escape=__obj.escape=function(value){return(""+value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){var current_date,current_entry,daynum,em_size,entry_map,index,invisible,max_index,regular_entries,regular_entry,regular_entry_collection,week_start_date,weeknum,_i,_j,_len,_len2,_ref,_ref2,_ref3;for(weeknum=0,_ref=this.week_count-1;0<=_ref?weeknum<=_ref:weeknum>=_ref;0<=_ref?weeknum++:weeknum--){__out.push("\n\n  ");week_start_date=this.start_date.next(weeknum*7);__out.push("\n  ");entry_map=this.spannedEntryMapForWeek(week_start_date);__out.push('\n\n  <div class="month_row_spanned_position" style="z-index:');__out.push(__sanitize(this.week_count-weeknum));__out.push('">\n    <div class="month_row_spanned">\n      ');max_index=entry_map.max(function(m){return m.size()});__out.push("\n      ");if(max_index>0){__out.push("\n        ");for(index=0,_ref2=max_index-1;0<=_ref2?index<=_ref2:index>=_ref2;0<=_ref2?index++:index--){__out.push("\n\n          ");for(daynum=0;daynum<=6;daynum++){__out.push("\n            ");current_date=this.start_date.next((weeknum*7)+daynum);__out.push("\n            ");current_entry=entry_map[daynum][index];__out.push("\n            ");if(current_entry){__out.push("\n              ");if(current_entry!=="skip"){__out.push('\n                <div class="event_position span_');__out.push(__sanitize(current_entry[1]));__out.push(" push_");__out.push(__sanitize(daynum));__out.push('" style="top:');__out.push(__sanitize(index*18));__out.push("px;z-index:");__out.push(__sanitize(200-index));__out.push('">\n                  ');__out.push(this.renderEntry(current_entry[0],{entry_classes:this.getSpannedEntryClasses(current_entry[0],week_start_date,current_date),menuDate:current_date,daynum:daynum,spanned:true}));__out.push("\n                </div>\n              ")}__out.push("\n            ")}__out.push("\n          ")}__out.push("\n\n        ")}__out.push("\n      ")}__out.push('\n    </div>\n  </div>\n  \n  <div class="month_row">\n    <table class="month_row_events" border="0" cellspacing="0" cellpadding="0">\n      <tr>\n        ');for(daynum=0;daynum<=6;daynum++){__out.push("\n          ");current_date=this.start_date.next((weeknum*7)+daynum);__out.push('\n\n          <td class="');__out.push(__sanitize(this.getCurrentDateClass(current_date)));__out.push(" load_new_entry_on_click\" data-date='");__out.push(__sanitize(current_date.toString()));__out.push("'>\n            <div class='new_entry_form_container ");__out.push(__sanitize(this.getCurrentDateClass(current_date)));__out.push("' data-daynum='");__out.push(__sanitize(daynum));__out.push("' data-date='");__out.push(__sanitize(current_date.toString()));__out.push("' >\n              <div class='menu_container new_entry_form_menu_container' data-menu-date='");__out.push(__sanitize(current_date.toString()));__out.push("'>\n                <div class='menu_target new_entry_form_menu_target'></div>\n\n                <div class=\"balloon menu_content ");__out.push(daynum>=4?"right":"left");__out.push('" style="display: none;">\n                  <div class="balloon_wrapper">\n                    <div class="balloon_pointer">\n                      <div class="balloon_arrow"></div>\n                      <div class="balloon_arrow_border"></div>\n                    </div>\n\n                    <div class="balloon_content">\n                      <div class=\'form_wrapper\'></div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n\n            <div class="date_label load_new_entry_on_click" data-date=\'');__out.push(__sanitize(current_date.toString()));__out.push("'>\n              ");if(current_date.value===this.today.value){__out.push('\n                <span class="day"><strong>');__out.push(__sanitize(this.today_label));__out.push(" ");__out.push(__sanitize(current_date.day));__out.push("</strong></span>\n              ")}else{__out.push('\n                <span class="day">\n                  ');if(current_date.day===1){__out.push("\n                    <strong>");__out.push(__sanitize(current_date.getAbbreviatedMonthName()));__out.push(" ");__out.push(__sanitize(current_date.day));__out.push("</strong>\n                  ")}else{__out.push("\n                    ");__out.push(__sanitize(current_date.day));__out.push("\n                  ")}__out.push("\n                </span>\n              ")}__out.push("\n            </div>\n\n            ");em_size=entry_map[daynum].size();__out.push("\n            ");if(em_size>0){__out.push("\n              ");for(invisible=1;1<=em_size?invisible<=em_size:invisible>=em_size;1<=em_size?invisible++:invisible--){__out.push('\n                <div class="event invisible load_new_entry_on_click" data-date=\'');__out.push(__sanitize(current_date.toString()));__out.push("'>&nbsp;</div>\n              ")}__out.push("\n            ")}__out.push("\n\n            ");regular_entries=this.regularEntriesForDate(current_date).partition(function(entry){return entry.isMilestone()});__out.push("\n            ");for(_i=0,_len=regular_entries.length;_i<_len;_i++){regular_entry_collection=regular_entries[_i];__out.push("\n              ");_ref3=regular_entry_collection.sortBy(function(entry){return entry.get("due_time_for_sort")||entry.get("id")});for(_j=0,_len2=_ref3.length;_j<_len2;_j++){regular_entry=_ref3[_j];__out.push("\n                ");__out.push(this.renderEntry(regular_entry,{daynum:daynum}));__out.push("\n              ")}__out.push("\n            ")}__out.push('\n\n            <div class="bottom_padding load_new_entry_on_click" data-date=\'');__out.push(__sanitize(current_date.toString()));__out.push("'>&nbsp;</div>\n          </td>\n        ")}__out.push("\n      </tr>\n\n    </table>\n  </div>\n")}__out.push("\n")}).call(this)}).call(__obj);__obj.safe=__objSafe,__obj.escape=__escape;return __out.join("")}}).call(this);(function(){this.templates||(this.templates={});this.templates.edit_balloon=function(__obj){if(!__obj){__obj={}}var __out=[],__capture=function(callback){var out=__out,result;__out=[];callback.call(this);result=__out.join("");__out=out;return __safe(result)},__sanitize=function(value){if(value&&value.ecoSafe){return value}else{if(typeof value!=="undefined"&&value!=null){return __escape(value)}else{return""}}},__safe,__objSafe=__obj.safe,__escape=__obj.escape;__safe=__obj.safe=function(value){if(value&&value.ecoSafe){return value}else{if(!(typeof value!=="undefined"&&value!=null)){value=""}var result=new String(value);result.ecoSafe=true;return result}};if(!__escape){__escape=__obj.escape=function(value){return(""+value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){__out.push('<div class="balloon menu_content ');__out.push(this.balloon_class);__out.push('" style="display:none;">\n\n  <div class="balloon_wrapper">\n    <!-- balloon pointer -->\n    <div class="balloon_pointer">\n      <div class="balloon_arrow"></div>\n      <div class="balloon_arrow_border"></div>\n    </div>\n\n    <!-- balloon content -->\n    <div class="balloon_content">\n      <div class=\'details_wrapper\'></div>\n      <div class=\'form_wrapper\'></div>\n    </div>\n  </div>\n  \n</div>\n')}).call(this)}).call(__obj);__obj.safe=__objSafe,__obj.escape=__escape;return __out.join("")}}).call(this);(function(){this.templates||(this.templates={});this.templates.overdue_milestones=function(__obj){if(!__obj){__obj={}}var __out=[],__capture=function(callback){var out=__out,result;__out=[];callback.call(this);result=__out.join("");__out=out;return __safe(result)},__sanitize=function(value){if(value&&value.ecoSafe){return value}else{if(typeof value!=="undefined"&&value!=null){return __escape(value)}else{return""}}},__safe,__objSafe=__obj.safe,__escape=__obj.escape;__safe=__obj.safe=function(value){if(value&&value.ecoSafe){return value}else{if(!(typeof value!=="undefined"&&value!=null)){value=""}var result=new String(value);result.ecoSafe=true;return result}};if(!__escape){__escape=__obj.escape=function(value){return(""+value).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}}(function(){(function(){var identifier,late_milestone,_i,_len,_ref;__out.push('<ul id="all_late_milestones_list">\n  ');_ref=this.lateMilestones();for(_i=0,_len=_ref.length;_i<_len;_i++){late_milestone=_ref[_i];__out.push("\n    ");identifier="milestone_"+late_milestone.get("id");__out.push('\n    <li id="');__out.push(__sanitize(identifier));__out.push('" record="');__out.push(__sanitize(identifier));__out.push('" class="menu_container calendar_entry_container" data-entry-id=\'');__out.push(__sanitize(late_milestone.get("id")));__out.push("' data-edit-path='");__out.push(__sanitize(late_milestone.editPath()));__out.push("'>\n\n      ");if(late_milestone.isCompletable()){__out.push('\n        <input type="checkbox" class="milestone_status_checkbox" ');if(late_milestone.get("status")==="complete"){__out.push("checked='checked'")}__out.push(" />\n      ")}else{__out.push('\n        <input type="checkbox" class="milestone_status_checkbox" disabled="disabled" ');if(late_milestone.get("status")==="complete"){__out.push("checked='checked'")}__out.push(" />\n      ")}__out.push('\n\n      <div class="event_label_wrapper">\n        <span class="event_label">\n\n          <strong>');__out.push(__sanitize(I18n.t("milestones.late_milestone.days_late",{count:late_milestone.get("overdue_days_count")})));__out.push('</strong>:\n\n          <span class="menu_position_reference">\n            <a data-details-path="');__out.push(__sanitize(late_milestone.detailsPath()));__out.push('" class="menu_target calendar_entry_menu_target" href="#">');__out.push(__sanitize(late_milestone.get("title")));__out.push("</a>\n            ");__out.push(templates.edit_balloon({entry:late_milestone,balloon_class:"left"}));__out.push('\n          </span>\n\n          <span class="event_meta_wrapper">\n            <span class="event_meta">\n              ');if(this.project_id.blank()){__out.push("\n                [");__out.push(__sanitize(late_milestone.get("company_name")));__out.push(" | ");__out.push(__sanitize(late_milestone.get("project_name")));__out.push(" | ");__out.push(__sanitize(late_milestone.get("responsible_party_name")));__out.push("]\n              ")}else{__out.push("\n                (");__out.push(__sanitize(I18n.translate("milestones.late_milestone.so_and_so_is_responsible",{responsible_party:late_milestone.get("responsible_party_name")})));__out.push(")\n              ")}__out.push("\n            </span>\n          </span>\n        </span>\n      </div>\n\n    </li>\n  ")}__out.push("\n</ul>\n")}).call(this)}).call(__obj);__obj.safe=__objSafe,__obj.escape=__escape;return __out.join("")}}).call(this);var TimeHandler={submit:function(form){if(TimeHandler.action.before){eval(TimeHandler.action.before)}form=$(form);var submit=form.down("input[type=submit][data-disable-with]");submit.writeAttribute("data-original-value",submit.value);submit.disabled=true;submit.value=submit.readAttribute("data-disable-with");new Ajax.Request(TimeHandler.action.url,{asynchronous:true,evalScripts:true,method:TimeHandler.action.method,parameters:Form.serialize("entry_adder"),onComplete:function(){submit.value=submit.readAttribute("data-original-value");submit.removeAttribute("data-original-value");submit.disabled=false}});return false},toggleReport:function(){$("inner_page_header").transition(function(){if($("new_time_report").visible()){$("new_time_report").hide();$("original_header").show()}else{$("new_time_report").show();$("original_header").hide()}}.bind(this))},updateTotals:function(by){this.updateField("hours_subtotal",by);this.updateField("hours_total",by)},updateField:function(field,by){field=$(field);if(field){var amount=parseFloat(field.innerHTML)+by;field.innerHTML=amount.toFixed(2)}},checkBlankSlate:function(){if(this.isBlank()){$("report_link_block","total").invoke("hide");if($("blank_slate")){$("blank_slate").show()}}else{$("report_link_block","total").invoke("show");if($("blank_slate")){$("blank_slate").hide()}}},isBlank:function(){return $$("#entries tr.entry").length==0},disableForm:function(){if($("new_time_entry")){Form.disable("new_time_entry")}},enableForm:function(){if($("new_time_entry")){Form.enable("new_time_entry")}}};document.observe("dom:loaded",function(){if($(document.body).hasClassName("time")){$(document.body).observe("calendar:dateSelected",function(event){var date=event.findElement(".calendar_date_select").previous("input").value;date=CalendarDate.parse(date);var element=event.findElement(".calendar_date_select");var container=element.up(".menu_container");if(container.down(".from_date")){var displayField=container.down(".from_date")}else{if(container.down(".to_date")){var displayField=container.down(".to_date")}else{if(container.down(".time_date")){var displayField=container.down(".time_date")}}}container.fire("menu:deactivate");displayField.value=date.format(displayField.readAttribute("format"))});$("screen_body").observe("menu:activated",function(event){var time_entry=event.findElement("#new_time_entry");if(time_entry){$("new_time_entry").down("input[type=hidden]").calendar.element.fire("calendar:fieldChanged")}})}});(function(){if(!("createTouch" in document)){return}var selector="input[type=text], input[type=password], input[type=search], textarea";function fire(element,type,identifier){var touch=document.createTouch(window,element,identifier,0,0,0,0);var touches=document.createTouchList(touch);var targetTouches=document.createTouchList(touch);var changedTouches=document.createTouchList(touch);var event=document.createEvent("TouchEvent");event.initTouchEvent(type,true,true,window,null,0,0,0,0,false,false,false,false,touches,targetTouches,changedTouches,1,0);element.dispatchEvent(event)}document.on("mouseup",selector,function(event,element){var identifier=new Date().getTime();fire.defer(element,"touchstart",identifier);fire.defer(element,"touchend",identifier)})})();document.observe("dom:loaded",function(){if($(document.body).hasClassName("todos")){preload("/images/assign_due_pop.png");$("screen_body").observe("menu:prepared",function(event){var menu=event.element().down("span.assign_due_pop");if(menu){TodoDates.refreshPopupValues(menu)}var field=event.element().down("input.calendar_date_select_field");if(field){new CalendarDateSelect(field)}});$("screen_body").observe("menu:activated",function(event){var popup=event.element().down("span.assign_due_pop, span.due_pop");if(popup){if(popup.hasClassName("assign_due_pop")){popup.removeClassName("edge");var viewportBottom=document.viewport.getScrollOffsets().top+document.viewport.getHeight();var headerBottom=$("Header").cumulativeOffset().top+$("Header").getHeight();var popupBottom=popup.cumulativeOffset().top+popup.getHeight();if(popupBottom>viewportBottom){popup.addClassName("edge")}if(popup.cumulativeOffset().top<headerBottom){popup.removeClassName("edge")}}popup.slideIntoView()}});$(document.body).observe("calendar:dateSelected",function(event){var form=event.findElement("form.todo_item");if(form){TodoDates.updateDueAtPreview(form);form.fire("menu:deactivate")}form=event.findElement("form.due_date");if(form){form.onsubmit()}if(event.findElement(".item_time_tracker")!=undefined){var date=event.findElement(".item_time_tracker").down(".calendar_date_select").previous("input").value;if(date){date=CalendarDate.parse(date);var element=event.findElement(".calendar_date_select");var container=element.up(".menu_container");var displayField=container.down(".time_date");container.fire("menu:deactivate");displayField.value=date.format(displayField.readAttribute("format"))}}});if(!Placeholder.supported()){$(document.body).observe("focus:in",function(event){var input=event.findElement("input.due_date");if(input){event.stop()}})}}document.observe("menu:activated",function(event){var element;if(element=event.findElement(".item_wrapper")){element.addClassName("has_active_menu");element.up(".list_wrapper").addClassName("has_active_menu")}if(element=event.findElement(".add_item")){element.addClassName("has_active_menu")}if(element=event.findElement(".items_wrapper")){element.addClassName("has_active_menu")}});document.observe("menu:deactivated",function(event){var element;if(element=event.findElement(".item_wrapper")){element.removeClassName("has_active_menu");element.up(".list_wrapper").removeClassName("has_active_menu")}if(element=event.findElement(".add_item")){element.removeClassName("has_active_menu")}if(element=event.findElement(".items_wrapper")){element.removeClassName("has_active_menu")}})});var TodoDates={clearDueAtPreview:function(form){var field=form.down("input.calendar_date_select_field");if(field.calendar){field.calendar.grid.selectDate()}TodoDates.updateDueAtPreview(form)},updateDueAtPreview:function(form){form=$(form);var preview=form.down("input.due_date");var field=form.down("span.due_pop input[type=hidden]");if(!field.value.blank()){var date=CalendarDate.parse(field.value);preview.value=date.format(preview.readAttribute("format"));preview.removeClassName("new_date")}else{preview.value="";preview.fire("focus:out");preview.addClassName("new_date")}},refreshPopupValues:function(menu){menu=$(menu);if(menu.childElements().length==0){menu.insert($("assign_due_popup_template").innerHTML);var div=menu.up("div.list_wrapper");TodoLists.hideClientOptionsIfPrivate(div.readAttribute("record"))}var responsibility_value=menu.readAttribute("data-responsibility");var responsibility_options=menu.select("form.responsibility select option");var responsibility_field=responsibility_options.detect(function(option){return option.value==responsibility_value});responsibility_field.selected=true;var due_at_field=menu.down("form.due_date input.calendar_date_select_field");if(due_at_field){due_at_field.value=menu.readAttribute("data-due-at")}},submitPopupForm:function(form){form=$(form);var item=form.up("div.content");var id=item.readAttribute("data-record-id");item.down("a.pill_todo_item").addClassName("busy");form.fire("menu:deactivate");new Ajax.Request("/todo_items/"+id,{asynchronous:true,evalScripts:true,parameters:Form.serialize(form)})}};document.observe("dom:loaded",function(){if(!$(document.body).hasClassName("todos")){return}var activeItem;document.on("selection:activated","div.item",function(event,element){activeItem=element});document.on("selection:deactivated",function(){activeItem=null});document.observe("keyup",function(event){if(event.keyCode=="E".charCodeAt(0)){if(!activeItem||activeItem.down("form.edit_todo_item")||formFrom(event)){return}edit(activeItem);event.stop()}else{if(event.keyCode==Event.KEY_ESC){var form=formFrom(event);if(form){cancel(form);event.stop()}}}});function formFrom(event){return event.findElement("form.todo_item, form.new_time_entry")}function edit(element){element.down("div.nubbin span.edit_button a").simulate("click")}function cancel(element){var textarea=element.down("textarea[sha1]");if(SHA1(textarea.getValue())!=textarea.readAttribute("sha1")){if(!confirm("Are you sure you want to discard your changes to this to-do item?")){return}}element.down("p.submit a.cancel").onclick()}});Widget={beforeDragRequestHandlers:[],serialize:function(widget){widget=$(widget||"widgets");var elements=widget.immediateDescendants().select(function(e){return e.match("div.widget")});return elements.invoke("readAttribute","record").map(function(record){return"records[]="+encodeURIComponent(record)}).join("&")},makeDragRequest:function(url,container){container=$(container);var widget=Draggables.activeDraggable.element;var widgetParent=widget.up("div.widget_parent");if(widgetParent!=container){return}for(var i=0,length=Widget.beforeDragRequestHandlers.length;i<length;i++){if(!Widget.beforeDragRequestHandlers[i](widget,widgetParent)){return false}}new Ajax.Request(url,{parameters:$H({container:(container.up("div.widget")||container.up("div.page.content")).id,record:widget.getAttribute("record")}).toQueryString()+"&"+Widget.serialize(container)})},onItemEditKeyPress:function(event){element=Event.element(event);if(event.keyCode==13){element.up("form").onsubmit();Event.stop(event)}},ifWidgetHasNoChildren:function(widget,callback){widget=$(widget);if(!widget.down("div.widget",1)){callback()}}};Widget.beforeDragRequestHandlers.push(function(widget,widgetParent){if(widgetParent.id=="widgets"){return true}var listIsTimeTracked=!!widgetParent.up("div.list.list_with_time_tracking");var itemIsTimeTracked=!!widget.down("div.item.item_with_time_tracking");if(listIsTimeTracked!=itemIsTimeTracked){if(!listIsTimeTracked){widgetParent.up("div.items_wrapper").addClassName("busy")}else{widget.addClassName("busy")}}return true});Widget.beforeDragRequestHandlers.push(function(widget,widgetParent){if(widgetParent.id=="widgets"){return true}var listId=widgetParent.up("div.list_wrapper").id,match;widget.descendants().concat(widget).each(function(element){if(match=(element.id||"").match(/^(.*)list_\d+(.+)/)){element.id=match[1]+listId+match[2]}});return true});function setNotifyVisible(notify,input,me,current){var value=$F(input);var notifiable=value!=me&&value.match(/^\d+$/);notify=$(notify);if(!notify){return}if(notifiable){var name=notify.select("span.person_name").first();if(name){var selected=input.select("option[value="+value+"]").first();var firstname=selected.text.split(" ").first();name.update(firstname)}notify.show()}else{notify.hide()}}Position.includeScrollOffsets=true;var TodoLists={resetNewListForm:function(){$("new_list_form").reset();$("use_title_block").show();$("use_template_block").hide();$("use_template_block").down("select").disable();$("link_to_use_template").show();$("link_to_enter_title").hide();var template_select=$("use_template_block").down("select");if(template_select){template_select.selectedIndex=0}},hideClientOptionsIfPrivate:function(list_id){var div=$("list_"+list_id);if(div.hasClassName("private")){TodoLists.hideClientOptions(list_id)}},hideClientOptions:function(list_id){var div=$("list_"+list_id);div.select("option.client").invoke("remove")}};var TodoItems={complete:function(id,url){$("item_"+id+"_notice").show();$("item_submission").action=url;$("item_submission").submit()}};document.on("dom:loaded",function(){var debug=window.location.hash=="#touch_debug";var mobile=Prototype.BrowserFeatures.Multitouch&&Prototype.Browser.Mobile;if(!mobile&&!debug){return}document.body.addClassName("touch");var styleElement=new Element("style",{type:"text/css"});document.documentElement.down("head").insert(styleElement);var stylesheet=styleElement.sheet;function getZoomFactor(){var deviceWidth,landscape=Math.abs(window.orientation)==90;if(window.screen.width==320){deviceWidth=landscape?480:320}else{deviceWidth=window.screen[landscape?"height":"width"]}return deviceWidth/window.innerWidth}function setDeviceScale(scale){if(stylesheet.rules.length){stylesheet.deleteRule(0)}stylesheet.insertRule(".device_scale { -webkit-transform: scale("+scale+") }",0)}function updateDeviceScale(){setDeviceScale(1/getZoomFactor())}function prepareNubbinForTouchDevice(element){if(!element.retrieve("preparedForTouchDevice")){element.store("preparedForTouchDevice",true);var wrapper=element.down("div.wrapper");if(wrapper){wrapper.insert({top:'<div class="arrow"></div>'})}var buttons=element.down("div.buttons");if(buttons){buttons.insert('<div class="spinner"><span></span><span></span><span></span></div>');var button=element.down("span.delete_button");if(button){buttons.insert({bottom:button})}}}}var selectionJustActivated;if(mobile){Event.observe(window,"scroll",updateDeviceScale);Event.observe(window,"resize",updateDeviceScale);Event.observe(window,"load",updateDeviceScale)}document.on("selection:prepared",function(event,element){var nubbin=element.down("div.nubbin");if(nubbin){prepareNubbinForTouchDevice(nubbin)}});document.on("selection:activated",function(event,element){selectionJustActivated=element;(function(){selectionJustActivated=null}).delay(1);var nubbin=element.down("div.nubbin");if(nubbin){var offset=element.cumulativeOffset();var left=event.memo.offset.left-offset.left;nubbin.setStyle({left:(mobile?left:100)+"px"})}});document.on("click","a",function(event){if(selectionJustActivated){event.stop()}})});document.observe("dom:loaded",function(){document.observe("attachment:added",function(event){var form=event.memo.form,id=event.memo.id;var swfUpload=form.attachmentManager.swfUpload;if(swfUpload){var control=form.getAttachmentControl(id);var field=new Element("input").writeAttribute({type:"hidden",name:"[debug]"});var value=Object.toJSON(control.getAttachmentInfo());field.setValue(value);control.insertInputField(field)}})});var UploadPreference={onPreferenceChangeLinkClicked:function(element){if(element.hasClassName("busy")){return}element.addClassName("busy");new Ajax.Request(element.readAttribute("href"),{method:"put"})},onAttachmentManagerChangedTo:function(attachmentManager){UppityUpload.forms.each(function(form){var formElement=form.element;UppityUpload.uninstall(formElement);formElement.writeAttribute("preferred_attachment_manager",attachmentManager);UppityUpload.install(formElement);formElement.fire("uploadPreference:changed")})}};document.observe("dom:loaded",function(){$(document.body).observe("click",function(event){var element=event.findElement("a.upload_preference");if(element){UploadPreference.onPreferenceChangeLinkClicked(element);event.stop()}})});var writeboards={login:function(url,password,dataInjection){$("login_form").action=url;$("login_password").value=password;if(dataInjection){$("data_injection").value=dataInjection}$("login_form").submit()},checkEmpty:function(){var count=$("writeboards").getElementsByTagName("LI").length;if(count<1){$(document.body).addClassName("blank_slate")}},showQuotaBlock:function(){Element.hide("new_writeboard_button");Element.showIf("limit_reached")},hideQuotaBlock:function(){Element.show("new_writeboard_button");Element.hideIf("limit_reached")},creator:{toggle:function(){this.visible()?this.hide(true):this.show(true)},show:function(animate){visible=this.visible();if(!writeboards.importer.hide(false)){new Effect.BlindDown("new_writeboard",{duration:0.2,afterFinish:function(){Field.focus("writeboard_title")}})}else{Element.show("new_writeboard");Field.focus("writeboard_title")}Element.activate("create_writeboard_link",true);$(document.body).removeClassName("blank_slate");return visible},hide:function(animate){visible=this.visible();animate?new Effect.BlindUp("new_writeboard",{duration:0.2,afterFinish:function(){writeboards.checkEmpty()}}):Element.hide("new_writeboard");Element.activate("create_writeboard_link",false);return visible},visible:function(){return $("new_writeboard").style.display!="none"},before:function(){Element.show("writeboard_new_spinner")},success:function(response){var url=response.responseJSON.login_url;var password=response.responseJSON.login_password;var dataInjection=response.responseJSON.data_injection;writeboards.login(url,password,dataInjection)},failure:function(request,upgradeMessage,errorMessage){Element.hide("writeboard_new_spinner");if(request.responseText.match(/limit exceeded/)){alert(upgradeMessage)}else{alert(errorMessage)}}},importer:{before:function(){Element.show("writeboard_import_spinner")},success:function(request){$("writeboard_import_spinner").hide();Layout.swapWithScreenBody("import_writeboard");$("import_writeboard").down("form").reset();var position=request.getResponseHeader("X-Writeboard-Position");var id=request.getResponseHeader("X-Writeboard-Id");var quota=request.getResponseHeader("X-Quota-Status");if(quota=="stop"){writeboards.showQuotaBlock()}if(position=="bottom"){new Insertion.Bottom("writeboards",request.responseText)}else{new Insertion.Before("writeboard_"+position,request.responseText)}new Effect.Highlight("writeboard_"+id)},failure:function(request,errorMessage){Element.hide("writeboard_import_spinner");alert(errorMessage)},notFound:function(request,errorMessage){Element.hide("writeboard_import_spinner");alert(errorMessage)}},remove:{toggle:function(id){this.visible(id)?this.hide(id):this.show(id)},show:function(id){$("privacy_"+id,"show_"+id).invoke("hide");new Effect.BlindDown("remove_"+id,{duration:0.2})},hide:function(id){new Effect.BlindUp("remove_"+id,{duration:0.2,afterFinish:function(){Element.show("show_"+id)}})},visible:function(id){return $("remove_"+id).style.display!="none"},before:function(id){Element.show("remove_spinner_"+id)},failure:function(request,id,errorMessage){Element.hide("remove_spinner_"+id);alert(errorMessage)},success:function(request,id){new Effect.Fade("writeboard_"+id,{afterFinish:function(){Element.remove("writeboard_"+id);writeboards.hideQuotaBlock();writeboards.checkEmpty()}})}},privacy:{toggle:function(id){this.visible(id)?this.hide(id):this.show(id)},show:function(id){Element.hideIf("remove_"+id,"show_"+id);new Effect.BlindDown("privacy_"+id,{duration:0.2})},hide:function(id){new Effect.BlindUp("privacy_"+id,{duration:0.2,afterFinish:function(){Element.show("show_"+id)}})},visible:function(id){return $("privacy_"+id).style.display!="none"},before:function(id){Element.show("privacy_spinner_"+id);Element.hide("public_"+id)},failure:function(request,id,errorMessage){Element.hide("privacy_spinner_"+id);Element.show("public_"+id);$("public_"+id).checked=!$("public_"+id).checked;alert(errorMessage)},success:function(request,id){$("writeboard_"+id).innerHTML=request.responseText;new Effect.Highlight("writeboard_"+id)}}};Prototype.BrowserFeatures.Multitouch="ontouchstart" in document;Prototype.Browser.Mobile=/iPhone|iP[ao]d|Android|Windows Phone|BlackBerry/.test(navigator.userAgent);Object.extend(Droppables,{add:Droppables.add.wrap(function(proceed,element){var options=arguments[2]||{},containment=options.containment;if(containment&&containment.expression&&containment.match){Droppables._containers_by_expression=Droppables._containers_by_expression||{};options._container_selector=containment;options._containers="selector";options.containment=null}return proceed(element,options)}),isContained:Droppables.isContained.wrap(function(proceed,element,drop){if(drop._container_selector&&drop._containers=="selector"){var selector=drop._container_selector,containers=Droppables._containers_by_expression;if(!containers[selector.expression]){containers[selector.expression]=selector.findElements()}drop._containers=containers[selector.expression]}return proceed(element,drop)}),reset:Droppables.reset.wrap(function(proceed){Droppables._containers_by_expression={};this.drops.each(function(drop){if(drop._container_selector){drop._containers="selector"}});return proceed()})});var Sortables=Sortable;function preload(){var all=$$('link[href*="/all.css"]'),protocol="",domain="";if(all.length>0){url=all.first().readAttribute("href").match(/^(.*?:)(\/\/.*?)\//);if(url){protocol=url[1],domain=url[2]}}$A(arguments).each(function(path){var src=protocol+domain+path;new Image().src=src})}function setMenuObserverOn(element){var element=$(element);if(element){var observer=new MenuObserver(element);element.observe("menu:activate",observer.onRegionMouseDown.bind(observer))}}document.observe("dom:loaded",function(){preload("/images/dots-white.gif","/images/upload_progress.gif","/images/basecamp_sprites.png")});document.observe("dom:loaded",function(){if(window.location.hash){var element=$(window.location.hash.substr(1));if(element&&element.hasClassName("sheet")){Layout.swapWithScreenBody(element)}}});document.observe("dom:loaded",function(){setMenuObserverOn("screen_body")});window.afterLoad=[];document.observe("dom:loaded",function(){if(window.afterLoad.length){(function(){window.afterLoad.backgroundEach(function(callback){callback()})}).delay(0.25)}});